ğŸ” Retour au [Sommaire](/SOMMAIRE.md)

# 14.7.3. Prometheus + postgres_exporter + Grafana

## Introduction

Surveiller une base de donnÃ©es PostgreSQL en production ne se limite pas Ã  consulter occasionnellement les logs ou Ã  exÃ©cuter quelques requÃªtes de diagnostic. Il faut un **systÃ¨me de monitoring continu, automatisÃ© et visuel** qui vous alerte immÃ©diatement en cas de problÃ¨me.

**La stack Prometheus + postgres_exporter + Grafana** est devenue la solution de rÃ©fÃ©rence pour le monitoring moderne des bases de donnÃ©es PostgreSQL. Elle combine :

- ğŸ” **Prometheus** : Collecte et stockage des mÃ©triques
- ğŸ“Š **postgres_exporter** : Extraction des mÃ©triques PostgreSQL
- ğŸ“ˆ **Grafana** : Visualisation et tableaux de bord interactifs

Cette stack est :
- âœ… **Open-source** et gratuite
- âœ… **Standard de l'industrie** (utilisÃ©e par Google, Netflix, Uber...)
- âœ… **Cloud-native** (parfaite pour Kubernetes)
- âœ… **Hautement configurable** et extensible
- âœ… **Puissante** pour l'alerting

### Pourquoi cette stack ?

**Avant** (approche traditionnelle) :
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DBA connectÃ© manuellement Ã  PostgreSQL   â”‚
â”‚ â†“                                        â”‚
â”‚ SELECT * FROM pg_stat_activity;          â”‚
â”‚ â†“                                        â”‚
â”‚ "Tout a l'air OK..."                     â”‚
â”‚                                          â”‚
â”‚ 2h plus tard : PANNE !                   â”‚
â”‚ "Pourquoi personne n'a rien vu ?!"       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Avec la stack Prometheus/Grafana** :
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Surveillance 24/7 automatique            â”‚
â”‚ â†“                                        â”‚
â”‚ MÃ©triques collectÃ©es toutes les 15s      â”‚
â”‚ â†“                                        â”‚
â”‚ Dashboard temps rÃ©el visible par tous    â”‚
â”‚ â†“                                        â”‚
â”‚ Alerte Slack : "CPU > 90% depuis 5min"   â”‚
â”‚ â†“                                        â”‚
â”‚ Ã‰quipe prÃ©venue AVANT la panne           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Comprendre les composants

### 1. Prometheus : Le collecteur de mÃ©triques

#### Qu'est-ce que Prometheus ?

**Prometheus** est un systÃ¨me de monitoring et d'alerting open-source crÃ©Ã© par SoundCloud en 2012, devenu projet incubÃ© par la Cloud Native Computing Foundation (CNCF).

**Philosophie** :
- ModÃ¨le **pull** : Prometheus interroge activement les sources de mÃ©triques
- Stockage **time-series** : Chaque mÃ©trique est associÃ©e Ã  un timestamp
- Langage de requÃªte puissant : **PromQL** (Prometheus Query Language)
- Architecture **distribuÃ©e** : Pas de point unique de dÃ©faillance

#### Comment fonctionne Prometheus ?

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Prometheus Server                 â”‚
â”‚                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚   Scraper    â”‚â”€â”€â”€â”€â”€â”€â–¶â”‚   TSDB       â”‚            â”‚
â”‚  â”‚ (Collecteur) â”‚       â”‚(Time Series) â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚         â”‚                                           â”‚
â”‚         â”‚ Pull HTTP GET                             â”‚
â”‚         â”‚ toutes les 15s                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ postgres_exporter   â”‚    â”‚ node_exporter       â”‚
â”‚ (mÃ©triques PG)      â”‚    â”‚ (mÃ©triques systÃ¨me) â”‚
â”‚ :9187/metrics       â”‚    â”‚ :9100/metrics       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Cycle de collecte** :
1. Prometheus envoie une requÃªte HTTP GET vers `/metrics` toutes les N secondes (ex: 15s)
2. L'exporter rÃ©pond avec les mÃ©triques au format texte
3. Prometheus stocke ces mÃ©triques avec timestamp dans sa base de donnÃ©es
4. Les donnÃ©es sont conservÃ©es selon la rÃ©tention configurÃ©e (ex: 30 jours)

#### Format des mÃ©triques Prometheus

Les mÃ©triques sont exposÃ©es au format texte simple :

```
# HELP pg_up Whether the PostgreSQL server is up
# TYPE pg_up gauge
pg_up{server="production-db"} 1

# HELP pg_stat_database_numbackends Number of backends currently connected
# TYPE pg_stat_database_numbackends gauge
pg_stat_database_numbackends{datname="myapp"} 45

# HELP pg_stat_database_xact_commit Transactions committed
# TYPE pg_stat_database_xact_commit counter
pg_stat_database_xact_commit{datname="myapp"} 1234567
```

**Structure** :
- `# HELP` : Description de la mÃ©trique
- `# TYPE` : Type de mÃ©trique (gauge, counter, histogram, summary)
- Nom de la mÃ©trique + labels + valeur

### 2. postgres_exporter : Le traducteur PostgreSQL

#### Qu'est-ce que postgres_exporter ?

**postgres_exporter** est un agent qui :
1. Se connecte Ã  PostgreSQL
2. ExÃ©cute des requÃªtes SQL prÃ©dÃ©finies
3. Transforme les rÃ©sultats en mÃ©triques Prometheus
4. Expose ces mÃ©triques sur un endpoint HTTP

**RÃ´le** : C'est le pont entre PostgreSQL (qui ne parle pas nativement Prometheus) et Prometheus.

#### Architecture de postgres_exporter

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         postgres_exporter                â”‚
â”‚                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚  â”‚ SQL Queries    â”‚                      â”‚
â”‚  â”‚ Executor       â”‚                      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚           â”‚                              â”‚
â”‚           â–¼                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Metric         â”‚â”€â”€â”€â–¶â”‚ HTTP Server  â”‚  â”‚
â”‚  â”‚ Converter      â”‚    â”‚ :9187        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â”‚ Connexion PostgreSQL
            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         PostgreSQL Server                â”‚
â”‚                                          â”‚
â”‚  â€¢ pg_stat_database                      â”‚
â”‚  â€¢ pg_stat_activity                      â”‚
â”‚  â€¢ pg_stat_bgwriter                      â”‚
â”‚  â€¢ pg_stat_replication                   â”‚
â”‚  â€¢ ... et bien d'autres vues systÃ¨me     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### MÃ©triques collectÃ©es par dÃ©faut

postgres_exporter collecte automatiquement des dizaines de mÃ©triques :

**SantÃ© et disponibilitÃ©** :
- `pg_up` : Le serveur PostgreSQL rÃ©pond-il ?
- `pg_stat_database_numbackends` : Nombre de connexions actives
- `pg_database_size_bytes` : Taille des bases de donnÃ©es

**Performance des requÃªtes** :
- `pg_stat_database_xact_commit` : Transactions committÃ©es
- `pg_stat_database_xact_rollback` : Transactions annulÃ©es
- `pg_stat_database_blks_read` : Blocs lus depuis le disque
- `pg_stat_database_blks_hit` : Blocs lus depuis le cache

**RÃ©plication** :
- `pg_stat_replication_lag` : Retard de rÃ©plication
- `pg_stat_replication_state` : Ã‰tat de la rÃ©plication

**Tables et index** :
- `pg_stat_user_tables_n_tup_ins` : Lignes insÃ©rÃ©es
- `pg_stat_user_tables_n_tup_upd` : Lignes modifiÃ©es
- `pg_stat_user_indexes_idx_scan` : Scans d'index

### 3. Grafana : La vitrine visuelle

#### Qu'est-ce que Grafana ?

**Grafana** est une plateforme de visualisation et d'analyse de donnÃ©es open-source.

**FonctionnalitÃ©s principales** :
- ğŸ“Š **Dashboards** : CrÃ©er des tableaux de bord avec graphiques interactifs
- ğŸ”” **Alerting** : DÃ©finir des alertes et notifications
- ğŸ‘¥ **Multi-utilisateurs** : Gestion des permissions et Ã©quipes
- ğŸ”Œ **Data sources** : Connexion Ã  Prometheus, InfluxDB, PostgreSQL, etc.
- ğŸ“¤ **Export/Import** : Partager des dashboards avec la communautÃ©

#### Pourquoi Grafana ?

Sans Grafana, vous interrogez Prometheus manuellement :
```
# RequÃªte PromQL dans le terminal
curl 'http://prometheus:9090/api/v1/query?query=pg_up'

# RÃ©sultat brut JSON
{"status":"success","data":{"resultType":"vector","result":[...]}}
```

Avec Grafana, vous obtenez :
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        Dashboard PostgreSQL            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â—â—â—â—  Database Health: âœ“ UP           â”‚
â”‚                                        â”‚
â”‚  [===== CPU: 45% =====]                â”‚
â”‚  [===== Memory: 78% ===]               â”‚
â”‚                                        â”‚
â”‚  ğŸ“Š Connections: 150/200               â”‚
â”‚  ğŸ“ˆ QPS: 1,245 queries/sec             â”‚
â”‚  ğŸ’¾ Cache Hit Ratio: 99.2%             â”‚
â”‚                                        â”‚
â”‚  [Graphique temps rÃ©el]                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Architecture complÃ¨te de la stack

### Vue d'ensemble

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Utilisateurs / Ã‰quipe                    â”‚
â”‚              (DÃ©veloppeurs, DevOps, DBA, Managers)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â”‚ Navigateur Web
                            â”‚ http://grafana:3000
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Grafana                                â”‚
â”‚                   (Visualisation)                           â”‚
â”‚                                                             â”‚
â”‚  â€¢ Dashboards interactifs                                   â”‚
â”‚  â€¢ Graphiques temps rÃ©el                                    â”‚
â”‚  â€¢ Alertes configurables                                    â”‚
â”‚  â€¢ Export PDF/PNG                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â”‚ RequÃªtes PromQL
                            â”‚ http://prometheus:9090
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Prometheus                               â”‚
â”‚                  (Collecte & Stockage)                      â”‚
â”‚                                                             â”‚
â”‚  â€¢ Time-series database                                     â”‚
â”‚  â€¢ Scraping toutes les 15s                                  â”‚
â”‚  â€¢ RÃ©tention 30 jours                                       â”‚
â”‚  â€¢ Moteur d'alerting                                        â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚                          â”‚
      â”‚ Pull                     â”‚ Pull
      â”‚ :9187/metrics            â”‚ :9100/metrics
      â–¼                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ postgres_exporter   â”‚    â”‚   node_exporter     â”‚
â”‚ (MÃ©triques PG)      â”‚    â”‚ (MÃ©triques SystÃ¨me) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”‚ Connexion SQL
           â”‚ SELECT * FROM pg_stat_*
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   PostgreSQL Server                         â”‚
â”‚                                                             â”‚
â”‚  â€¢ Vues systÃ¨me (pg_stat_*)                                 â”‚
â”‚  â€¢ MÃ©triques temps rÃ©el                                     â”‚
â”‚  â€¢ DonnÃ©es de production                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Flux de donnÃ©es

1. **PostgreSQL** expose ses statistiques via les vues systÃ¨me (`pg_stat_*`)
2. **postgres_exporter** interroge ces vues et les transforme en mÃ©triques Prometheus
3. **Prometheus** collecte ces mÃ©triques pÃ©riodiquement et les stocke
4. **Grafana** interroge Prometheus pour afficher les graphiques
5. **Utilisateurs** consultent les dashboards Grafana dans leur navigateur

---

## Installation et configuration

### PrÃ©requis

- **SystÃ¨me** : Linux (Ubuntu, Debian, CentOS, RHEL)
- **PostgreSQL** : Version 10+ (idÃ©alement 18)
- **MÃ©moire** : 2GB minimum (4GB recommandÃ©)
- **RÃ©seau** : Ports 9090 (Prometheus), 9187 (postgres_exporter), 3000 (Grafana)

### Option 1 : Installation via Docker (RecommandÃ© pour dÃ©buter)

#### Ã‰tape 1 : CrÃ©er le fichier docker-compose.yml

```yaml
version: '3.8'

services:
  # PostgreSQL (si vous n'en avez pas dÃ©jÃ  un)
  postgres:
    image: postgres:18
    container_name: postgres
    environment:
      POSTGRES_USER: myuser
      POSTGRES_PASSWORD: mypassword
      POSTGRES_DB: myapp
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - monitoring

  # postgres_exporter
  postgres_exporter:
    image: prometheuscommunity/postgres-exporter:latest
    container_name: postgres_exporter
    environment:
      DATA_SOURCE_NAME: "postgresql://myuser:mypassword@postgres:5432/myapp?sslmode=disable"
    ports:
      - "9187:9187"
    networks:
      - monitoring
    depends_on:
      - postgres

  # Prometheus
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=30d'
    networks:
      - monitoring

  # Grafana
  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_INSTALL_PLUGINS=grafana-clock-panel
    volumes:
      - grafana_data:/var/lib/grafana
    networks:
      - monitoring

volumes:
  postgres_data:
  prometheus_data:
  grafana_data:

networks:
  monitoring:
    driver: bridge
```

#### Ã‰tape 2 : CrÃ©er le fichier prometheus.yml

```yaml
# Configuration globale
global:
  scrape_interval: 15s      # Collecte toutes les 15 secondes
  evaluation_interval: 15s  # Ã‰valuation des rÃ¨gles toutes les 15s

# Configuration des targets Ã  scraper
scrape_configs:
  # Prometheus lui-mÃªme
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']

  # PostgreSQL via postgres_exporter
  - job_name: 'postgresql'
    static_configs:
      - targets: ['postgres_exporter:9187']
        labels:
          instance: 'production-db'
          environment: 'production'
```

#### Ã‰tape 3 : DÃ©marrer la stack

```bash
# DÃ©marrer tous les services
docker-compose up -d

# VÃ©rifier que tout fonctionne
docker-compose ps

# Logs de postgres_exporter
docker-compose logs -f postgres_exporter
```

#### Ã‰tape 4 : VÃ©rifier l'installation

**1. VÃ©rifier postgres_exporter** :
```bash
curl http://localhost:9187/metrics

# RÃ©sultat attendu : Liste de mÃ©triques
# pg_up 1
# pg_stat_database_numbackends{datname="myapp"} 5
# ...
```

**2. VÃ©rifier Prometheus** :
- Ouvrir : http://localhost:9090
- Aller dans Status â†’ Targets
- VÃ©rifier que "postgresql" est **UP**

**3. VÃ©rifier Grafana** :
- Ouvrir : http://localhost:3000
- Login : admin / admin
- Vous devriez voir la page d'accueil

### Option 2 : Installation native (Production)

#### Ã‰tape 1 : Installer Prometheus

```bash
# TÃ©lÃ©charger Prometheus
cd /tmp
wget https://github.com/prometheus/prometheus/releases/download/v2.48.0/prometheus-2.48.0.linux-amd64.tar.gz

# Extraire
tar xvfz prometheus-*.tar.gz
cd prometheus-*

# DÃ©placer les binaires
sudo mv prometheus promtool /usr/local/bin/

# CrÃ©er les rÃ©pertoires
sudo mkdir -p /etc/prometheus /var/lib/prometheus

# Copier les fichiers de config
sudo mv prometheus.yml /etc/prometheus/
sudo mv consoles/ console_libraries/ /etc/prometheus/

# CrÃ©er un utilisateur systÃ¨me
sudo useradd --no-create-home --shell /bin/false prometheus

# Permissions
sudo chown -R prometheus:prometheus /etc/prometheus /var/lib/prometheus
```

**CrÃ©er le service systemd** : `/etc/systemd/system/prometheus.service`

```ini
[Unit]
Description=Prometheus Monitoring System
Documentation=https://prometheus.io/docs/
After=network.target

[Service]
User=prometheus
Group=prometheus
Type=simple
ExecStart=/usr/local/bin/prometheus \
  --config.file=/etc/prometheus/prometheus.yml \
  --storage.tsdb.path=/var/lib/prometheus/ \
  --storage.tsdb.retention.time=30d \
  --web.console.templates=/etc/prometheus/consoles \
  --web.console.libraries=/etc/prometheus/console_libraries

Restart=on-failure
RestartSec=5

[Install]
WantedBy=multi-user.target
```

**DÃ©marrer Prometheus** :
```bash
sudo systemctl daemon-reload
sudo systemctl start prometheus
sudo systemctl enable prometheus
sudo systemctl status prometheus
```

#### Ã‰tape 2 : Installer postgres_exporter

```bash
# TÃ©lÃ©charger
cd /tmp
wget https://github.com/prometheus-community/postgres_exporter/releases/download/v0.15.0/postgres_exporter-0.15.0.linux-amd64.tar.gz

# Extraire
tar xvfz postgres_exporter-*.tar.gz
cd postgres_exporter-*

# DÃ©placer le binaire
sudo mv postgres_exporter /usr/local/bin/

# CrÃ©er un utilisateur
sudo useradd --no-create-home --shell /bin/false postgres_exporter
```

**CrÃ©er le fichier de configuration** : `/etc/postgres_exporter/postgres_exporter.env`

```bash
DATA_SOURCE_NAME="postgresql://monitoring_user:secure_password@localhost:5432/postgres?sslmode=disable"
```

**Important** : CrÃ©er un utilisateur PostgreSQL dÃ©diÃ© au monitoring :

```sql
-- Se connecter Ã  PostgreSQL
psql -U postgres

-- CrÃ©er l'utilisateur de monitoring
CREATE USER monitoring_user WITH PASSWORD 'secure_password';

-- Permissions minimales nÃ©cessaires
GRANT CONNECT ON DATABASE postgres TO monitoring_user;
GRANT USAGE ON SCHEMA public TO monitoring_user;
GRANT SELECT ON ALL TABLES IN SCHEMA public TO monitoring_user;

-- Permissions sur les vues systÃ¨me
GRANT pg_monitor TO monitoring_user;

-- Pour PostgreSQL < 10
ALTER USER monitoring_user SET SEARCH_PATH TO public,pg_catalog;
```

**CrÃ©er le service systemd** : `/etc/systemd/system/postgres_exporter.service`

```ini
[Unit]
Description=PostgreSQL Exporter for Prometheus
Documentation=https://github.com/prometheus-community/postgres_exporter
After=network.target

[Service]
User=postgres_exporter
Group=postgres_exporter
Type=simple
EnvironmentFile=/etc/postgres_exporter/postgres_exporter.env
ExecStart=/usr/local/bin/postgres_exporter

Restart=on-failure
RestartSec=5

[Install]
WantedBy=multi-user.target
```

**DÃ©marrer postgres_exporter** :
```bash
sudo systemctl daemon-reload
sudo systemctl start postgres_exporter
sudo systemctl enable postgres_exporter
sudo systemctl status postgres_exporter
```

#### Ã‰tape 3 : Installer Grafana

```bash
# Ajouter le dÃ©pÃ´t Grafana
sudo apt-get install -y software-properties-common
sudo add-apt-repository "deb https://packages.grafana.com/oss/deb stable main"

# Ajouter la clÃ© GPG
wget -q -O - https://packages.grafana.com/gpg.key | sudo apt-key add -

# Installer Grafana
sudo apt-get update
sudo apt-get install grafana

# DÃ©marrer Grafana
sudo systemctl start grafana-server
sudo systemctl enable grafana-server
sudo systemctl status grafana-server
```

---

## Configuration de Grafana

### Connexion initiale

1. Ouvrir http://localhost:3000 dans votre navigateur
2. Login par dÃ©faut : `admin` / `admin`
3. Changer le mot de passe lors de la premiÃ¨re connexion

### Ajouter Prometheus comme data source

**Ã‰tape 1** : Aller dans Configuration â†’ Data Sources

**Ã‰tape 2** : Cliquer sur "Add data source"

**Ã‰tape 3** : SÃ©lectionner "Prometheus"

**Ã‰tape 4** : Configurer :
```
Name: Prometheus
URL: http://prometheus:9090 (Docker) ou http://localhost:9090 (natif)
Access: Server (par dÃ©faut)
```

**Ã‰tape 5** : Cliquer sur "Save & Test"

âœ… RÃ©sultat attendu : "Data source is working"

### Importer un dashboard PostgreSQL

Grafana dispose d'une bibliothÃ¨que de dashboards prÃªts Ã  l'emploi.

**Ã‰tape 1** : Aller dans Dashboards â†’ Import

**Ã‰tape 2** : Utiliser un dashboard communautaire

**Dashboards PostgreSQL populaires** :

| ID | Nom | Description |
|----|-----|-------------|
| 9628 | PostgreSQL Database | Dashboard complet officiel |
| 12485 | PostgreSQL Exporter Quickstart | Vue d'ensemble rapide |
| 12906 | PostgreSQL Performance | Focus performance |
| 14114 | PostgreSQL Replication | Monitoring rÃ©plication |

**Ã‰tape 3** : Entrer l'ID (ex: 9628) et cliquer sur "Load"

**Ã‰tape 4** : SÃ©lectionner la data source Prometheus

**Ã‰tape 5** : Cliquer sur "Import"

ğŸ‰ **Vous avez maintenant un dashboard PostgreSQL opÃ©rationnel !**

---

## MÃ©triques essentielles Ã  surveiller

### 1. SantÃ© globale (Health)

#### pg_up

**Description** : PostgreSQL est-il accessible ?

**Valeur** :
- `1` : Base accessible âœ…
- `0` : Base inaccessible âŒ

**PromQL** :
```promql
pg_up
```

**Alerte** :
```yaml
- alert: PostgreSQLDown
  expr: pg_up == 0
  for: 1m
  annotations:
    summary: "PostgreSQL is down"
```

#### pg_database_size_bytes

**Description** : Taille de chaque base de donnÃ©es en octets

**PromQL** :
```promql
# Taille en GB
pg_database_size_bytes / 1024 / 1024 / 1024

# Croissance sur 24h
delta(pg_database_size_bytes[24h]) / 1024 / 1024 / 1024
```

**Alerte** :
```yaml
- alert: DatabaseSizeGrowing
  expr: delta(pg_database_size_bytes[24h]) > 10737418240  # >10GB/jour
  for: 1h
  annotations:
    summary: "Database growing rapidly"
```

### 2. Connexions (Connections)

#### pg_stat_database_numbackends

**Description** : Nombre de connexions actives par base

**PromQL** :
```promql
# Connexions totales
sum(pg_stat_database_numbackends)

# Pourcentage d'utilisation
sum(pg_stat_database_numbackends) / pg_settings_max_connections * 100

# Par base de donnÃ©es
pg_stat_database_numbackends{datname="myapp"}
```

**Alerte** :
```yaml
- alert: TooManyConnections
  expr: sum(pg_stat_database_numbackends) / pg_settings_max_connections > 0.8
  for: 5m
  annotations:
    summary: "Connection pool usage > 80%"
```

#### pg_settings_max_connections

**Description** : Nombre maximum de connexions autorisÃ©es

**PromQL** :
```promql
pg_settings_max_connections
```

### 3. Performance des transactions

#### pg_stat_database_xact_commit / xact_rollback

**Description** : Nombre de transactions committÃ©es vs annulÃ©es

**PromQL** :
```promql
# Taux de commit par seconde
rate(pg_stat_database_xact_commit[5m])

# Taux de rollback par seconde
rate(pg_stat_database_xact_rollback[5m])

# Ratio rollback/commit (doit Ãªtre faible)
rate(pg_stat_database_xact_rollback[5m]) / rate(pg_stat_database_xact_commit[5m])
```

**Alerte** :
```yaml
- alert: HighRollbackRate
  expr: rate(pg_stat_database_xact_rollback[5m]) / rate(pg_stat_database_xact_commit[5m]) > 0.1
  for: 10m
  annotations:
    summary: "Rollback rate > 10%"
```

### 4. Cache Hit Ratio (Performance I/O)

#### pg_stat_database_blks_hit / blks_read

**Description** : Ratio de lectures depuis le cache vs le disque

**PromQL** :
```promql
# Cache hit ratio (devrait Ãªtre > 95%)
sum(rate(pg_stat_database_blks_hit[5m])) /
(sum(rate(pg_stat_database_blks_hit[5m])) + sum(rate(pg_stat_database_blks_read[5m]))) * 100

# Par base de donnÃ©es
rate(pg_stat_database_blks_hit{datname="myapp"}[5m]) /
(rate(pg_stat_database_blks_hit{datname="myapp"}[5m]) + rate(pg_stat_database_blks_read{datname="myapp"}[5m])) * 100
```

**InterprÃ©tation** :
- **> 99%** : Excellent âœ…
- **95-99%** : Bon âœ…
- **90-95%** : Ã€ surveiller âš ï¸
- **< 90%** : ProblÃ¨me, augmenter `shared_buffers` âŒ

**Alerte** :
```yaml
- alert: LowCacheHitRatio
  expr: |
    sum(rate(pg_stat_database_blks_hit[5m])) /
    (sum(rate(pg_stat_database_blks_hit[5m])) + sum(rate(pg_stat_database_blks_read[5m]))) < 0.95
  for: 10m
  annotations:
    summary: "Cache hit ratio < 95%"
```

### 5. RÃ©plication (pour les setups HA)

#### pg_stat_replication_lag

**Description** : Retard de rÃ©plication en secondes

**PromQL** :
```promql
# Retard en secondes
pg_stat_replication_lag_seconds

# Retard en bytes
pg_stat_replication_lag_bytes
```

**Alerte** :
```yaml
- alert: ReplicationLag
  expr: pg_stat_replication_lag_seconds > 60
  for: 5m
  annotations:
    summary: "Replication lag > 60s"
```

### 6. Locks (Verrous)

#### pg_stat_database_deadlocks

**Description** : Nombre de deadlocks dÃ©tectÃ©s

**PromQL** :
```promql
# Deadlocks par seconde
rate(pg_stat_database_deadlocks[5m])

# Total sur 1h
increase(pg_stat_database_deadlocks[1h])
```

**Alerte** :
```yaml
- alert: FrequentDeadlocks
  expr: increase(pg_stat_database_deadlocks[1h]) > 5
  for: 5m
  annotations:
    summary: "More than 5 deadlocks in the last hour"
```

### 7. Tables et index

#### pg_stat_user_tables_n_tup_*

**Description** : OpÃ©rations sur les tables (INSERT, UPDATE, DELETE)

**PromQL** :
```promql
# Taux d'insertion par seconde
rate(pg_stat_user_tables_n_tup_ins[5m])

# Taux de mise Ã  jour
rate(pg_stat_user_tables_n_tup_upd[5m])

# Taux de suppression
rate(pg_stat_user_tables_n_tup_del[5m])
```

#### pg_stat_user_tables_n_live_tup / n_dead_tup

**Description** : Lignes vivantes vs lignes mortes (bloat)

**PromQL** :
```promql
# Pourcentage de dead tuples
pg_stat_user_tables_n_dead_tup /
(pg_stat_user_tables_n_live_tup + pg_stat_user_tables_n_dead_tup) * 100
```

**Alerte** :
```yaml
- alert: HighTableBloat
  expr: |
    pg_stat_user_tables_n_dead_tup /
    (pg_stat_user_tables_n_live_tup + pg_stat_user_tables_n_dead_tup) > 0.2
  for: 30m
  annotations:
    summary: "Table bloat > 20%"
```

### 8. Checkpoints

#### pg_stat_bgwriter_checkpoints_*

**Description** : Statistiques sur les checkpoints

**PromQL** :
```promql
# Checkpoints planifiÃ©s (bons)
rate(pg_stat_bgwriter_checkpoints_timed[5m])

# Checkpoints forcÃ©s (mauvais si trop nombreux)
rate(pg_stat_bgwriter_checkpoints_req[5m])

# Ratio de checkpoints forcÃ©s
rate(pg_stat_bgwriter_checkpoints_req[5m]) /
(rate(pg_stat_bgwriter_checkpoints_timed[5m]) + rate(pg_stat_bgwriter_checkpoints_req[5m])) * 100
```

**Alerte** :
```yaml
- alert: TooManyForcedCheckpoints
  expr: |
    rate(pg_stat_bgwriter_checkpoints_req[5m]) /
    (rate(pg_stat_bgwriter_checkpoints_timed[5m]) + rate(pg_stat_bgwriter_checkpoints_req[5m])) > 0.5
  for: 10m
  annotations:
    summary: "Forced checkpoints > 50%"
    description: "Consider increasing max_wal_size"
```

---

## CrÃ©er des dashboards personnalisÃ©s

### Panel 1 : Connexions actives (Gauge)

**Ã‰tape 1** : CrÃ©er un nouveau dashboard

**Ã‰tape 2** : Ajouter un panel de type "Gauge"

**Ã‰tape 3** : Configurer la requÃªte PromQL :
```promql
sum(pg_stat_database_numbackends)
```

**Ã‰tape 4** : Configurer les seuils :
- Vert : 0-80
- Orange : 80-150
- Rouge : 150+

**Ã‰tape 5** : Configurer l'unitÃ© : "Number"

### Panel 2 : QPS (Time series)

**Type** : Time series (graphique de courbe)

**RequÃªte PromQL** :
```promql
# Queries par seconde
sum(rate(pg_stat_database_xact_commit[5m]))
```

**Titre** : "Queries per Second (QPS)"

**Axe Y** : queries/sec

### Panel 3 : Cache Hit Ratio (Stat)

**Type** : Stat

**RequÃªte PromQL** :
```promql
sum(rate(pg_stat_database_blks_hit[5m])) /
(sum(rate(pg_stat_database_blks_hit[5m])) + sum(rate(pg_stat_database_blks_read[5m]))) * 100
```

**Titre** : "Cache Hit Ratio"

**UnitÃ©** : percent (0-100)

**Seuils** :
- Rouge : < 90
- Orange : 90-95
- Vert : > 95

### Panel 4 : Top 5 tables par size (Bar gauge)

**Type** : Bar gauge

**RequÃªte PromQL** :
```promql
topk(5, pg_stat_user_tables_n_live_tup)
```

**Titre** : "Top 5 Tables by Row Count"

**Legend** : `{{relname}}`

### Dashboard complet - Exemple de layout

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   PostgreSQL Monitoring                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  [â—] Status: UP    [150] Connections    [99.2%] Cache Hit   â”‚
â”‚                                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚         Queries per Second (QPS)                    â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚    â”‚
â”‚  â”‚  â”‚                    â•±â•²                       â”‚    â”‚    â”‚
â”‚  â”‚  â”‚                   â•±  â•²      â•±â•²              â”‚    â”‚    â”‚
â”‚  â”‚  â”‚        â•±â•²        â•±    â•²    â•±  â•²    â•±â•²       â”‚    â”‚    â”‚
â”‚  â”‚  â”‚â”€â”€â”€â”€â”€â”€â”€â•±â”€â”€â•²â”€â”€â”€â”€â”€â”€â•±â”€â”€â”€â”€â”€â”€â•²â”€â”€â•±â”€â”€â”€â”€â•²â”€â”€â•±â”€â”€â•²â”€â”€â”€â”€â”€ â”‚    â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚  Connection Pool     â”‚  â”‚  Replication Lag     â”‚         â”‚
â”‚  â”‚  â–“â–“â–“â–“â–“â–“â–“â–“â–‘â–‘ 75%      â”‚  â”‚  12 seconds          â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Configuration de l'alerting

### Ã‰tape 1 : Configurer un canal de notification

**Dans Grafana** : Alerting â†’ Notification channels

**Canaux disponibles** :
- Email
- Slack
- PagerDuty
- Webhook
- Microsoft Teams
- Telegram
- Discord

**Exemple : Configuration Slack**

1. CrÃ©er un Incoming Webhook dans Slack
2. Dans Grafana : Add channel
3. Type : Slack
4. Webhook URL : Votre URL Slack
5. Tester la notification

### Ã‰tape 2 : CrÃ©er des rÃ¨gles d'alerte

#### Alerte : PostgreSQL Down

**Panel** : "Database Status"

**Alert Rule** :
- Condition : `WHEN last() OF query(A, 5m, now) IS BELOW 1`
- Frequency : Evaluate every 1m for 2m
- Send to : Slack

**Message** :
```
ğŸš¨ CRITICAL: PostgreSQL is DOWN
Instance: {{ $labels.instance }}
Environment: {{ $labels.environment }}
```

#### Alerte : High Connection Usage

**Condition** :
```promql
sum(pg_stat_database_numbackends) / pg_settings_max_connections > 0.8
```

**Message** :
```
âš ï¸ WARNING: High connection usage
Current: {{ $value }}%
Threshold: 80%
```

#### Alerte : Low Cache Hit Ratio

**Condition** :
```promql
sum(rate(pg_stat_database_blks_hit[5m])) /
(sum(rate(pg_stat_database_blks_hit[5m])) + sum(rate(pg_stat_database_blks_read[5m]))) < 0.9
```

**Message** :
```
âš ï¸ WARNING: Low cache hit ratio
Current: {{ $value }}%
Recommendation: Consider increasing shared_buffers
```

### Ã‰tape 3 : Tester les alertes

**Simuler une alerte** :
```bash
# ArrÃªter PostgreSQL temporairement
sudo systemctl stop postgresql

# Attendre 2-3 minutes
# â†’ Vous devriez recevoir l'alerte "PostgreSQL Down"

# RedÃ©marrer
sudo systemctl start postgresql

# â†’ Vous devriez recevoir une alerte de rÃ©solution
```

---

## Bonnes pratiques

### 1. SÃ©curitÃ©

#### SÃ©curiser l'accÃ¨s aux services

**Grafana** :
```ini
# /etc/grafana/grafana.ini

[server]
http_addr = 127.0.0.1  # Ã‰couter seulement sur localhost
http_port = 3000

[security]
admin_user = admin
admin_password = CHANGE_ME_STRONG_PASSWORD

# Forcer HTTPS
protocol = https
cert_file = /path/to/cert.pem
cert_key = /path/to/key.pem
```

**Prometheus** :
```yaml
# prometheus.yml

# Authentification basique
basic_auth:
  username: prometheus_user
  password: secure_password

# TLS
tls_config:
  cert_file: /path/to/cert.pem
  key_file: /path/to/key.pem
```

**postgres_exporter** :
```bash
# Utilisateur PostgreSQL avec permissions minimales
# Ne PAS utiliser le superuser !

CREATE USER monitoring_user WITH PASSWORD 'complex_password';
GRANT pg_monitor TO monitoring_user;
```

#### Utiliser un reverse proxy

**Nginx** pour exposer Grafana de maniÃ¨re sÃ©curisÃ©e :

```nginx
server {
    listen 443 ssl http2;
    server_name grafana.example.com;

    ssl_certificate /etc/letsencrypt/live/grafana.example.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/grafana.example.com/privkey.pem;

    location / {
        proxy_pass http://localhost:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

### 2. Performance et dimensionnement

#### Optimiser la rÃ©tention Prometheus

**ProblÃ¨me** : Prometheus peut consommer beaucoup de disque.

**Configuration dans prometheus.yml** :
```yaml
global:
  scrape_interval: 15s         # FrÃ©quence de collecte
  evaluation_interval: 15s

# Ligne de commande
--storage.tsdb.retention.time=30d     # Conserver 30 jours
--storage.tsdb.retention.size=50GB    # Limiter Ã  50GB
```

**Calcul de l'espace nÃ©cessaire** :
```
Espace = nb_mÃ©triques Ã— Ã©chantillons_par_jour Ã— taille_Ã©chantillon Ã— rÃ©tention_jours

Exemple :
1000 mÃ©triques Ã— 5760 Ã©chantillons/jour Ã— 2 bytes Ã— 30 jours = 345 MB
```

#### Optimiser les requÃªtes PromQL

**Mauvais** (calcule sur toutes les sÃ©ries) :
```promql
rate(pg_stat_database_xact_commit[5m])
```

**Bon** (filtre dÃ¨s le dÃ©but) :
```promql
rate(pg_stat_database_xact_commit{datname="myapp"}[5m])
```

**Utiliser le recording rules** pour les calculs complexes :

```yaml
# prometheus.yml
rule_files:
  - "rules.yml"

# rules.yml
groups:
  - name: postgresql
    interval: 30s
    rules:
      - record: job:pg_cache_hit_ratio:rate5m
        expr: |
          sum(rate(pg_stat_database_blks_hit[5m])) /
          (sum(rate(pg_stat_database_blks_hit[5m])) + sum(rate(pg_stat_database_blks_read[5m])))
```

### 3. Organisation des dashboards

#### HiÃ©rarchie recommandÃ©e

```
ğŸ“Š PostgreSQL Monitoring (Folder)
â”œâ”€â”€ 01-Overview.json           # Vue d'ensemble
â”œâ”€â”€ 02-Performance.json        # CPU, I/O, Cache
â”œâ”€â”€ 03-Connections.json        # Pool, sessions
â”œâ”€â”€ 04-Queries.json            # Slow queries, QPS
â”œâ”€â”€ 05-Replication.json        # Standby, lag
â”œâ”€â”€ 06-Tables-Indexes.json     # Bloat, scans
â””â”€â”€ 07-Alerting.json           # Status des alertes
```

#### Conventions de nommage

**Panels** :
- Commencer par le type de mÃ©trique : `[Gauge] Connections`
- Utiliser des verbes d'action : `Monitor`, `Track`, `Analyze`
- ÃŠtre explicite : `Cache Hit Ratio (%)` plutÃ´t que `Cache`

**Variables** :
- `$environment` : production, staging, development
- `$instance` : nom de l'instance PostgreSQL
- `$database` : nom de la base de donnÃ©es

### 4. Documentation et runbooks

**Ajouter des annotations aux panels** :

```
Description:
Ce panel affiche le nombre de connexions actives.

Seuils:
- Vert (0-80): Utilisation normale
- Orange (80-150): Surveiller
- Rouge (>150): Action requise

Actions si alerte:
1. VÃ©rifier les connexions inutiles: SELECT * FROM pg_stat_activity
2. Identifier les connexions idle: WHERE state = 'idle'
3. Terminer les connexions zombies si nÃ©cessaire
4. VÃ©rifier le connection pooling (PgBouncer)

Contact: dba-team@example.com
```

### 5. Versionning et backup

**Exporter les dashboards** :
```bash
# Export manuel
Dashboard â†’ Settings â†’ JSON Model â†’ Copy

# Automatiser avec grafana-cli
grafana-cli admin data-migration extract --folder="PostgreSQL"

# Versionner dans Git
mkdir dashboards
mv *.json dashboards/
git add dashboards/
git commit -m "Update PostgreSQL dashboards"
```

**Backup de Grafana** :
```bash
# Backup de la base SQLite de Grafana
sudo cp /var/lib/grafana/grafana.db /backup/grafana_$(date +%Y%m%d).db

# Ou pour Docker
docker exec grafana cat /var/lib/grafana/grafana.db > grafana_backup.db
```

---

## Cas d'usage avancÃ©s

### 1. Monitoring multi-instances

**ScÃ©nario** : Vous avez plusieurs instances PostgreSQL (prod, staging, dev).

**Configuration Prometheus** :
```yaml
scrape_configs:
  - job_name: 'postgresql'
    static_configs:
      - targets: ['postgres-exporter-prod:9187']
        labels:
          instance: 'production'
          environment: 'prod'
          datacenter: 'us-east-1'

      - targets: ['postgres-exporter-staging:9187']
        labels:
          instance: 'staging'
          environment: 'staging'
          datacenter: 'us-west-1'

      - targets: ['postgres-exporter-dev:9187']
        labels:
          instance: 'development'
          environment: 'dev'
          datacenter: 'eu-west-1'
```

**Dashboard avec variables** :

Variable `environment` :
```promql
label_values(pg_up, environment)
```

Panel filtrÃ© :
```promql
pg_stat_database_numbackends{environment="$environment"}
```

### 2. Alerting sur tendances

**DÃ©tecter une croissance anormale** :

```promql
# Croissance de la base > 10GB en 24h
delta(pg_database_size_bytes[24h]) > 10737418240

# Augmentation soudaine des connexions (>50% en 10min)
(pg_stat_database_numbackends - pg_stat_database_numbackends offset 10m) /
pg_stat_database_numbackends offset 10m > 0.5

# DÃ©gradation progressive du cache hit ratio
(avg_over_time(job:pg_cache_hit_ratio:rate5m[7d] offset 7d) -
 avg_over_time(job:pg_cache_hit_ratio:rate5m[7d])) > 0.05
```

### 3. CorrÃ©lation avec les mÃ©triques systÃ¨me

**Ajouter node_exporter** pour les mÃ©triques OS :

```yaml
# docker-compose.yml
node_exporter:
  image: prom/node-exporter:latest
  ports:
    - "9100:9100"
  volumes:
    - /proc:/host/proc:ro
    - /sys:/host/sys:ro
  command:
    - '--path.procfs=/host/proc'
    - '--path.sysfs=/host/sys'
```

**Dashboard combinÃ©** :

Panel 1 : CPU PostgreSQL vs CPU SystÃ¨me
```promql
# CPU PostgreSQL (via pg_stat_kcache si disponible)
rate(pg_stat_kcache_exec_user_time[5m])

# CPU SystÃ¨me total
100 - (avg(irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100)
```

Panel 2 : I/O PostgreSQL vs I/O Disque
```promql
# I/O PostgreSQL
rate(pg_stat_database_blks_read[5m])

# I/O Disque (device sda)
rate(node_disk_read_bytes_total{device="sda"}[5m])
```

### 4. SLO/SLI monitoring

**DÃ©finir des SLOs (Service Level Objectives)** :

**SLI 1** : DisponibilitÃ© > 99.9%
```promql
# Uptime ratio sur 30 jours
avg_over_time(pg_up[30d]) * 100
```

**SLI 2** : 95% des requÃªtes < 100ms
```promql
# NÃ©cessite pg_stat_statements + custom exporter
histogram_quantile(0.95, rate(pg_query_duration_bucket[5m]))
```

**Dashboard SLO** avec "burn rate" :
```promql
# Error budget restant
1 - ((1 - avg_over_time(pg_up[30d])) / 0.001)
```

---

## Troubleshooting

### ProblÃ¨me 1 : Prometheus ne collecte pas les mÃ©triques

**SymptÃ´mes** :
- Target est en Ã©tat "DOWN" dans Prometheus
- Pas de donnÃ©es dans Grafana

**Diagnostic** :
```bash
# VÃ©rifier que postgres_exporter Ã©coute
netstat -tulpn | grep 9187

# Tester l'endpoint manuellement
curl http://localhost:9187/metrics

# VÃ©rifier les logs
docker logs postgres_exporter
# ou
journalctl -u postgres_exporter -f
```

**Causes courantes** :
1. postgres_exporter n'arrive pas Ã  se connecter Ã  PostgreSQL
2. Firewall bloque le port 9187
3. Configuration DATA_SOURCE_NAME incorrecte

**Solution** :
```bash
# Tester la connexion PostgreSQL
psql "postgresql://monitoring_user:password@localhost:5432/postgres"

# VÃ©rifier les permissions
psql -U monitoring_user -d postgres -c "SELECT * FROM pg_stat_database LIMIT 1;"
```

### ProblÃ¨me 2 : MÃ©triques manquantes

**SymptÃ´me** : Certaines mÃ©triques ne s'affichent pas.

**Cause** : postgres_exporter ne collecte que les mÃ©triques de base par dÃ©faut.

**Solution** : Activer les mÃ©triques Ã©tendues.

**CrÃ©er un fichier queries.yaml** :
```yaml
pg_replication:
  query: "SELECT CASE WHEN pg_last_wal_receive_lsn() = pg_last_wal_replay_lsn() THEN 0 ELSE EXTRACT(EPOCH FROM NOW() - pg_last_xact_replay_timestamp()) END AS lag"
  master: true
  metrics:
    - lag:
        usage: "GAUGE"
        description: "Replication lag behind master in seconds"

pg_postmaster:
  query: "SELECT pg_postmaster_start_time() as start_time_seconds"
  metrics:
    - start_time_seconds:
        usage: "GAUGE"
        description: "Time at which postmaster started"
```

**Charger le fichier** :
```bash
# Ligne de commande
postgres_exporter --extend.query-path=/etc/postgres_exporter/queries.yaml

# Docker
docker run -v /path/to/queries.yaml:/queries.yaml \
  -e PG_EXPORTER_EXTEND_QUERY_PATH=/queries.yaml \
  postgres_exporter
```

### ProblÃ¨me 3 : Dashboards vides aprÃ¨s import

**Cause** : Data source non configurÃ©e ou nom diffÃ©rent.

**Solution** :
1. VÃ©rifier que la data source existe : Configuration â†’ Data Sources
2. Ã‰diter le dashboard : Settings â†’ Variables
3. Changer la data source dans chaque variable/panel si nÃ©cessaire

### ProblÃ¨me 4 : Alertes qui ne se dÃ©clenchent pas

**Diagnostic** :
1. VÃ©rifier l'Ã©tat de l'alerte : Alerting â†’ Alert Rules
2. Tester la condition manuellement dans un panel
3. VÃ©rifier le canal de notification : Test

**Erreur courante** : Alerte configurÃ©e dans Grafana mais pas dans Prometheus.

**Solution** : Utiliser soit Grafana Alerting, soit Prometheus Alertmanager, pas les deux.

### ProblÃ¨me 5 : Performance dÃ©gradÃ©e de Prometheus

**SymptÃ´mes** :
- Prometheus lent Ã  rÃ©pondre
- Grafana timeout sur les requÃªtes
- CPU Ã©levÃ© sur le serveur Prometheus

**Causes** :
- Trop de mÃ©triques collectÃ©es
- RÃ©tention trop longue
- RequÃªtes PromQL non optimisÃ©es

**Solutions** :
```yaml
# 1. RÃ©duire la frÃ©quence de scraping
global:
  scrape_interval: 30s  # Au lieu de 15s

# 2. RÃ©duire la rÃ©tention
--storage.tsdb.retention.time=15d  # Au lieu de 30d

# 3. Filtrer les mÃ©triques inutiles
scrape_configs:
  - job_name: 'postgresql'
    metric_relabel_configs:
      - source_labels: [__name__]
        regex: 'pg_stat_user_tables_.*'
        action: drop  # Ne pas collecter les mÃ©triques par table
```

---

## Comparaison avec d'autres solutions

### Prometheus/Grafana vs Solutions propriÃ©taires

| CritÃ¨re | Prometheus/Grafana | Datadog | New Relic | CloudWatch |
|---------|-------------------|---------|-----------|------------|
| **CoÃ»t** | Gratuit | $15-$23/host/mois | $25+/host/mois | Pay-as-you-go |
| **Setup** | Manuel, complet | Simple, agent | Simple, agent | Automatique (AWS) |
| **FlexibilitÃ©** | TrÃ¨s Ã©levÃ©e | Moyenne | Moyenne | Faible |
| **On-premise** | Oui | Non | Non | Non (AWS only) |
| **CommunautÃ©** | TrÃ¨s active | SupportÃ©e | SupportÃ©e | AWS |
| **Alerting** | AvancÃ© | AvancÃ© | AvancÃ© | Basique |
| **RÃ©tention** | Configurable | 15 mois | Variable | 15 mois |

**Quand choisir Prometheus/Grafana** :
- âœ… Budget limitÃ© (open-source)
- âœ… On-premise ou multi-cloud
- âœ… Besoin de contrÃ´le total
- âœ… Ã‰quipe technique capable de maintenir

**Quand choisir une solution propriÃ©taire** :
- âœ… Budget disponible
- âœ… Ã‰quipe petite, besoin de simplicitÃ©
- âœ… Besoin d'APM intÃ©grÃ© (traÃ§age distribuÃ©)
- âœ… Support 24/7 requis

### Prometheus vs InfluxDB

| CritÃ¨re | Prometheus | InfluxDB |
|---------|-----------|----------|
| **ModÃ¨le** | Pull (scraping) | Push (agents) |
| **Stockage** | Time-series optimisÃ© | Time-series avec SQL |
| **RequÃªtes** | PromQL | InfluxQL, Flux |
| **Clustering** | FÃ©dÃ©ration | Natif (InfluxDB Enterprise) |
| **Cas d'usage** | Monitoring infra/apps | IoT, analytics temps rÃ©el |

---

## Ressources et formation

### Documentation officielle

- **Prometheus** : https://prometheus.io/docs/
- **Grafana** : https://grafana.com/docs/
- **postgres_exporter** : https://github.com/prometheus-community/postgres_exporter

### Dashboards communautaires

- **Grafana Dashboard Library** : https://grafana.com/grafana/dashboards/
- **PostgreSQL Dashboard #9628** : Le plus populaire
- **PostgreSQL Performance #12906** : Focus performance

### Formations recommandÃ©es

**Gratuites** :
- "Prometheus Monitoring" - Udemy (introductif)
- "Grafana Fundamentals" - Grafana Labs (officiel)
- YouTube : "TechWorld with Nana" (excellentes vidÃ©os)

**Payantes** :
- "Prometheus & Grafana" - Udemy (~â‚¬50)
- "Monitoring with Prometheus" - Linux Foundation
- Certification "Grafana Certified Associate"

### CommunautÃ©s

- **CNCF Slack** : #prometheus, #grafana
- **Reddit** : r/prometheusmonitoring, r/grafana
- **Stack Overflow** : Tags [prometheus], [grafana], [postgres-exporter]
- **PostgreSQL France** : Forums et rencontres

---

## Conclusion

### Ce qu'il faut retenir

La stack **Prometheus + postgres_exporter + Grafana** est la solution de monitoring moderne pour PostgreSQL :

- âœ… **Open-source** et gratuite
- âœ… **Industrie-standard** (CNCF, utilisÃ©e par les gÃ©ants tech)
- âœ… **Puissante** : MÃ©triques dÃ©taillÃ©es, alerting avancÃ©
- âœ… **Flexible** : Dashboards personnalisables, intÃ©grations multiples
- âœ… **Scalable** : Du petit projet Ã  l'entreprise

**Workflow complet** :
```
1. postgres_exporter collecte les mÃ©triques PostgreSQL
   â†“
2. Prometheus stocke ces mÃ©triques (time-series DB)
   â†“
3. Grafana visualise via dashboards interactifs
   â†“
4. Alertes envoyÃ©es automatiquement (Slack, email...)
   â†“
5. Ã‰quipe informÃ©e AVANT les incidents majeurs
```

### Checklist de mise en production

**Infrastructure** :
- [ ] Prometheus installÃ© et configurÃ©
- [ ] postgres_exporter dÃ©ployÃ© avec user dÃ©diÃ©
- [ ] Grafana accessible et sÃ©curisÃ© (HTTPS)
- [ ] RÃ©tention configurÃ©e (disque, performance)

**Monitoring** :
- [ ] Dashboards PostgreSQL importÃ©s et personnalisÃ©s
- [ ] Variables configurÃ©es (environment, instance)
- [ ] MÃ©triques clÃ©s vÃ©rifiÃ©es (pg_up, connections, cache hit ratio)

**Alerting** :
- [ ] Canaux de notification configurÃ©s (Slack, email)
- [ ] Alertes critiques dÃ©finies (PostgreSQL Down, High connections)
- [ ] Alertes de performance (Low cache, High bloat)
- [ ] Tests d'alertes effectuÃ©s

**SÃ©curitÃ©** :
- [ ] Authentification activÃ©e sur tous les services
- [ ] Permissions PostgreSQL minimales (pg_monitor)
- [ ] Reverse proxy configurÃ© (Nginx)
- [ ] SSL/TLS activÃ©

**Documentation** :
- [ ] Runbooks crÃ©Ã©s pour chaque alerte
- [ ] Annotations ajoutÃ©es aux panels
- [ ] Dashboards versionnÃ©s dans Git
- [ ] Ã‰quipe formÃ©e Ã  l'utilisation

### Prochaines Ã©tapes

AprÃ¨s avoir maÃ®trisÃ© cette stack, vous pouvez explorer :

1. **Prometheus Alertmanager** : Routage avancÃ© des alertes
2. **Thanos** : Stockage long terme et haute disponibilitÃ© pour Prometheus
3. **Loki** : AgrÃ©gation de logs (complÃ©ment parfait)
4. **Tempo** : TraÃ§age distribuÃ© (APM)
5. **Service Mesh** : Istio/Linkerd pour monitoring microservices

**La stack Prometheus/Grafana transforme votre monitoring rÃ©actif en monitoring proactif.** Vous dÃ©tectez les problÃ¨mes avant qu'ils n'impactent vos utilisateurs.

---

## Glossaire

| Terme | DÃ©finition |
|-------|------------|
| **Scraping** | Action de collecter les mÃ©triques par pull HTTP |
| **Target** | Source de mÃ©triques (endpoint HTTP) |
| **TSDB** | Time-Series Database (base de donnÃ©es temporelle) |
| **PromQL** | Prometheus Query Language (langage de requÃªte) |
| **Exporter** | Agent qui expose des mÃ©triques au format Prometheus |
| **Data source** | Source de donnÃ©es dans Grafana (Prometheus, InfluxDB...) |
| **Panel** | Widget individuel dans un dashboard Grafana |
| **Dashboard** | Tableau de bord composÃ© de plusieurs panels |
| **SLO** | Service Level Objective (objectif de niveau de service) |
| **SLI** | Service Level Indicator (indicateur de niveau de service) |
| **Gauge** | MÃ©trique qui peut monter et descendre |
| **Counter** | MÃ©trique qui ne fait qu'augmenter |
| **Histogram** | Distribution de valeurs dans des buckets |
| **Recording rule** | PrÃ©-calcul de requÃªtes PromQL complexes |
| **Alertmanager** | Composant Prometheus pour le routage des alertes |

---


â­ï¸ [Solutions cloud natives (CloudWatch, Azure Monitor, GCP)](/14-observabilite-et-monitoring/07.4-solutions-cloud-natives.md)
