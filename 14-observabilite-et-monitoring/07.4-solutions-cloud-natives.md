ğŸ” Retour au [Sommaire](/SOMMAIRE.md)

# 14.7.4. Solutions cloud natives (CloudWatch, Azure Monitor, GCP)

## Introduction

Lorsque vous hÃ©bergez PostgreSQL dans le cloud (AWS, Azure ou Google Cloud), vous avez accÃ¨s Ã  des **solutions de monitoring intÃ©grÃ©es** fournies directement par les fournisseurs cloud. Ces solutions sont **cloud-natives** : elles sont conÃ§ues pour s'intÃ©grer naturellement avec l'infrastructure cloud et les services managÃ©s.

### Cloud-native vs Self-hosted

**Monitoring self-hosted** (comme Prometheus/Grafana) :
```
Vous installez et gÃ©rez :
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Votre infrastructure               â”‚
â”‚  â€¢ Serveurs de monitoring           â”‚
â”‚  â€¢ Configuration manuelle           â”‚
â”‚  â€¢ Maintenance et mises Ã  jour      â”‚
â”‚  â€¢ SÃ©curitÃ© Ã  gÃ©rer                 â”‚
â”‚  â€¢ ScalabilitÃ© Ã  planifier          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Monitoring cloud-native** :
```
Le cloud provider gÃ¨re pour vous :
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Service managÃ©                     â”‚
â”‚  â€¢ Aucun serveur Ã  provisionner     â”‚
â”‚  â€¢ IntÃ©gration automatique          â”‚
â”‚  â€¢ Mises Ã  jour transparentes       â”‚
â”‚  â€¢ SÃ©curitÃ© incluse                 â”‚
â”‚  â€¢ Scaling automatique              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Pourquoi utiliser les solutions cloud natives ?

**Avantages** :
- âœ… **IntÃ©gration native** : MÃ©triques PostgreSQL automatiquement collectÃ©es
- âœ… **ZÃ©ro infrastructure** : Pas de serveurs de monitoring Ã  gÃ©rer
- âœ… **DÃ©marrage rapide** : OpÃ©rationnel en quelques clics
- âœ… **ScalabilitÃ© automatique** : GÃ¨re des millions de mÃ©triques
- âœ… **SÃ©curitÃ© intÃ©grÃ©e** : IAM, encryption, audit logs
- âœ… **Ã‰cosystÃ¨me complet** : Logs, mÃ©triques, traces au mÃªme endroit

**InconvÃ©nients** :
- âš ï¸ **CoÃ»t** : GÃ©nÃ©ralement plus cher qu'une solution self-hosted
- âš ï¸ **Vendor lock-in** : DÃ©pendance au fournisseur cloud
- âš ï¸ **Moins de flexibilitÃ©** : FonctionnalitÃ©s prÃ©-dÃ©finies
- âš ï¸ **DonnÃ©es dans le cloud** : Pas de contrÃ´le total sur l'hÃ©bergement

### Les trois grandes solutions

| Fournisseur | Service principal | Lancement | Force principale |
|-------------|-------------------|-----------|------------------|
| **AWS** | CloudWatch | 2009 | Ã‰cosystÃ¨me AWS riche |
| **Azure** | Azure Monitor | 2014 | IntÃ©gration Microsoft |
| **Google Cloud** | Cloud Monitoring | 2014 | Analytics avancÃ©s |

---

## AWS CloudWatch

### PrÃ©sentation

**Amazon CloudWatch** est le service de monitoring et d'observabilitÃ© d'AWS, intÃ©grÃ© Ã  tous les services AWS, y compris Amazon RDS PostgreSQL et Aurora PostgreSQL.

### Architecture CloudWatch pour PostgreSQL

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Utilisateur / Ã‰quipe                  â”‚
â”‚                    (Console AWS)                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â”‚ AccÃ¨s via Console / API
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   AWS CloudWatch                         â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚   Metrics    â”‚  â”‚     Logs     â”‚  â”‚   Alarms     â”‚    â”‚
â”‚  â”‚  (MÃ©triques) â”‚  â”‚ (Journaux)   â”‚  â”‚  (Alertes)   â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Dashboards  â”‚  â”‚   Insights   â”‚  â”‚  Events      â”‚    â”‚
â”‚  â”‚ (Tableaux)   â”‚  â”‚ (Analytics)  â”‚  â”‚ (EventBridge)â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â”‚ Collecte automatique
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Amazon RDS PostgreSQL / Aurora PostgreSQL        â”‚
â”‚                                                          â”‚
â”‚  â€¢ MÃ©triques systÃ¨me (CPU, RAM, I/O)                     â”‚
â”‚  â€¢ MÃ©triques PostgreSQL (connexions, transactions)       â”‚
â”‚  â€¢ Logs PostgreSQL (postgresql.log)                      â”‚
â”‚  â€¢ Enhanced Monitoring (mÃ©triques OS dÃ©taillÃ©es)         â”‚
â”‚  â€¢ Performance Insights (analyse des requÃªtes)           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### MÃ©triques CloudWatch pour RDS PostgreSQL

#### MÃ©triques standard (incluses gratuitement)

CloudWatch collecte automatiquement des mÃ©triques toutes les **1 minute** pour RDS :

**MÃ©triques CPU et mÃ©moire** :

| MÃ©trique | Description | UnitÃ© | Seuil recommandÃ© |
|----------|-------------|-------|------------------|
| `CPUUtilization` | Utilisation CPU | Pourcentage | < 80% |
| `FreeableMemory` | MÃ©moire disponible | Bytes | > 512MB |
| `SwapUsage` | Utilisation du swap | Bytes | 0 (idÃ©alement) |

**MÃ©triques stockage** :

| MÃ©trique | Description | UnitÃ© | Seuil recommandÃ© |
|----------|-------------|-------|------------------|
| `FreeStorageSpace` | Espace disque disponible | Bytes | > 20% |
| `ReadIOPS` | OpÃ©rations I/O lecture | Count/sec | Surveiller tendances |
| `WriteIOPS` | OpÃ©rations I/O Ã©criture | Count/sec | Surveiller tendances |
| `ReadLatency` | Latence de lecture | Secondes | < 10ms |
| `WriteLatency` | Latence d'Ã©criture | Secondes | < 10ms |
| `ReadThroughput` | DÃ©bit de lecture | Bytes/sec | - |
| `WriteThroughput` | DÃ©bit d'Ã©criture | Bytes/sec | - |

**MÃ©triques rÃ©seau** :

| MÃ©trique | Description | UnitÃ© |
|----------|-------------|-------|
| `NetworkReceiveThroughput` | Trafic entrant | Bytes/sec |
| `NetworkTransmitThroughput` | Trafic sortant | Bytes/sec |

**MÃ©triques PostgreSQL spÃ©cifiques** :

| MÃ©trique | Description | UnitÃ© | Seuil recommandÃ© |
|----------|-------------|-------|------------------|
| `DatabaseConnections` | Nombre de connexions | Count | < 80% de max_connections |
| `TransactionLogsDiskUsage` | Espace WAL utilisÃ© | MB | < 50% de l'espace |
| `MaximumUsedTransactionIDs` | Transaction IDs utilisÃ©s | Count | Surveiller wraparound |
| `OldestReplicationSlotLag` | Retard du slot de rÃ©plication le plus ancien | MB | < 10GB |

#### Enhanced Monitoring (mÃ©triques avancÃ©es)

**Enhanced Monitoring** fournit des mÃ©triques au niveau systÃ¨me d'exploitation avec une granularitÃ© jusqu'Ã  **1 seconde**.

**MÃ©triques supplÃ©mentaires** :
- Utilisation CPU par processus
- MÃ©moire dÃ©taillÃ©e (active, inactive, buffers, cached)
- I/O par device
- Statistiques systÃ¨me (load average, tasks, swap)
- Liste des processus actifs

**Activation** :
```bash
# Via AWS CLI
aws rds modify-db-instance \
  --db-instance-identifier my-postgres-instance \
  --monitoring-interval 60 \
  --monitoring-role-arn arn:aws:iam::123456789012:role/rds-monitoring-role
```

**CoÃ»t** : Enhanced Monitoring est facturÃ© sÃ©parÃ©ment (~$2.50/mois par instance pour un intervalle de 60s).

### Performance Insights

**Performance Insights** est un outil AWS spÃ©cialement conÃ§u pour l'analyse des performances des bases de donnÃ©es.

**FonctionnalitÃ©s** :
- ğŸ“Š **Dashboard temps rÃ©el** : Visualisation de la charge base de donnÃ©es
- ğŸ” **Top SQL queries** : RequÃªtes les plus consommatrices
- â±ï¸ **Wait events** : Analyse des Ã©vÃ©nements d'attente
- ğŸ“ˆ **MÃ©triques historiques** : RÃ©tention jusqu'Ã  2 ans (avec coÃ»t)
- ğŸ¯ **Analyse des dimensions** : Par utilisateur, host, base de donnÃ©es

**MÃ©triques clÃ©s** :
- **DB Load** : Charge active moyenne de la base (Average Active Sessions)
- **Top SQL** : Les requÃªtes triÃ©es par temps total, appels, latence
- **Wait events** : CPU, I/O, locks, network

**Activation** :
```bash
aws rds modify-db-instance \
  --db-instance-identifier my-postgres-instance \
  --enable-performance-insights \
  --performance-insights-retention-period 7  # Jours (7 gratuit, jusqu'Ã  731 payant)
```

**CoÃ»t** :
- 7 jours de rÃ©tention : **Gratuit**
- RÃ©tention longue (jusqu'Ã  2 ans) : ~$0.02/vCPU/heure

### CloudWatch Logs Insights

**CloudWatch Logs Insights** permet d'analyser les logs PostgreSQL avec un langage de requÃªte puissant.

**Exemples de requÃªtes** :

**1. RequÃªtes lentes** :
```
fields @timestamp, @message
| filter @message like /duration: [0-9]{4,}/
| parse @message /duration: (?<duration>[0-9]+)/
| sort duration desc
| limit 20
```

**2. Erreurs les plus frÃ©quentes** :
```
fields @timestamp, @message
| filter @message like /ERROR/
| stats count() by @message
| sort count desc
| limit 10
```

**3. Connexions par base** :
```
fields @timestamp, @message
| filter @message like /connection received/
| parse @message /database=(?<database>[^ ]+)/
| stats count() by database
```

### CloudWatch Dashboards

**CrÃ©er un dashboard personnalisÃ©** :

**Via la console AWS** :
1. CloudWatch â†’ Dashboards â†’ Create dashboard
2. Add widget â†’ Line, Number, Gauge, etc.
3. SÃ©lectionner les mÃ©triques RDS
4. Configurer les pÃ©riodes et statistiques

**Widgets typiques pour PostgreSQL** :

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            PostgreSQL RDS Dashboard                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚  [45%] CPU    [2.5GB] Free Memory    [â—] Status: UP     â”‚
â”‚                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚        Database Connections                       â”‚  â”‚
â”‚  â”‚   â•±â”€â”€â”€â”€â”€â”€â”€â”€â•²                                      â”‚  â”‚
â”‚  â”‚  â•±          â•²                    â•±â”€â”€â”€â•²            â”‚  â”‚
â”‚  â”‚â”€â•±â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•²â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•±â”€â”€â”€â”€â”€â•²â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚  ReadIOPS        â”‚    â”‚  WriteIOPS       â”‚           â”‚
â”‚  â”‚  1,250/sec       â”‚    â”‚  850/sec         â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚        Storage Space (GB)                        â”‚   â”‚
â”‚  â”‚  â–“â–“â–“â–“â–“â–“â–“â–“â–“â–‘â–‘â–‘â–‘â–‘â–‘  Used: 350GB / 500GB            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### CloudWatch Alarms

**CrÃ©er une alarme** :

**Exemple 1 : CPU Ã©levÃ©**
```bash
aws cloudwatch put-metric-alarm \
  --alarm-name high-cpu-alarm \
  --alarm-description "CPU > 80% for 5 minutes" \
  --metric-name CPUUtilization \
  --namespace AWS/RDS \
  --statistic Average \
  --period 300 \
  --threshold 80 \
  --comparison-operator GreaterThanThreshold \
  --evaluation-periods 1 \
  --dimensions Name=DBInstanceIdentifier,Value=my-postgres-instance \
  --alarm-actions arn:aws:sns:us-east-1:123456789012:my-sns-topic
```

**Exemple 2 : Espace disque faible**
```bash
aws cloudwatch put-metric-alarm \
  --alarm-name low-storage-alarm \
  --metric-name FreeStorageSpace \
  --namespace AWS/RDS \
  --statistic Average \
  --period 300 \
  --threshold 10737418240 \  # 10GB
  --comparison-operator LessThanThreshold \
  --evaluation-periods 1 \
  --dimensions Name=DBInstanceIdentifier,Value=my-postgres-instance
```

**Actions possibles** :
- ğŸ“§ **SNS Topic** : Envoyer email/SMS
- ğŸ”” **Lambda** : ExÃ©cuter une fonction (ex: scale automatique)
- ğŸ“± **Systems Manager** : ExÃ©cuter un runbook
- ğŸš¨ **Auto Scaling** : Augmenter les ressources

### CoÃ»ts CloudWatch

**MÃ©triques** :
- MÃ©triques standard RDS : **Gratuites**
- MÃ©triques personnalisÃ©es : $0.30/mÃ©trique/mois (premiers 10k)
- API GetMetricData : $0.01 / 1000 requÃªtes

**Logs** :
- Ingestion : $0.50/GB
- Stockage : $0.03/GB/mois
- Logs Insights : $0.005/GB scannÃ©

**Dashboards** :
- 3 premiers dashboards : **Gratuits**
- Dashboards supplÃ©mentaires : $3/dashboard/mois

**Alarms** :
- 10 alarmes standard : **Gratuites**
- Alarmes supplÃ©mentaires : $0.10/alarme/mois
- Alarmes haute rÃ©solution : $0.30/alarme/mois

**Exemple de coÃ»t mensuel** (instance RDS de taille moyenne) :
```
MÃ©triques standard         : Gratuit
Enhanced Monitoring        : $2.50
Performance Insights (7j)  : Gratuit
Logs (10GB/mois)          : $5.30
Dashboards (1 custom)      : Gratuit (dans les 3 premiers)
Alarms (5 alarms)          : Gratuit (dans les 10 premiers)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Total                      : ~$8/mois
```

---

## Azure Monitor

### PrÃ©sentation

**Azure Monitor** est la plateforme unifiÃ©e de monitoring Microsoft, intÃ©grÃ©e Ã  Azure Database for PostgreSQL (single server et flexible server).

### Architecture Azure Monitor pour PostgreSQL

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                Utilisateur / Ã‰quipe                      â”‚
â”‚              (Portail Azure / CLI)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â”‚ AccÃ¨s via Portal / API
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Azure Monitor                          â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   Metrics    â”‚  â”‚     Logs       â”‚  â”‚   Alerts     â”‚  â”‚
â”‚  â”‚              â”‚  â”‚ (Log Analytics)â”‚  â”‚              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Workbooks   â”‚  â”‚   Insights   â”‚  â”‚  Action Groupsâ”‚   â”‚
â”‚  â”‚ (Dashboards) â”‚  â”‚              â”‚  â”‚               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â”‚ Collecte automatique
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Azure Database for PostgreSQL                    â”‚
â”‚         (Single Server / Flexible Server)                â”‚
â”‚                                                          â”‚
â”‚  â€¢ MÃ©triques plateforme (CPU, RAM, I/O)                  â”‚
â”‚  â€¢ MÃ©triques PostgreSQL (connexions, rÃ©plication)        â”‚
â”‚  â€¢ Logs (postgresql.log, slow queries)                   â”‚
â”‚  â€¢ Diagnostic settings                                   â”‚
â”‚  â€¢ Query Performance Insights                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### MÃ©triques Azure Monitor pour PostgreSQL

#### MÃ©triques de plateforme (gratuites)

**MÃ©triques de ressources** :

| MÃ©trique | Description | UnitÃ© | Seuil recommandÃ© |
|----------|-------------|-------|------------------|
| `cpu_percent` | Utilisation CPU | % | < 80% |
| `memory_percent` | Utilisation mÃ©moire | % | < 85% |
| `io_consumption_percent` | Consommation I/O | % | < 80% |
| `storage_percent` | Stockage utilisÃ© | % | < 85% |
| `storage_used` | Stockage utilisÃ© | Bytes | - |
| `storage_limit` | Limite de stockage | Bytes | - |

**MÃ©triques PostgreSQL** :

| MÃ©trique | Description | UnitÃ© |
|----------|-------------|-------|
| `active_connections` | Connexions actives | Count |
| `connections_failed` | Connexions Ã©chouÃ©es | Count |
| `network_bytes_ingress` | RÃ©seau entrant | Bytes |
| `network_bytes_egress` | RÃ©seau sortant | Bytes |
| `backup_storage_used` | Stockage backup utilisÃ© | Bytes |

**MÃ©triques de rÃ©plication** (Flexible Server) :

| MÃ©trique | Description | UnitÃ© |
|----------|-------------|-------|
| `physical_replication_delay_in_seconds` | Retard de rÃ©plication physique | Seconds |
| `physical_replication_delay_in_bytes` | Retard en bytes | Bytes |
| `read_replica_log_delay_in_seconds` | Retard du replica read | Seconds |

### Diagnostic Settings (Logs)

**Activer les logs** :

Via le portail Azure :
1. Azure Database for PostgreSQL â†’ Diagnostic settings
2. Add diagnostic setting
3. SÃ©lectionner les logs Ã  capturer :
   - `PostgreSQLLogs` : Logs PostgreSQL standard
   - `QueryStoreRuntimeStatistics` : Statistiques Query Store
   - `QueryStoreWaitStatistics` : Wait events
4. Destination : Log Analytics workspace, Storage account, ou Event Hub

**Via Azure CLI** :
```bash
az monitor diagnostic-settings create \
  --resource /subscriptions/{subscription-id}/resourceGroups/{rg}/providers/Microsoft.DBforPostgreSQL/servers/{server-name} \
  --name DiagnosticSetting1 \
  --logs '[
    {
      "category": "PostgreSQLLogs",
      "enabled": true
    },
    {
      "category": "QueryStoreRuntimeStatistics",
      "enabled": true
    }
  ]' \
  --workspace {log-analytics-workspace-id}
```

### Query Performance Insights

**Query Performance Insights** (similaire Ã  AWS Performance Insights) analyse les performances des requÃªtes.

**FonctionnalitÃ©s** :
- ğŸ“Š **Top queries** : RequÃªtes les plus consommatrices
- â±ï¸ **Wait statistics** : Analyse des temps d'attente
- ğŸ“ˆ **MÃ©triques historiques** : Jusqu'Ã  7 jours (gratuit)
- ğŸ¯ **Drill-down** : DÃ©tails par requÃªte

**Activation** :
1. Portail Azure â†’ Azure Database for PostgreSQL
2. Intelligent Performance â†’ Query Performance Insight
3. Activer Query Store si ce n'est pas dÃ©jÃ  fait

**Configuration Query Store** :
```sql
-- Configuration dans PostgreSQL
ALTER DATABASE mydb SET pg_qs.query_capture_mode = 'TOP';
ALTER DATABASE mydb SET pgms_wait_sampling.query_capture_mode = 'ALL';
```

### Azure Monitor Workbooks

**Workbooks** sont des dashboards interactifs et personnalisables.

**Templates disponibles** :
- PostgreSQL Performance Monitoring
- Connection Analysis
- Storage and Backup Monitoring
- Replication Monitoring

**CrÃ©er un workbook personnalisÃ©** :

1. Azure Monitor â†’ Workbooks â†’ New
2. Ajouter des Ã©lÃ©ments :
   - **MÃ©triques** : Graphiques de mÃ©triques
   - **Logs** : RequÃªtes KQL (Kusto Query Language)
   - **Texte** : Documentation, instructions
   - **ParamÃ¨tres** : Variables (serveur, base, pÃ©riode)

**Exemple de requÃªte KQL pour les connexions Ã©chouÃ©es** :
```kql
AzureDiagnostics
| where ResourceProvider == "MICROSOFT.DBFORPOSTGRESQL"
| where Category == "PostgreSQLLogs"
| where Message contains "connection"
| where Message contains "failed"
| summarize FailedConnections = count() by bin(TimeGenerated, 5m)
| render timechart
```

### Azure Alerts

**CrÃ©er une alerte sur mÃ©trique** :

Via le portail :
1. Azure Database for PostgreSQL â†’ Alerts â†’ New alert rule
2. SÃ©lectionner une condition (ex: CPU > 80%)
3. Configurer la logique :
   - Seuil : 80
   - AgrÃ©gation : Average
   - PÃ©riode : 5 minutes
4. Associer un Action Group (email, SMS, webhook, Logic App)

**Via Azure CLI** :
```bash
# CrÃ©er une rÃ¨gle d'alerte
az monitor metrics alert create \
  --name high-cpu-alert \
  --resource-group myResourceGroup \
  --scopes /subscriptions/{sub-id}/resourceGroups/{rg}/providers/Microsoft.DBforPostgreSQL/servers/{server} \
  --condition "avg cpu_percent > 80" \
  --window-size 5m \
  --evaluation-frequency 1m \
  --action {action-group-id}
```

**Action Groups** :

Actions possibles :
- ğŸ“§ **Email/SMS** : Notification directe
- ğŸ“± **Azure mobile app** : Push notification
- ğŸ”” **Webhook** : Appeler une API externe
- âš¡ **Azure Function** : ExÃ©cuter du code custom
- ğŸ¤– **Logic App** : Workflow d'automatisation
- ğŸ« **ITSM** : CrÃ©er un ticket (ServiceNow, etc.)

### Azure Monitor Logs (KQL)

**Kusto Query Language (KQL)** est le langage de requÃªte d'Azure Monitor.

**Exemples de requÃªtes** :

**1. RequÃªtes lentes** :
```kql
AzureDiagnostics
| where ResourceProvider == "MICROSOFT.DBFORPOSTGRESQL"
| where Category == "PostgreSQLLogs"
| where Message contains "duration:"
| parse Message with * "duration: " Duration:real " ms" *
| where Duration > 1000  // > 1 seconde
| project TimeGenerated, Duration, Message
| order by Duration desc
| take 20
```

**2. Taux d'erreurs par heure** :
```kql
AzureDiagnostics
| where ResourceProvider == "MICROSOFT.DBFORPOSTGRESQL"
| where Category == "PostgreSQLLogs"
| where Level == "ERROR"
| summarize ErrorCount = count() by bin(TimeGenerated, 1h)
| render columnchart
```

**3. Top bases de donnÃ©es par connexions** :
```kql
AzureMetrics
| where ResourceProvider == "MICROSOFT.DBFORPOSTGRESQL"
| where MetricName == "active_connections"
| summarize AvgConnections = avg(Average) by Resource
| order by AvgConnections desc
```

### CoÃ»ts Azure Monitor

**MÃ©triques** :
- MÃ©triques de plateforme : **Gratuites**
- Alertes sur mÃ©triques : $0.10/alerte/mois (aprÃ¨s 10 gratuites)

**Logs** :
- Ingestion : $2.76/GB (5 premiers GB/mois gratuits)
- RÃ©tention 31 jours : Incluse
- RÃ©tention supplÃ©mentaire : $0.12/GB/mois
- RequÃªtes : Incluses

**Workbooks** :
- **Gratuits** (pas de limite)

**Action Groups** :
- Email : **Gratuit**
- SMS : $0.0035/SMS (US)
- Webhook, Azure Function : $0.0002/appel

**Exemple de coÃ»t mensuel** :
```
MÃ©triques                : Gratuit
Logs (5GB/mois)          : Gratuit (dans le tier gratuit)
Logs (10GB supplÃ©mentaires): $27.60
Alertes (5)              : Gratuit (dans les 10 premiÃ¨res)
Action Groups (email)     : Gratuit
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Total                    : ~$28/mois
```

---

## Google Cloud Monitoring (Operations Suite)

### PrÃ©sentation

**Google Cloud Monitoring** (anciennement Stackdriver) fait partie de **Google Cloud Operations Suite**, la plateforme d'observabilitÃ© de Google Cloud.

### Architecture Cloud Monitoring pour PostgreSQL

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                Utilisateur / Ã‰quipe                      â”‚
â”‚              (Console GCP / CLI)                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â”‚ AccÃ¨s via Console / API
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          Google Cloud Operations Suite                   â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Monitoring  â”‚  â”‚   Logging    â”‚  â”‚    Trace     â”‚    â”‚
â”‚  â”‚ (MÃ©triques)  â”‚  â”‚  (Logs)      â”‚  â”‚ (Distributed)â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Dashboards  â”‚  â”‚   Alerting   â”‚  â”‚  Profiler    â”‚    â”‚
â”‚  â”‚              â”‚  â”‚              â”‚  â”‚              â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â”‚ Collecte automatique
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            Cloud SQL for PostgreSQL                      â”‚
â”‚            (ou AlloyDB for PostgreSQL)                   â”‚
â”‚                                                          â”‚
â”‚  â€¢ MÃ©triques systÃ¨me (CPU, RAM, Disk)                    â”‚
â”‚  â€¢ MÃ©triques PostgreSQL (connexions, transactions)       â”‚
â”‚  â€¢ Logs PostgreSQL (postgres.log)                        â”‚
â”‚  â€¢ Query Insights (analyse des requÃªtes)                 â”‚
â”‚  â€¢ Slow query logs                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### MÃ©triques Cloud Monitoring pour PostgreSQL

#### MÃ©triques Cloud SQL (incluses)

**MÃ©triques systÃ¨me** :

| MÃ©trique | Description | UnitÃ© | Seuil recommandÃ© |
|----------|-------------|-------|------------------|
| `database/cpu/utilization` | Utilisation CPU | Ratio (0-1) | < 0.80 |
| `database/memory/utilization` | Utilisation mÃ©moire | Ratio (0-1) | < 0.85 |
| `database/disk/utilization` | Utilisation disque | Ratio (0-1) | < 0.85 |
| `database/disk/read_ops_count` | OpÃ©rations de lecture | Count/sec | - |
| `database/disk/write_ops_count` | OpÃ©rations d'Ã©criture | Count/sec | - |

**MÃ©triques PostgreSQL** :

| MÃ©trique | Description | UnitÃ© |
|----------|-------------|-------|
| `database/postgresql/num_backends` | Nombre de connexions | Count |
| `database/postgresql/transaction_count` | Nombre de transactions | Count |
| `database/postgresql/replication/replica_lag` | Retard de rÃ©plication | Secondes |
| `database/postgresql/replication/network_lag` | Retard rÃ©seau de rÃ©plication | Secondes |

**MÃ©triques de performance** :

| MÃ©trique | Description | UnitÃ© |
|----------|-------------|-------|
| `database/network/sent_bytes_count` | Bytes envoyÃ©s | Bytes |
| `database/network/received_bytes_count` | Bytes reÃ§us | Bytes |
| `database/network/connections` | Connexions rÃ©seau | Count |

#### Query Insights (Cloud SQL)

**Query Insights** analyse automatiquement les requÃªtes et fournit des recommandations.

**FonctionnalitÃ©s** :
- ğŸ“Š **Top queries** : Par temps d'exÃ©cution, appels, latence
- ğŸ” **Query plans** : Plans d'exÃ©cution des requÃªtes
- ğŸ’¡ **Recommandations** : Suggestions d'index et d'optimisation
- ğŸ“ˆ **Historique** : Jusqu'Ã  24h (gratuit)

**Activation** :
```bash
# Via gcloud CLI
gcloud sql instances patch INSTANCE_NAME \
  --insights-config-query-insights-enabled \
  --insights-config-query-string-length=1024 \
  --insights-config-record-application-tags \
  --insights-config-record-client-address
```

**AccÃ¨s** :
Console GCP â†’ Cloud SQL â†’ Instance â†’ Query Insights

### Cloud Logging

**Cloud Logging** collecte et analyse les logs PostgreSQL.

**Types de logs disponibles** :
- `cloudsql.googleapis.com/postgres.log` : Logs PostgreSQL standard
- `cloudsql.googleapis.com/cloudsql_error.log` : Erreurs Cloud SQL
- `cloudsql.googleapis.com/cloudsql_access.log` : AccÃ¨s et connexions

**Configuration des logs PostgreSQL** :
```bash
gcloud sql instances patch INSTANCE_NAME \
  --database-flags log_min_duration_statement=1000,log_connections=on,log_disconnections=on
```

**RequÃªtes Log Explorer** :

**1. RequÃªtes lentes** :
```
resource.type="cloudsql_database"
resource.labels.database_id="PROJECT:INSTANCE"
textPayload=~"duration: [0-9]{4,}"
```

**2. Erreurs de connexion** :
```
resource.type="cloudsql_database"
severity="ERROR"
textPayload=~"connection.*failed"
```

**3. Analyse des deadlocks** :
```
resource.type="cloudsql_database"
textPayload=~"deadlock detected"
```

### Cloud Monitoring Dashboards

**CrÃ©er un dashboard personnalisÃ©** :

Via la console :
1. Monitoring â†’ Dashboards â†’ Create Dashboard
2. Add Chart (line, stacked area, stacked bar, etc.)
3. SÃ©lectionner la ressource : Cloud SQL
4. Choisir les mÃ©triques
5. Configurer les filtres et agrÃ©gations

**Exemple de configuration pour connexions actives** :
```
Resource type: Cloud SQL Database
Metric: database/postgresql/num_backends
Filter: instance_id = "my-postgres-instance"
Aggregation: mean
Aligner: ALIGN_MEAN
```

**Dashboard typique** :

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Cloud SQL PostgreSQL Dashboard                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚  CPU: 45%    Memory: 72%    Disk: 68%    Status: â—      â”‚
â”‚                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚      Transactions per Second                       â”‚ â”‚
â”‚  â”‚                                                    â”‚ â”‚
â”‚  â”‚      â•±â”€â”€â•²        â•±â”€â”€â•²                              â”‚ â”‚
â”‚  â”‚     â•±    â•²      â•±    â•²      â•±â”€â”€â•²                   â”‚ â”‚
â”‚  â”‚â”€â”€â”€â”€â•±â”€â”€â”€â”€â”€â”€â•²â”€â”€â”€â”€â•±â”€â”€â”€â”€â”€â”€â•²â”€â”€â”€â”€â•±â”€â”€â”€â”€â•²â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚  Connections     â”‚    â”‚  Replica Lag     â”‚           â”‚
â”‚  â”‚  â—â—â—â—â—â—â—‹â—‹â—‹â—‹      â”‚    â”‚  2.3 seconds     â”‚           â”‚
â”‚  â”‚  120 / 200       â”‚    â”‚                  â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Cloud Monitoring Alerts

**CrÃ©er une politique d'alerte** :

Via la console :
1. Monitoring â†’ Alerting â†’ Create Policy
2. Add Condition :
   - Ressource : Cloud SQL Database
   - MÃ©trique : Ex: `database/cpu/utilization`
   - Condition : Above threshold
   - Seuil : 0.80 (80%)
   - DurÃ©e : 5 minutes
3. Configurer les notifications :
   - Email
   - SMS
   - Slack
   - PagerDuty
   - Webhook

**Via gcloud CLI** :
```bash
# CrÃ©er une politique d'alerte
gcloud alpha monitoring policies create \
  --notification-channels=CHANNEL_ID \
  --display-name="High CPU Alert" \
  --condition-display-name="CPU > 80%" \
  --condition-threshold-value=0.80 \
  --condition-threshold-duration=300s \
  --condition-metric="cloudsql.googleapis.com/database/cpu/utilization" \
  --condition-filter='resource.type="cloudsql_database" AND resource.labels.database_id="PROJECT:INSTANCE"'
```

**Canaux de notification disponibles** :
- ğŸ“§ Email
- ğŸ“± SMS
- ğŸ’¬ Slack
- ğŸš¨ PagerDuty
- ğŸ“ Webhooks
- ğŸ“Š Pub/Sub (pour automatisation)
- ğŸ“± Mobile app

### MQL (Monitoring Query Language)

**MQL** est le langage de requÃªte avancÃ© de Google Cloud Monitoring, similaire Ã  PromQL.

**Exemples de requÃªtes MQL** :

**1. Taux de connexions** :
```
fetch cloudsql_database
| metric 'cloudsql.googleapis.com/database/postgresql/num_backends'
| group_by 1m, [value_num_backends_mean: mean(value.num_backends)]
| every 1m
```

**2. Utilisation CPU avec seuil** :
```
fetch cloudsql_database
| metric 'cloudsql.googleapis.com/database/cpu/utilization'
| filter resource.database_id == 'my-project:my-instance'
| group_by 5m, [value_utilization_mean: mean(value.utilization)]
| condition value_utilization_mean > 0.80
```

**3. Comparaison avec semaine prÃ©cÃ©dente** :
```
fetch cloudsql_database
| metric 'cloudsql.googleapis.com/database/postgresql/transaction_count'
| align rate(1m)
| group_by [resource.database_id], [value: sum(value)]
| outer_join 0,
  (fetch cloudsql_database
   | metric 'cloudsql.googleapis.com/database/postgresql/transaction_count'
   | align rate(1m)
   | group_by [resource.database_id], [value: sum(value)]
   | time_shift(7d))
```

### IntÃ©gration avec AlloyDB

**AlloyDB** est la base PostgreSQL managÃ©e nouvelle gÃ©nÃ©ration de Google.

**MÃ©triques supplÃ©mentaires AlloyDB** :
- `alloydb.googleapis.com/database/transaction_count`
- `alloydb.googleapis.com/database/query_count`
- `alloydb.googleapis.com/database/insights/perquery/execution_time`
- `alloydb.googleapis.com/database/insights/perquery/row_count`

**Avantages AlloyDB** :
- Performances 4Ã— supÃ©rieures Ã  Cloud SQL standard
- CompatibilitÃ© 100% PostgreSQL
- Analytics intÃ©grÃ©s (sans ETL)
- MÃ©triques plus dÃ©taillÃ©es

### CoÃ»ts Cloud Monitoring

**MÃ©triques** :
- 150 premiers MB/mois : **Gratuits** (ingestion)
- Au-delÃ  : $0.2580/MB (150-100k MB)
- RÃ©tention 6 semaines : Incluse

**Logs** :
- 50 premiers GB/mois/projet : **Gratuits**
- Au-delÃ  : $0.50/GB
- RÃ©tention 30 jours : Incluse
- RÃ©tention Ã©tendue : $0.01/GB/mois

**Alertes** :
- **Gratuites** (pas de limite)

**Dashboards** :
- **Gratuits** (pas de limite)

**Exemple de coÃ»t mensuel** :
```
MÃ©triques (50MB)         : Gratuit
Logs (30GB/mois)         : Gratuit (dans les 50GB gratuits)
Alertes                  : Gratuit
Dashboards               : Gratuit
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Total                    : $0/mois ğŸ‰
```

**Note** : Google Cloud a l'un des tiers gratuits les plus gÃ©nÃ©reux pour le monitoring.

---

## Comparaison des trois solutions

### Tableau comparatif global

| CritÃ¨re | AWS CloudWatch | Azure Monitor | GCP Cloud Monitoring |
|---------|---------------|---------------|---------------------|
| **FacilitÃ© d'utilisation** | â­â­â­ Moyenne | â­â­â­â­ Bonne | â­â­â­â­â­ Excellente |
| **IntÃ©gration native** | â­â­â­â­â­ Excellente | â­â­â­â­â­ Excellente | â­â­â­â­â­ Excellente |
| **Richesse des mÃ©triques** | â­â­â­â­ TrÃ¨s bon | â­â­â­â­ TrÃ¨s bon | â­â­â­â­ TrÃ¨s bon |
| **Langage de requÃªte** | â­â­â­ Basique | â­â­â­â­â­ KQL puissant | â­â­â­â­â­ MQL puissant |
| **Visualisation** | â­â­â­ Correcte | â­â­â­â­ Workbooks | â­â­â­â­ Dashboards |
| **Alerting** | â­â­â­â­ TrÃ¨s bon | â­â­â­â­ TrÃ¨s bon | â­â­â­â­ TrÃ¨s bon |
| **CoÃ»t** | â­â­â­ Moyen | â­â­ Ã‰levÃ© | â­â­â­â­â­ GÃ©nÃ©reux tier gratuit |
| **Documentation** | â­â­â­â­ TrÃ¨s bonne | â­â­â­â­ TrÃ¨s bonne | â­â­â­â­â­ Excellente |
| **CommunautÃ©** | â­â­â­â­â­ La plus grande | â­â­â­â­ Grande | â­â­â­ Moyenne |

### Comparaison des fonctionnalitÃ©s

| FonctionnalitÃ© | AWS | Azure | GCP |
|---------------|-----|-------|-----|
| **MÃ©triques standard** | âœ… Oui | âœ… Oui | âœ… Oui |
| **MÃ©triques avancÃ©es** | âœ… Enhanced Monitoring ($) | âœ… Diagnostic Settings | âœ… Inclus |
| **Analyse de requÃªtes** | âœ… Performance Insights (7j gratuit) | âœ… Query Performance Insights | âœ… Query Insights |
| **Logs structurÃ©s** | âœ… CloudWatch Logs Insights | âœ… Log Analytics (KQL) | âœ… Cloud Logging |
| **Dashboards** | âœ… CloudWatch Dashboards | âœ… Workbooks | âœ… Cloud Monitoring Dashboards |
| **Alerting avancÃ©** | âœ… Composite alarms, Anomaly detection | âœ… Smart detection, Action Groups | âœ… Alerting policies, Incident management |
| **RÃ©tention longue** | âœ… Jusqu'Ã  15 mois (mÃ©triques haute rÃ©solution) | âœ… Log Analytics retention | âœ… Jusqu'Ã  6 semaines (mÃ©triques) |
| **TraÃ§age distribuÃ©** | âœ… X-Ray | âœ… Application Insights | âœ… Cloud Trace |
| **APM intÃ©grÃ©** | âš ï¸ X-Ray sÃ©parÃ© | âœ… Application Insights | âœ… Cloud Profiler |

### Comparaison des coÃ»ts

**ScÃ©nario** : Instance PostgreSQL moyenne avec :
- 10 mÃ©triques personnalisÃ©es
- 20GB de logs/mois
- 5 dashboards
- 10 alertes

| Composant | AWS CloudWatch | Azure Monitor | GCP Cloud Monitoring |
|-----------|---------------|---------------|---------------------|
| MÃ©triques standard | Gratuit | Gratuit | Gratuit |
| MÃ©triques personnalisÃ©es (10) | $3.00 | Inclus (via logs) | Gratuit (dans tier) |
| Logs (20GB) | $10.60 | $2.76 (premiers 5GB) + $41.40 | Gratuit (< 50GB) |
| Dashboards (5) | $6.00 (2 payants) | Gratuit | Gratuit |
| Alertes (10) | Gratuit | Gratuit | Gratuit |
| Performance Insights | Gratuit (7j) | Inclus | Gratuit |
| **Total/mois** | **~$20** | **~$44** | **$0** |

**Note** : Les coÃ»ts varient selon l'utilisation rÃ©elle et les rÃ©gions.

### Quand choisir quelle solution ?

#### Choisir AWS CloudWatch si :
- âœ… Vous Ãªtes dÃ©jÃ  sur AWS (RDS, Aurora)
- âœ… Vous avez besoin de Performance Insights avancÃ©
- âœ… Vous utilisez beaucoup d'autres services AWS
- âœ… Vous avez besoin de CloudWatch Anomaly Detection

#### Choisir Azure Monitor si :
- âœ… Vous Ãªtes sur Azure (Azure Database for PostgreSQL)
- âœ… Vous aimez les Workbooks (trÃ¨s personnalisables)
- âœ… Vous avez besoin de KQL (langage puissant)
- âœ… Vous utilisez l'Ã©cosystÃ¨me Microsoft (.NET, etc.)

#### Choisir GCP Cloud Monitoring si :
- âœ… Vous Ãªtes sur Google Cloud (Cloud SQL, AlloyDB)
- âœ… Vous cherchez le meilleur rapport qualitÃ©/prix
- âœ… Vous apprÃ©ciez l'interface Ã©purÃ©e de GCP
- âœ… Vous voulez MQL (similaire Ã  PromQL)
- âœ… Vous avez un budget limitÃ© (tier gratuit gÃ©nÃ©reux)

---

## Migration et stratÃ©gies multi-cloud

### Migration d'une solution self-hosted vers le cloud

**Ã‰tapes** :

1. **Ã‰valuation** :
   - Identifier les mÃ©triques actuellement collectÃ©es
   - Lister les dashboards existants
   - Inventorier les alertes configurÃ©es

2. **Mapping** :
   - Mapper les mÃ©triques Prometheus â†’ MÃ©triques cloud natives
   - Identifier les gaps (mÃ©triques manquantes)
   - PrÃ©voir les mÃ©triques personnalisÃ©es nÃ©cessaires

3. **Migration progressive** :
   ```
   Phase 1: Collecte en parallÃ¨le (Prometheus + Cloud native)
   â†“
   Phase 2: Validation des donnÃ©es (comparaison)
   â†“
   Phase 3: Migration des dashboards un par un
   â†“
   Phase 4: Migration des alertes
   â†“
   Phase 5: DÃ©sactivation de Prometheus
   ```

4. **Formation** :
   - Former l'Ã©quipe aux nouveaux outils
   - CrÃ©er de la documentation interne
   - Ã‰tablir de nouveaux runbooks

### StratÃ©gie multi-cloud

**ScÃ©nario** : Vous utilisez plusieurs clouds (AWS + Azure, ou AWS + GCP).

**Options** :

#### Option 1 : Monitoring natif par cloud
```
AWS RDS â†’ CloudWatch
Azure PostgreSQL â†’ Azure Monitor
GCP Cloud SQL â†’ Cloud Monitoring

InconvÃ©nient: Pas de vue unifiÃ©e
```

#### Option 2 : Hub centralisÃ© (Grafana)
```
                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚   Grafana    â”‚
                 â”‚  (Central)   â”‚
                 â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚              â”‚              â”‚
    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
    â”‚CloudWatchâ”‚   â”‚Azure Monâ”‚   â”‚GCP Mon   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚              â”‚              â”‚
    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”
    â”‚AWS RDS  â”‚    â”‚Azure DB â”‚   â”‚Cloud SQL â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Avantage: Vue unifiÃ©e
InconvÃ©nient: Infrastructure Grafana Ã  gÃ©rer
```

#### Option 3 : Solution tierce (Datadog, New Relic)
```
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   Datadog APM    â”‚
        â”‚   (SaaS Tiers)   â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”
         â”‚       â”‚       â”‚
    AWS RDS  Azure DB  Cloud SQL

Avantage: Une seule interface pour tout
InconvÃ©nient: CoÃ»t Ã©levÃ©
```

**Recommandation** :
- **Production critique** : Option 3 (Datadog, New Relic)
- **Multi-cloud lÃ©ger** : Option 2 (Grafana centralisÃ©)
- **Mono-cloud** : Option 1 (Natif)

---

## Bonnes pratiques

### 1. Configuration des logs

**Quoi logger** :

| Niveau | Ã‰vÃ©nements | Environnement |
|--------|-----------|---------------|
| **Minimal** | Erreurs uniquement | Production stable |
| **Standard** | Erreurs + Connexions + RequÃªtes lentes (>1s) | Production typique |
| **DÃ©taillÃ©** | + Toutes les requÃªtes | DÃ©veloppement, Debug |
| **Verbeux** | Tout (attention au volume !) | Troubleshooting ponctuel |

**Configuration PostgreSQL recommandÃ©e** :
```sql
-- Pour RDS/Cloud SQL, via paramÃ¨tres
log_connections = on
log_disconnections = on
log_min_duration_statement = 1000  -- 1 seconde
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '
log_statement = 'ddl'  -- Log des DDL uniquement
```

### 2. Dimensionnement des alertes

**Principe** : Alerter sur ce qui nÃ©cessite une action, pas sur tout.

**Alertes critiques** (notification immÃ©diate, 24/7) :
- Base de donnÃ©es inaccessible
- Espace disque < 10%
- CPU > 90% pendant 10+ minutes
- RÃ©plication en Ã©chec

**Alertes warning** (notification pendant heures de travail) :
- CPU > 80% pendant 30 minutes
- Espace disque < 20%
- Cache hit ratio < 90%
- Connexions > 80% du max

**Alertes info** (pas de notification, dashboard seulement) :
- Tendances Ã  surveiller
- MÃ©triques de capacitÃ©

### 3. Organisation des dashboards

**HiÃ©rarchie recommandÃ©e** :

```
ğŸ“Š PostgreSQL (Dossier principal)
â”œâ”€â”€ ğŸŒ Overview (Vue d'ensemble multi-instances)
â”œâ”€â”€ ğŸ“ˆ Production
â”‚   â”œâ”€â”€ Production-DB-1 (dÃ©taillÃ©)
â”‚   â”œâ”€â”€ Production-DB-2 (dÃ©taillÃ©)
â”‚   â””â”€â”€ Production-Replicas
â”œâ”€â”€ ğŸ§ª Staging
â”‚   â””â”€â”€ Staging-DB
â”œâ”€â”€ ğŸ”§ Development
â”‚   â””â”€â”€ Dev-DBs
â””â”€â”€ ğŸš¨ Alerting Status (Ã©tat des alertes)
```

**Un dashboard = Un objectif** :
- **Overview** : SantÃ© globale, toutes instances
- **Performance** : CPU, I/O, cache, requÃªtes lentes
- **Capacity** : Stockage, connexions, croissance
- **Replication** : Lag, Ã©tat des replicas
- **Troubleshooting** : MÃ©triques dÃ©taillÃ©es pour debug

### 4. RÃ©tention des donnÃ©es

**StratÃ©gie 3-2-1 adaptÃ©e au monitoring** :

```
3 copies de vos mÃ©triques critiques
2 types de stockage diffÃ©rents
1 copie hors du cloud principal
```

**Exemple** :
```
â€¢ MÃ©triques en temps rÃ©el : 7 jours (haute rÃ©solution)
â€¢ MÃ©triques agrÃ©gÃ©es : 90 jours (rÃ©solution 5min)
â€¢ MÃ©triques archivÃ©es : 1 an (rÃ©solution 1h)
â€¢ Export mensuel : Backup hors ligne
```

**Configuration** :

AWS CloudWatch :
```bash
# MÃ©triques standard: 15 mois automatique
# Logs: Configurer la rÃ©tention
aws logs put-retention-policy \
  --log-group-name /aws/rds/instance/my-postgres/postgresql \
  --retention-in-days 90
```

Azure Monitor :
```bash
# Log Analytics workspace retention
az monitor log-analytics workspace update \
  --resource-group myResourceGroup \
  --workspace-name myWorkspace \
  --retention-time 90
```

GCP :
```bash
# Cloud Logging retention
gcloud logging sinks create my-export-sink \
  storage.googleapis.com/my-log-bucket \
  --log-filter='resource.type="cloudsql_database"'
```

### 5. CoÃ»ts et optimisation

**StratÃ©gies pour rÃ©duire les coÃ»ts** :

1. **Filtrer les logs inutiles** :
   ```
   # Ne pas logger les requÃªtes SELECT simples
   log_min_duration_statement = 1000
   log_statement = 'ddl'  # Pas 'all'
   ```

2. **AgrÃ©ger les mÃ©triques** :
   - Haute rÃ©solution (1min) : 7 jours seulement
   - RÃ©solution normale (5min) : 30 jours
   - AgrÃ©gations (1h) : 1 an

3. **Archiver plutÃ´t que stocker** :
   - Exporter vers S3/Blob Storage (beaucoup moins cher)
   - Compression des logs

4. **Limiter les dashboards payants** (AWS) :
   - Consolider plusieurs mÃ©triques dans un dashboard
   - Partager les dashboards entre Ã©quipes

### 6. SÃ©curitÃ© et conformitÃ©

**Chiffrement** :
- âœ… MÃ©triques et logs chiffrÃ©s au repos (KMS, Azure Key Vault, Cloud KMS)
- âœ… Transit chiffrÃ© (HTTPS/TLS)
- âœ… AccÃ¨s via IAM/RBAC

**Audit** :
- âœ… CloudTrail (AWS) / Activity Log (Azure) / Cloud Audit Logs (GCP)
- âœ… Qui a accÃ©dÃ© aux dashboards ?
- âœ… Qui a modifiÃ© les alertes ?

**ConformitÃ©** :
- âœ… RÃ©tention selon rÃ©glementations (RGPD, HIPAA, SOC2)
- âœ… SÃ©paration des environnements (prod/dev)
- âœ… Masquage des donnÃ©es sensibles dans les logs

---

## Troubleshooting

### ProblÃ¨me 1 : MÃ©triques manquantes

**SymptÃ´mes** :
- Dashboards vides
- Alertes ne se dÃ©clenchent pas
- Gaps dans les graphiques

**Diagnostic** :

AWS :
```bash
# VÃ©rifier que l'instance RDS existe et est UP
aws rds describe-db-instances --db-instance-identifier my-instance

# Lister les mÃ©triques disponibles
aws cloudwatch list-metrics --namespace AWS/RDS

# Tester une mÃ©trique
aws cloudwatch get-metric-statistics \
  --namespace AWS/RDS \
  --metric-name CPUUtilization \
  --dimensions Name=DBInstanceIdentifier,Value=my-instance \
  --start-time 2025-01-01T00:00:00Z \
  --end-time 2025-01-01T01:00:00Z \
  --period 300 \
  --statistics Average
```

Azure :
```bash
# VÃ©rifier les mÃ©triques disponibles
az monitor metrics list-definitions \
  --resource /subscriptions/{sub}/resourceGroups/{rg}/providers/Microsoft.DBforPostgreSQL/servers/{server}

# Tester une mÃ©trique
az monitor metrics list \
  --resource {resource-id} \
  --metric cpu_percent \
  --start-time 2025-01-01T00:00:00Z \
  --end-time 2025-01-01T01:00:00Z
```

GCP :
```bash
# Lister les mÃ©triques
gcloud monitoring metrics-descriptors list \
  --filter="metric.type:cloudsql.googleapis.com"

# Tester une mÃ©trique
gcloud monitoring time-series list \
  --filter='metric.type="cloudsql.googleapis.com/database/cpu/utilization"'
```

### ProblÃ¨me 2 : Alertes qui ne fonctionnent pas

**Causes courantes** :

1. **Condition mal configurÃ©e** :
   - Seuil inadaptÃ©
   - Mauvaise agrÃ©gation (avg vs max vs sum)
   - PÃ©riode trop courte/longue

2. **Notification mal configurÃ©e** :
   - Email non vÃ©rifiÃ©
   - Webhook incorrect
   - SNS topic sans abonnement (AWS)

3. **Permissions insuffisantes** :
   - Service de monitoring ne peut pas publier sur SNS/Pub-Sub
   - Action Group dÃ©sactivÃ© (Azure)

**Solution** :
```bash
# AWS: Tester SNS
aws sns publish \
  --topic-arn arn:aws:sns:region:account:topic \
  --message "Test alert"

# Azure: Tester Action Group
az monitor action-group test-notifications create \
  --action-group-name myActionGroup \
  --resource-group myResourceGroup

# GCP: Tester notification channel
gcloud alpha monitoring channels verify CHANNEL_ID
```

### ProblÃ¨me 3 : CoÃ»ts Ã©levÃ©s inattendus

**Investigation** :

AWS CloudWatch :
```bash
# Analyser les coÃ»ts via Cost Explorer
# Filtrer par service: CloudWatch
# VÃ©rifier:
# - GetMetricStatistics API calls
# - Log ingestion
# - Logs storage
```

Azure Monitor :
```bash
# Analyser via Cost Management
# VÃ©rifier:
# - Log Analytics ingestion
# - Diagnostic settings volume
# - Alertes haute frÃ©quence
```

**Solutions** :
1. RÃ©duire la frÃ©quence de scraping
2. Filtrer les logs avant ingestion
3. Archiver les logs anciens vers stockage froid
4. DÃ©sactiver Enhanced Monitoring si non nÃ©cessaire

### ProblÃ¨me 4 : Latence dans les dashboards

**Causes** :
- RequÃªtes trop larges (trop de mÃ©triques)
- PÃ©riode trop longue (ex: 1 an de donnÃ©es)
- Pas d'agrÃ©gation

**Solutions** :

1. **Utiliser des agrÃ©gations** :
   ```
   Au lieu de: Toutes les valeurs sur 30 jours
   Utiliser: AgrÃ©gation horaire sur 30 jours
   ```

2. **Limiter la pÃ©riode par dÃ©faut** :
   ```
   Dashboard: DerniÃ¨res 24h par dÃ©faut
   Permettre l'extension Ã  7 jours si nÃ©cessaire
   ```

3. **Utiliser des variables** :
   ```
   Filtrer par instance_id, database_name
   â†’ RÃ©duire le volume de donnÃ©es
   ```

---

## Conclusion

### RÃ©capitulatif

Les **solutions cloud natives** (CloudWatch, Azure Monitor, GCP Cloud Monitoring) offrent un monitoring **puissant et intÃ©grÃ©** pour PostgreSQL :

- âœ… **ZÃ©ro infrastructure** : Pas de serveurs Ã  gÃ©rer
- âœ… **IntÃ©gration native** : MÃ©triques automatiques
- âœ… **ScalabilitÃ©** : GÃ¨re des millions de mÃ©triques
- âœ… **SÃ©curitÃ©** : IAM, chiffrement, audit
- âœ… **Ã‰cosystÃ¨me complet** : MÃ©triques + Logs + Traces

**Points de vigilance** :
- âš ï¸ **CoÃ»t** : Peut devenir Ã©levÃ© avec beaucoup de logs
- âš ï¸ **Vendor lock-in** : DÃ©pendance au cloud provider
- âš ï¸ **FlexibilitÃ© limitÃ©e** : Moins personnalisable que Prometheus/Grafana

### Choix de solution

**Matrice de dÃ©cision** :

| Situation | Solution recommandÃ©e |
|-----------|---------------------|
| **PostgreSQL sur AWS RDS/Aurora** | AWS CloudWatch + Performance Insights |
| **PostgreSQL sur Azure** | Azure Monitor + Query Performance Insights |
| **PostgreSQL sur GCP** | Cloud Monitoring (meilleur rapport qualitÃ©/prix) |
| **Multi-cloud** | Grafana centralisÃ© + exporters |
| **Hybride (on-prem + cloud)** | Prometheus/Grafana ou Datadog |
| **Budget trÃ¨s limitÃ©** | GCP (tier gratuit gÃ©nÃ©reux) ou Prometheus self-hosted |
| **Besoin APM complet** | Datadog, New Relic (payant) |

### Checklist de mise en place

**Avant le dÃ©ploiement** :
- [ ] Choisir le cloud provider
- [ ] Provisionner l'instance PostgreSQL managÃ©e
- [ ] Configurer les paramÃ¨tres de logging PostgreSQL
- [ ] Activer les services de monitoring (gratuits)

**Configuration monitoring** :
- [ ] Activer Enhanced Monitoring / Diagnostic Settings
- [ ] Configurer Performance Insights / Query Insights
- [ ] ParamÃ©trer la rÃ©tention des logs
- [ ] VÃ©rifier que les mÃ©triques sont collectÃ©es

**Dashboards et visualisation** :
- [ ] CrÃ©er un dashboard principal (Overview)
- [ ] CrÃ©er des dashboards par Ã©quipe/environnement
- [ ] Ajouter des annotations et documentation
- [ ] Configurer les pÃ©riodes d'affichage par dÃ©faut

**Alerting** :
- [ ] DÃ©finir les seuils d'alerte (CPU, RAM, Disk, Connections)
- [ ] Configurer les canaux de notification (email, Slack, etc.)
- [ ] Tester les alertes
- [ ] CrÃ©er des runbooks pour chaque alerte

**Optimisation coÃ»ts** :
- [ ] Filtrer les logs inutiles
- [ ] Configurer l'archivage automatique
- [ ] Monitorer les coÃ»ts mensuellement
- [ ] Ajuster la rÃ©tention selon les besoins

**SÃ©curitÃ©** :
- [ ] Configurer IAM/RBAC
- [ ] Activer le chiffrement
- [ ] Activer les audit logs
- [ ] Restreindre les accÃ¨s aux dashboards sensibles

### Pour aller plus loin

**Formation** :
- Certifications cloud (AWS Certified DevOps, Azure Administrator, GCP Professional Cloud Architect)
- Cours spÃ©cialisÃ©s monitoring (Udemy, Pluralsight, A Cloud Guru)

**Outils complÃ©mentaires** :
- **Terraform** : Infrastructure as Code pour monitoring
- **Ansible** : Automatisation de la configuration
- **Kubectl** : Si PostgreSQL sur Kubernetes

**CommunautÃ©s** :
- AWS re:Post, Azure Community, Google Cloud Community
- Reddit : r/aws, r/AZURE, r/googlecloud
- Meetups locaux DevOps et Cloud

---

## Ressources

### Documentation officielle

**AWS** :
- CloudWatch : https://docs.aws.amazon.com/cloudwatch/
- RDS Performance Insights : https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/USER_PerfInsights.html
- CloudWatch Logs Insights : https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/AnalyzingLogData.html

**Azure** :
- Azure Monitor : https://docs.microsoft.com/en-us/azure/azure-monitor/
- Log Analytics : https://docs.microsoft.com/en-us/azure/azure-monitor/logs/
- Workbooks : https://docs.microsoft.com/en-us/azure/azure-monitor/visualize/workbooks-overview

**Google Cloud** :
- Cloud Monitoring : https://cloud.google.com/monitoring/docs
- Cloud Logging : https://cloud.google.com/logging/docs
- Query Insights : https://cloud.google.com/sql/docs/postgres/using-query-insights

### Blogs et articles

- AWS Database Blog : https://aws.amazon.com/blogs/database/
- Azure Database Blog : https://azure.microsoft.com/en-us/blog/topics/database/
- Google Cloud Blog : https://cloud.google.com/blog/products/databases

### Comparateurs et guides

- "AWS vs Azure vs GCP: Cloud Comparison" - CloudAcademy
- "Database Monitoring Best Practices" - Percona
- "Cloud Native PostgreSQL" - EnterpriseDB

---

## Glossaire

| Terme | DÃ©finition |
|-------|------------|
| **Cloud-native** | ConÃ§u spÃ©cifiquement pour fonctionner dans le cloud |
| **Managed service** | Service gÃ©rÃ© par le cloud provider (infra, maintenance, etc.) |
| **IAM** | Identity and Access Management (gestion des accÃ¨s) |
| **KQL** | Kusto Query Language (langage Azure Monitor Logs) |
| **MQL** | Monitoring Query Language (langage GCP) |
| **SNS** | Simple Notification Service (AWS) |
| **Action Group** | Groupe d'actions de notification (Azure) |
| **Notification Channel** | Canal de notification (GCP) |
| **Enhanced Monitoring** | Monitoring avancÃ© au niveau OS (AWS RDS) |
| **Performance Insights** | Outil d'analyse de performances requÃªtes (AWS, Azure) |
| **Query Insights** | Outil d'analyse de performances requÃªtes (GCP) |
| **Workbook** | Dashboard interactif (Azure Monitor) |
| **CloudWatch Logs Insights** | Outil d'analyse de logs (AWS) |
| **Log Analytics** | Service d'analyse de logs (Azure) |
| **Cloud Logging** | Service de logging (GCP) |

---


â­ï¸ [Programmation Serveur (PL/pgSQL)](/15-programmation-serveur/README.md)
