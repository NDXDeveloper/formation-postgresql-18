üîù Retour au [Sommaire](/SOMMAIRE.md)

# 16.4.3. Default Privileges (ALTER DEFAULT PRIVILEGES)

## Introduction

Imaginez cette situation frustrante : vous accordez soigneusement des permissions √† un utilisateur sur toutes les tables existantes. Tout fonctionne parfaitement. Puis, quelques jours plus tard, une nouvelle table est cr√©√©e dans la base de donn√©es. Soudain, votre utilisateur ne peut plus y acc√©der car il n'a **pas de permissions** sur cette nouvelle table !

C'est exactement le probl√®me que r√©sout **ALTER DEFAULT PRIVILEGES** : cette commande permet de d√©finir des permissions **par d√©faut** qui seront **automatiquement appliqu√©es** √† tous les nouveaux objets cr√©√©s dans le futur.

Cette section explique comment utiliser cette fonctionnalit√© puissante pour automatiser la gestion des permissions et √©viter les oublis.

---

## 1. Le Probl√®me : Permissions sur les Nouveaux Objets

### 1.1. Sc√©nario Probl√©matique

Voici une situation typique qui cause des probl√®mes :

```sql
-- √âtape 1 : Configuration initiale
CREATE SCHEMA app_data;

CREATE TABLE app_data.users (
    id SERIAL PRIMARY KEY,
    username VARCHAR(50)
);

CREATE ROLE app_backend LOGIN PASSWORD 'secure_pass';

-- √âtape 2 : Accorder les permissions
GRANT USAGE ON SCHEMA app_data TO app_backend;
GRANT SELECT, INSERT, UPDATE ON ALL TABLES IN SCHEMA app_data TO app_backend;
GRANT USAGE ON ALL SEQUENCES IN SCHEMA app_data TO app_backend;

-- ‚úÖ Tout fonctionne : app_backend peut acc√©der √† la table users
```

Quelques jours plus tard, un d√©veloppeur cr√©e une nouvelle table :

```sql
-- Nouvelle table cr√©√©e par postgres (superuser)
CREATE TABLE app_data.orders (
    id SERIAL PRIMARY KEY,
    user_id INTEGER,
    total NUMERIC
);
```

Et maintenant, l'application rencontre une erreur :

```sql
-- L'application essaie d'acc√©der √† la nouvelle table
SELECT * FROM app_data.orders;
-- ‚ùå Erreur : permission denied for table orders
```

**Pourquoi ?** Parce que les permissions accord√©es avec `GRANT ... ON ALL TABLES` ne s'appliquent qu'aux tables **existantes au moment de la commande**. Les nouvelles tables n'h√©ritent pas automatiquement de ces permissions.

### 1.2. Solution Na√Øve (et Mauvaise)

Une solution serait de r√©-ex√©cuter les GRANT √† chaque fois qu'une nouvelle table est cr√©√©e :

```sql
-- Apr√®s chaque CREATE TABLE...
GRANT SELECT, INSERT, UPDATE ON ALL TABLES IN SCHEMA app_data TO app_backend;
GRANT USAGE ON ALL SEQUENCES IN SCHEMA app_data TO app_backend;
```

‚ùå **Probl√®mes** :
- Fastidieux et r√©p√©titif
- Facile √† oublier
- Erreurs garanties en production
- Ne s'int√®gre pas bien dans les pipelines d'automatisation

### 1.3. La Vraie Solution : ALTER DEFAULT PRIVILEGES

```sql
-- Configuration des permissions par d√©faut
ALTER DEFAULT PRIVILEGES IN SCHEMA app_data
GRANT SELECT, INSERT, UPDATE ON TABLES TO app_backend;

ALTER DEFAULT PRIVILEGES IN SCHEMA app_data
GRANT USAGE ON SEQUENCES TO app_backend;
```

Maintenant, **toutes les nouvelles tables et s√©quences** cr√©√©es dans `app_data` auront automatiquement ces permissions accord√©es √† `app_backend` ! üéâ

---

## 2. Syntaxe et Fonctionnement

### 2.1. Syntaxe G√©n√©rale

```sql
ALTER DEFAULT PRIVILEGES
    [ FOR ROLE role_name ]
    [ IN SCHEMA schema_name ]
    abbreviated_grant_or_revoke;
```

**Composants** :

- **FOR ROLE** : Sp√©cifie le r√¥le qui cr√©era les objets (optionnel)
- **IN SCHEMA** : Limite aux objets cr√©√©s dans un sch√©ma sp√©cifique (optionnel)
- **abbreviated_grant_or_revoke** : GRANT ou REVOKE habituel, mais sans nommer d'objet sp√©cifique

### 2.2. Syntaxe D√©taill√©e pour GRANT

```sql
ALTER DEFAULT PRIVILEGES [ FOR ROLE creating_role ] [ IN SCHEMA schema_name ]
GRANT { privilege [, ...] | ALL [ PRIVILEGES ] }
    ON { TABLES | SEQUENCES | FUNCTIONS | TYPES | SCHEMAS }
    TO { role_name | PUBLIC } [, ...]
    [ WITH GRANT OPTION ];
```

### 2.3. Types d'Objets Support√©s

ALTER DEFAULT PRIVILEGES fonctionne pour :

| Type d'Objet | Permissions Applicables | Exemple d'Usage |
|--------------|------------------------|-----------------|
| **TABLES** | SELECT, INSERT, UPDATE, DELETE, TRUNCATE, REFERENCES, TRIGGER, ALL | Tables et vues |
| **SEQUENCES** | USAGE, SELECT, UPDATE, ALL | S√©quences (SERIAL, IDENTITY) |
| **FUNCTIONS** | EXECUTE | Fonctions et proc√©dures stock√©es |
| **TYPES** | USAGE | Types personnalis√©s |
| **SCHEMAS** | USAGE, CREATE | Sch√©mas (rarement utilis√©) |

---

## 3. Exemples Pratiques

### 3.1. Exemple de Base : Application Simple

Configuration compl√®te pour une application avec lecture/√©criture :

```sql
-- 1. Cr√©er le sch√©ma
CREATE SCHEMA app_data;

-- 2. Cr√©er le r√¥le
CREATE ROLE app_backend LOGIN PASSWORD 'secure_password';

-- 3. Permissions sur le sch√©ma
GRANT USAGE ON SCHEMA app_data TO app_backend;

-- 4. Permissions sur les objets EXISTANTS
GRANT SELECT, INSERT, UPDATE, DELETE ON ALL TABLES IN SCHEMA app_data TO app_backend;
GRANT USAGE ON ALL SEQUENCES IN SCHEMA app_data TO app_backend;

-- 5. üåü Permissions par D√âFAUT sur les FUTURS objets
ALTER DEFAULT PRIVILEGES IN SCHEMA app_data
GRANT SELECT, INSERT, UPDATE, DELETE ON TABLES TO app_backend;

ALTER DEFAULT PRIVILEGES IN SCHEMA app_data
GRANT USAGE ON SEQUENCES TO app_backend;
```

**Test** :

```sql
-- Cr√©er une nouvelle table
CREATE TABLE app_data.products (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100)
);

-- app_backend a AUTOMATIQUEMENT les permissions !
-- (se connecter en tant que app_backend pour tester)
SELECT * FROM app_data.products;  -- ‚úÖ Fonctionne !
INSERT INTO app_data.products (name) VALUES ('Test');  -- ‚úÖ Fonctionne !
```

### 3.2. Exemple : Utilisateur en Lecture Seule

Pour un utilisateur qui doit uniquement consulter les donn√©es :

```sql
-- Cr√©er le r√¥le
CREATE ROLE app_readonly LOGIN PASSWORD 'secure_password';

-- Permission sur le sch√©ma
GRANT USAGE ON SCHEMA app_data TO app_readonly;

-- Permissions sur les tables existantes
GRANT SELECT ON ALL TABLES IN SCHEMA app_data TO app_readonly;

-- üåü Permissions par d√©faut sur les futures tables
ALTER DEFAULT PRIVILEGES IN SCHEMA app_data
GRANT SELECT ON TABLES TO app_readonly;
```

Maintenant, chaque nouvelle table sera automatiquement accessible en lecture √† `app_readonly`.

### 3.3. Exemple : FOR ROLE (Propri√©taire Sp√©cifique)

Par d√©faut, ALTER DEFAULT PRIVILEGES s'applique aux objets cr√©√©s par **l'utilisateur qui ex√©cute la commande**. Pour sp√©cifier un autre cr√©ateur, utilisez FOR ROLE :

```sql
-- Imaginons que "developpeur" cr√©e les tables
CREATE ROLE developpeur LOGIN PASSWORD 'pass';
GRANT CREATE ON SCHEMA app_data TO developpeur;

-- Configuration des permissions par d√©faut pour les objets cr√©√©s par "developpeur"
ALTER DEFAULT PRIVILEGES FOR ROLE developpeur IN SCHEMA app_data
GRANT SELECT, INSERT, UPDATE ON TABLES TO app_backend;

ALTER DEFAULT PRIVILEGES FOR ROLE developpeur IN SCHEMA app_data
GRANT SELECT ON TABLES TO app_readonly;
```

**Explication** :
- Quand `developpeur` cr√©e une table dans `app_data`, elle aura automatiquement :
  - SELECT, INSERT, UPDATE pour `app_backend`
  - SELECT pour `app_readonly`

### 3.4. Exemple : Plusieurs Sch√©mas

Pour appliquer les m√™mes permissions √† plusieurs sch√©mas, il faut r√©p√©ter la commande :

```sql
-- Configuration pour le sch√©ma app_data
ALTER DEFAULT PRIVILEGES IN SCHEMA app_data
GRANT SELECT, INSERT, UPDATE ON TABLES TO app_backend;

-- Configuration pour le sch√©ma app_logs
ALTER DEFAULT PRIVILEGES IN SCHEMA app_logs
GRANT SELECT, INSERT, UPDATE ON TABLES TO app_backend;

-- Configuration pour le sch√©ma app_cache
ALTER DEFAULT PRIVILEGES IN SCHEMA app_cache
GRANT SELECT, INSERT, UPDATE, DELETE, TRUNCATE ON TABLES TO app_backend;
```

### 3.5. Exemple : Fonctions et Proc√©dures

Les fonctions ont un comportement par d√©faut particulier : elles sont ex√©cutables par PUBLIC. Pour le changer :

```sql
-- R√©voquer l'acc√®s public par d√©faut sur les nouvelles fonctions
ALTER DEFAULT PRIVILEGES IN SCHEMA app_data
REVOKE EXECUTE ON FUNCTIONS FROM PUBLIC;

-- Accorder uniquement √† app_backend
ALTER DEFAULT PRIVILEGES IN SCHEMA app_data
GRANT EXECUTE ON FUNCTIONS TO app_backend;
```

Maintenant, les nouvelles fonctions cr√©√©es dans `app_data` ne seront ex√©cutables que par `app_backend`.

### 3.6. Exemple : ALL PRIVILEGES

Pour accorder toutes les permissions possibles :

```sql
-- Administrateur avec tous les droits sur les futures tables
ALTER DEFAULT PRIVILEGES IN SCHEMA app_data
GRANT ALL PRIVILEGES ON TABLES TO admin_role;

ALTER DEFAULT PRIVILEGES IN SCHEMA app_data
GRANT ALL PRIVILEGES ON SEQUENCES TO admin_role;

ALTER DEFAULT PRIVILEGES IN SCHEMA app_data
GRANT ALL PRIVILEGES ON FUNCTIONS TO admin_role;
```

---

## 4. REVOKE avec DEFAULT PRIVILEGES

Tout comme on peut GRANT par d√©faut, on peut aussi REVOKE par d√©faut.

### 4.1. R√©voquer des Permissions par D√©faut

```sql
-- R√©voquer SELECT par d√©faut
ALTER DEFAULT PRIVILEGES IN SCHEMA app_data
REVOKE SELECT ON TABLES FROM app_readonly;

-- R√©voquer EXECUTE sur les fonctions de PUBLIC
ALTER DEFAULT PRIVILEGES IN SCHEMA app_data
REVOKE EXECUTE ON FUNCTIONS FROM PUBLIC;
```

### 4.2. Exemple : S√©curiser les Fonctions

Par d√©faut, PostgreSQL accorde EXECUTE sur les nouvelles fonctions √† PUBLIC. Pour une s√©curit√© maximale :

```sql
-- R√©voquer l'acc√®s public par d√©faut
ALTER DEFAULT PRIVILEGES
REVOKE EXECUTE ON FUNCTIONS FROM PUBLIC;

-- Dans chaque sch√©ma aussi
ALTER DEFAULT PRIVILEGES IN SCHEMA app_data
REVOKE EXECUTE ON FUNCTIONS FROM PUBLIC;

-- Puis accorder explicitement selon les besoins
ALTER DEFAULT PRIVILEGES IN SCHEMA app_data
GRANT EXECUTE ON FUNCTIONS TO app_backend;
```

---

## 5. V√©rifier les Default Privileges

### 5.1. Via psql : \ddp

La commande `\ddp` affiche les default privileges configur√©s :

```sql
\ddp
```

R√©sultat exemple :
```
          Default access privileges
 Owner  | Schema   | Type     | Access privileges
--------+----------+----------+-------------------
 postgres | app_data | table    | app_backend=arwd/postgres
                                 app_readonly=r/postgres
 postgres | app_data | sequence | app_backend=rU/postgres
```

### 5.2. Avec un Filtre sur un Sch√©ma

```sql
\ddp app_data
```

### 5.3. Via SQL : pg_default_acl

Pour une analyse plus d√©taill√©e, interrogez la table syst√®me `pg_default_acl` :

```sql
SELECT
    pg_get_userbyid(d.defaclrole) AS owner,
    n.nspname AS schema,
    CASE d.defaclobjtype
        WHEN 'r' THEN 'table'
        WHEN 'S' THEN 'sequence'
        WHEN 'f' THEN 'function'
        WHEN 'T' THEN 'type'
        WHEN 'n' THEN 'schema'
    END AS object_type,
    d.defaclacl AS default_acl
FROM pg_default_acl d
LEFT JOIN pg_namespace n ON d.defaclnamespace = n.oid
WHERE n.nspname = 'app_data'  -- Filtrer par sch√©ma
   OR d.defaclnamespace = 0;   -- ou global (pas de sch√©ma sp√©cifique)
```

### 5.4. D√©coder les Permissions (Plus Lisible)

```sql
SELECT
    pg_get_userbyid(d.defaclrole) AS "Owner/Creator",
    COALESCE(n.nspname, 'ALL SCHEMAS') AS "Schema",
    CASE d.defaclobjtype
        WHEN 'r' THEN 'Tables'
        WHEN 'S' THEN 'Sequences'
        WHEN 'f' THEN 'Functions'
        WHEN 'T' THEN 'Types'
    END AS "Object Type",
    (aclexplode(d.defaclacl)).grantee::regrole AS "Grantee",
    (aclexplode(d.defaclacl)).privilege_type AS "Privilege"
FROM pg_default_acl d
LEFT JOIN pg_namespace n ON d.defaclnamespace = n.oid
ORDER BY 1, 2, 3, 4;
```

R√©sultat exemple :
```
 Owner/Creator | Schema   | Object Type | Grantee      | Privilege
---------------+----------+-------------+--------------+-----------
 postgres      | app_data | Tables      | app_backend  | INSERT
 postgres      | app_data | Tables      | app_backend  | SELECT
 postgres      | app_data | Tables      | app_backend  | UPDATE
 postgres      | app_data | Tables      | app_readonly | SELECT
 postgres      | app_data | Sequences   | app_backend  | USAGE
```

---

## 6. Cas d'Usage Avanc√©s

### 6.1. Environnement de D√©veloppement vs Production

#### D√©veloppement : Permissif

```sql
-- En dev, les d√©veloppeurs ont tous les droits
ALTER DEFAULT PRIVILEGES IN SCHEMA public
GRANT ALL PRIVILEGES ON TABLES TO developpeurs;

ALTER DEFAULT PRIVILEGES IN SCHEMA public
GRANT ALL PRIVILEGES ON SEQUENCES TO developpeurs;

ALTER DEFAULT PRIVILEGES IN SCHEMA public
GRANT ALL PRIVILEGES ON FUNCTIONS TO developpeurs;
```

#### Production : Restrictif

```sql
-- En prod, s√©paration stricte des r√¥les
-- Application : seulement ce qui est n√©cessaire
ALTER DEFAULT PRIVILEGES IN SCHEMA app_data
GRANT SELECT, INSERT, UPDATE ON TABLES TO app_production;

ALTER DEFAULT PRIVILEGES IN SCHEMA app_data
GRANT USAGE ON SEQUENCES TO app_production;

-- Lecture seule : analystes et reporting
ALTER DEFAULT PRIVILEGES IN SCHEMA app_data
GRANT SELECT ON TABLES TO readonly_group;

-- Admin : tous les droits pour maintenance
ALTER DEFAULT PRIVILEGES IN SCHEMA app_data
GRANT ALL PRIVILEGES ON TABLES TO admin_production;
```

### 6.2. Architecture Multi-Tenant par Sch√©ma

Chaque client a son propre sch√©ma, avec des permissions automatiques :

```sql
-- Fonction pour cr√©er un nouveau tenant avec default privileges
CREATE OR REPLACE FUNCTION create_tenant(tenant_name TEXT)
RETURNS VOID AS $$
DECLARE
    schema_name TEXT;
    app_role TEXT;
    admin_role TEXT;
BEGIN
    schema_name := 'tenant_' || tenant_name;
    app_role := 'app_' || tenant_name;
    admin_role := 'admin_' || tenant_name;

    -- Cr√©er le sch√©ma
    EXECUTE format('CREATE SCHEMA %I', schema_name);

    -- Cr√©er les r√¥les
    EXECUTE format('CREATE ROLE %I LOGIN PASSWORD ''changeme''', app_role);
    EXECUTE format('CREATE ROLE %I LOGIN PASSWORD ''changeme''', admin_role);

    -- Permissions sur le sch√©ma
    EXECUTE format('GRANT USAGE ON SCHEMA %I TO %I', schema_name, app_role);
    EXECUTE format('GRANT ALL ON SCHEMA %I TO %I', schema_name, admin_role);

    -- üåü Default privileges pour l'application
    EXECUTE format('ALTER DEFAULT PRIVILEGES IN SCHEMA %I GRANT SELECT, INSERT, UPDATE ON TABLES TO %I',
                   schema_name, app_role);
    EXECUTE format('ALTER DEFAULT PRIVILEGES IN SCHEMA %I GRANT USAGE ON SEQUENCES TO %I',
                   schema_name, app_role);

    -- üåü Default privileges pour l'admin
    EXECUTE format('ALTER DEFAULT PRIVILEGES IN SCHEMA %I GRANT ALL PRIVILEGES ON TABLES TO %I',
                   schema_name, admin_role);
    EXECUTE format('ALTER DEFAULT PRIVILEGES IN SCHEMA %I GRANT ALL PRIVILEGES ON SEQUENCES TO %I',
                   schema_name, admin_role);

    RAISE NOTICE 'Tenant % cr√©√© avec succ√®s', tenant_name;
END;
$$ LANGUAGE plpgsql;

-- Utilisation
SELECT create_tenant('acme_corp');
SELECT create_tenant('globex');
```

Maintenant, chaque fois qu'une nouvelle table est cr√©√©e dans le sch√©ma d'un tenant, les permissions sont automatiquement configur√©es !

### 6.3. Pipeline CI/CD avec Migrations

Dans un pipeline CI/CD moderne avec des migrations de base de donn√©es (Flyway, Liquibase, Alembic) :

```sql
-- Script d'initialisation (ex√©cut√© une fois)
-- init_permissions.sql

-- R√¥le qui ex√©cute les migrations
CREATE ROLE migration_runner LOGIN PASSWORD 'secure_pass';
GRANT CREATE ON SCHEMA app_data TO migration_runner;

-- R√¥le de l'application
CREATE ROLE app_backend LOGIN PASSWORD 'secure_pass';
GRANT USAGE ON SCHEMA app_data TO app_backend;

-- üåü Default privileges : les objets cr√©√©s par migration_runner
-- seront automatiquement accessibles √† app_backend
ALTER DEFAULT PRIVILEGES FOR ROLE migration_runner IN SCHEMA app_data
GRANT SELECT, INSERT, UPDATE, DELETE ON TABLES TO app_backend;

ALTER DEFAULT PRIVILEGES FOR ROLE migration_runner IN SCHEMA app_data
GRANT USAGE ON SEQUENCES TO app_backend;

ALTER DEFAULT PRIVILEGES FOR ROLE migration_runner IN SCHEMA app_data
GRANT EXECUTE ON FUNCTIONS TO app_backend;
```

**Workflow** :
1. Le pipeline CI/CD se connecte avec `migration_runner`
2. Il cr√©e des tables, fonctions, etc.
3. `app_backend` a **automatiquement** acc√®s √† tout ce qui est cr√©√©
4. Pas besoin de GRANT manuels dans chaque migration !

### 6.4. √âquipes Multiples avec Cr√©ateurs Diff√©rents

Dans une grande organisation avec plusieurs √©quipes :

```sql
-- √âquipe Backend cr√©e des tables applicatives
CREATE ROLE equipe_backend;

ALTER DEFAULT PRIVILEGES FOR ROLE equipe_backend IN SCHEMA app_data
GRANT SELECT, INSERT, UPDATE, DELETE ON TABLES TO app_production;

-- √âquipe Analytics cr√©e des tables de reporting
CREATE ROLE equipe_analytics;

ALTER DEFAULT PRIVILEGES FOR ROLE equipe_analytics IN SCHEMA reporting
GRANT SELECT ON TABLES TO data_scientists;

-- √âquipe DevOps cr√©e des tables de monitoring
CREATE ROLE equipe_devops;

ALTER DEFAULT PRIVILEGES FOR ROLE equipe_devops IN SCHEMA monitoring
GRANT SELECT ON TABLES TO grafana_user;
```

---

## 7. Pi√®ges et Erreurs Courantes

### 7.1. Pi√®ge #1 : Oublier FOR ROLE

‚ùå **Erreur courante** :

```sql
-- En tant que postgres (superuser)
ALTER DEFAULT PRIVILEGES IN SCHEMA app_data
GRANT SELECT ON TABLES TO app_backend;

-- Un d√©veloppeur cr√©e une table
-- (connect√© en tant que developpeur, pas postgres)
CREATE TABLE app_data.new_table (id INTEGER);

-- app_backend n'a PAS les permissions ! üò±
```

**Pourquoi ?** Les default privileges s'appliquent **au r√¥le qui ex√©cute ALTER DEFAULT PRIVILEGES**, pas √† tous les cr√©ateurs potentiels.

‚úÖ **Solution** :

```sql
-- Sp√©cifier explicitement FOR ROLE
ALTER DEFAULT PRIVILEGES FOR ROLE developpeur IN SCHEMA app_data
GRANT SELECT ON TABLES TO app_backend;

-- Ou, en tant que postgres, pour soi-m√™me
ALTER DEFAULT PRIVILEGES FOR ROLE postgres IN SCHEMA app_data
GRANT SELECT ON TABLES TO app_backend;
```

### 7.2. Pi√®ge #2 : Objets Existants Non Couverts

ALTER DEFAULT PRIVILEGES ne s'applique **qu'aux futurs objets**, pas aux existants.

‚ùå **Erreur** :

```sql
-- Des tables existent d√©j√†
CREATE TABLE app_data.old_table (id INTEGER);

-- Configuration des default privileges
ALTER DEFAULT PRIVILEGES IN SCHEMA app_data
GRANT SELECT ON TABLES TO app_backend;

-- app_backend ne peut PAS acc√©der √† old_table ! üò±
```

‚úÖ **Solution** : Toujours combiner avec GRANT pour les objets existants :

```sql
-- Permissions sur les objets EXISTANTS
GRANT SELECT ON ALL TABLES IN SCHEMA app_data TO app_backend;

-- Permissions sur les FUTURS objets
ALTER DEFAULT PRIVILEGES IN SCHEMA app_data
GRANT SELECT ON TABLES TO app_backend;
```

### 7.3. Pi√®ge #3 : Oublier les S√©quences

Les colonnes SERIAL/IDENTITY cr√©ent des s√©quences. Il faut configurer les default privileges pour les s√©quences aussi :

‚ùå **Erreur** :

```sql
-- Seulement les tables
ALTER DEFAULT PRIVILEGES IN SCHEMA app_data
GRANT SELECT, INSERT ON TABLES TO app_backend;

-- Nouvelle table avec SERIAL
CREATE TABLE app_data.orders (
    id SERIAL PRIMARY KEY,  -- Cr√©e une s√©quence !
    total NUMERIC
);

-- INSERT √©choue !
INSERT INTO app_data.orders (total) VALUES (100);
-- ‚ùå Erreur : permission denied for sequence orders_id_seq
```

‚úÖ **Solution** :

```sql
-- Toujours inclure les s√©quences
ALTER DEFAULT PRIVILEGES IN SCHEMA app_data
GRANT SELECT, INSERT ON TABLES TO app_backend;

ALTER DEFAULT PRIVILEGES IN SCHEMA app_data
GRANT USAGE ON SEQUENCES TO app_backend;  -- ‚úÖ
```

### 7.4. Pi√®ge #4 : Sch√©mas Multiples

ALTER DEFAULT PRIVILEGES s'applique **par sch√©ma**. Si vous utilisez plusieurs sch√©mas, r√©p√©tez la configuration :

```sql
-- Configuration pour CHAQUE sch√©ma
ALTER DEFAULT PRIVILEGES IN SCHEMA schema1
GRANT SELECT ON TABLES TO app_backend;

ALTER DEFAULT PRIVILEGES IN SCHEMA schema2
GRANT SELECT ON TABLES TO app_backend;

ALTER DEFAULT PRIVILEGES IN SCHEMA schema3
GRANT SELECT ON TABLES TO app_backend;

-- Ou cr√©er une fonction helper pour √©viter la r√©p√©tition
CREATE OR REPLACE FUNCTION setup_default_privileges(schema_name TEXT, role_name TEXT)
RETURNS VOID AS $$
BEGIN
    EXECUTE format('ALTER DEFAULT PRIVILEGES IN SCHEMA %I GRANT SELECT, INSERT, UPDATE ON TABLES TO %I',
                   schema_name, role_name);
    EXECUTE format('ALTER DEFAULT PRIVILEGES IN SCHEMA %I GRANT USAGE ON SEQUENCES TO %I',
                   schema_name, role_name);
END;
$$ LANGUAGE plpgsql;

-- Utilisation
SELECT setup_default_privileges('schema1', 'app_backend');
SELECT setup_default_privileges('schema2', 'app_backend');
```

---

## 8. Bonnes Pratiques

### 8.1. Configurer les Default Privileges D√®s le D√©but

**Meilleur moment** : Lors de la cr√©ation de la base de donn√©es et des sch√©mas.

```sql
-- Template de configuration initiale
CREATE DATABASE nouvelle_app;
\c nouvelle_app

-- S√©curisation
REVOKE ALL ON DATABASE nouvelle_app FROM PUBLIC;
REVOKE CREATE ON SCHEMA public FROM PUBLIC;

-- Sch√©mas
CREATE SCHEMA app_data;
CREATE SCHEMA app_logs;

-- R√¥les
CREATE ROLE app_backend LOGIN PASSWORD 'secure_pass';
CREATE ROLE app_readonly LOGIN PASSWORD 'secure_pass';

-- Permissions sch√©ma
GRANT USAGE ON SCHEMA app_data, app_logs TO app_backend, app_readonly;

-- üåü Default privileges (d√®s le d√©but !)
ALTER DEFAULT PRIVILEGES IN SCHEMA app_data
GRANT SELECT, INSERT, UPDATE, DELETE ON TABLES TO app_backend;

ALTER DEFAULT PRIVILEGES IN SCHEMA app_data
GRANT SELECT ON TABLES TO app_readonly;

ALTER DEFAULT PRIVILEGES IN SCHEMA app_data
GRANT USAGE ON SEQUENCES TO app_backend;

ALTER DEFAULT PRIVILEGES IN SCHEMA app_logs
GRANT SELECT, INSERT ON TABLES TO app_backend;

ALTER DEFAULT PRIVILEGES IN SCHEMA app_logs
GRANT USAGE ON SEQUENCES TO app_backend;
```

### 8.2. Documenter les Default Privileges

Commentez vos configurations :

```sql
-- ==================================================
-- DEFAULT PRIVILEGES CONFIGURATION
-- Appliqu√© par: DBA Team
-- Date: 2024-01-15
-- Raison: Automatiser les permissions pour CI/CD
-- ==================================================

-- Application backend : lecture/√©criture compl√®te
ALTER DEFAULT PRIVILEGES FOR ROLE migration_runner IN SCHEMA app_data
GRANT SELECT, INSERT, UPDATE, DELETE ON TABLES TO app_backend;

-- Analystes : lecture seule
ALTER DEFAULT PRIVILEGES FOR ROLE migration_runner IN SCHEMA app_data
GRANT SELECT ON TABLES TO analytics_team;

-- ==================================================
```

### 8.3. Utiliser FOR ROLE Syst√©matiquement

Sp√©cifiez toujours FOR ROLE pour √™tre explicite, m√™me si c'est pour votre propre r√¥le :

```sql
-- ‚úÖ Explicite et clair
ALTER DEFAULT PRIVILEGES FOR ROLE postgres IN SCHEMA app_data
GRANT SELECT ON TABLES TO app_backend;

-- ‚ùå Ambigu (s'applique au r√¥le courant, mais lequel ?)
ALTER DEFAULT PRIVILEGES IN SCHEMA app_data
GRANT SELECT ON TABLES TO app_backend;
```

### 8.4. Script de V√©rification

Cr√©ez un script pour v√©rifier que les default privileges sont correctement configur√©s :

```sql
-- verify_default_privileges.sql
DO $$
DECLARE
    expected_count INTEGER;
    actual_count INTEGER;
BEGIN
    RAISE NOTICE '=== VERIFICATION DEFAULT PRIVILEGES ===';

    -- V√©rifier les default privileges sur les tables dans app_data
    SELECT COUNT(*) INTO actual_count
    FROM pg_default_acl d
    JOIN pg_namespace n ON d.defaclnamespace = n.oid
    WHERE n.nspname = 'app_data'
    AND d.defaclobjtype = 'r';  -- 'r' = tables

    expected_count := 1;  -- On attend 1 configuration

    IF actual_count >= expected_count THEN
        RAISE NOTICE '‚úì Default privileges configur√©s sur tables: % configurations', actual_count;
    ELSE
        RAISE WARNING '‚úó Default privileges MANQUANTS sur tables ! Trouv√©: %, Attendu: au moins %',
                      actual_count, expected_count;
    END IF;

    -- V√©rifier les s√©quences
    SELECT COUNT(*) INTO actual_count
    FROM pg_default_acl d
    JOIN pg_namespace n ON d.defaclnamespace = n.oid
    WHERE n.nspname = 'app_data'
    AND d.defaclobjtype = 'S';  -- 'S' = sequences

    IF actual_count >= 1 THEN
        RAISE NOTICE '‚úì Default privileges configur√©s sur s√©quences';
    ELSE
        RAISE WARNING '‚úó Default privileges MANQUANTS sur s√©quences !';
    END IF;
END $$;
```

### 8.5. Inclure dans les Scripts de Migration

Int√©grez ALTER DEFAULT PRIVILEGES dans vos scripts d'infrastructure as code :

```sql
-- migrations/V001__init_database.sql (Flyway)

-- Cr√©ation des structures
CREATE SCHEMA app_data;
CREATE ROLE app_backend LOGIN PASSWORD '${APP_PASSWORD}';

-- Permissions de base
GRANT USAGE ON SCHEMA app_data TO app_backend;

-- Default privileges pour le futur
ALTER DEFAULT PRIVILEGES FOR ROLE ${MIGRATION_USER} IN SCHEMA app_data
GRANT SELECT, INSERT, UPDATE, DELETE ON TABLES TO app_backend;

ALTER DEFAULT PRIVILEGES FOR ROLE ${MIGRATION_USER} IN SCHEMA app_data
GRANT USAGE ON SEQUENCES TO app_backend;
```

### 8.6. Audit R√©gulier

V√©rifiez r√©guli√®rement que les default privileges sont toujours pertinents :

```sql
-- Lister tous les default privileges configur√©s
SELECT
    pg_get_userbyid(d.defaclrole) AS creator,
    COALESCE(n.nspname, 'ALL') AS schema,
    CASE d.defaclobjtype
        WHEN 'r' THEN 'tables'
        WHEN 'S' THEN 'sequences'
        WHEN 'f' THEN 'functions'
    END AS type,
    d.defaclacl AS acl
FROM pg_default_acl d
LEFT JOIN pg_namespace n ON d.defaclnamespace = n.oid
ORDER BY 1, 2, 3;
```

---

## 9. Supprimer les Default Privileges

Si vous souhaitez supprimer compl√®tement une configuration de default privileges :

### 9.1. R√©voquer Toutes les Permissions Par D√©faut

```sql
-- R√©voquer tous les default privileges d'un r√¥le sur les tables
ALTER DEFAULT PRIVILEGES FOR ROLE developpeur IN SCHEMA app_data
REVOKE ALL PRIVILEGES ON TABLES FROM app_backend;

-- R√©voquer pour les s√©quences
ALTER DEFAULT PRIVILEGES FOR ROLE developpeur IN SCHEMA app_data
REVOKE ALL PRIVILEGES ON SEQUENCES FROM app_backend;
```

### 9.2. V√©rifier la Suppression

```sql
-- V√©rifier qu'il n'y a plus de default privileges
\ddp app_data
```

---

## 10. Comparaison : GRANT vs ALTER DEFAULT PRIVILEGES

| Aspect | GRANT | ALTER DEFAULT PRIVILEGES |
|--------|-------|--------------------------|
| **Cible** | Objets existants | Futurs objets |
| **Moment d'application** | Imm√©diat | √Ä la cr√©ation de l'objet |
| **Dur√©e** | Permanent (jusqu'√† REVOKE) | Permanent (r√®gle pour le futur) |
| **Modification r√©troactive** | Oui (affecte imm√©diatement) | Non (pas d'effet sur l'existant) |
| **Cas d'usage** | Corriger les permissions | Automatiser les permissions |

**Conclusion** : Utilisez **LES DEUX** :
- **GRANT** pour les objets qui existent d√©j√†
- **ALTER DEFAULT PRIVILEGES** pour les objets qui seront cr√©√©s

---

## 11. Exemple Complet : Configuration Production

Voici un exemple complet de configuration pour un environnement de production :

```sql
-- ========================================
-- CONFIGURATION PRODUCTION
-- Database: app_production
-- ========================================

-- Connexion
\c app_production

-- ----------------------------------------
-- 1. S√âCURISATION DE BASE
-- ----------------------------------------
REVOKE ALL ON DATABASE app_production FROM PUBLIC;
REVOKE CREATE ON SCHEMA public FROM PUBLIC;

-- ----------------------------------------
-- 2. CR√âATION DES SCH√âMAS
-- ----------------------------------------
CREATE SCHEMA app_core;       -- Tables m√©tier principales
CREATE SCHEMA app_analytics;  -- Tables analytiques
CREATE SCHEMA app_audit;      -- Logs d'audit

-- ----------------------------------------
-- 3. CR√âATION DES R√îLES
-- ----------------------------------------
-- Application principale
CREATE ROLE app_backend LOGIN PASSWORD 'CHANGE_ME_IN_PROD';

-- Service de reporting
CREATE ROLE app_reporting LOGIN PASSWORD 'CHANGE_ME_IN_PROD';

-- √âquipe data science
CREATE ROLE data_scientists;

-- R√¥le pour les migrations (utilis√© par CI/CD)
CREATE ROLE migration_runner LOGIN PASSWORD 'CHANGE_ME_IN_PROD';

-- ----------------------------------------
-- 4. PERMISSIONS SUR LES SCH√âMAS
-- ----------------------------------------
GRANT USAGE ON SCHEMA app_core TO app_backend, app_reporting, data_scientists;
GRANT CREATE ON SCHEMA app_core TO migration_runner;

GRANT USAGE ON SCHEMA app_analytics TO app_reporting, data_scientists;
GRANT CREATE ON SCHEMA app_analytics TO migration_runner;

GRANT USAGE ON SCHEMA app_audit TO app_backend;
GRANT CREATE ON SCHEMA app_audit TO app_backend;

-- ----------------------------------------
-- 5. PERMISSIONS SUR OBJETS EXISTANTS
-- ----------------------------------------
-- (Au cas o√π des tables existent d√©j√†)
GRANT SELECT, INSERT, UPDATE, DELETE ON ALL TABLES IN SCHEMA app_core TO app_backend;
GRANT USAGE ON ALL SEQUENCES IN SCHEMA app_core TO app_backend;

GRANT SELECT ON ALL TABLES IN SCHEMA app_core TO app_reporting;
GRANT SELECT ON ALL TABLES IN SCHEMA app_analytics TO app_reporting, data_scientists;

-- ----------------------------------------
-- 6. üåü DEFAULT PRIVILEGES (Le c≈ìur !)
-- ----------------------------------------

-- Tables cr√©√©es par migration_runner dans app_core
ALTER DEFAULT PRIVILEGES FOR ROLE migration_runner IN SCHEMA app_core
GRANT SELECT, INSERT, UPDATE, DELETE ON TABLES TO app_backend;

ALTER DEFAULT PRIVILEGES FOR ROLE migration_runner IN SCHEMA app_core
GRANT SELECT ON TABLES TO app_reporting;

ALTER DEFAULT PRIVILEGES FOR ROLE migration_runner IN SCHEMA app_core
GRANT USAGE ON SEQUENCES TO app_backend;

-- Tables cr√©√©es par migration_runner dans app_analytics
ALTER DEFAULT PRIVILEGES FOR ROLE migration_runner IN SCHEMA app_analytics
GRANT SELECT ON TABLES TO app_reporting, data_scientists;

ALTER DEFAULT PRIVILEGES FOR ROLE migration_runner IN SCHEMA app_analytics
GRANT USAGE ON SEQUENCES TO app_reporting;

-- Tables d'audit cr√©√©es par l'application elle-m√™me
ALTER DEFAULT PRIVILEGES FOR ROLE app_backend IN SCHEMA app_audit
GRANT SELECT, INSERT ON TABLES TO app_backend;

ALTER DEFAULT PRIVILEGES FOR ROLE app_backend IN SCHEMA app_audit
GRANT USAGE ON SEQUENCES TO app_backend;

-- Fonctions : s√©curit√© maximale
ALTER DEFAULT PRIVILEGES FOR ROLE migration_runner IN SCHEMA app_core
REVOKE EXECUTE ON FUNCTIONS FROM PUBLIC;

ALTER DEFAULT PRIVILEGES FOR ROLE migration_runner IN SCHEMA app_core
GRANT EXECUTE ON FUNCTIONS TO app_backend;

-- ----------------------------------------
-- 7. V√âRIFICATION
-- ----------------------------------------
\echo '=== V√©rification Default Privileges ==='
\ddp app_core
\ddp app_analytics
\ddp app_audit

\echo '=== Configuration termin√©e ==='
```

---

## Conclusion

**ALTER DEFAULT PRIVILEGES** est une fonctionnalit√© essentielle pour :

- ‚úÖ **Automatiser** : Plus besoin de GRANT √† chaque cr√©ation d'objet
- ‚úÖ **S√©curiser** : Les permissions sont consistantes et pr√©dictibles
- ‚úÖ **Simplifier** : Moins d'erreurs humaines et de permissions manquantes
- ‚úÖ **Int√©grer** : S'int√®gre parfaitement dans les pipelines CI/CD
- ‚úÖ **Maintenir** : Configuration centralis√©e et document√©e

### Points Cl√©s √† Retenir

1. **Utilisez TOUJOURS ALTER DEFAULT PRIVILEGES** dans vos bases de production
2. **Combinez avec GRANT** pour couvrir les objets existants ET futurs
3. **Sp√©cifiez FOR ROLE** pour √™tre explicite sur qui cr√©e les objets
4. **N'oubliez pas les s√©quences** (SERIAL/IDENTITY)
5. **Configurez d√®s le d√©but** de votre projet
6. **Documentez** vos choix de configuration
7. **V√©rifiez r√©guli√®rement** avec `\ddp` ou des requ√™tes SQL

ALTER DEFAULT PRIVILEGES transforme la gestion des permissions d'un processus manuel et source d'erreurs en un syst√®me automatis√© et fiable. C'est un investissement minimal pour un gain √©norme en robustesse et en s√©r√©nit√© ! üéØ

---

‚è≠Ô∏è [R√¥les, Groupes et principe du moindre privil√®ge](/16-administration-configuration-securite/05-roles-groupes-moindre-privilege.md)
