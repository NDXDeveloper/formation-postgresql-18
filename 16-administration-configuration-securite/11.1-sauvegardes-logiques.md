üîù Retour au [Sommaire](/SOMMAIRE.md)

# 16.11.1. Sauvegardes Logiques (pg_dump, pg_dumpall)

## Introduction aux Sauvegardes Logiques

Les sauvegardes sont l'un des aspects les plus critiques de l'administration d'une base de donn√©es. Une sauvegarde logique consiste √† extraire les donn√©es et la structure de votre base de donn√©es sous forme de commandes SQL que vous pourrez rejouer plus tard pour recr√©er exactement le m√™me √©tat.

### Pourquoi "Logique" ?

On appelle ces sauvegardes "logiques" parce qu'elles sauvegardent la **logique** de reconstruction de la base de donn√©es (les commandes SQL), et non pas les fichiers binaires bruts du syst√®me PostgreSQL. C'est comme sauvegarder la recette d'un g√¢teau plut√¥t que le g√¢teau lui-m√™me.

### Avantages des Sauvegardes Logiques

‚úÖ **Portabilit√©** : Le fichier de sauvegarde peut √™tre restaur√© sur diff√©rentes versions de PostgreSQL, diff√©rents syst√®mes d'exploitation, voire m√™me migr√© vers un autre SGBD (avec quelques adaptations).

‚úÖ **Flexibilit√©** : Vous pouvez sauvegarder une seule table, un sch√©ma sp√©cifique, ou l'int√©gralit√© de la base.

‚úÖ **Lisibilit√©** : Le fichier de sauvegarde (en format texte) peut √™tre inspect√© et √©dit√© manuellement si n√©cessaire.

‚úÖ **Compatibilit√©** : Excellente compatibilit√© entre versions PostgreSQL (mont√©e de version facilit√©e).

### Inconv√©nients des Sauvegardes Logiques

‚ùå **Performance** : Plus lentes que les sauvegardes physiques pour les tr√®s grandes bases de donn√©es.

‚ùå **Coh√©rence transactionnelle limit√©e** : pg_dump capture un instantan√© coh√©rent d'une base, mais pg_dumpall peut avoir des incoh√©rences entre bases.

‚ùå **Taille** : Les fichiers de sauvegarde peuvent √™tre volumineux (bien que compressibles).

‚ùå **Restauration** : La restauration peut √™tre longue car elle rejoue toutes les commandes SQL.

---

## pg_dump : Sauvegarde d'une Base de Donn√©es

### Qu'est-ce que pg_dump ?

`pg_dump` est l'outil principal pour cr√©er des sauvegardes logiques d'une **seule base de donn√©es** PostgreSQL. Il produit un fichier contenant toutes les commandes SQL n√©cessaires pour recr√©er la base de donn√©es dans l'√©tat exact o√π elle √©tait au moment de la sauvegarde.

### Principe de Fonctionnement

Lorsque vous ex√©cutez `pg_dump`, PostgreSQL :

1. **√âtablit une transaction en lecture seule** sur la base de donn√©es
2. **Capture un instantan√© coh√©rent** (snapshot) gr√¢ce au syst√®me MVCC
3. **Exporte** toutes les d√©finitions d'objets (tables, index, contraintes, etc.)
4. **Exporte** toutes les donn√©es contenues dans les tables
5. **Garantit la coh√©rence** : m√™me si d'autres utilisateurs modifient la base pendant le dump, votre sauvegarde refl√©tera l'√©tat au moment du d√©marrage

### Syntaxe de Base

```bash
pg_dump [options] nom_base_donnees > fichier_sauvegarde.sql
```

**Exemple simple** :
```bash
pg_dump ma_base > sauvegarde_ma_base.sql
```

Cette commande cr√©e un fichier texte `sauvegarde_ma_base.sql` contenant toutes les commandes SQL pour recr√©er `ma_base`.

### Formats de Sortie

`pg_dump` propose plusieurs formats de sortie, chacun ayant ses avantages :

#### 1. Format Plain Text (Texte Brut) - Par D√©faut

```bash
pg_dump ma_base > sauvegarde.sql
```

**Caract√©ristiques** :
- Format : Fichier SQL texte lisible
- Extension recommand√©e : `.sql`
- Avantages : Lisible, √©ditable, compatible avec psql
- Inconv√©nients : Pas de restauration s√©lective, pas de parall√©lisation

**Contenu typique** :
```sql
-- PostgreSQL database dump
CREATE TABLE clients (
    id integer NOT NULL,
    nom character varying(100),
    email character varying(255)
);

INSERT INTO clients VALUES (1, 'Dupont', 'dupont@example.com');
INSERT INTO clients VALUES (2, 'Martin', 'martin@example.com');
```

**Restauration** :
```bash
psql ma_base < sauvegarde.sql
```

#### 2. Format Custom (Personnalis√©) - Recommand√©

```bash
pg_dump -Fc ma_base > sauvegarde.dump
# Ou avec -f pour sp√©cifier le fichier de sortie
pg_dump -Fc ma_base -f sauvegarde.dump
```

**Caract√©ristiques** :
- Format : Binaire compress√© propri√©taire PostgreSQL
- Extension recommand√©e : `.dump` ou `.backup`
- Option : `-Fc` (F = Format, c = custom)
- Avantages : Compression native, restauration s√©lective, parall√©lisation possible
- Inconv√©nients : Pas lisible directement, n√©cessite `pg_restore`

**Restauration** :
```bash
pg_restore -d ma_base sauvegarde.dump
```

#### 3. Format Directory (R√©pertoire)

```bash
pg_dump -Fd ma_base -f /chemin/vers/repertoire_sauvegarde
```

**Caract√©ristiques** :
- Format : R√©pertoire contenant plusieurs fichiers
- Option : `-Fd` (F = Format, d = directory)
- Avantages : Parall√©lisation du dump et de la restauration, restauration s√©lective
- Inconv√©nients : G√©n√®re plusieurs fichiers (gestion plus complexe)

**Restauration** :
```bash
pg_restore -d ma_base -j 4 /chemin/vers/repertoire_sauvegarde
```

#### 4. Format Tar (Archive)

```bash
pg_dump -Ft ma_base -f sauvegarde.tar
```

**Caract√©ristiques** :
- Format : Archive TAR
- Option : `-Ft` (F = Format, t = tar)
- Avantages : Portable, restauration s√©lective
- Inconv√©nients : Pas de compression native, pas de parall√©lisation

**Restauration** :
```bash
pg_restore -d ma_base sauvegarde.tar
```

### Options Importantes de pg_dump

#### Options de Connexion

```bash
# Sp√©cifier l'h√¥te
pg_dump -h localhost ma_base > sauvegarde.sql

# Sp√©cifier le port
pg_dump -p 5432 ma_base > sauvegarde.sql

# Sp√©cifier l'utilisateur
pg_dump -U admin ma_base > sauvegarde.sql

# Combinaison
pg_dump -h localhost -p 5432 -U admin ma_base > sauvegarde.sql
```

#### Options de Contenu

**Sauvegarder uniquement la structure (sch√©ma) sans les donn√©es** :
```bash
pg_dump --schema-only ma_base > structure.sql
# Ou
pg_dump -s ma_base > structure.sql
```

**Sauvegarder uniquement les donn√©es sans la structure** :
```bash
pg_dump --data-only ma_base > donnees.sql
# Ou
pg_dump -a ma_base > donnees.sql
```

**Inclure les commandes DROP avant CREATE** :
```bash
pg_dump --clean ma_base > sauvegarde.sql
# Ou
pg_dump -c ma_base > sauvegarde.sql
```
Cela g√©n√®re des commandes comme `DROP TABLE IF EXISTS clients;` avant chaque `CREATE TABLE`.

**Inclure CREATE DATABASE** :
```bash
pg_dump --create ma_base > sauvegarde.sql
# Ou
pg_dump -C ma_base > sauvegarde.sql
```

#### Options de S√©lection

**Sauvegarder uniquement une table sp√©cifique** :
```bash
pg_dump -t clients ma_base > clients.sql
```

**Sauvegarder plusieurs tables** :
```bash
pg_dump -t clients -t commandes ma_base > tables.sql
```

**Exclure une table** :
```bash
pg_dump -T logs ma_base > sauvegarde.sql
```

**Sauvegarder uniquement un sch√©ma** :
```bash
pg_dump -n public ma_base > public_schema.sql
```

**Exclure un sch√©ma** :
```bash
pg_dump -N ancien_schema ma_base > sauvegarde.sql
```

#### Options de Compression

**Compression avec format custom (compression int√©gr√©e)** :
```bash
pg_dump -Fc ma_base > sauvegarde.dump
```

**Sp√©cifier le niveau de compression (0-9)** :
```bash
pg_dump -Fc -Z 9 ma_base > sauvegarde.dump
# 0 = pas de compression
# 9 = compression maximale (plus lent)
# 6 = d√©faut (bon compromis)
```

**Compression avec gzip (format plain)** :
```bash
pg_dump ma_base | gzip > sauvegarde.sql.gz
```

#### Options de Performance

**Mode verbose (afficher la progression)** :
```bash
pg_dump -v ma_base > sauvegarde.sql
```

**Parall√©lisation (uniquement avec format directory)** :
```bash
pg_dump -Fd -j 4 ma_base -f /sauvegarde/
# -j 4 = utiliser 4 processus parall√®les
```

### Exemples Pratiques de pg_dump

#### Exemple 1 : Sauvegarde Compl√®te Standard
```bash
pg_dump -U postgres -Fc -v ma_base -f /backups/ma_base_$(date +%Y%m%d).dump
```
- Format custom compress√©
- Utilisateur postgres
- Mode verbose
- Nom de fichier avec date

#### Exemple 2 : Sauvegarde Structure Seulement
```bash
pg_dump -U admin --schema-only -Fc production_db -f schema_prod.dump
```
- Sauvegarde uniquement le sch√©ma (DDL)
- Utile pour cloner la structure vers un environnement de test

#### Exemple 3 : Sauvegarde d'un Sch√©ma Sp√©cifique
```bash
pg_dump -n ventes -Fc ecommerce_db -f ventes_schema.dump
```
- Sauvegarde uniquement le sch√©ma "ventes"

#### Exemple 4 : Sauvegarde Haute Performance
```bash
pg_dump -Fd -j 8 -v huge_database -f /backups/huge_db/
```
- Format directory pour permettre la parall√©lisation
- 8 processus parall√®les
- Mode verbose pour suivre la progression

#### Exemple 5 : Sauvegarde avec Exclusions
```bash
pg_dump -T logs -T temp_* -Fc app_db -f app_db_clean.dump
```
- Exclut la table "logs"
- Exclut toutes les tables commen√ßant par "temp_"

---

## pg_dumpall : Sauvegarde de Toutes les Bases

### Qu'est-ce que pg_dumpall ?

`pg_dumpall` est l'outil pour cr√©er une sauvegarde logique de **toutes les bases de donn√©es** d'une instance PostgreSQL (cluster), incluant les objets globaux qui ne sont pas sp√©cifiques √† une base de donn√©es.

### Diff√©rences avec pg_dump

| Aspect | pg_dump | pg_dumpall |
|--------|---------|------------|
| **Port√©e** | Une seule base de donn√©es | Toutes les bases du cluster |
| **Objets globaux** | Non inclus | Inclus (r√¥les, tablespaces) |
| **Format** | Plain, Custom, Directory, Tar | Plain uniquement |
| **Compression** | Oui (custom, directory) | Non native (utiliser gzip) |
| **Restauration** | psql ou pg_restore | psql uniquement |
| **Parall√©lisation** | Oui (directory) | Non |

### Objets Globaux Sauvegard√©s

`pg_dumpall` sauvegarde les objets qui existent au niveau du cluster PostgreSQL :

- **R√¥les (utilisateurs et groupes)** : Tous les comptes avec leurs permissions
- **Tablespaces** : D√©finitions des emplacements de stockage personnalis√©s
- **Configuration globale** : Certains param√®tres au niveau cluster
- **Databases** : La liste et d√©finition de toutes les bases

### Syntaxe de Base

```bash
pg_dumpall [options] > fichier_sauvegarde.sql
```

**Exemple simple** :
```bash
pg_dumpall -U postgres > sauvegarde_complete.sql
```

### Pourquoi Utiliser pg_dumpall ?

**Sc√©narios typiques** :

1. **Migration compl√®te** : Vous devez migrer toutes vos bases vers un nouveau serveur
2. **Sauvegarde des r√¥les** : Vous voulez sauvegarder les utilisateurs et leurs permissions
3. **Disaster recovery global** : Besoin de restaurer l'int√©gralit√© du cluster
4. **Clone d'environnement** : R√©pliquer un environnement complet (dev ‚Üí staging)

### Options Importantes de pg_dumpall

#### Sauvegarder Uniquement les Objets Globaux

```bash
pg_dumpall --globals-only -U postgres > globals.sql
```

**Contenu typique** :
```sql
-- Roles
CREATE ROLE admin LOGIN PASSWORD 'md5...';
CREATE ROLE readonly NOLOGIN;

-- Tablespaces
CREATE TABLESPACE fast_storage LOCATION '/mnt/ssd/pg_data';

-- Database creation
CREATE DATABASE production WITH OWNER = admin;
```

**Cas d'usage** : Vous avez d√©j√† des sauvegardes individuelles de chaque base (pg_dump) et vous voulez juste sauvegarder les r√¥les et tablespaces.

#### Sauvegarder Uniquement les R√¥les

```bash
pg_dumpall --roles-only -U postgres > roles.sql
```

**Cas d'usage** : Synchroniser les utilisateurs entre diff√©rents environnements.

#### Sauvegarder Uniquement les Tablespaces

```bash
pg_dumpall --tablespaces-only -U postgres > tablespaces.sql
```

#### Options de Connexion

Identiques √† `pg_dump` :
```bash
pg_dumpall -h localhost -p 5432 -U postgres > sauvegarde.sql
```

#### Mode Verbose

```bash
pg_dumpall -v -U postgres > sauvegarde.sql
```

### Exemples Pratiques de pg_dumpall

#### Exemple 1 : Sauvegarde Compl√®te du Cluster
```bash
pg_dumpall -U postgres -v | gzip > /backups/cluster_complet_$(date +%Y%m%d).sql.gz
```
- Sauvegarde toutes les bases et objets globaux
- Compression avec gzip
- Nom de fichier avec date

#### Exemple 2 : Sauvegarde des R√¥les pour Synchronisation
```bash
pg_dumpall --roles-only -U postgres > /sync/roles_prod.sql
```
- Sauvegarde uniquement les r√¥les
- Peut √™tre appliqu√© sur un autre serveur

#### Exemple 3 : Sauvegarde Globaux + Bases Individuelles
```bash
# √âtape 1 : Sauvegarder les globaux
pg_dumpall --globals-only -U postgres > globals.sql

# √âtape 2 : Sauvegarder chaque base individuellement
pg_dump -Fc db1 -f db1.dump
pg_dump -Fc db2 -f db2.dump
pg_dump -Fc db3 -f db3.dump
```
**Avantage** : Combine la flexibilit√© de pg_dump (format custom, compression) avec la sauvegarde des objets globaux.

---

## Restauration des Sauvegardes Logiques

### Restaurer une Sauvegarde pg_dump

#### Format Plain Text

```bash
psql -U postgres -d ma_base < sauvegarde.sql
```

**Cr√©er d'abord la base si n√©cessaire** :
```bash
createdb ma_base
psql -U postgres -d ma_base < sauvegarde.sql
```

**Si la sauvegarde inclut CREATE DATABASE** :
```bash
psql -U postgres < sauvegarde.sql
```

#### Format Custom, Directory ou Tar (pg_restore)

```bash
pg_restore -d ma_base -U postgres sauvegarde.dump
```

**Options utiles de pg_restore** :

**Restauration avec nettoyage pr√©alable** :
```bash
pg_restore -d ma_base --clean sauvegarde.dump
```

**Restauration parall√©lis√©e** :
```bash
pg_restore -d ma_base -j 4 repertoire_sauvegarde/
```

**Restauration s√©lective (une seule table)** :
```bash
pg_restore -d ma_base -t clients sauvegarde.dump
```

**Liste du contenu d'une sauvegarde** :
```bash
pg_restore --list sauvegarde.dump
```

### Restaurer une Sauvegarde pg_dumpall

```bash
psql -U postgres -f sauvegarde_complete.sql
```

**Si compress√©e avec gzip** :
```bash
gunzip -c sauvegarde_complete.sql.gz | psql -U postgres
```

**Ordre de restauration** :

1. Les objets globaux (r√¥les, tablespaces) sont cr√©√©s en premier
2. Puis chaque base de donn√©es est cr√©√©e
3. Enfin, le contenu de chaque base est restaur√©

---

## Bonnes Pratiques

### 1. Strat√©gie de Nommage

Utilisez des noms de fichiers explicites avec horodatage :

```bash
# Bonnes pratiques de nommage
ma_base_20251122_0300.dump           # Base + Date + Heure
production_schema_20251122.sql       # Environnement + Type + Date
cluster_full_20251122.sql.gz         # Port√©e + Date
```

### 2. Automatisation avec Cron

**Script de sauvegarde automatique** :
```bash
#!/bin/bash
# /usr/local/bin/backup_postgres.sh

DATE=$(date +%Y%m%d_%H%M)
BACKUP_DIR="/backups/postgresql"
RETENTION_DAYS=7

# Sauvegarde compl√®te
pg_dump -U postgres -Fc production_db -f "${BACKUP_DIR}/production_${DATE}.dump"

# Nettoyage des anciennes sauvegardes
find ${BACKUP_DIR} -name "production_*.dump" -mtime +${RETENTION_DAYS} -delete

# Log
echo "Backup completed: production_${DATE}.dump" >> ${BACKUP_DIR}/backup.log
```

**T√¢che cron (tous les jours √† 3h du matin)** :
```bash
0 3 * * * /usr/local/bin/backup_postgres.sh
```

### 3. Test de Restauration

**Ne jamais consid√©rer une sauvegarde valide sans l'avoir test√©e !**

```bash
# Cr√©er une base de test
createdb test_restore

# Tester la restauration
pg_restore -d test_restore sauvegarde.dump

# V√©rifier l'int√©grit√©
psql -d test_restore -c "SELECT count(*) FROM clients;"

# Nettoyer
dropdb test_restore
```

### 4. V√©rification d'Int√©grit√©

```bash
# V√©rifier qu'un fichier de sauvegarde custom n'est pas corrompu
pg_restore --list sauvegarde.dump > /dev/null
# Si aucune erreur, le fichier est valide
```

### 5. Compression et Espace Disque

**Toujours surveiller l'espace disque disponible** :

```bash
# V√©rifier avant sauvegarde
df -h /backups

# Compresser les anciennes sauvegardes plain text
gzip /backups/old_backup.sql
```

### 6. S√©curit√© des Sauvegardes

**Permissions restrictives** :
```bash
# Les sauvegardes peuvent contenir des donn√©es sensibles
chmod 600 sauvegarde.dump
chown postgres:postgres sauvegarde.dump
```

**Chiffrement** :
```bash
# Chiffrer une sauvegarde avec GPG
pg_dump ma_base | gpg --encrypt --recipient admin@company.com > sauvegarde.sql.gpg

# D√©chiffrer pour restaurer
gpg --decrypt sauvegarde.sql.gpg | psql ma_base
```

### 7. Strat√©gie Hybride (Recommand√©e)

Pour un environnement de production, combinez pg_dump et pg_dumpall :

```bash
#!/bin/bash
BACKUP_DIR="/backups/$(date +%Y%m%d)"
mkdir -p ${BACKUP_DIR}

# 1. Sauvegarder les objets globaux
pg_dumpall --globals-only > ${BACKUP_DIR}/globals.sql

# 2. Sauvegarder chaque base individuellement en format custom
for DB in $(psql -U postgres -t -c "SELECT datname FROM pg_database WHERE datistemplate = false AND datname != 'postgres'")
do
    pg_dump -U postgres -Fc ${DB} -f ${BACKUP_DIR}/${DB}.dump
done

# 3. Compresser le tout
tar czf backups_$(date +%Y%m%d).tar.gz ${BACKUP_DIR}/
```

### 8. Surveillance et Alertes

**V√©rifier le succ√®s de la sauvegarde** :
```bash
#!/bin/bash
pg_dump -U postgres -Fc production_db -f /backups/prod.dump

if [ $? -eq 0 ]; then
    echo "Backup successful" | mail -s "Backup OK" admin@company.com
else
    echo "Backup FAILED" | mail -s "BACKUP FAILED" admin@company.com
fi
```

---

## Comparaison : pg_dump vs pg_dumpall

### Quand Utiliser pg_dump ?

- ‚úÖ Sauvegarde d'une base sp√©cifique
- ‚úÖ Besoin de compression native
- ‚úÖ Besoin de restauration parall√©lis√©e
- ‚úÖ Besoin de restauration s√©lective (tables sp√©cifiques)
- ‚úÖ Sauvegardes fr√©quentes de bases individuelles
- ‚úÖ Migration d'une base vers un autre serveur

### Quand Utiliser pg_dumpall ?

- ‚úÖ Sauvegarde compl√®te du cluster
- ‚úÖ Besoin de sauvegarder les r√¥les et permissions
- ‚úÖ Besoin de sauvegarder les tablespaces
- ‚úÖ Migration compl√®te d'un serveur
- ‚úÖ Clonage complet d'un environnement
- ‚úÖ Disaster recovery global

### Recommandation G√©n√©rale

Pour la plupart des environnements de production :

1. **Quotidien** : `pg_dump` de chaque base critique en format custom
2. **Hebdomadaire** : `pg_dumpall --globals-only` pour les objets globaux
3. **Compl√©mentaire** : Sauvegardes physiques (pg_basebackup) pour PITR

---

## Limitations et Consid√©rations

### Limitations des Sauvegardes Logiques

1. **Performance** : Pour des bases de plusieurs centaines de Go, les sauvegardes logiques peuvent √™tre tr√®s longues (plusieurs heures).

2. **Coh√©rence entre bases** : `pg_dumpall` ne garantit pas une coh√©rence transactionnelle entre diff√©rentes bases du cluster.

3. **Large Objects** : Les objets de type BLOB (Large Objects) peuvent poser des probl√®mes de performance.

4. **Downtime pour restauration** : La restauration peut prendre beaucoup de temps (rejeu de toutes les commandes SQL).

5. **Extensions** : Certaines extensions (notamment avec code C) doivent √™tre r√©install√©es manuellement sur le serveur cible.

### Consid√©rations Techniques

**Taille de la base vs Temps de sauvegarde** :

| Taille Base | Temps pg_dump (approx) | Recommandation |
|-------------|------------------------|----------------|
| < 10 GB     | Minutes               | pg_dump suffisant |
| 10-100 GB   | 30min - 2h            | pg_dump + compression |
| 100-500 GB  | 2h - 8h               | pg_dump -Fd avec parall√©lisation |
| > 500 GB    | > 8h                  | Consid√©rer sauvegardes physiques |

**Connexions durant la sauvegarde** :

- `pg_dump` n'emp√™che **pas** les autres connexions
- `pg_dump` ne bloque **pas** les √©critures
- `pg_dump` peut l√©g√®rement impacter les performances (CPU, I/O, m√©moire)
- Il est recommand√© de faire les sauvegardes durant les heures creuses

**Verrouillage** :

- `pg_dump` acquiert un verrou `ACCESS SHARE` (le moins restrictif)
- Les √©critures continuent normalement pendant le dump
- Certaines op√©rations DDL peuvent √™tre bloqu√©es (ALTER TABLE, DROP TABLE)

---

## Cas d'Usage R√©els

### Cas 1 : Sauvegarde Quotidienne d'une Application Web

**Contexte** : Base de donn√©es de 50 GB, application e-commerce.

**Solution** :
```bash
# Script ex√©cut√© √† 2h du matin via cron
pg_dump -Fc -Z6 -v ecommerce_db -f /backups/ecommerce_$(date +%Y%m%d).dump

# Rotation : garder 7 jours localement
find /backups -name "ecommerce_*.dump" -mtime +7 -delete

# Upload vers S3 pour archivage long terme
aws s3 cp /backups/ecommerce_$(date +%Y%m%d).dump s3://company-backups/postgres/
```

### Cas 2 : Migration de Serveur

**Contexte** : Migration d'un serveur PostgreSQL 15 vers PostgreSQL 18.

**Solution** :
```bash
# Sur l'ancien serveur (PG 15)
pg_dumpall -U postgres > /tmp/full_migration.sql

# Transf√©rer le fichier
scp /tmp/full_migration.sql new_server:/tmp/

# Sur le nouveau serveur (PG 18)
psql -U postgres -f /tmp/full_migration.sql
```

### Cas 3 : Clonage d'Environnement Dev ‚Üí Staging

**Contexte** : Besoin de rafra√Æchir l'environnement de staging avec les donn√©es de d√©veloppement.

**Solution** :
```bash
# Sur serveur dev
pg_dump -Fc dev_database -f /tmp/dev_snapshot.dump

# Copier vers staging
scp /tmp/dev_snapshot.dump staging_server:/tmp/

# Sur staging : nettoyer et restaurer
dropdb staging_database
createdb staging_database
pg_restore -d staging_database /tmp/dev_snapshot.dump
```

### Cas 4 : Sauvegarde Avant Modification Majeure

**Contexte** : D√©ploiement d'une migration de sch√©ma risqu√©e en production.

**Solution** :
```bash
# Sauvegarde de s√©curit√© imm√©diate
pg_dump -Fc production_db -f /backups/pre_migration_$(date +%Y%m%d_%H%M%S).dump

# Appliquer la migration
psql production_db -f migration_v2.5.sql

# Si probl√®me : rollback
pg_restore -d production_db --clean /backups/pre_migration_*.dump
```

---

## Points Cl√©s √† Retenir

### Pour pg_dump :

- üìå Sauvegarde **une seule base de donn√©es** √† la fois
- üìå Offre plusieurs **formats** (plain, custom, directory, tar)
- üìå Le format **custom est recommand√©** (compression, flexibilit√©)
- üìå Permet la **parall√©lisation** avec le format directory
- üìå Capture un **instantan√© coh√©rent** gr√¢ce √† MVCC
- üìå **N'inclut pas** les objets globaux (r√¥les, tablespaces)

### Pour pg_dumpall :

- üìå Sauvegarde **toutes les bases** du cluster
- üìå Inclut les **objets globaux** (r√¥les, tablespaces)
- üìå Format **plain text uniquement**
- üìå Utile pour les **migrations compl√®tes**
- üìå Peut √™tre utilis√© avec `--globals-only` pour sauvegarder uniquement les r√¥les et tablespaces

### Bonnes Pratiques Universelles :

- ‚úÖ **Testez vos restaurations** r√©guli√®rement
- ‚úÖ **Automatisez** vos sauvegardes avec cron
- ‚úÖ **Surveillez** l'espace disque
- ‚úÖ **Compressez** vos sauvegardes
- ‚úÖ **S√©curisez** vos fichiers de sauvegarde (permissions, chiffrement)
- ‚úÖ **Documentez** votre strat√©gie de sauvegarde
- ‚úÖ **Appliquez une rotation** (ne gardez pas toutes les sauvegardes ind√©finiment)
- ‚úÖ Combinez sauvegardes logiques et physiques pour une strat√©gie compl√®te

---

## Ressources Compl√©mentaires

### Documentation Officielle

- [pg_dump Documentation](https://www.postgresql.org/docs/current/app-pgdump.html)
- [pg_dumpall Documentation](https://www.postgresql.org/docs/current/app-pg-dumpall.html)
- [pg_restore Documentation](https://www.postgresql.org/docs/current/app-pgrestore.html)

### Commandes de R√©f√©rence Rapide

```bash
# pg_dump - Formats courants
pg_dump -Fc dbname > backup.dump          # Format custom
pg_dump -Fd dbname -f backup/             # Format directory
pg_dump dbname > backup.sql               # Format plain text

# pg_dumpall - Usage typique
pg_dumpall > full_backup.sql              # Sauvegarde compl√®te
pg_dumpall --globals-only > globals.sql   # Objets globaux seulement
pg_dumpall --roles-only > roles.sql       # R√¥les seulement

# Restauration
psql dbname < backup.sql                  # Plain text
pg_restore -d dbname backup.dump          # Custom/Directory/Tar
```

---


‚è≠Ô∏è [Sauvegardes physiques (pg_basebackup)](/16-administration-configuration-securite/11.2-sauvegardes-physiques.md)
