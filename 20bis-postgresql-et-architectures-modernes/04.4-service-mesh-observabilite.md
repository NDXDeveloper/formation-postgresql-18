ğŸ” Retour au [Sommaire](/SOMMAIRE.md)

# 20bis.4.4. Service Mesh et ObservabilitÃ©

## Introduction

ExÃ©cuter PostgreSQL sur Kubernetes en production nÃ©cessite bien plus que le simple dÃ©ploiement d'un cluster. Vous devez pouvoir **observer** ce qui se passe (mÃ©triques, logs, traces) et **sÃ©curiser** les communications entre vos services.

Ce chapitre explore deux concepts complÃ©mentaires :
- Les **Service Meshes** : une couche d'infrastructure qui gÃ¨re la communication entre services
- L'**ObservabilitÃ©** : la capacitÃ© Ã  comprendre l'Ã©tat interne de votre systÃ¨me Ã  partir de ses sorties

Ces outils sont essentiels pour opÃ©rer PostgreSQL de maniÃ¨re fiable dans un environnement Kubernetes de production.

---

## Partie 1 : Service Mesh

### Qu'est-ce qu'un Service Mesh ?

Un **Service Mesh** est une couche d'infrastructure dÃ©diÃ©e qui gÃ¨re la communication service-Ã -service dans un environnement de microservices.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    SANS SERVICE MESH                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚   â”‚ Service â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ Service â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚PostgreSQLâ”‚          â”‚
â”‚   â”‚    A    â”‚           â”‚    B    â”‚           â”‚         â”‚           â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                                                     â”‚
â”‚   ProblÃ¨mes :                                                       â”‚
â”‚   â€¢ Communication non chiffrÃ©e                                      â”‚
â”‚   â€¢ Pas de retry/timeout automatique                                â”‚
â”‚   â€¢ Pas de mÃ©triques de communication                               â”‚
â”‚   â€¢ Chaque service doit implÃ©menter sa propre logique rÃ©seau        â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    AVEC SERVICE MESH                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚   Service A     â”‚   â”‚   Service B     â”‚   â”‚   PostgreSQL    â”‚   â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚   â”‚   â”‚   App   â”‚   â”‚   â”‚   â”‚   App   â”‚   â”‚   â”‚   â”‚   DB    â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜   â”‚   â”‚   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜   â”‚   â”‚   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”   â”‚   â”‚   â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”   â”‚   â”‚   â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”   â”‚   â”‚
â”‚   â”‚   â”‚ Sidecar â”‚   â”‚   â”‚   â”‚ Sidecar â”‚   â”‚   â”‚   â”‚ Sidecar â”‚   â”‚   â”‚
â”‚   â”‚   â”‚ Proxy   â”‚   â”‚   â”‚   â”‚ Proxy   â”‚   â”‚   â”‚   â”‚ Proxy   â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜   â”‚   â”‚   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜   â”‚   â”‚   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚            â”‚                     â”‚                     â”‚            â”‚
â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                    Communication mTLS automatique                   â”‚
â”‚                    MÃ©triques, retry, circuit breaker                â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### FonctionnalitÃ©s d'un Service Mesh

| FonctionnalitÃ© | Description | BÃ©nÃ©fice pour PostgreSQL |
|----------------|-------------|-------------------------|
| **mTLS** | Chiffrement mutuel automatique | Connexions DB sÃ©curisÃ©es |
| **Traffic Management** | Routing, load balancing | Distribution vers replicas |
| **ObservabilitÃ©** | MÃ©triques, traces automatiques | Monitoring des connexions |
| **Resiliency** | Retry, timeout, circuit breaker | Gestion des pannes |
| **Policy** | ContrÃ´le d'accÃ¨s | Qui peut accÃ©der Ã  la DB |

### Les Principaux Service Meshes

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    COMPARAISON DES SERVICE MESHES                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  ISTIO                                                              â”‚
â”‚  â•â•â•â•â•                                                              â”‚
â”‚  â€¢ Le plus complet et le plus utilisÃ©                               â”‚
â”‚  â€¢ BasÃ© sur Envoy Proxy                                             â”‚
â”‚  â€¢ FonctionnalitÃ©s trÃ¨s riches                                      â”‚
â”‚  â€¢ Complexe Ã  configurer et opÃ©rer                                  â”‚
â”‚  â€¢ Consommation de ressources Ã©levÃ©e                                â”‚
â”‚                                                                     â”‚
â”‚  LINKERD                                                            â”‚
â”‚  â•â•â•â•â•â•â•                                                            â”‚
â”‚  â€¢ Plus lÃ©ger et plus simple                                        â”‚
â”‚  â€¢ Projet CNCF graduated                                            â”‚
â”‚  â€¢ Proxy en Rust (performant)                                       â”‚
â”‚  â€¢ Facile Ã  dÃ©marrer                                                â”‚
â”‚  â€¢ Moins de fonctionnalitÃ©s qu'Istio                                â”‚
â”‚                                                                     â”‚
â”‚  CILIUM (Service Mesh)                                              â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                                               â”‚
â”‚  â€¢ BasÃ© sur eBPF (kernel-level)                                     â”‚
â”‚  â€¢ TrÃ¨s performant                                                  â”‚
â”‚  â€¢ Aussi CNI (rÃ©seau Kubernetes)                                    â”‚
â”‚  â€¢ Adoption croissante                                              â”‚
â”‚                                                                     â”‚
â”‚  CONSUL CONNECT                                                     â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                                                    â”‚
â”‚  â€¢ Par HashiCorp                                                    â”‚
â”‚  â€¢ IntÃ©gration avec l'Ã©cosystÃ¨me HashiCorp                          â”‚
â”‚  â€¢ Service discovery intÃ©grÃ©                                        â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Service Mesh et PostgreSQL : ConsidÃ©rations SpÃ©ciales

PostgreSQL utilise un protocole binaire sur TCP, ce qui pose des dÃ©fis particuliers avec les service meshes :

```
DÃ‰FIS DU SERVICE MESH AVEC POSTGRESQL
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                     â”‚
â”‚  1. PROTOCOLE BINAIRE                                               â”‚
â”‚     PostgreSQL n'est pas HTTP - le proxy doit gÃ©rer TCP pur         â”‚
â”‚                                                                     â”‚
â”‚  2. CONNEXIONS LONGUE DURÃ‰E                                         â”‚
â”‚     Les connexions DB durent souvent des heures                     â”‚
â”‚     (contrairement aux requÃªtes HTTP Ã©phÃ©mÃ¨res)                     â”‚
â”‚                                                                     â”‚
â”‚  3. Ã‰TAT DE SESSION                                                 â”‚
â”‚     Transactions, prepared statements, variables de session         â”‚
â”‚     â†’ Ne peut pas changer de backend en cours de route              â”‚
â”‚                                                                     â”‚
â”‚  4. RÃ‰PLICATION                                                     â”‚
â”‚     Le trafic de rÃ©plication streaming doit Ãªtre traitÃ©             â”‚
â”‚     diffÃ©remment du trafic client                                   â”‚
â”‚                                                                     â”‚
â”‚  5. PERFORMANCE                                                     â”‚
â”‚     Latence ajoutÃ©e par le proxy peut impacter les perfs            â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Istio avec PostgreSQL

#### Architecture

```
                    ISTIO AVEC POSTGRESQL
                    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         KUBERNETES CLUSTER                       â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                     ISTIO CONTROL PLANE                    â”‚  â”‚
â”‚  â”‚                                                            â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚  â”‚
â”‚  â”‚  â”‚  Istiod â”‚  â”‚  Pilot  â”‚  â”‚ Citadel â”‚                     â”‚  â”‚
â”‚  â”‚  â”‚         â”‚  â”‚         â”‚  â”‚ (mTLS)  â”‚                     â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                              â”‚                                   â”‚
â”‚                              â”‚ Configure                         â”‚
â”‚                              â–¼                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                      DATA PLANE                            â”‚  â”‚
â”‚  â”‚                                                            â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚  â”‚
â”‚  â”‚  â”‚     Application     â”‚     â”‚     PostgreSQL      â”‚       â”‚  â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚     â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚       â”‚  â”‚
â”‚  â”‚  â”‚  â”‚  App Container â”‚ â”‚     â”‚  â”‚  PG Container â”‚  â”‚       â”‚  â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚     â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚       â”‚  â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”  â”‚     â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”  â”‚       â”‚  â”‚
â”‚  â”‚  â”‚  â”‚ Envoy Sidecar â”‚â—„â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â–ºâ”‚ Envoy Sidecar â”‚  â”‚       â”‚  â”‚
â”‚  â”‚  â”‚  â”‚    (proxy)    â”‚  â”‚     â”‚  â”‚    (proxy)    â”‚  â”‚       â”‚  â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚     â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚       â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚  â”‚
â”‚  â”‚                                                            â”‚  â”‚
â”‚  â”‚            mTLS automatique entre les sidecars             â”‚  â”‚
â”‚  â”‚                                                            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Configuration Istio pour PostgreSQL

##### 1. Activer l'Injection de Sidecar

```yaml
# Activer l'injection dans le namespace
apiVersion: v1
kind: Namespace
metadata:
  name: postgres
  labels:
    istio-injection: enabled
```

##### 2. DestinationRule pour PostgreSQL

```yaml
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: postgres-destination
  namespace: postgres
spec:
  host: postgres-primary.postgres.svc.cluster.local
  trafficPolicy:
    connectionPool:
      tcp:
        maxConnections: 100
        connectTimeout: 10s
        tcpKeepalive:
          time: 7200s
          interval: 75s
    tls:
      mode: ISTIO_MUTUAL    # mTLS automatique
```

##### 3. VirtualService pour le Traffic Management

```yaml
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: postgres-routing
  namespace: postgres
spec:
  hosts:
    - postgres.postgres.svc.cluster.local
  tcp:
    - match:
        - port: 5432
      route:
        - destination:
            host: postgres-primary.postgres.svc.cluster.local
            port:
              number: 5432
          weight: 100
```

##### 4. SÃ©parer le Trafic Lecture/Ã‰criture

```yaml
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: postgres-read-write-split
  namespace: postgres
spec:
  hosts:
    - postgres-rw.postgres.svc.cluster.local
  tcp:
    - route:
        - destination:
            host: postgres-primary.postgres.svc.cluster.local
            port:
              number: 5432

---
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: postgres-readonly
  namespace: postgres
spec:
  hosts:
    - postgres-ro.postgres.svc.cluster.local
  tcp:
    - route:
        - destination:
            host: postgres-replica.postgres.svc.cluster.local
            port:
              number: 5432
```

##### 5. PeerAuthentication (mTLS Strict)

```yaml
apiVersion: security.istio.io/v1beta1
kind: PeerAuthentication
metadata:
  name: postgres-mtls
  namespace: postgres
spec:
  selector:
    matchLabels:
      app: postgres
  mtls:
    mode: STRICT    # Forcer mTLS pour toutes les connexions
```

##### 6. AuthorizationPolicy (ContrÃ´le d'AccÃ¨s)

```yaml
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: postgres-access
  namespace: postgres
spec:
  selector:
    matchLabels:
      app: postgres
  action: ALLOW
  rules:
    - from:
        - source:
            principals:
              - cluster.local/ns/app-namespace/sa/app-service-account
      to:
        - operation:
            ports: ["5432"]
```

#### Exclure la RÃ©plication du Mesh

La rÃ©plication PostgreSQL peut nÃ©cessiter d'Ãªtre exclue du service mesh :

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: postgres-replica
  annotations:
    # Exclure le port de rÃ©plication du proxy
    traffic.sidecar.istio.io/excludeOutboundPorts: "5432"
    # Ou exclure des IPs spÃ©cifiques
    traffic.sidecar.istio.io/excludeOutboundIPRanges: "10.0.0.0/8"
spec:
  # ...
```

### Linkerd avec PostgreSQL

Linkerd est plus simple Ã  configurer pour PostgreSQL car il gÃ¨re bien le trafic TCP par dÃ©faut.

#### Installation

```bash
# Installer le CLI
curl -sL https://run.linkerd.io/install | sh
export PATH=$PATH:$HOME/.linkerd2/bin

# VÃ©rifier les prÃ©requis
linkerd check --pre

# Installer Linkerd
linkerd install | kubectl apply -f -

# VÃ©rifier l'installation
linkerd check
```

#### Injecter Linkerd dans le Namespace PostgreSQL

```bash
# MÃ©thode 1 : Annotation du namespace
kubectl annotate namespace postgres linkerd.io/inject=enabled

# MÃ©thode 2 : Injecter manuellement
kubectl get deploy -n postgres -o yaml | linkerd inject - | kubectl apply -f -
```

#### ServiceProfile pour PostgreSQL

```yaml
apiVersion: linkerd.io/v1alpha2
kind: ServiceProfile
metadata:
  name: postgres-primary.postgres.svc.cluster.local
  namespace: postgres
spec:
  # Pas de routes HTTP pour PostgreSQL (TCP pur)
  # Les mÃ©triques TCP sont automatiques
```

#### Server et ServerAuthorization (mTLS)

```yaml
apiVersion: policy.linkerd.io/v1beta1
kind: Server
metadata:
  name: postgres-server
  namespace: postgres
spec:
  podSelector:
    matchLabels:
      app: postgres
  port: 5432
  proxyProtocol: opaque    # TCP pur, pas HTTP

---
apiVersion: policy.linkerd.io/v1beta1
kind: ServerAuthorization
metadata:
  name: postgres-authz
  namespace: postgres
spec:
  server:
    name: postgres-server
  client:
    meshTLS:
      serviceAccounts:
        - name: app-service-account
          namespace: app-namespace
```

### Quand Utiliser un Service Mesh pour PostgreSQL ?

```
ARBRE DE DÃ‰CISION
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Avez-vous des exigences de sÃ©curitÃ© strictes (compliance) ?
â”‚
â”œâ”€â”€ OUI â”€â”€â–º Service Mesh recommandÃ© (mTLS, audit)
â”‚
â””â”€â”€ NON
    â”‚
    Avez-vous de nombreux services communiquant avec PostgreSQL ?
    â”‚
    â”œâ”€â”€ OUI â”€â”€â–º Service Mesh bÃ©nÃ©fique (observabilitÃ©, policy)
    â”‚
    â””â”€â”€ NON
        â”‚
        La latence ajoutÃ©e est-elle acceptable ? (~1-2ms)
        â”‚
        â”œâ”€â”€ OUI â”€â”€â–º Service Mesh peut Ãªtre utile
        â”‚
        â””â”€â”€ NON â”€â”€â–º Ã‰viter le Service Mesh pour PostgreSQL
                    Utiliser TLS natif PostgreSQL
```

---

## Partie 2 : ObservabilitÃ©

### Les Trois Piliers de l'ObservabilitÃ©

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               LES TROIS PILIERS DE L'OBSERVABILITÃ‰                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚         MÃ‰TRIQUES              LOGS              TRACES             â”‚
â”‚         â•â•â•â•â•â•â•â•              â•â•â•â•              â•â•â•â•â•â•              â”‚
â”‚                                                                     â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚     â”‚            â”‚       â”‚            â”‚       â”‚  Service A â”‚        â”‚
â”‚     â”‚  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  â”‚       â”‚ [INFO] ... â”‚       â”‚     â”‚      â”‚        â”‚
â”‚     â”‚  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ    â”‚       â”‚ [WARN] ... â”‚       â”‚     â–¼      â”‚        â”‚
â”‚     â”‚  â–ˆâ–ˆâ–ˆâ–ˆ      â”‚       â”‚ [ERROR]... â”‚       â”‚  Service B â”‚        â”‚
â”‚     â”‚            â”‚       â”‚            â”‚       â”‚     â”‚      â”‚        â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚     â–¼      â”‚        â”‚
â”‚                                               â”‚ PostgreSQL â”‚        â”‚
â”‚     Quantitatif          Qualitatif          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚     "Combien ?"          "Que s'est-il       "Comment la requÃªte    â”‚
â”‚     "Ã€ quelle            passÃ© ?"            a-t-elle traversÃ©      â”‚
â”‚     frÃ©quence ?"                             le systÃ¨me ?"          â”‚
â”‚                                                                     â”‚
â”‚     Outils :             Outils :            Outils :               â”‚
â”‚     Prometheus           Loki                Jaeger                 â”‚
â”‚     Grafana              ELK Stack           Zipkin                 â”‚
â”‚     Datadog              Fluentd             Tempo                  â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### MÃ©triques PostgreSQL avec Prometheus

#### Architecture de Monitoring

```
                    STACK PROMETHEUS/GRAFANA
                    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         KUBERNETES CLUSTER                         â”‚
â”‚                                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                    PROMETHEUS STACK                        â”‚    â”‚
â”‚  â”‚                                                            â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚    â”‚
â”‚  â”‚  â”‚ Prometheus  â”‚  â”‚   Grafana   â”‚  â”‚ Alertmanagerâ”‚         â”‚    â”‚
â”‚  â”‚  â”‚             â”‚  â”‚             â”‚  â”‚             â”‚         â”‚    â”‚
â”‚  â”‚  â”‚ Scrape &    â”‚  â”‚ Visualize   â”‚  â”‚ Route       â”‚         â”‚    â”‚
â”‚  â”‚  â”‚ Store       â”‚  â”‚ & Dashboard â”‚  â”‚ Alerts      â”‚         â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚    â”‚
â”‚  â”‚         â”‚                                                  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚            â”‚ Scrape /metrics                                       â”‚
â”‚            â”‚                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚         â–¼           POSTGRESQL PODS                        â”‚    â”‚
â”‚  â”‚                                                            â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚
â”‚  â”‚  â”‚              postgres-0 (Primary)                    â”‚  â”‚    â”‚
â”‚  â”‚  â”‚                                                      â”‚  â”‚    â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚    â”‚
â”‚  â”‚  â”‚  â”‚ PostgreSQL  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚  postgres_exporter   â”‚   â”‚  â”‚    â”‚
â”‚  â”‚  â”‚  â”‚   :5432     â”‚          â”‚       :9187          â”‚   â”‚  â”‚    â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚    â”‚
â”‚  â”‚  â”‚                                    â”‚                 â”‚  â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚
â”‚  â”‚                                       â”‚                    â”‚    â”‚
â”‚  â”‚                              /metrics â”‚                    â”‚    â”‚
â”‚  â”‚                                       â–¼                    â”‚    â”‚
â”‚  â”‚                              Prometheus scrape             â”‚    â”‚
â”‚  â”‚                                                            â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Installation de la Stack Prometheus

```bash
# Ajouter le repo Helm
helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
helm repo update

# Installer kube-prometheus-stack
helm install prometheus prometheus-community/kube-prometheus-stack \
  --namespace monitoring \
  --create-namespace \
  --set grafana.adminPassword=your-password
```

#### postgres_exporter : L'Exporteur de MÃ©triques

Le **postgres_exporter** expose les mÃ©triques PostgreSQL au format Prometheus.

##### DÃ©ploiement Standalone

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: postgres-exporter
  namespace: postgres
spec:
  replicas: 1
  selector:
    matchLabels:
      app: postgres-exporter
  template:
    metadata:
      labels:
        app: postgres-exporter
    spec:
      containers:
        - name: postgres-exporter
          image: quay.io/prometheuscommunity/postgres-exporter:v0.15.0
          ports:
            - containerPort: 9187
              name: metrics
          env:
            - name: DATA_SOURCE_URI
              value: "postgres-primary.postgres.svc:5432/postgres?sslmode=disable"
            - name: DATA_SOURCE_USER
              valueFrom:
                secretKeyRef:
                  name: postgres-credentials
                  key: username
            - name: DATA_SOURCE_PASS
              valueFrom:
                secretKeyRef:
                  name: postgres-credentials
                  key: password
          resources:
            requests:
              cpu: 100m
              memory: 128Mi
            limits:
              cpu: 200m
              memory: 256Mi

---
apiVersion: v1
kind: Service
metadata:
  name: postgres-exporter
  namespace: postgres
  labels:
    app: postgres-exporter
spec:
  ports:
    - port: 9187
      targetPort: 9187
      name: metrics
  selector:
    app: postgres-exporter
```

##### Sidecar dans le Pod PostgreSQL

```yaml
# Ajouter comme sidecar dans le StatefulSet/Operator
spec:
  containers:
    - name: postgres
      image: postgres:16
      # ...

    - name: exporter
      image: quay.io/prometheuscommunity/postgres-exporter:v0.15.0
      ports:
        - containerPort: 9187
          name: metrics
      env:
        - name: DATA_SOURCE_NAME
          value: "postgresql://postgres:password@localhost:5432/postgres?sslmode=disable"
```

#### ServiceMonitor pour Prometheus Operator

```yaml
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: postgres-monitor
  namespace: monitoring
  labels:
    release: prometheus    # Doit matcher le label du Prometheus
spec:
  namespaceSelector:
    matchNames:
      - postgres
  selector:
    matchLabels:
      app: postgres-exporter
  endpoints:
    - port: metrics
      interval: 30s
      path: /metrics
```

#### MÃ©triques PostgreSQL Essentielles

| MÃ©trique | Description | Seuil d'Alerte |
|----------|-------------|----------------|
| `pg_up` | PostgreSQL est accessible | != 1 |
| `pg_database_size_bytes` | Taille de la base | Croissance anormale |
| `pg_stat_activity_count` | Connexions actives | > 80% max_connections |
| `pg_stat_activity_max_tx_duration` | Transaction la plus longue | > 5 minutes |
| `pg_replication_lag` | Retard de rÃ©plication | > 1 seconde |
| `pg_locks_count` | Nombre de verrous | Pics anormaux |
| `pg_stat_bgwriter_buffers_backend` | Ã‰critures directes | Ã‰levÃ© = problÃ¨me |

#### RequÃªtes PersonnalisÃ©es

Vous pouvez ajouter des requÃªtes SQL personnalisÃ©es :

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: postgres-exporter-queries
  namespace: postgres
data:
  queries.yaml: |
    pg_slow_queries:
      query: |
        SELECT COUNT(*) as count
        FROM pg_stat_activity
        WHERE state = 'active'
        AND now() - query_start > interval '5 seconds'
      metrics:
        - count:
            usage: "GAUGE"
            description: "Number of slow queries (>5s)"

    pg_table_bloat:
      query: |
        SELECT schemaname, tablename,
               pg_total_relation_size(schemaname||'.'||tablename) as total_bytes,
               pg_relation_size(schemaname||'.'||tablename) as table_bytes
        FROM pg_tables
        WHERE schemaname NOT IN ('pg_catalog', 'information_schema')
      metrics:
        - schemaname:
            usage: "LABEL"
        - tablename:
            usage: "LABEL"
        - total_bytes:
            usage: "GAUGE"
            description: "Total size including indexes"
        - table_bytes:
            usage: "GAUGE"
            description: "Table size only"
```

### Alertes Prometheus pour PostgreSQL

```yaml
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: postgres-alerts
  namespace: monitoring
spec:
  groups:
    - name: postgresql
      rules:
        # PostgreSQL Down
        - alert: PostgreSQLDown
          expr: pg_up == 0
          for: 1m
          labels:
            severity: critical
          annotations:
            summary: "PostgreSQL instance down"
            description: "PostgreSQL instance {{ $labels.instance }} is down"

        # Connexions Ã©levÃ©es
        - alert: PostgreSQLHighConnections
          expr: |
            pg_stat_activity_count / pg_settings_max_connections * 100 > 80
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "PostgreSQL high connection usage"
            description: "Connection usage is {{ $value }}% on {{ $labels.instance }}"

        # Lag de rÃ©plication
        - alert: PostgreSQLReplicationLag
          expr: pg_replication_lag > 30
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "PostgreSQL replication lag"
            description: "Replication lag is {{ $value }} seconds"

        # Transaction longue
        - alert: PostgreSQLLongTransaction
          expr: pg_stat_activity_max_tx_duration > 300
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "PostgreSQL long running transaction"
            description: "Transaction running for {{ $value }} seconds"

        # Deadlocks
        - alert: PostgreSQLDeadlocks
          expr: increase(pg_stat_database_deadlocks[5m]) > 5
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "PostgreSQL deadlocks detected"
            description: "{{ $value }} deadlocks in last 5 minutes"

        # Cache hit ratio faible
        - alert: PostgreSQLLowCacheHitRatio
          expr: |
            pg_stat_database_blks_hit /
            (pg_stat_database_blks_hit + pg_stat_database_blks_read) < 0.9
          for: 15m
          labels:
            severity: warning
          annotations:
            summary: "PostgreSQL low cache hit ratio"
            description: "Cache hit ratio is {{ $value | humanizePercentage }}"
```

### Dashboards Grafana pour PostgreSQL

#### Dashboard RecommandÃ©

Le dashboard Grafana ID **9628** (PostgreSQL Database) est un excellent point de dÃ©part.

```bash
# Importer via l'API Grafana
curl -X POST http://admin:password@grafana:3000/api/dashboards/import \
  -H "Content-Type: application/json" \
  -d '{
    "dashboard": {
      "id": null,
      "uid": null,
      "title": "PostgreSQL",
      "tags": ["postgresql"],
      "timezone": "browser",
      "schemaVersion": 16,
      "version": 0
    },
    "folderId": 0,
    "overwrite": false,
    "inputs": [],
    "pluginId": "grafana-piechart-panel",
    "gnetId": 9628
  }'
```

#### Panels Essentiels

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    DASHBOARD POSTGRESQL GRAFANA                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚   DB Status     â”‚  â”‚   Connections   â”‚  â”‚  Transactions   â”‚      â”‚
â”‚  â”‚      ğŸŸ¢ UP      â”‚  â”‚     45/100      â”‚  â”‚    1.2K TPS     â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                     Query Performance                       â”‚    â”‚
â”‚  â”‚   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘   â”‚    â”‚
â”‚  â”‚   Avg: 5ms    P95: 25ms    P99: 120ms    Max: 500ms         â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚     Cache Hit Ratio      â”‚  â”‚    Replication Lag       â”‚         â”‚
â”‚  â”‚                          â”‚  â”‚                          â”‚         â”‚
â”‚  â”‚         98.5%            â”‚  â”‚        0.2 sec           â”‚         â”‚
â”‚  â”‚      â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘        â”‚  â”‚      â–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘          â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                   Connections Over Time                     â”‚    â”‚
â”‚  â”‚                                                             â”‚    â”‚
â”‚  â”‚  50â”‚    â•±â•²    â•±â•²                                            â”‚    â”‚
â”‚  â”‚  40â”‚   â•±  â•²  â•±  â•²    â•±â•²                                     â”‚    â”‚
â”‚  â”‚  30â”‚  â•±    â•²â•±    â•²  â•±  â•²                                    â”‚    â”‚
â”‚  â”‚  20â”‚ â•±            â•²â•±    â•²                                   â”‚    â”‚
â”‚  â”‚  10â”‚â•±                    â•²                                  â”‚    â”‚
â”‚  â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚    â”‚
â”‚  â”‚     00:00   06:00   12:00   18:00   00:00                   â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Logs PostgreSQL

#### Configuration des Logs PostgreSQL

```ini
# postgresql.conf
log_destination = 'stderr'
logging_collector = on
log_directory = 'log'
log_filename = 'postgresql-%Y-%m-%d.log'

# Quoi logger
log_min_duration_statement = 1000    # Log requÃªtes > 1s
log_checkpoints = on
log_connections = on
log_disconnections = on
log_lock_waits = on
log_temp_files = 0                    # Log tous les fichiers temp

# Format
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '
```

#### Collecte avec Fluentd/Fluent Bit

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: fluent-bit-config
  namespace: postgres
data:
  fluent-bit.conf: |
    [SERVICE]
        Flush         1
        Log_Level     info
        Daemon        off

    [INPUT]
        Name              tail
        Path              /var/log/postgresql/*.log
        Tag               postgres.*
        Refresh_Interval  5
        Mem_Buf_Limit     5MB

    [FILTER]
        Name          parser
        Match         postgres.*
        Key_Name      log
        Parser        postgres

    [OUTPUT]
        Name          loki
        Match         *
        Host          loki.monitoring.svc
        Port          3100
        Labels        job=postgres, namespace=postgres

  parsers.conf: |
    [PARSER]
        Name          postgres
        Format        regex
        Regex         ^(?<time>\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}\.\d{3} \w+) \[(?<pid>\d+)\]: \[(?<session>\d+-\d+)\] user=(?<user>\w*),db=(?<database>\w*),app=(?<app>.*?),client=(?<client>[\d\.]*) (?<level>\w+):  (?<message>.*)$
        Time_Key      time
        Time_Format   %Y-%m-%d %H:%M:%S.%L %Z
```

#### Visualisation dans Grafana avec Loki

```
LOKI + GRAFANA POUR LES LOGS
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         GRAFANA EXPLORE                          â”‚
â”‚                                                                  â”‚
â”‚  Query: {job="postgres"} |= "ERROR"                              â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ 2024-01-15 10:23:45 ERROR: duplicate key value violates    â”‚  â”‚
â”‚  â”‚ unique constraint "users_email_key"                        â”‚  â”‚
â”‚  â”‚ DETAIL: Key (email)=(test@example.com) already exists.     â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚ 2024-01-15 10:22:12 ERROR: deadlock detected               â”‚  â”‚
â”‚  â”‚ DETAIL: Process 1234 waits for ShareLock on transaction... â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚ 2024-01-15 10:20:33 ERROR: canceling statement due to      â”‚  â”‚
â”‚  â”‚ statement timeout                                          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Traces DistribuÃ©es

Pour les applications qui communiquent avec PostgreSQL, le tracing distribuÃ© permet de suivre une requÃªte Ã  travers tous les services.

#### Architecture avec Jaeger

```
                    TRACING DISTRIBUÃ‰
                    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

     RequÃªte utilisateur
            â”‚
            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      API Gateway      â”‚ â”€â”€â–º Span: "HTTP GET /users"
â”‚   (trace_id: abc123)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     User Service      â”‚ â”€â”€â–º Span: "getUser"
â”‚   (trace_id: abc123)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      PostgreSQL       â”‚ â”€â”€â–º Span: "SELECT * FROM users"
â”‚   (trace_id: abc123)  â”‚     Duration: 5ms
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Dans Jaeger UI :
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Trace: abc123                                    Total: 45msâ”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â”œâ”€â”€ API Gateway (HTTP GET /users)              â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ â”‚
â”‚ â”‚   â””â”€â”€ User Service (getUser)                 â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ     â”‚
â”‚ â”‚       â””â”€â”€ PostgreSQL (SELECT)                â–ˆâ–ˆ           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Instrumentation avec OpenTelemetry

```python
# Exemple Python avec OpenTelemetry
from opentelemetry import trace
from opentelemetry.instrumentation.psycopg2 import Psycopg2Instrumentor

# Instrumenter automatiquement psycopg2
Psycopg2Instrumentor().instrument()

# Les requÃªtes PostgreSQL seront automatiquement tracÃ©es
import psycopg2
conn = psycopg2.connect(...)
cursor = conn.cursor()
cursor.execute("SELECT * FROM users WHERE id = %s", [user_id])
# Cette requÃªte apparaÃ®tra dans les traces !
```

### ObservabilitÃ© avec les Operators PostgreSQL

Les Operators PostgreSQL intÃ¨grent souvent l'observabilitÃ©.

#### CloudNativePG

```yaml
apiVersion: postgresql.cnpg.io/v1
kind: Cluster
metadata:
  name: my-cluster
spec:
  instances: 3

  monitoring:
    enablePodMonitor: true              # CrÃ©e un PodMonitor automatiquement
    customQueriesConfigMap:
      - name: custom-queries
        key: queries

  # Logs structurÃ©s
  postgresql:
    parameters:
      log_destination: "csvlog"
      logging_collector: "on"
```

#### Crunchy PGO

```yaml
apiVersion: postgres-operator.crunchydata.com/v1beta1
kind: PostgresCluster
metadata:
  name: hippo
spec:
  monitoring:
    pgmonitor:
      exporter:
        image: registry.crunchydata.com/crunchydata/crunchy-postgres-exporter:latest
        configuration:
          - configMap:
              name: custom-queries
```

---

## Stack d'ObservabilitÃ© ComplÃ¨te

### Architecture RecommandÃ©e

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 STACK D'OBSERVABILITÃ‰ COMPLÃˆTE                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                      VISUALISATION                           â”‚    â”‚
â”‚  â”‚                                                              â”‚    â”‚
â”‚  â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â”‚    â”‚
â”‚  â”‚                    â”‚   GRAFANA   â”‚                           â”‚    â”‚
â”‚  â”‚                    â”‚             â”‚                           â”‚    â”‚
â”‚  â”‚                    â”‚ Dashboards  â”‚                           â”‚    â”‚
â”‚  â”‚                    â”‚ Alerting    â”‚                           â”‚    â”‚
â”‚  â”‚                    â”‚ Explore     â”‚                           â”‚    â”‚
â”‚  â”‚                    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                           â”‚    â”‚
â”‚  â”‚                          â”‚                                   â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                             â”‚                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                      STOCKAGE                                â”‚    â”‚
â”‚  â”‚                          â”‚                                   â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚    â”‚
â”‚  â”‚  â”‚ PROMETHEUS  â”‚  â”‚    LOKI     â”‚  â”‚   TEMPO     â”‚           â”‚    â”‚
â”‚  â”‚  â”‚             â”‚  â”‚             â”‚  â”‚             â”‚           â”‚    â”‚
â”‚  â”‚  â”‚  MÃ©triques  â”‚  â”‚    Logs     â”‚  â”‚   Traces    â”‚           â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜           â”‚    â”‚
â”‚  â”‚         â”‚                â”‚                â”‚                  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚            â”‚                â”‚                â”‚                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚         â”‚           COLLECTE              â”‚                  â”‚    â”‚
â”‚  â”‚         â”‚                â”‚                â”‚                  â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”           â”‚    â”‚
â”‚  â”‚  â”‚ PG Exporter â”‚  â”‚ Fluent Bit  â”‚  â”‚   OTel      â”‚           â”‚    â”‚
â”‚  â”‚  â”‚   /metrics  â”‚  â”‚   (logs)    â”‚  â”‚  Collector  â”‚           â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜           â”‚    â”‚
â”‚  â”‚         â”‚                â”‚                â”‚                  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚            â”‚                â”‚                â”‚                       â”‚
â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚                             â”‚                                        â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”                               â”‚
â”‚                    â”‚   POSTGRESQL    â”‚                               â”‚
â”‚                    â”‚                 â”‚                               â”‚
â”‚                    â”‚  MÃ©triques      â”‚                               â”‚
â”‚                    â”‚  Logs           â”‚                               â”‚
â”‚                    â”‚  (Traces app)   â”‚                               â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                               â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Installation avec Helm

```bash
# Prometheus + Grafana
helm install prometheus prometheus-community/kube-prometheus-stack \
  --namespace monitoring --create-namespace

# Loki pour les logs
helm install loki grafana/loki-stack \
  --namespace monitoring \
  --set promtail.enabled=true

# Tempo pour les traces
helm install tempo grafana/tempo \
  --namespace monitoring

# Configurer Grafana pour utiliser toutes les sources
kubectl apply -f - <<EOF
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-datasources
  namespace: monitoring
data:
  datasources.yaml: |
    apiVersion: 1
    datasources:
      - name: Prometheus
        type: prometheus
        url: http://prometheus-server:80
        isDefault: true
      - name: Loki
        type: loki
        url: http://loki:3100
      - name: Tempo
        type: tempo
        url: http://tempo:3100
EOF
```

---

## Bonnes Pratiques

### 1. Commencer Simple

```
APPROCHE PROGRESSIVE
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Ã‰tape 1 : MÃ©triques de base
  â””â”€â”€ postgres_exporter + Prometheus + Grafana
  â””â”€â”€ Alertes critiques (down, connexions, lag)

Ã‰tape 2 : Logs centralisÃ©s
  â””â”€â”€ Fluent Bit + Loki
  â””â”€â”€ Recherche et corrÃ©lation

Ã‰tape 3 : Traces (si nÃ©cessaire)
  â””â”€â”€ OpenTelemetry + Tempo/Jaeger
  â””â”€â”€ Pour applications microservices

Ã‰tape 4 : Service Mesh (si nÃ©cessaire)
  â””â”€â”€ Linkerd ou Istio
  â””â”€â”€ Pour sÃ©curitÃ© avancÃ©e
```

### 2. Alertes Actionnables

```yaml
# âœ… BON : Alerte actionnable
- alert: PostgreSQLHighConnections
  expr: pg_stat_activity_count > 80
  annotations:
    runbook_url: https://wiki.company.com/pg-connections
    action: "1. VÃ©rifier les connexions idle 2. Augmenter pool size 3. Contacter DBA"

# âŒ MAUVAIS : Alerte sans contexte
- alert: PostgreSQLAlert
  expr: some_metric > 100
  annotations:
    summary: "Something is wrong"
```

### 3. Retention AppropriÃ©e

| Type de DonnÃ©es | RÃ©tention RecommandÃ©e |
|-----------------|----------------------|
| **MÃ©triques haute rÃ©solution** | 15 jours |
| **MÃ©triques agrÃ©gÃ©es** | 90 jours |
| **Logs** | 30-90 jours |
| **Traces** | 7-14 jours |

### 4. SÃ©curiser l'AccÃ¨s

```yaml
# RBAC pour Grafana
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: grafana-viewer
rules:
  - apiGroups: [""]
    resources: ["configmaps", "secrets"]
    verbs: ["get", "list"]
```

### 5. Documenter les Dashboards

Chaque dashboard devrait inclure :
- Description de son but
- Explication des panels
- Actions recommandÃ©es pour chaque alerte

---

## Conclusion

L'observabilitÃ© et les service meshes sont des composants essentiels pour opÃ©rer PostgreSQL en production sur Kubernetes :

**Service Mesh :**
- Apporte sÃ©curitÃ© (mTLS) et contrÃ´le du trafic
- Ajoute de la complexitÃ© et de la latence
- Ã‰valuer si les bÃ©nÃ©fices justifient les coÃ»ts

**ObservabilitÃ© :**
- Les trois piliers (mÃ©triques, logs, traces) sont complÃ©mentaires
- Commencer par les mÃ©triques avec Prometheus/Grafana
- Ajouter les logs et traces selon les besoins

**Points clÃ©s :**
- L'observabilitÃ© n'est pas optionnelle en production
- Automatiser les alertes et les runbooks
- Tester rÃ©guliÃ¨rement que le monitoring fonctionne
- Adapter la stack Ã  vos besoins rÃ©els

Une bonne observabilitÃ© vous permet de dÃ©tecter et rÃ©soudre les problÃ¨mes avant qu'ils n'impactent vos utilisateurs.

---

## Ressources ComplÃ©mentaires

### Documentation Officielle

- [Istio Documentation](https://istio.io/latest/docs/)
- [Linkerd Documentation](https://linkerd.io/docs/)
- [Prometheus Documentation](https://prometheus.io/docs/)
- [Grafana Documentation](https://grafana.com/docs/)

### Outils

- postgres_exporter
- Grafana dashboards pour PostgreSQL
- Loki et Promtail
- Jaeger / Tempo

### Tutoriels

- Monitoring PostgreSQL with Prometheus
- Istio Service Mesh for Databases
- Building Observability Pipelines

---


â­ï¸ [Conclusion et Perspectives](/21-conclusion-et-perspectives/README.md)
