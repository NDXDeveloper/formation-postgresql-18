ğŸ” Retour au [Sommaire](/SOMMAIRE.md)

# 20bis.4.2. Operators : Zalando, CloudNativePG, Crunchy

## Introduction

Dans le chapitre prÃ©cÃ©dent, nous avons vu que les StatefulSets fournissent les briques de base pour exÃ©cuter PostgreSQL sur Kubernetes : identitÃ© stable, persistance des donnÃ©es et ordre de dÃ©ploiement. Cependant, ils ne gÃ¨rent pas la logique mÃ©tier spÃ©cifique Ã  PostgreSQL.

C'est lÃ  qu'interviennent les **Operators**. Un Operator est un composant qui automatise la gestion complÃ¨te d'une application sur Kubernetes, en encapsulant l'expertise d'un administrateur de base de donnÃ©es dans du code.

Dans ce chapitre, nous explorerons trois Operators PostgreSQL majeurs : **Zalando Postgres Operator**, **CloudNativePG** et **Crunchy Postgres Operator**. Vous comprendrez leurs forces, leurs diffÃ©rences et comment choisir celui qui convient Ã  votre projet.

---

## Qu'est-ce qu'un Operator ?

### Le Concept Fondamental

Un **Operator** est un logiciel qui Ã©tend Kubernetes pour gÃ©rer des applications complexes de maniÃ¨re automatisÃ©e. Il encode les connaissances d'un expert humain dans un contrÃ´leur logiciel.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    LE CONCEPT D'OPERATOR                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚   SANS OPERATOR (Gestion manuelle)                                  â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                  â”‚
â”‚                                                                     â”‚
â”‚   Administrateur humain doit :                                      â”‚
â”‚   â€¢ Configurer la rÃ©plication                                       â”‚
â”‚   â€¢ Surveiller la santÃ© du cluster                                  â”‚
â”‚   â€¢ GÃ©rer les failovers manuellement                                â”‚
â”‚   â€¢ Planifier et exÃ©cuter les backups                               â”‚
â”‚   â€¢ GÃ©rer les mises Ã  jour                                          â”‚
â”‚   â€¢ RÃ©agir aux pannes (souvent la nuit !)                           â”‚
â”‚                                                                     â”‚
â”‚                                                                     â”‚
â”‚   AVEC OPERATOR (Gestion automatisÃ©e)                               â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                               â”‚
â”‚                                                                     â”‚
â”‚   L'Operator fait tout automatiquement :                            â”‚
â”‚   â€¢ Configure la rÃ©plication âœ“                                      â”‚
â”‚   â€¢ Surveille en continu âœ“                                          â”‚
â”‚   â€¢ Failover automatique en secondes âœ“                              â”‚
â”‚   â€¢ Backups planifiÃ©s âœ“                                             â”‚
â”‚   â€¢ Rolling updates âœ“                                               â”‚
â”‚   â€¢ Self-healing 24/7 âœ“                                             â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Le Pattern Operator

Un Operator fonctionne selon un cycle de **rÃ©conciliation** continu :

```
                    BOUCLE DE RÃ‰CONCILIATION
                    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚                                                     â”‚
     â”‚   1. OBSERVER                                       â”‚
     â”‚      L'Operator surveille l'Ã©tat actuel             â”‚
     â”‚      du cluster PostgreSQL                          â”‚
     â”‚                                                     â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚                                                     â”‚
     â”‚   2. COMPARER                                       â”‚
     â”‚      Ã‰tat actuel vs Ã‰tat dÃ©sirÃ©                     â”‚
     â”‚      (dÃ©fini dans le Custom Resource)               â”‚
     â”‚                                                     â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚                                                     â”‚
     â”‚   3. AGIR                                           â”‚
     â”‚      Si diffÃ©rence dÃ©tectÃ©e :                       â”‚
     â”‚      â†’ Appliquer les changements nÃ©cessaires        â”‚
     â”‚      â†’ CrÃ©er/modifier/supprimer des ressources      â”‚
     â”‚                                                     â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º Retour Ã  l'Ã©tape 1
                                        (boucle continue)
```

### Custom Resources (CR) et Custom Resource Definitions (CRD)

Les Operators introduisent de nouveaux types de ressources dans Kubernetes :

```yaml
# Exemple de Custom Resource pour PostgreSQL
apiVersion: postgresql.example.com/v1
kind: PostgresCluster        # â† Nouveau type de ressource !
metadata:
  name: my-postgres
spec:
  instances: 3
  storage: 100Gi
  version: "16"
  backup:
    schedule: "0 2 * * *"    # Backup Ã  2h du matin
```

Au lieu de gÃ©rer manuellement des StatefulSets, Services, ConfigMaps, etc., vous dÃ©clarez simplement **ce que vous voulez** et l'Operator s'occupe du **comment**.

```
SANS OPERATOR                           AVEC OPERATOR
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                           â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Vous gÃ©rez :                            Vous gÃ©rez :
â€¢ 1 StatefulSet                         â€¢ 1 Custom Resource
â€¢ 1 Service Headless                       (PostgresCluster)
â€¢ 1 Service ClusterIP
â€¢ 1 ConfigMap                           L'Operator gÃ¨re :
â€¢ 1 Secret                              â€¢ Tout le reste
â€¢ N PersistentVolumeClaims                automatiquement !
â€¢ Scripts de rÃ©plication
â€¢ Scripts de backup
â€¢ Monitoring config
â€¢ ...

~500 lignes de YAML                     ~30 lignes de YAML
```

---

## Pourquoi Utiliser un Operator pour PostgreSQL ?

### Les DÃ©fis de PostgreSQL en Production

ExÃ©cuter PostgreSQL en production sur Kubernetes implique de nombreux dÃ©fis :

| DÃ©fi | ComplexitÃ© sans Operator |
|------|-------------------------|
| **RÃ©plication streaming** | Configuration manuelle de primary/replica |
| **Failover** | DÃ©tection de panne + promotion manuelle |
| **Backups** | Scripts cron + stockage + rÃ©tention |
| **Restauration** | ProcÃ©dure manuelle, risque d'erreur |
| **Mises Ã  jour** | Rolling update dÃ©licat |
| **Scaling** | Ajout de replicas avec rÃ©plication |
| **Monitoring** | Configuration Prometheus/exporters |
| **TLS** | GÃ©nÃ©ration et rotation des certificats |

### Ce qu'un Operator Apporte

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 FONCTIONNALITÃ‰S D'UN OPERATOR POSTGRESQL            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â”‚ HAUTE DISPONIBILITÃ‰  â”‚  â”‚      BACKUPS         â”‚                 â”‚
â”‚  â”‚                      â”‚  â”‚                      â”‚                 â”‚
â”‚  â”‚ â€¢ RÃ©plication auto   â”‚  â”‚ â€¢ Backups planifiÃ©s  â”‚                 â”‚
â”‚  â”‚ â€¢ Failover auto      â”‚  â”‚ â€¢ Stockage S3/GCS    â”‚                 â”‚
â”‚  â”‚ â€¢ Leader election    â”‚  â”‚ â€¢ RÃ©tention auto     â”‚                 â”‚
â”‚  â”‚ â€¢ Health checks      â”‚  â”‚ â€¢ PITR               â”‚                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â”‚     SÃ‰CURITÃ‰         â”‚  â”‚    OBSERVABILITÃ‰     â”‚                 â”‚
â”‚  â”‚                      â”‚  â”‚                      â”‚                 â”‚
â”‚  â”‚ â€¢ TLS automatique    â”‚  â”‚ â€¢ MÃ©triques Prom.    â”‚                 â”‚
â”‚  â”‚ â€¢ Rotation secrets   â”‚  â”‚ â€¢ Logs centralisÃ©s   â”‚                 â”‚
â”‚  â”‚ â€¢ RBAC intÃ©grÃ©       â”‚  â”‚ â€¢ Alertes            â”‚                 â”‚
â”‚  â”‚ â€¢ Network policies   â”‚  â”‚ â€¢ Dashboards         â”‚                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â”‚   CYCLE DE VIE       â”‚  â”‚     SCALING          â”‚                 â”‚
â”‚  â”‚                      â”‚  â”‚                      â”‚                 â”‚
â”‚  â”‚ â€¢ Provisioning       â”‚  â”‚ â€¢ Horizontal (repl.) â”‚                 â”‚
â”‚  â”‚ â€¢ Updates            â”‚  â”‚ â€¢ Vertical (ressour.)â”‚                 â”‚
â”‚  â”‚ â€¢ Minor upgrades     â”‚  â”‚ â€¢ Connection pooling â”‚                 â”‚
â”‚  â”‚ â€¢ Major upgrades     â”‚  â”‚ â€¢ Read replicas      â”‚                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Zalando Postgres Operator

### PrÃ©sentation

Le **Zalando Postgres Operator** a Ã©tÃ© dÃ©veloppÃ© par Zalando, le gÃ©ant europÃ©en du e-commerce. En production chez Zalando depuis 2017, il gÃ¨re des milliers de clusters PostgreSQL.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ZALANDO POSTGRES OPERATOR                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  CrÃ©ateur    : Zalando SE (Allemagne)                               â”‚
â”‚  Depuis      : 2017                                                 â”‚
â”‚  Licence     : MIT                                                  â”‚
â”‚  GitHub      : github.com/zalando/postgres-operator                 â”‚
â”‚  MaturitÃ©    : Production-ready, trÃ¨s utilisÃ©                       â”‚
â”‚                                                                     â”‚
â”‚  Points forts :                                                     â”‚
â”‚  â€¢ SimplicitÃ© de configuration                                      â”‚
â”‚  â€¢ IntÃ©gration AWS native (S3, IAM)                                 â”‚
â”‚  â€¢ Connection pooling intÃ©grÃ© (PgBouncer)                           â”‚
â”‚  â€¢ Interface Web (UI) optionnelle                                   â”‚
â”‚  â€¢ Large communautÃ©                                                 â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Architecture

```
                    ARCHITECTURE ZALANDO OPERATOR
                    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         KUBERNETES CLUSTER                        â”‚
â”‚                                                                   â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚   â”‚              POSTGRES OPERATOR (Deployment)              â”‚    â”‚
â”‚   â”‚                                                          â”‚    â”‚
â”‚   â”‚   Surveille les ressources "postgresql"                  â”‚    â”‚
â”‚   â”‚   CrÃ©e et gÃ¨re les clusters PostgreSQL                   â”‚    â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                             â”‚                                     â”‚
â”‚                             â”‚ GÃ¨re                                â”‚
â”‚                             â–¼                                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚   â”‚              CLUSTER POSTGRESQL "my-db"                  â”‚    â”‚
â”‚   â”‚                                                          â”‚    â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚    â”‚
â”‚   â”‚   â”‚my-db-0    â”‚  â”‚my-db-1    â”‚  â”‚my-db-2    â”‚            â”‚    â”‚
â”‚   â”‚   â”‚(Primary)  â”‚  â”‚(Replica)  â”‚  â”‚(Replica)  â”‚            â”‚    â”‚
â”‚   â”‚   â”‚           â”‚  â”‚           â”‚  â”‚           â”‚            â”‚    â”‚
â”‚   â”‚   â”‚â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚  â”‚â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚  â”‚â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚            â”‚    â”‚
â”‚   â”‚   â”‚â”‚Postgres â”‚â”‚  â”‚â”‚Postgres â”‚â”‚  â”‚â”‚Postgres â”‚â”‚            â”‚    â”‚
â”‚   â”‚   â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚  â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚  â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚            â”‚    â”‚
â”‚   â”‚   â”‚â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚  â”‚â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚  â”‚â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚            â”‚    â”‚
â”‚   â”‚   â”‚â”‚ Patroni â”‚â”‚  â”‚â”‚ Patroni â”‚â”‚  â”‚â”‚ Patroni â”‚â”‚            â”‚    â”‚
â”‚   â”‚   â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚  â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚  â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚            â”‚    â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜            â”‚    â”‚
â”‚   â”‚         â”‚              â”‚              â”‚                  â”‚    â”‚
â”‚   â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚    â”‚
â”‚   â”‚                        â–¼                                 â”‚    â”‚
â”‚   â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚    â”‚
â”‚   â”‚              â”‚     Spilo       â”‚  Image Docker contenant â”‚    â”‚
â”‚   â”‚              â”‚ (PostgreSQL +   â”‚  PostgreSQL + Patroni   â”‚    â”‚
â”‚   â”‚              â”‚  Patroni + ...) â”‚  + outils               â”‚    â”‚
â”‚   â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚    â”‚
â”‚   â”‚                                                          â”‚    â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Composants ClÃ©s

| Composant | RÃ´le |
|-----------|------|
| **Postgres Operator** | ContrÃ´leur qui gÃ¨re le cycle de vie des clusters |
| **Spilo** | Image Docker contenant PostgreSQL + Patroni + outils |
| **Patroni** | Gestion du failover et de la haute disponibilitÃ© |
| **PgBouncer** | Connection pooling (optionnel) |

### Custom Resource : postgresql

```yaml
# Exemple de cluster Zalando
apiVersion: "acid.zalan.do/v1"
kind: postgresql
metadata:
  name: my-postgres-cluster
  namespace: default
spec:
  teamId: "myteam"                    # PrÃ©fixe pour les ressources

  # Configuration du cluster
  numberOfInstances: 3                 # 1 primary + 2 replicas

  # Version PostgreSQL
  postgresql:
    version: "16"
    parameters:
      max_connections: "100"
      shared_buffers: "256MB"

  # Ressources
  resources:
    requests:
      cpu: "500m"
      memory: "1Gi"
    limits:
      cpu: "1"
      memory: "2Gi"

  # Stockage
  volume:
    size: 50Gi
    storageClass: fast-ssd

  # Utilisateurs et bases
  users:
    myapp_user:
      - superuser
      - createdb
    readonly_user: []

  databases:
    myapp_db: myapp_user              # base: owner

  # Connection pooling
  enableConnectionPooler: true
  connectionPooler:
    numberOfInstances: 2
    mode: "transaction"

  # Backups vers S3
  backup:
    enableWALBackup: true
```

### FonctionnalitÃ©s Principales

#### 1. Haute DisponibilitÃ© avec Patroni

Zalando utilise **Patroni** pour la haute disponibilitÃ© :

```
FAILOVER AUTOMATIQUE AVEC PATRONI
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Ã‰tat normal :
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  my-db-0    â”‚     â”‚  my-db-1    â”‚     â”‚  my-db-2    â”‚
â”‚  (Primary)  â”‚â”€â”€â”€â”€â–ºâ”‚  (Replica)  â”‚     â”‚  (Replica)  â”‚
â”‚             â”‚â”€â”€â”€â”€â–ºâ”‚             â”‚     â”‚             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚                   â–²                   â–²
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              RÃ©plication streaming


Le Primary tombe :
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  my-db-0    â”‚     â”‚  my-db-1    â”‚     â”‚  my-db-2    â”‚
â”‚    â•³ DOWN   â”‚     â”‚  (Replica)  â”‚     â”‚  (Replica)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                           â”‚
                           â”‚ Patroni dÃ©tecte (~10s)
                           â”‚ Ã‰lection du nouveau leader
                           â–¼

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  my-db-0    â”‚     â”‚  my-db-1    â”‚     â”‚  my-db-2    â”‚
â”‚  (Ã  recrÃ©er)â”‚â—„â”€â”€â”€â”€â”‚ (NOUVEAU    â”‚â”€â”€â”€â”€â–ºâ”‚  (Replica)  â”‚
â”‚             â”‚     â”‚  PRIMARY)   â”‚     â”‚             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Temps de failover : ~10-30 secondes
```

#### 2. Connection Pooling IntÃ©grÃ©

```yaml
# Activer PgBouncer
spec:
  enableConnectionPooler: true
  connectionPooler:
    numberOfInstances: 2
    mode: "transaction"      # ou "session"
    maxDBConnections: 100
```

L'Operator crÃ©e automatiquement :
- Des Pods PgBouncer
- Un Service pour accÃ©der au pooler
- La configuration appropriÃ©e

#### 3. Gestion des Utilisateurs et Bases

```yaml
spec:
  users:
    admin_user:
      - superuser
      - createdb
    app_user:
      - login
    readonly_user:
      - login

  databases:
    production_db: admin_user
    analytics_db: admin_user
```

Les mots de passe sont automatiquement gÃ©nÃ©rÃ©s et stockÃ©s dans des Secrets Kubernetes.

#### 4. Backups vers S3

```yaml
# Configuration dans l'Operator (ConfigMap)
configuration:
  aws_region: eu-west-1
  wal_s3_bucket: my-postgres-backups

# Ou dans le cluster
spec:
  backup:
    enableWALBackup: true
```

### Installation de Zalando Operator

```bash
# Cloner le dÃ©pÃ´t
git clone https://github.com/zalando/postgres-operator.git
cd postgres-operator

# Installer avec kubectl
kubectl create -f manifests/configmap.yaml
kubectl create -f manifests/operator-service-account-rbac.yaml
kubectl create -f manifests/postgres-operator.yaml

# Ou avec Helm
helm repo add postgres-operator-charts \
  https://opensource.zalando.com/postgres-operator/charts/postgres-operator
helm install postgres-operator postgres-operator-charts/postgres-operator
```

---

## CloudNativePG

### PrÃ©sentation

**CloudNativePG** (anciennement CloudNative-PG) est un Operator dÃ©veloppÃ© initialement par EDB (EnterpriseDB) puis donnÃ© Ã  la CNCF (Cloud Native Computing Foundation). Il est conÃ§u nativement pour Kubernetes, sans dÃ©pendances externes.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         CLOUDNATIVEPG                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  CrÃ©ateur    : EDB, maintenant projet CNCF                          â”‚
â”‚  Depuis      : 2020                                                 â”‚
â”‚  Licence     : Apache 2.0                                           â”‚
â”‚  GitHub      : github.com/cloudnative-pg/cloudnative-pg             â”‚
â”‚  MaturitÃ©    : Production-ready, en forte croissance                â”‚
â”‚                                                                     â”‚
â”‚  Points forts :                                                     â”‚
â”‚  â€¢ Architecture Kubernetes-native pure                              â”‚
â”‚  â€¢ Pas de dÃ©pendances externes (pas de Patroni/etcd)                â”‚
â”‚  â€¢ Excellente documentation                                         â”‚
â”‚  â€¢ Support officiel disponible (EDB)                                â”‚
â”‚  â€¢ Projet CNCF (gouvernance neutre)                                 â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Architecture

CloudNativePG se distingue par son approche **Kubernetes-native** : il utilise les mÃ©canismes natifs de Kubernetes (leases, endpoints) plutÃ´t que des outils externes.

```
                    ARCHITECTURE CLOUDNATIVEPG
                    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         KUBERNETES CLUSTER                       â”‚
â”‚                                                                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚   â”‚            CLOUDNATIVEPG OPERATOR (Deployment)          â”‚    â”‚
â”‚   â”‚                                                         â”‚    â”‚
â”‚   â”‚   â€¢ Surveille les ressources "Cluster"                  â”‚    â”‚
â”‚   â”‚   â€¢ GÃ¨re le failover via Kubernetes Leases              â”‚    â”‚
â”‚   â”‚   â€¢ Pas de dÃ©pendance externe (Patroni, etcd)           â”‚    â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                             â”‚                                    â”‚
â”‚                             â”‚ GÃ¨re                               â”‚
â”‚                             â–¼                                    â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚   â”‚                   CLUSTER "my-cluster"                  â”‚    â”‚
â”‚   â”‚                                                         â”‚    â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                     â”‚    â”‚
â”‚   â”‚   â”‚my-cluster-1   â”‚  â† Primary                          â”‚    â”‚
â”‚   â”‚   â”‚               â”‚                                     â”‚    â”‚
â”‚   â”‚   â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚                                     â”‚    â”‚
â”‚   â”‚   â”‚ â”‚ PostgreSQLâ”‚ â”‚                                     â”‚    â”‚
â”‚   â”‚   â”‚ â”‚   16      â”‚ â”‚                                     â”‚    â”‚
â”‚   â”‚   â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚                                     â”‚    â”‚
â”‚   â”‚   â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚                                     â”‚    â”‚
â”‚   â”‚   â”‚ â”‚ Instance  â”‚ â”‚  Gestionnaire intÃ©grÃ©               â”‚    â”‚
â”‚   â”‚   â”‚ â”‚ Manager   â”‚ â”‚  (pas de Patroni)                   â”‚    â”‚
â”‚   â”‚   â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚                                     â”‚    â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                     â”‚    â”‚
â”‚   â”‚           â”‚ RÃ©plication                                 â”‚    â”‚
â”‚   â”‚           â–¼                                             â”‚    â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚    â”‚
â”‚   â”‚   â”‚my-cluster-2   â”‚  â”‚my-cluster-3   â”‚                  â”‚    â”‚
â”‚   â”‚   â”‚ (Replica)     â”‚  â”‚ (Replica)     â”‚                  â”‚    â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚    â”‚
â”‚   â”‚                                                         â”‚    â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Custom Resource : Cluster

```yaml
# Exemple de cluster CloudNativePG
apiVersion: postgresql.cnpg.io/v1
kind: Cluster
metadata:
  name: my-cluster
  namespace: default
spec:
  # Nombre d'instances (1 primary + N-1 replicas)
  instances: 3

  # Version PostgreSQL
  imageName: ghcr.io/cloudnative-pg/postgresql:16.2

  # Configuration PostgreSQL
  postgresql:
    parameters:
      max_connections: "100"
      shared_buffers: "256MB"
      effective_cache_size: "1GB"
    pg_hba:
      - host all all 10.0.0.0/8 scram-sha-256

  # Stockage
  storage:
    size: 50Gi
    storageClass: fast-ssd

  # Ressources
  resources:
    requests:
      memory: "1Gi"
      cpu: "500m"
    limits:
      memory: "2Gi"
      cpu: "1"

  # Bootstrap (initialisation)
  bootstrap:
    initdb:
      database: myapp
      owner: myapp_user
      secret:
        name: myapp-credentials

  # Backups
  backup:
    barmanObjectStore:
      destinationPath: s3://my-bucket/backups
      s3Credentials:
        accessKeyId:
          name: s3-creds
          key: ACCESS_KEY_ID
        secretAccessKey:
          name: s3-creds
          key: SECRET_ACCESS_KEY
    retentionPolicy: "7d"

  # Monitoring
  monitoring:
    enablePodMonitor: true
```

### FonctionnalitÃ©s Principales

#### 1. Failover Kubernetes-Native

CloudNativePG utilise les **Leases Kubernetes** pour l'Ã©lection du leader :

```
FAILOVER AVEC LEASES KUBERNETES
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  Kubernetes Lease   â”‚
                    â”‚  "my-cluster-leader"â”‚
                    â”‚                     â”‚
                    â”‚  holder: cluster-1  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                     â”‚                     â”‚
         â–¼                     â–¼                     â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  cluster-1  â”‚      â”‚  cluster-2    â”‚      â”‚  cluster-3    â”‚
  â”‚  (Primary)  â”‚      â”‚  (Replica)    â”‚      â”‚  (Replica)    â”‚
  â”‚             â”‚      â”‚               â”‚      â”‚               â”‚
  â”‚ "J'ai la    â”‚      â”‚ "Je surveille â”‚      â”‚ "Je surveille â”‚
  â”‚  Lease !"   â”‚      â”‚  la Lease"    â”‚      â”‚  la Lease"    â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Si cluster-1 tombe :
1. La Lease expire
2. cluster-2 ou cluster-3 l'acquiert
3. Le nouveau holder devient Primary

Pas besoin de Patroni, etcd ou autre composant externe !
```

#### 2. Backup avec Barman

CloudNativePG utilise **Barman** pour les backups :

```yaml
spec:
  backup:
    barmanObjectStore:
      destinationPath: s3://my-bucket/backups
      s3Credentials:
        accessKeyId:
          name: s3-creds
          key: ACCESS_KEY_ID
        secretAccessKey:
          name: s3-creds
          key: SECRET_ACCESS_KEY
      wal:
        compression: gzip
    retentionPolicy: "7d"
```

CrÃ©er un backup Ã  la demande :

```yaml
apiVersion: postgresql.cnpg.io/v1
kind: Backup
metadata:
  name: my-backup
spec:
  cluster:
    name: my-cluster
```

#### 3. Point-In-Time Recovery (PITR)

Restaurer Ã  un moment prÃ©cis :

```yaml
apiVersion: postgresql.cnpg.io/v1
kind: Cluster
metadata:
  name: restored-cluster
spec:
  instances: 3

  bootstrap:
    recovery:
      source: my-cluster
      recoveryTarget:
        targetTime: "2024-01-15 10:30:00"

  externalClusters:
    - name: my-cluster
      barmanObjectStore:
        destinationPath: s3://my-bucket/backups
        s3Credentials:
          accessKeyId:
            name: s3-creds
            key: ACCESS_KEY_ID
          secretAccessKey:
            name: s3-creds
            key: SECRET_ACCESS_KEY
```

#### 4. Replica Clusters (Disaster Recovery)

CrÃ©er un cluster replica dans une autre rÃ©gion :

```yaml
apiVersion: postgresql.cnpg.io/v1
kind: Cluster
metadata:
  name: dr-cluster
  namespace: default
spec:
  instances: 3

  # Ce cluster rÃ©plique depuis un autre cluster
  replica:
    enabled: true
    source: main-cluster

  externalClusters:
    - name: main-cluster
      connectionParameters:
        host: main-cluster-rw.primary-region.svc
        user: streaming_replica
      password:
        name: replica-credentials
        key: password
```

#### 5. Monitoring IntÃ©grÃ©

CloudNativePG expose des mÃ©triques Prometheus automatiquement :

```yaml
spec:
  monitoring:
    enablePodMonitor: true    # CrÃ©e un PodMonitor pour Prometheus
    customQueriesConfigMap:
      - name: custom-queries
        key: queries
```

### Installation de CloudNativePG

```bash
# Installation avec kubectl
kubectl apply -f \
  https://raw.githubusercontent.com/cloudnative-pg/cloudnative-pg/release-1.22/releases/cnpg-1.22.0.yaml

# Ou avec Helm
helm repo add cnpg https://cloudnative-pg.github.io/charts
helm upgrade --install cnpg \
  --namespace cnpg-system \
  --create-namespace \
  cnpg/cloudnative-pg
```

---

## Crunchy Postgres Operator (PGO)

### PrÃ©sentation

Le **Crunchy Postgres Operator** (aussi appelÃ© PGO) est dÃ©veloppÃ© par Crunchy Data, un des principaux contributeurs Ã  PostgreSQL. C'est l'un des Operators les plus complets et les plus matures.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CRUNCHY POSTGRES OPERATOR (PGO)                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  CrÃ©ateur    : Crunchy Data                                         â”‚
â”‚  Depuis      : 2017                                                 â”‚
â”‚  Licence     : Apache 2.0                                           â”‚
â”‚  GitHub      : github.com/CrunchyData/postgres-operator             â”‚
â”‚  MaturitÃ©    : Production-ready, trÃ¨s mature                        â”‚
â”‚                                                                     â”‚
â”‚  Points forts :                                                     â”‚
â”‚  â€¢ FonctionnalitÃ©s trÃ¨s complÃ¨tes                                   â”‚
â”‚  â€¢ pgBackRest pour backups (robuste)                                â”‚
â”‚  â€¢ Support commercial disponible                                    â”‚
â”‚  â€¢ Excellent pour les environnements enterprise                     â”‚
â”‚  â€¢ IntÃ©gration avec l'Ã©cosystÃ¨me Crunchy                            â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Architecture

```
                    ARCHITECTURE CRUNCHY PGO
                    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         KUBERNETES CLUSTER                       â”‚
â”‚                                                                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚   â”‚                    PGO OPERATOR                         â”‚    â”‚
â”‚   â”‚                                                         â”‚    â”‚
â”‚   â”‚   Surveille les ressources "PostgresCluster"            â”‚    â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                             â”‚                                    â”‚
â”‚                             â”‚ GÃ¨re                               â”‚
â”‚                             â–¼                                    â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚   â”‚                POSTGRESCLUSTER "hippo"                  â”‚    â”‚
â”‚   â”‚                                                         â”‚    â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚    â”‚
â”‚   â”‚  â”‚              INSTANCE SET "instance1"           â”‚    â”‚    â”‚
â”‚   â”‚  â”‚                                                 â”‚    â”‚    â”‚
â”‚   â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚    â”‚    â”‚
â”‚   â”‚  â”‚  â”‚ hippo-     â”‚ â”‚ hippo-     â”‚ â”‚ hippo-     â”‚   â”‚    â”‚    â”‚
â”‚   â”‚  â”‚  â”‚ instance1  â”‚ â”‚ instance1  â”‚ â”‚ instance1  â”‚   â”‚    â”‚    â”‚
â”‚   â”‚  â”‚  â”‚ -xxxx      â”‚ â”‚ -yyyy      â”‚ â”‚ -zzzz      â”‚   â”‚    â”‚    â”‚
â”‚   â”‚  â”‚  â”‚            â”‚ â”‚            â”‚ â”‚            â”‚   â”‚    â”‚    â”‚
â”‚   â”‚  â”‚  â”‚â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚ â”‚â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚ â”‚â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚   â”‚    â”‚    â”‚
â”‚   â”‚  â”‚  â”‚â”‚PostgreSQLâ”‚â”‚ â”‚â”‚PostgreSQLâ”‚â”‚ â”‚â”‚PostgreSQLâ”‚â”‚   â”‚    â”‚    â”‚
â”‚   â”‚  â”‚  â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚ â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚ â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚   â”‚    â”‚    â”‚
â”‚   â”‚  â”‚  â”‚â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚ â”‚â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚ â”‚â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚   â”‚    â”‚    â”‚
â”‚   â”‚  â”‚  â”‚â”‚ Patroni  â”‚â”‚ â”‚â”‚ Patroni  â”‚â”‚ â”‚â”‚ Patroni  â”‚â”‚   â”‚    â”‚    â”‚
â”‚   â”‚  â”‚  â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚ â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚ â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚   â”‚    â”‚    â”‚
â”‚   â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚    â”‚    â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚    â”‚
â”‚   â”‚                                                         â”‚    â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚    â”‚
â”‚   â”‚  â”‚ PgBouncer   â”‚  â”‚ pgBackRest  â”‚  â”‚ pg_exporter â”‚      â”‚    â”‚
â”‚   â”‚  â”‚ (Pooler)    â”‚  â”‚ (Backup)    â”‚  â”‚ (Metrics)   â”‚      â”‚    â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚    â”‚
â”‚   â”‚                                                         â”‚    â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Custom Resource : PostgresCluster

```yaml
# Exemple de cluster Crunchy PGO
apiVersion: postgres-operator.crunchydata.com/v1beta1
kind: PostgresCluster
metadata:
  name: hippo
spec:
  # Version PostgreSQL
  postgresVersion: 16

  # Instances PostgreSQL
  instances:
    - name: instance1
      replicas: 3
      dataVolumeClaimSpec:
        accessModes:
          - ReadWriteOnce
        resources:
          requests:
            storage: 50Gi
        storageClassName: fast-ssd
      resources:
        requests:
          cpu: "500m"
          memory: "1Gi"
        limits:
          cpu: "1"
          memory: "2Gi"

  # Configuration PostgreSQL
  patroni:
    dynamicConfiguration:
      postgresql:
        parameters:
          max_connections: "100"
          shared_buffers: "256MB"

  # Utilisateurs
  users:
    - name: hippo
      databases:
        - hippo
      options: "SUPERUSER"
    - name: app_user
      databases:
        - hippo

  # Backups avec pgBackRest
  backups:
    pgbackrest:
      image: registry.developers.crunchydata.com/crunchydata/crunchy-pgbackrest:ubi8-2.47-2
      repos:
        - name: repo1
          schedules:
            full: "0 1 * * 0"        # Full backup dimanche 1h
            differential: "0 1 * * 1-6"  # Diff backup autres jours
          volume:
            volumeClaimSpec:
              accessModes:
                - ReadWriteOnce
              resources:
                requests:
                  storage: 100Gi
        - name: repo2
          s3:
            bucket: "my-postgres-backups"
            endpoint: "s3.amazonaws.com"
            region: "us-east-1"

  # Connection pooling
  proxy:
    pgBouncer:
      replicas: 2
      config:
        global:
          pool_mode: transaction

  # Monitoring
  monitoring:
    pgmonitor:
      exporter:
        image: registry.developers.crunchydata.com/crunchydata/crunchy-postgres-exporter:ubi8-5.5.0-0
```

### FonctionnalitÃ©s Principales

#### 1. Backups Robustes avec pgBackRest

Crunchy utilise **pgBackRest**, l'outil de backup le plus robuste pour PostgreSQL :

```
TYPES DE BACKUPS pgBackRest
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                 â”‚
â”‚  FULL BACKUP (Dimanche)                                         â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                                        â”‚
â”‚  Copie complÃ¨te de la base                                      â”‚
â”‚  ~50 Go                                                         â”‚
â”‚                                                                 â”‚
â”‚  DIFFERENTIAL BACKUP (Lundi-Samedi)                             â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                              â”‚
â”‚  Seulement les changements depuis le dernier FULL               â”‚
â”‚  ~5-10 Go                                                       â”‚
â”‚                                                                 â”‚
â”‚  INCREMENTAL BACKUP (Optionnel, plus frÃ©quent)                  â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                  â”‚
â”‚  Seulement les changements depuis le dernier backup (any)       â”‚
â”‚  ~1-2 Go                                                        â”‚
â”‚                                                                 â”‚
â”‚  + WAL Archiving en continu                                     â”‚
â”‚    Permet PITR Ã  n'importe quelle seconde                       â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

Configuration multi-repo (local + S3) :

```yaml
backups:
  pgbackrest:
    repos:
      - name: repo1
        volume:                    # Repo local (rapide)
          volumeClaimSpec:
            storage: 100Gi
      - name: repo2
        s3:                        # Repo S3 (DR)
          bucket: "pg-backups"
          endpoint: "s3.amazonaws.com"
          region: "us-east-1"
```

#### 2. Clone et Restauration

Cloner un cluster existant :

```yaml
apiVersion: postgres-operator.crunchydata.com/v1beta1
kind: PostgresCluster
metadata:
  name: hippo-clone
spec:
  postgresVersion: 16

  dataSource:
    postgresCluster:
      clusterName: hippo
      repoName: repo1

  instances:
    - name: instance1
      replicas: 3
      dataVolumeClaimSpec:
        storage: 50Gi
```

Restauration PITR :

```yaml
dataSource:
  postgresCluster:
    clusterName: hippo
    repoName: repo1
    options:
      - --type=time
      - --target="2024-01-15 10:30:00"
```

#### 3. Connection Pooling avec PgBouncer

```yaml
spec:
  proxy:
    pgBouncer:
      replicas: 2
      config:
        global:
          pool_mode: transaction
          max_client_conn: "1000"
          default_pool_size: "20"
      resources:
        requests:
          cpu: "100m"
          memory: "128Mi"
```

#### 4. Affinity et Topologie

ContrÃ´le fin du placement des Pods :

```yaml
instances:
  - name: instance1
    replicas: 3
    affinity:
      podAntiAffinity:
        preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            podAffinityTerm:
              topologyKey: "topology.kubernetes.io/zone"
              labelSelector:
                matchLabels:
                  postgres-operator.crunchydata.com/cluster: hippo
```

#### 5. TLS Automatique

PGO gÃ©nÃ¨re et gÃ¨re automatiquement les certificats TLS :

```yaml
spec:
  customTLSSecret:
    name: hippo-tls        # Optionnel : utiliser vos propres certificats

  # Sinon, certificats auto-gÃ©nÃ©rÃ©s
```

### Installation de Crunchy PGO

```bash
# Avec kubectl (mÃ©thode recommandÃ©e)
kubectl apply -k \
  github.com/CrunchyData/postgres-operator-examples/kustomize/install/default

# Ou avec Helm
helm repo add crunchydata https://crunchydata.github.io/postgres-operator
helm install pgo crunchydata/pgo
```

---

## Comparaison des Trois Operators

### Tableau Comparatif DÃ©taillÃ©

| Aspect | Zalando | CloudNativePG | Crunchy PGO |
|--------|---------|---------------|-------------|
| **Licence** | MIT | Apache 2.0 | Apache 2.0 |
| **MaturitÃ©** | TrÃ¨s mature (2017) | Mature (2020) | TrÃ¨s mature (2017) |
| **HA Solution** | Patroni | Kubernetes-native | Patroni |
| **Backup Tool** | WAL-E/WAL-G | Barman | pgBackRest |
| **Connection Pooler** | PgBouncer intÃ©grÃ© | Externe (PgBouncer) | PgBouncer intÃ©grÃ© |
| **DÃ©pendances externes** | Patroni, S3 | Aucune | Patroni |
| **ComplexitÃ© config** | Simple | Moyenne | AvancÃ©e |
| **Support commercial** | Non (Zalando interne) | Oui (EDB) | Oui (Crunchy) |
| **Projet CNCF** | Non | Oui (Sandbox) | Non |
| **Documentation** | Bonne | Excellente | Excellente |
| **CommunautÃ©** | Grande | En croissance | Grande |

### Forces et Faiblesses

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          ZALANDO OPERATOR                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  âœ… Forces                        â”‚  âš ï¸ Faiblesses                  â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  â€¢ Configuration simple           â”‚  â€¢ Moins flexible               â”‚
â”‚  â€¢ UI web disponible              â”‚  â€¢ Pas de support commercial    â”‚
â”‚  â€¢ PgBouncer natif                â”‚  â€¢ Moins de features backup     â”‚
â”‚  â€¢ Battle-tested chez Zalando     â”‚  â€¢ DÃ©pend de Patroni/etcd       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          CLOUDNATIVEPG                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  âœ… Forces                        â”‚  âš ï¸ Faiblesses                  â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  â€¢ Kubernetes-native pur          â”‚  â€¢ Plus rÃ©cent                  â”‚
â”‚  â€¢ Pas de dÃ©pendances externes    â”‚  â€¢ Moins de plugins/intÃ©grationsâ”‚
â”‚  â€¢ Documentation excellente       â”‚  â€¢ Courbe d'apprentissage       â”‚
â”‚  â€¢ Projet CNCF                    â”‚  â€¢ PgBouncer externe            â”‚
â”‚  â€¢ Architecture Ã©lÃ©gante          â”‚                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          CRUNCHY PGO                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  âœ… Forces                        â”‚  âš ï¸ Faiblesses                  â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  â€¢ FonctionnalitÃ©s complÃ¨tes      â”‚  â€¢ ComplexitÃ© de config         â”‚
â”‚  â€¢ pgBackRest (best backup)       â”‚  â€¢ Images plus lourdes          â”‚
â”‚  â€¢ Support commercial             â”‚  â€¢ Courbe d'apprentissage       â”‚
â”‚  â€¢ Multi-repo backup              â”‚  â€¢ VerbositÃ© YAML               â”‚
â”‚  â€¢ Entreprise-ready               â”‚                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Arbre de DÃ©cision

```
                    QUEL OPERATOR CHOISIR ?
                    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Avez-vous besoin d'un support commercial ?
â”‚
â”œâ”€â”€ OUI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                    â”‚
â”‚   PrÃ©fÃ©rence pour l'Ã©cosystÃ¨me ?                   â”‚
â”‚   â”‚                                                â”‚
â”‚   â”œâ”€â”€ EDB / PostgreSQL officiel â”€â”€â–º CloudNativePG  â”‚
â”‚   â”‚                                                â”‚
â”‚   â””â”€â”€ Crunchy Data â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º Crunchy PGO     â”‚
â”‚                                                    â”‚
â””â”€â”€ NON                                              â”‚
    â”‚                                                â”‚
    ComplexitÃ© de vos besoins ?                      â”‚
    â”‚                                                â”‚
    â”œâ”€â”€ Simple (petit/moyen projet)                  â”‚
    â”‚   â”‚                                            â”‚
    â”‚   â””â”€â”€ Zalando Operator                         â”‚
    â”‚       (facile Ã  dÃ©marrer)                      â”‚
    â”‚                                                â”‚
    â”œâ”€â”€ Moyen (features avancÃ©es, K8s-native)        â”‚
    â”‚   â”‚                                            â”‚
    â”‚   â””â”€â”€ CloudNativePG                            â”‚
    â”‚       (pas de dÃ©pendances)                     â”‚
    â”‚                                                â”‚
    â””â”€â”€ AvancÃ© (enterprise, DR, multi-rÃ©gion)        â”‚
        â”‚                                            â”‚
        â””â”€â”€ Crunchy PGO                              â”‚
            (le plus complet)                        â”‚
```

---

## Exemple Pratique : MÃªme Cluster, Trois Operators

Pour mieux comprendre les diffÃ©rences, voici comment crÃ©er un cluster PostgreSQL similaire avec chaque Operator.

### SpÃ©cifications Communes

- 3 instances (1 primary + 2 replicas)
- 50 Gi de stockage
- PostgreSQL 16
- Backups vers S3

### Avec Zalando

```yaml
apiVersion: "acid.zalan.do/v1"
kind: postgresql
metadata:
  name: my-cluster
spec:
  teamId: "myteam"
  numberOfInstances: 3
  postgresql:
    version: "16"
  volume:
    size: 50Gi
  enableConnectionPooler: true
```

**Lignes de YAML** : ~15

### Avec CloudNativePG

```yaml
apiVersion: postgresql.cnpg.io/v1
kind: Cluster
metadata:
  name: my-cluster
spec:
  instances: 3
  imageName: ghcr.io/cloudnative-pg/postgresql:16.2
  storage:
    size: 50Gi
  backup:
    barmanObjectStore:
      destinationPath: s3://my-bucket/backups
      s3Credentials:
        accessKeyId:
          name: s3-creds
          key: ACCESS_KEY_ID
        secretAccessKey:
          name: s3-creds
          key: SECRET_ACCESS_KEY
```

**Lignes de YAML** : ~20

### Avec Crunchy PGO

```yaml
apiVersion: postgres-operator.crunchydata.com/v1beta1
kind: PostgresCluster
metadata:
  name: my-cluster
spec:
  postgresVersion: 16
  instances:
    - name: instance1
      replicas: 3
      dataVolumeClaimSpec:
        accessModes: ["ReadWriteOnce"]
        resources:
          requests:
            storage: 50Gi
  backups:
    pgbackrest:
      repos:
        - name: repo1
          s3:
            bucket: "my-bucket"
            endpoint: "s3.amazonaws.com"
            region: "us-east-1"
  proxy:
    pgBouncer:
      replicas: 2
```

**Lignes de YAML** : ~30

---

## Bonnes Pratiques Communes

### 1. Toujours Configurer les Backups

```yaml
# Quel que soit l'Operator, configurez les backups DÃˆS LE DÃ‰BUT
backup:
  retentionPolicy: "7d"    # Ou selon vos besoins
  schedule: "0 2 * * *"     # Quotidien Ã  2h
```

### 2. Utiliser des Resources AppropriÃ©es

```yaml
resources:
  requests:
    cpu: "500m"
    memory: "1Gi"
  limits:
    cpu: "2"
    memory: "4Gi"
```

### 3. Configurer la Haute DisponibilitÃ©

- Minimum 3 instances pour la HA
- Utiliser des anti-affinity rules pour distribuer sur plusieurs nodes/zones

### 4. Activer le Monitoring

```yaml
# Exposer les mÃ©triques pour Prometheus
monitoring:
  enabled: true
```

### 5. SÃ©curiser les AccÃ¨s

- Utiliser TLS pour les connexions
- Stocker les mots de passe dans des Secrets
- Configurer les network policies

### 6. Tester les Restaurations

Testez rÃ©guliÃ¨rement :
- La restauration de backup
- Le failover automatique
- Le PITR

---

## Migration Entre Operators

Si vous souhaitez changer d'Operator, voici la stratÃ©gie gÃ©nÃ©rale :

```
MIGRATION ENTRE OPERATORS
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

1. BACKUP
   Effectuer un backup complet avec pg_dump ou backup natif

2. DÃ‰PLOYER
   Installer le nouvel Operator
   CrÃ©er un nouveau cluster vide

3. RESTAURER
   Restaurer les donnÃ©es dans le nouveau cluster
   (pg_restore ou restauration native)

4. TESTER
   VÃ©rifier l'intÃ©gritÃ© des donnÃ©es
   Tester les applications

5. BASCULER
   Mettre Ã  jour les connexions applicatives

6. NETTOYER
   Supprimer l'ancien cluster
   DÃ©sinstaller l'ancien Operator
```

---

## Conclusion

Les trois Operators prÃ©sentÃ©s dans ce chapitre sont tous production-ready et largement utilisÃ©s. Le choix dÃ©pend de vos besoins spÃ©cifiques :

| Choisissez | Si vous... |
|------------|-----------|
| **Zalando** | Voulez dÃ©marrer rapidement avec une solution simple et Ã©prouvÃ©e |
| **CloudNativePG** | PrÃ©fÃ©rez une architecture Kubernetes-native sans dÃ©pendances |
| **Crunchy PGO** | Avez besoin de fonctionnalitÃ©s enterprise avancÃ©es |

Dans tous les cas, l'utilisation d'un Operator est **fortement recommandÃ©e** pour exÃ©cuter PostgreSQL en production sur Kubernetes. Les StatefulSets seuls ne suffisent pas pour gÃ©rer la complexitÃ© d'un SGBD en production.

Les Operators transforment des heures d'administration manuelle en quelques lignes de YAML dÃ©claratif, tout en assurant une haute disponibilitÃ© et des backups automatisÃ©s.

---

## Ressources ComplÃ©mentaires

### Documentation Officielle

- [Zalando Postgres Operator](https://postgres-operator.readthedocs.io/)
- [CloudNativePG](https://cloudnative-pg.io/documentation/)
- [Crunchy Postgres Operator](https://access.crunchydata.com/documentation/postgres-operator/)

### Tutoriels et Guides

- Zalando : Getting Started Guide
- CloudNativePG : Quickstart
- Crunchy : Tutorial avec exemples

### CommunautÃ©s

- GitHub Issues de chaque projet
- Slack Kubernetes (#postgresql)
- Mailing lists PostgreSQL

### Outils ComplÃ©mentaires

- kubectl plugins pour PostgreSQL
- Lens (IDE Kubernetes)
- k9s (terminal UI)

---


â­ï¸ [Backup automation (Velero, native solutions)](/20bis-postgresql-et-architectures-modernes/04.3-backup-automation.md)
