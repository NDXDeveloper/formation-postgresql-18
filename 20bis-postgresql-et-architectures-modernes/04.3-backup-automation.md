ğŸ” Retour au [Sommaire](/SOMMAIRE.md)

# 20bis.4.3. Backup Automation (Velero, Native Solutions)

## Introduction

Les sauvegardes sont la **police d'assurance** de vos donnÃ©es. Dans un environnement Kubernetes, la question des backups PostgreSQL se complexifie : il ne suffit pas de sauvegarder la base de donnÃ©es, il faut aussi considÃ©rer les ressources Kubernetes associÃ©es (ConfigMaps, Secrets, PersistentVolumes).

Ce chapitre explore les diffÃ©rentes approches pour automatiser les sauvegardes de PostgreSQL sur Kubernetes : des solutions natives PostgreSQL aux outils Kubernetes comme **Velero**, en passant par les fonctionnalitÃ©s intÃ©grÃ©es aux Operators.

---

## Pourquoi les Backups Sont Critiques

### Les ScÃ©narios de Perte de DonnÃ©es

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              SCÃ‰NARIOS NÃ‰CESSITANT UNE RESTAURATION                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  ğŸ”´ ERREUR HUMAINE (cause #1)                                       â”‚
â”‚     â€¢ DELETE ou DROP accidentel                                     â”‚
â”‚     â€¢ UPDATE sans clause WHERE                                      â”‚
â”‚     â€¢ Migration de schÃ©ma ratÃ©e                                     â”‚
â”‚                                                                     â”‚
â”‚  ğŸ”´ CORRUPTION DE DONNÃ‰ES                                           â”‚
â”‚     â€¢ Bug applicatif qui corrompt les donnÃ©es                       â”‚
â”‚     â€¢ ProblÃ¨me de disque                                            â”‚
â”‚     â€¢ Crash pendant une Ã©criture                                    â”‚
â”‚                                                                     â”‚
â”‚  ğŸ”´ DÃ‰FAILLANCE D'INFRASTRUCTURE                                    â”‚
â”‚     â€¢ Panne du node Kubernetes                                      â”‚
â”‚     â€¢ Perte du PersistentVolume                                     â”‚
â”‚     â€¢ Incident datacenter / zone cloud                              â”‚
â”‚                                                                     â”‚
â”‚  ğŸ”´ SÃ‰CURITÃ‰                                                        â”‚
â”‚     â€¢ Ransomware                                                    â”‚
â”‚     â€¢ Intrusion et modification malveillante                        â”‚
â”‚     â€¢ Suppression volontaire par un acteur malveillant              â”‚
â”‚                                                                     â”‚
â”‚  ğŸ”´ CONFORMITÃ‰                                                      â”‚
â”‚     â€¢ Audit nÃ©cessitant des donnÃ©es historiques                     â”‚
â”‚     â€¢ Obligations lÃ©gales de conservation                           â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### La RÃ¨gle 3-2-1

La rÃ¨gle d'or des sauvegardes :

```
                    LA RÃˆGLE 3-2-1
                    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                                     â”‚
        â”‚    3  copies de vos donnÃ©es         â”‚
        â”‚       (original + 2 backups)        â”‚
        â”‚                                     â”‚
        â”‚    2  types de mÃ©dias diffÃ©rents    â”‚
        â”‚       (disque local + cloud)        â”‚
        â”‚                                     â”‚
        â”‚    1  copie hors-site               â”‚
        â”‚       (autre rÃ©gion/datacenter)     â”‚
        â”‚                                     â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Exemple pour PostgreSQL sur Kubernetes :

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    ORIGINAL    â”‚   â”‚   BACKUP #1    â”‚   â”‚   BACKUP #2     â”‚
â”‚                â”‚   â”‚                â”‚   â”‚                 â”‚
â”‚  PostgreSQL    â”‚   â”‚  PV Snapshot   â”‚   â”‚  S3 Bucket      â”‚
â”‚  sur PV local  â”‚   â”‚  (mÃªme rÃ©gion) â”‚   â”‚  (autre rÃ©gion) â”‚
â”‚                â”‚   â”‚                â”‚   â”‚                 â”‚
â”‚  [Copie 1]     â”‚   â”‚  [Copie 2]     â”‚   â”‚  [Copie 3]      â”‚
â”‚  [MÃ©dia: SSD]  â”‚   â”‚  [MÃ©dia: SSD]  â”‚   â”‚  [MÃ©dia: Cloud] â”‚
â”‚  [Sur-site]    â”‚   â”‚  [Sur-site]    â”‚   â”‚  [Hors-site]    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Types de Backups PostgreSQL

Avant de plonger dans les outils, comprenons les diffÃ©rents types de sauvegardes PostgreSQL.

### 1. Backup Logique (pg_dump)

Un backup logique exporte les donnÃ©es sous forme de commandes SQL.

```
BACKUP LOGIQUE (pg_dump)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

PostgreSQL â”€â”€â–º pg_dump â”€â”€â–º fichier SQL/custom
                           (CREATE TABLE, INSERT, ...)

Avantages :
âœ… Portable entre versions PostgreSQL
âœ… Restauration sÃ©lective (tables, schÃ©mas)
âœ… Lisible par un humain (format SQL)
âœ… Fonctionne entre architectures diffÃ©rentes

InconvÃ©nients :
âŒ Lent pour les grosses bases (>100 Go)
âŒ Consomme beaucoup de ressources
âŒ Pas de PITR (Point-In-Time Recovery)
âŒ La base continue Ã  changer pendant le dump
```

**Commandes de base :**

```bash
# Backup complet
pg_dump -h localhost -U postgres -d mydb -F custom -f backup.dump

# Backup en SQL lisible
pg_dump -h localhost -U postgres -d mydb -f backup.sql

# Backup de toutes les bases
pg_dumpall -h localhost -U postgres -f all_databases.sql

# Restauration
pg_restore -h localhost -U postgres -d mydb backup.dump
```

### 2. Backup Physique (pg_basebackup)

Un backup physique copie les fichiers de donnÃ©es PostgreSQL directement.

```
BACKUP PHYSIQUE (pg_basebackup)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

PostgreSQL â”€â”€â–º pg_basebackup â”€â”€â–º copie des fichiers data
               (binary copy)     (/var/lib/postgresql/data)

Avantages :
âœ… TrÃ¨s rapide, mÃªme pour les grosses bases
âœ… Base pour le PITR
âœ… Copie cohÃ©rente Ã  un instant T
âœ… Peut Ãªtre streamÃ© vers un stockage distant

InconvÃ©nients :
âŒ Non portable entre versions majeures
âŒ Restauration complÃ¨te uniquement (pas de sÃ©lection)
âŒ DÃ©pend de l'architecture (x86 vs ARM)
âŒ NÃ©cessite plus d'espace (copie binaire)
```

**Commandes de base :**

```bash
# Backup physique complet
pg_basebackup -h localhost -U replication -D /backup/base -Fp -Xs -P

# Backup compressÃ©
pg_basebackup -h localhost -U replication -D /backup/base -Ft -z -Xs -P
```

### 3. WAL Archiving et PITR

Le **Point-In-Time Recovery** permet de restaurer Ã  n'importe quel moment.

```
WAL ARCHIVING + PITR
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

                    WAL (Write-Ahead Log)
                    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                    Journal de toutes les modifications

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Base Backup  â”‚ â”€â”€â–º â”‚ WAL Segment 1â”‚ â”€â”€â–º â”‚ WAL Segment 2â”‚ â”€â”€â–º ...
â”‚ (Lundi 00:00)â”‚     â”‚ (Lundi 00:01)â”‚     â”‚ (Lundi 00:02)â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                    â”‚                    â”‚
       â”‚                    â”‚                    â”‚
       â–¼                    â–¼                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      STOCKAGE S3                            â”‚
â”‚                                                             â”‚
â”‚  base_backup_2024-01-15.tar.gz                              â”‚
â”‚  wal/000000010000000000000001                               â”‚
â”‚  wal/000000010000000000000002                               â”‚
â”‚  wal/000000010000000000000003                               â”‚
â”‚  ...                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

PITR : Restaurer Ã  Mardi 14:35:22 exactement
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

1. Restaurer le base backup de Lundi 00:00
2. Rejouer les WAL jusqu'Ã  Mardi 14:35:22
3. Base restaurÃ©e Ã  l'Ã©tat exact de ce moment !
```

### 4. Snapshot de Volume

Les snapshots de PersistentVolume capturent l'Ã©tat du disque.

```
VOLUME SNAPSHOT
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     PersistentVolume                         â”‚
â”‚                     (100 Gi, EBS gp3)                        â”‚
â”‚                                                              â”‚
â”‚   /var/lib/postgresql/data                                   â”‚
â”‚   â”œâ”€â”€ base/                                                  â”‚
â”‚   â”œâ”€â”€ global/                                                â”‚
â”‚   â”œâ”€â”€ pg_wal/                                                â”‚
â”‚   â””â”€â”€ ...                                                    â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â”‚ Snapshot
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     VolumeSnapshot                           â”‚
â”‚                     (snapshot-2024-01-15)                    â”‚
â”‚                                                              â”‚
â”‚   Copie instantanÃ©e du volume                                â”‚
â”‚   (Copy-on-Write, trÃ¨s rapide)                               â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Avantages :
âœ… TrÃ¨s rapide (secondes)
âœ… CohÃ©rence au niveau bloc
âœ… Restauration rapide

InconvÃ©nients :
âŒ DÃ©pend du provider de stockage
âŒ Pas portable entre clouds
âŒ NÃ©cessite que PostgreSQL soit en mode cohÃ©rent
```

### Comparaison des Types de Backup

| Aspect | pg_dump | pg_basebackup | WAL/PITR | Snapshot |
|--------|---------|---------------|----------|----------|
| **Vitesse backup** | Lent | Moyen | Continu | TrÃ¨s rapide |
| **Vitesse restore** | Lent | Rapide | Variable | TrÃ¨s rapide |
| **PITR** | âŒ | âŒ | âœ… | âŒ |
| **PortabilitÃ©** | âœ… | âŒ | âŒ | âŒ |
| **SÃ©lectivitÃ©** | âœ… | âŒ | âŒ | âŒ |
| **Grosses bases** | âŒ | âœ… | âœ… | âœ… |
| **ComplexitÃ©** | Simple | Moyenne | AvancÃ©e | Moyenne |

---

## Solutions Natives PostgreSQL

### pgBackRest

**pgBackRest** est l'outil de backup le plus robuste et le plus utilisÃ© pour PostgreSQL en production.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           pgBackRest                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  CaractÃ©ristiques :                                                 â”‚
â”‚  â€¢ Backups full, diffÃ©rentiels et incrÃ©mentaux                      â”‚
â”‚  â€¢ Compression et chiffrement                                       â”‚
â”‚  â€¢ ParallÃ©lisation (trÃ¨s rapide)                                    â”‚
â”‚  â€¢ Multi-repository (local + S3 + Azure + GCS)                      â”‚
â”‚  â€¢ PITR intÃ©grÃ©                                                     â”‚
â”‚  â€¢ VÃ©rification d'intÃ©gritÃ©                                         â”‚
â”‚                                                                     â”‚
â”‚  UtilisÃ© par : Crunchy Operator, nombreuses entreprises             â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Configuration de Base

```ini
# /etc/pgbackrest/pgbackrest.conf

[global]
repo1-path=/var/lib/pgbackrest
repo1-retention-full=2
repo1-retention-diff=7

# Compression
compress-type=zst
compress-level=3

# ParallÃ©lisation
process-max=4

[mydb]
pg1-path=/var/lib/postgresql/16/main
pg1-port=5432
```

#### Commandes Essentielles

```bash
# Backup full
pgbackrest --stanza=mydb --type=full backup

# Backup diffÃ©rentiel
pgbackrest --stanza=mydb --type=diff backup

# Backup incrÃ©mental
pgbackrest --stanza=mydb --type=incr backup

# Lister les backups
pgbackrest --stanza=mydb info

# Restaurer le dernier backup
pgbackrest --stanza=mydb restore

# Restaurer Ã  un point prÃ©cis (PITR)
pgbackrest --stanza=mydb --type=time \
  --target="2024-01-15 14:30:00" restore

# VÃ©rifier l'intÃ©gritÃ©
pgbackrest --stanza=mydb verify
```

#### Configuration Multi-Repository

```ini
[global]
# Repo local (rapide)
repo1-path=/var/lib/pgbackrest
repo1-retention-full=2

# Repo S3 (disaster recovery)
repo2-type=s3
repo2-s3-endpoint=s3.amazonaws.com
repo2-s3-bucket=my-pg-backups
repo2-s3-region=us-east-1
repo2-path=/backups
repo2-retention-full=4
```

### Barman

**Barman** (Backup and Recovery Manager) est dÃ©veloppÃ© par EDB et utilisÃ© par CloudNativePG.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                             Barman                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  CaractÃ©ristiques :                                                 â”‚
â”‚  â€¢ Backups full et incrÃ©mentaux                                     â”‚
â”‚  â€¢ WAL archiving et streaming                                       â”‚
â”‚  â€¢ PITR                                                             â”‚
â”‚  â€¢ Support S3, Azure, GCS                                           â”‚
â”‚  â€¢ Hooks prÃ©/post backup                                            â”‚
â”‚                                                                     â”‚
â”‚  UtilisÃ© par : CloudNativePG, EDB                                   â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Configuration de Base

```ini
# /etc/barman/barman.conf

[barman]
barman_home = /var/lib/barman
configuration_files_directory = /etc/barman/conf.d
barman_lock_directory = /var/lib/barman
log_file = /var/log/barman/barman.log
compression = gzip

[mydb]
description = "My PostgreSQL Server"
ssh_command = ssh postgres@db-server
conninfo = host=db-server user=barman dbname=postgres
backup_method = rsync
archiver = on
retention_policy = RECOVERY WINDOW OF 7 DAYS
```

#### Commandes Essentielles

```bash
# VÃ©rifier la configuration
barman check mydb

# CrÃ©er un backup
barman backup mydb

# Lister les backups
barman list-backup mydb

# Restaurer
barman recover mydb latest /var/lib/postgresql/data

# Restaurer PITR
barman recover mydb latest /var/lib/postgresql/data \
  --target-time "2024-01-15 14:30:00"
```

### WAL-G

**WAL-G** est le successeur de WAL-E, utilisÃ© par Zalando Operator.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                             WAL-G                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  CaractÃ©ristiques :                                                 â”‚
â”‚  â€¢ TrÃ¨s rapide (Ã©crit en Go)                                        â”‚
â”‚  â€¢ Compression LZ4/ZSTD                                             â”‚
â”‚  â€¢ Support S3, GCS, Azure, Swift, filesystem                        â”‚
â”‚  â€¢ Delta backups                                                    â”‚
â”‚  â€¢ Chiffrement                                                      â”‚
â”‚                                                                     â”‚
â”‚  UtilisÃ© par : Zalando Operator                                     â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Variables d'Environnement

```bash
# Configuration S3
export WALG_S3_PREFIX=s3://my-bucket/walg
export AWS_ACCESS_KEY_ID=xxx
export AWS_SECRET_ACCESS_KEY=xxx
export AWS_REGION=us-east-1

# Compression
export WALG_COMPRESSION_METHOD=zstd
```

#### Commandes Essentielles

```bash
# Backup full
wal-g backup-push /var/lib/postgresql/data

# Lister les backups
wal-g backup-list

# Restaurer le dernier backup
wal-g backup-fetch /var/lib/postgresql/data LATEST

# Supprimer les anciens backups (garder 7)
wal-g delete retain FULL 7 --confirm

# Archiver un WAL
wal-g wal-push /var/lib/postgresql/data/pg_wal/000000010000000000000001

# RÃ©cupÃ©rer un WAL
wal-g wal-fetch 000000010000000000000001 /var/lib/postgresql/data/pg_wal/
```

---

## Backups avec les Operators PostgreSQL

Les Operators PostgreSQL intÃ¨grent les outils de backup natifs et automatisent leur utilisation.

### CloudNativePG : Backups avec Barman

```yaml
apiVersion: postgresql.cnpg.io/v1
kind: Cluster
metadata:
  name: my-cluster
spec:
  instances: 3

  # Configuration des backups
  backup:
    barmanObjectStore:
      destinationPath: s3://my-bucket/backups
      s3Credentials:
        accessKeyId:
          name: s3-creds
          key: ACCESS_KEY_ID
        secretAccessKey:
          name: s3-creds
          key: SECRET_ACCESS_KEY
      wal:
        compression: gzip
        maxParallel: 4
      data:
        compression: gzip
        immediateCheckpoint: true
    retentionPolicy: "7d"

---
# Backup planifiÃ©
apiVersion: postgresql.cnpg.io/v1
kind: ScheduledBackup
metadata:
  name: daily-backup
spec:
  cluster:
    name: my-cluster
  schedule: "0 2 * * *"      # Tous les jours Ã  2h
  backupOwnerReference: self
  immediate: false
```

**CrÃ©er un backup Ã  la demande :**

```yaml
apiVersion: postgresql.cnpg.io/v1
kind: Backup
metadata:
  name: manual-backup-20240115
spec:
  cluster:
    name: my-cluster
```

```bash
kubectl apply -f backup.yaml
kubectl get backups
```

### Crunchy PGO : Backups avec pgBackRest

```yaml
apiVersion: postgres-operator.crunchydata.com/v1beta1
kind: PostgresCluster
metadata:
  name: hippo
spec:
  postgresVersion: 16

  instances:
    - name: instance1
      replicas: 3
      dataVolumeClaimSpec:
        storage: 50Gi

  # Configuration pgBackRest
  backups:
    pgbackrest:
      image: registry.crunchydata.com/crunchydata/crunchy-pgbackrest:ubi8-2.47-2

      # Configuration globale
      configuration:
        - secret:
            name: pgbackrest-secrets

      global:
        repo1-retention-full: "7"
        repo1-retention-full-type: count

      # Repositories
      repos:
        # Repo local pour backups rapides
        - name: repo1
          schedules:
            full: "0 1 * * 0"       # Dimanche 1h
            differential: "0 1 * * 1-6"  # Lun-Sam 1h
          volume:
            volumeClaimSpec:
              accessModes: ["ReadWriteOnce"]
              resources:
                requests:
                  storage: 100Gi

        # Repo S3 pour DR
        - name: repo2
          schedules:
            full: "0 3 * * 0"       # Dimanche 3h
          s3:
            bucket: "my-pg-backups"
            endpoint: "s3.amazonaws.com"
            region: "us-east-1"
```

**CrÃ©er un backup Ã  la demande :**

```bash
# Annoter le cluster pour dÃ©clencher un backup
kubectl annotate postgrescluster hippo \
  postgres-operator.crunchydata.com/pgbackrest-backup="$(date +%Y%m%d%H%M%S)"
```

### Zalando Operator : Backups avec WAL-G

```yaml
# ConfigMap de l'Operator
apiVersion: v1
kind: ConfigMap
metadata:
  name: postgres-operator
data:
  # Configuration WAL-G vers S3
  aws_region: eu-west-1
  wal_s3_bucket: my-postgres-backups

  # Planification
  logical_backup_schedule: "0 3 * * *"

  # RÃ©tention
  wal_g_backup_retention: "7"
```

```yaml
# Cluster avec backup activÃ©
apiVersion: "acid.zalan.do/v1"
kind: postgresql
metadata:
  name: my-cluster
spec:
  teamId: myteam
  numberOfInstances: 3
  postgresql:
    version: "16"
  volume:
    size: 50Gi

  # Activer les backups logiques
  enableLogicalBackup: true
  logicalBackupSchedule: "0 3 * * *"
```

---

## Velero : Backup de l'Ensemble du Cluster

### PrÃ©sentation

**Velero** (anciennement Heptio Ark) est un outil de backup pour Kubernetes qui sauvegarde Ã  la fois les ressources Kubernetes et les volumes persistants.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                             VELERO                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  Ce que Velero sauvegarde :                                         â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  RESSOURCES KUBERNETES                                      â”‚    â”‚
â”‚  â”‚  â€¢ Deployments, StatefulSets, Services                      â”‚    â”‚
â”‚  â”‚  â€¢ ConfigMaps, Secrets                                      â”‚    â”‚
â”‚  â”‚  â€¢ Custom Resources (PostgresCluster, Cluster, etc.)        â”‚    â”‚
â”‚  â”‚  â€¢ RBAC (Roles, RoleBindings)                               â”‚    â”‚
â”‚  â”‚  â€¢ NetworkPolicies                                          â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                            +                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  VOLUMES PERSISTANTS                                        â”‚    â”‚
â”‚  â”‚  â€¢ Snapshots de PersistentVolumes                           â”‚    â”‚
â”‚  â”‚  â€¢ Ou copie via Restic/Kopia (filesystem backup)            â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                     â”‚
â”‚  Stockage : S3, GCS, Azure Blob, MinIO, ...                         â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Quand Utiliser Velero pour PostgreSQL ?

| ScÃ©nario | Velero seul | Backup PostgreSQL natif | Les deux |
|----------|-------------|------------------------|----------|
| **DR cluster complet** | âœ… | âŒ | âœ… |
| **Migration de cluster** | âœ… | âŒ | âœ… |
| **PITR granulaire** | âŒ | âœ… | âœ… |
| **Restauration table** | âŒ | âœ… | âœ… |
| **Backup cross-cloud** | âœ… | âœ… | âœ… |
| **ConformitÃ©/Audit** | âœ… | âœ… | âœ… |

**Recommandation** : Utilisez **les deux** pour une protection maximale.

### Installation de Velero

```bash
# TÃ©lÃ©charger le CLI
curl -LO https://github.com/vmware-tanzu/velero/releases/download/v1.13.0/velero-v1.13.0-linux-amd64.tar.gz
tar -xvf velero-v1.13.0-linux-amd64.tar.gz
sudo mv velero-v1.13.0-linux-amd64/velero /usr/local/bin/

# Installer Velero avec le provider AWS
velero install \
  --provider aws \
  --plugins velero/velero-plugin-for-aws:v1.8.0 \
  --bucket my-velero-backups \
  --backup-location-config region=us-east-1 \
  --snapshot-location-config region=us-east-1 \
  --secret-file ./credentials-velero

# VÃ©rifier l'installation
velero version
kubectl get pods -n velero
```

#### Fichier credentials-velero

```ini
[default]
aws_access_key_id=YOUR_ACCESS_KEY
aws_secret_access_key=YOUR_SECRET_KEY
```

### Configuration de Velero

#### BackupStorageLocation

```yaml
apiVersion: velero.io/v1
kind: BackupStorageLocation
metadata:
  name: default
  namespace: velero
spec:
  provider: aws
  objectStorage:
    bucket: my-velero-backups
    prefix: cluster-backups
  config:
    region: us-east-1
    s3ForcePathStyle: "false"
```

#### VolumeSnapshotLocation

```yaml
apiVersion: velero.io/v1
kind: VolumeSnapshotLocation
metadata:
  name: default
  namespace: velero
spec:
  provider: aws
  config:
    region: us-east-1
```

### CrÃ©er un Backup avec Velero

#### Backup Complet du Namespace

```bash
# Backup du namespace contenant PostgreSQL
velero backup create postgres-backup-20240115 \
  --include-namespaces postgres-namespace \
  --wait

# VÃ©rifier le status
velero backup describe postgres-backup-20240115
velero backup logs postgres-backup-20240115
```

#### Backup avec Labels

```bash
# Backup uniquement les ressources avec un label spÃ©cifique
velero backup create postgres-cluster-backup \
  --selector app=postgres \
  --include-namespaces postgres-namespace \
  --wait
```

#### Backup PlanifiÃ©

```yaml
apiVersion: velero.io/v1
kind: Schedule
metadata:
  name: daily-postgres-backup
  namespace: velero
spec:
  schedule: "0 3 * * *"    # Tous les jours Ã  3h
  template:
    includedNamespaces:
      - postgres-namespace
    includedResources:
      - persistentvolumeclaims
      - persistentvolumes
      - secrets
      - configmaps
      - services
      - statefulsets
      - postgresclusters.postgresql.cnpg.io  # CR CloudNativePG
    storageLocation: default
    volumeSnapshotLocations:
      - default
    ttl: 168h    # RÃ©tention 7 jours
```

```bash
kubectl apply -f schedule.yaml
velero schedule get
```

### Restaurer avec Velero

#### Restauration ComplÃ¨te

```bash
# Restaurer dans le mÃªme cluster
velero restore create --from-backup postgres-backup-20240115

# Restaurer dans un namespace diffÃ©rent
velero restore create --from-backup postgres-backup-20240115 \
  --namespace-mappings postgres-namespace:postgres-restored
```

#### Restauration SÃ©lective

```bash
# Restaurer uniquement les PVC et secrets
velero restore create --from-backup postgres-backup-20240115 \
  --include-resources persistentvolumeclaims,secrets
```

### Hooks Pre/Post Backup

Pour garantir la cohÃ©rence des backups PostgreSQL, utilisez des **hooks** :

```yaml
apiVersion: velero.io/v1
kind: Backup
metadata:
  name: postgres-consistent-backup
  namespace: velero
spec:
  includedNamespaces:
    - postgres-namespace
  hooks:
    resources:
      - name: postgres-hook
        includedNamespaces:
          - postgres-namespace
        labelSelector:
          matchLabels:
            app: postgres
        pre:
          - exec:
              container: postgres
              command:
                - /bin/bash
                - -c
                - |
                  # Checkpoint pour garantir la cohÃ©rence
                  psql -U postgres -c "CHECKPOINT;"
                  # Optionnel : pause des Ã©critures
                  # psql -U postgres -c "SELECT pg_backup_start('velero');"
              onError: Fail
              timeout: 60s
        post:
          - exec:
              container: postgres
              command:
                - /bin/bash
                - -c
                - |
                  # Optionnel : reprise des Ã©critures
                  # psql -U postgres -c "SELECT pg_backup_stop();"
                  echo "Backup completed"
              onError: Continue
              timeout: 60s
```

### Velero avec Restic/Kopia (File System Backup)

Pour les volumes qui ne supportent pas les snapshots natifs :

```bash
# Installer avec Restic/Kopia
velero install \
  --provider aws \
  --plugins velero/velero-plugin-for-aws:v1.8.0 \
  --bucket my-velero-backups \
  --backup-location-config region=us-east-1 \
  --use-node-agent \
  --default-volumes-to-fs-backup \
  --secret-file ./credentials-velero
```

Annoter les PVC pour le backup filesystem :

```yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: data-postgres-0
  annotations:
    backup.velero.io/backup-volumes: data
spec:
  # ...
```

---

## Volume Snapshots Kubernetes

### VolumeSnapshot API

Kubernetes offre une API native pour les snapshots de volumes.

```yaml
# VolumeSnapshotClass
apiVersion: snapshot.storage.k8s.io/v1
kind: VolumeSnapshotClass
metadata:
  name: csi-snapclass
driver: ebs.csi.aws.com    # Ou votre driver CSI
deletionPolicy: Retain
parameters:
  # ParamÃ¨tres spÃ©cifiques au driver
```

```yaml
# VolumeSnapshot
apiVersion: snapshot.storage.k8s.io/v1
kind: VolumeSnapshot
metadata:
  name: postgres-snapshot-20240115
spec:
  volumeSnapshotClassName: csi-snapclass
  source:
    persistentVolumeClaimName: data-postgres-0
```

### Automatiser les Snapshots

```yaml
# CronJob pour snapshots quotidiens
apiVersion: batch/v1
kind: CronJob
metadata:
  name: postgres-snapshot-job
spec:
  schedule: "0 2 * * *"
  jobTemplate:
    spec:
      template:
        spec:
          serviceAccountName: snapshot-creator
          containers:
            - name: snapshot-creator
              image: bitnami/kubectl:latest
              command:
                - /bin/bash
                - -c
                - |
                  TIMESTAMP=$(date +%Y%m%d%H%M%S)
                  cat <<EOF | kubectl apply -f -
                  apiVersion: snapshot.storage.k8s.io/v1
                  kind: VolumeSnapshot
                  metadata:
                    name: postgres-snapshot-${TIMESTAMP}
                  spec:
                    volumeSnapshotClassName: csi-snapclass
                    source:
                      persistentVolumeClaimName: data-postgres-0
                  EOF
          restartPolicy: OnFailure
```

### Restaurer depuis un Snapshot

```yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: data-postgres-restored
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 50Gi
  dataSource:
    name: postgres-snapshot-20240115
    kind: VolumeSnapshot
    apiGroup: snapshot.storage.k8s.io
```

---

## StratÃ©gie de Backup ComplÃ¨te

### Architecture RecommandÃ©e

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              STRATÃ‰GIE DE BACKUP MULTICOUCHE                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  COUCHE 1 : BACKUP POSTGRESQL NATIF (via Operator)                  â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                   â”‚
â”‚  â€¢ Backup continu WAL (PITR)                                        â”‚
â”‚  â€¢ Backup full quotidien                                            â”‚
â”‚  â€¢ Stockage : S3 rÃ©gion primaire                                    â”‚
â”‚  â€¢ RÃ©tention : 7 jours                                              â”‚
â”‚  â€¢ Restauration : table, PITR, base complÃ¨te                        â”‚
â”‚                                                                     â”‚
â”‚                               +                                     â”‚
â”‚                                                                     â”‚
â”‚  COUCHE 2 : VELERO (Ressources K8s + Volumes)                       â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                       â”‚
â”‚  â€¢ Backup quotidien namespace complet                               â”‚
â”‚  â€¢ Snapshots de volumes                                             â”‚
â”‚  â€¢ Stockage : S3 rÃ©gion primaire                                    â”‚
â”‚  â€¢ RÃ©tention : 30 jours                                             â”‚
â”‚  â€¢ Restauration : cluster complet, migration                        â”‚
â”‚                                                                     â”‚
â”‚                               +                                     â”‚
â”‚                                                                     â”‚
â”‚  COUCHE 3 : RÃ‰PLICATION CROSS-RÃ‰GION (DR)                           â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                           â”‚
â”‚  â€¢ Replica cluster dans une autre rÃ©gion                            â”‚
â”‚  â€¢ S3 Cross-Region Replication                                      â”‚
â”‚  â€¢ Velero backup vers bucket DR                                     â”‚
â”‚  â€¢ RPO : quelques minutes                                           â”‚
â”‚  â€¢ RTO : quelques heures                                            â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Planification des Backups

```
CALENDRIER DE BACKUP
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Heure â”‚ Lun â”‚ Mar â”‚ Mer â”‚ Jeu â”‚ Ven â”‚ Sam â”‚ Dim â”‚ Type          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 00:00 â”‚  â—  â”‚  â—  â”‚  â—  â”‚  â—  â”‚  â—  â”‚  â—  â”‚  â—  â”‚ WAL continu   â”‚
â”‚ 01:00 â”‚  â—‹  â”‚  â—‹  â”‚  â—‹  â”‚  â—‹  â”‚  â—‹  â”‚  â—‹  â”‚  â—†  â”‚ PG Full(dim)  â”‚
â”‚ 02:00 â”‚  â—‹  â”‚  â—‹  â”‚  â—‹  â”‚  â—‹  â”‚  â—‹  â”‚  â—‹  â”‚     â”‚ PG Diff       â”‚
â”‚ 03:00 â”‚  â–   â”‚  â–   â”‚  â–   â”‚  â–   â”‚  â–   â”‚  â–   â”‚  â–   â”‚ Velero        â”‚
â”‚ 04:00 â”‚     â”‚     â”‚     â”‚     â”‚     â”‚     â”‚  â–¡  â”‚ Velero DR     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

LÃ©gende :
â—  WAL archiving (continu)
â—‹  PostgreSQL diffÃ©rentiel
â—†  PostgreSQL full
â–   Velero quotidien
â–¡  Velero cross-rÃ©gion (hebdo)
```

### Matrice de RÃ©tention

| Type de Backup | FrÃ©quence | RÃ©tention | Stockage |
|----------------|-----------|-----------|----------|
| **WAL** | Continu | 7 jours | S3 primaire |
| **PG Full** | Hebdo | 4 semaines | S3 primaire |
| **PG Diff** | Quotidien | 7 jours | S3 primaire |
| **Velero** | Quotidien | 30 jours | S3 primaire |
| **Velero DR** | Hebdo | 90 jours | S3 secondaire |
| **Export mensuel** | Mensuel | 1 an | S3 Glacier |

---

## Tester les Restaurations

### Pourquoi Tester ?

> "Un backup non testÃ© n'est pas un backup."

```
STATISTIQUES ALARMANTES
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

â€¢ 34% des entreprises ne testent jamais leurs backups
â€¢ 77% des restaurations Ã©chouent lors du premier essai
â€¢ Le temps moyen pour dÃ©couvrir un backup corrompu : 140 jours
```

### Plan de Test de Restauration

```yaml
# CronJob de test de restauration mensuel
apiVersion: batch/v1
kind: CronJob
metadata:
  name: backup-restore-test
spec:
  schedule: "0 4 1 * *"    # Premier jour du mois Ã  4h
  jobTemplate:
    spec:
      template:
        spec:
          containers:
            - name: restore-test
              image: my-restore-tester:latest
              env:
                - name: SLACK_WEBHOOK
                  valueFrom:
                    secretKeyRef:
                      name: alerting-secrets
                      key: slack-webhook
              command:
                - /bin/bash
                - -c
                - |
                  set -e

                  echo "=== Test de restauration PostgreSQL ==="

                  # 1. CrÃ©er un namespace temporaire
                  kubectl create namespace restore-test

                  # 2. Restaurer depuis le dernier backup
                  velero restore create test-restore-$(date +%Y%m%d) \
                    --from-backup $(velero backup get -o json | jq -r '.items[0].metadata.name') \
                    --namespace-mappings postgres-namespace:restore-test \
                    --wait

                  # 3. Attendre que PostgreSQL soit prÃªt
                  kubectl wait --for=condition=ready pod -l app=postgres \
                    -n restore-test --timeout=300s

                  # 4. VÃ©rifier l'intÃ©gritÃ© des donnÃ©es
                  kubectl exec -n restore-test postgres-0 -- \
                    psql -U postgres -c "SELECT count(*) FROM important_table;"

                  # 5. Nettoyer
                  kubectl delete namespace restore-test

                  # 6. Notifier le succÃ¨s
                  curl -X POST $SLACK_WEBHOOK \
                    -d '{"text":"âœ… Test de restauration rÃ©ussi !"}'
          restartPolicy: OnFailure
```

### Checklist de Test

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CHECKLIST TEST DE RESTAURATION                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  â–¡ Backup le plus rÃ©cent est accessible                             â”‚
â”‚  â–¡ Restauration complÃ¨te fonctionne                                 â”‚
â”‚  â–¡ PostgreSQL dÃ©marre correctement                                  â”‚
â”‚  â–¡ DonnÃ©es sont intÃ¨gres (checksums, count)                         â”‚
â”‚  â–¡ Applications peuvent se connecter                                â”‚
â”‚  â–¡ Performances acceptables aprÃ¨s restauration                      â”‚
â”‚  â–¡ PITR fonctionne Ã  diffÃ©rents points dans le temps                â”‚
â”‚  â–¡ Temps de restauration (RTO) est dans les limites                 â”‚
â”‚  â–¡ Documentation de procÃ©dure est Ã  jour                            â”‚
â”‚  â–¡ L'Ã©quipe sait exÃ©cuter la procÃ©dure                              â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Bonnes Pratiques

### 1. Automatiser Tout

```yaml
# Aucun backup manuel en production
# Tout doit Ãªtre automatisÃ© et planifiÃ©
schedule: "0 2 * * *"    # Pas d'intervention humaine
```

### 2. Chiffrer les Backups

```yaml
# pgBackRest
repo1-cipher-type=aes-256-cbc
repo1-cipher-pass=your-encryption-key

# Velero avec chiffrement S3
spec:
  config:
    serverSideEncryption: aws:kms
    kmsKeyId: arn:aws:kms:...
```

### 3. Monitorer les Backups

```yaml
# Alertes sur Ã©chec de backup
- alert: PostgresBackupFailed
  expr: pg_backup_last_success_timestamp < (time() - 86400)
  for: 1h
  labels:
    severity: critical
  annotations:
    summary: "Backup PostgreSQL en Ã©chec depuis 24h"
```

### 4. Documenter les ProcÃ©dures

```markdown
## ProcÃ©dure de Restauration d'Urgence

### PrÃ©requis
- AccÃ¨s kubectl au cluster
- Credentials S3
- ...

### Ã‰tapes
1. Identifier le backup Ã  restaurer
   ```
   velero backup get
   ```
2. CrÃ©er la restauration
   ...
```

### 5. Respecter les RPO/RTO

| MÃ©trique | DÃ©finition | Cible Typique |
|----------|------------|---------------|
| **RPO** (Recovery Point Objective) | Perte de donnÃ©es max acceptable | 1 heure |
| **RTO** (Recovery Time Objective) | Temps de restauration max | 4 heures |

---

## Conclusion

L'automatisation des backups PostgreSQL sur Kubernetes nÃ©cessite une approche multicouche :

1. **Backups PostgreSQL natifs** (pgBackRest, Barman, WAL-G) pour la granularitÃ© et le PITR
2. **Velero** pour la sauvegarde complÃ¨te des ressources Kubernetes et la migration
3. **Snapshots de volumes** pour des restaurations rapides
4. **RÃ©plication cross-rÃ©gion** pour le disaster recovery

Les Operators PostgreSQL (CloudNativePG, Crunchy, Zalando) simplifient considÃ©rablement la configuration des backups natifs. Velero complÃ¨te cette protection en sauvegardant l'ensemble de l'environnement Kubernetes.

**Points clÃ©s Ã  retenir :**

- Automatisez 100% de vos backups
- Suivez la rÃ¨gle 3-2-1
- Testez rÃ©guliÃ¨rement vos restaurations
- Documentez vos procÃ©dures
- Monitorez et alertez sur les Ã©checs

Un systÃ¨me de backup robuste n'est pas un luxe, c'est une nÃ©cessitÃ© absolue pour toute base de donnÃ©es en production.

---

## Ressources ComplÃ©mentaires

### Documentation Officielle

- [Velero Documentation](https://velero.io/docs/)
- [pgBackRest Documentation](https://pgbackrest.org/)
- [Barman Documentation](https://docs.pgbarman.org/)
- [WAL-G GitHub](https://github.com/wal-g/wal-g)

### Tutoriels

- Velero : Getting Started Guide
- Kubernetes Volume Snapshots
- Disaster Recovery pour PostgreSQL

### Outils

- Velero CLI
- kubectl avec plugins snapshot
- pgBackRest CLI
- Barman CLI

---


â­ï¸ [Service mesh et observabilitÃ©](/20bis-postgresql-et-architectures-modernes/04.4-service-mesh-observabilite.md)
