üîù Retour au [Sommaire](/SOMMAIRE.md)

# 21.3.4. Upgrade Simplifi√© avec Pr√©servation des Statistiques

## Introduction

Mettre √† jour PostgreSQL vers une nouvelle version majeure a longtemps √©t√© une op√©ration d√©licate, notamment en raison de la perte des **statistiques de l'optimiseur**. PostgreSQL 18 r√©volutionne ce processus en introduisant la **pr√©servation automatique des statistiques** et plusieurs am√©liorations de l'outil `pg_upgrade`.

Cette section explique ces nouveaut√©s de mani√®re accessible, m√™me si vous n'avez jamais effectu√© de mise √† jour majeure de PostgreSQL.

---

## Comprendre les Enjeux d'une Mise √† Jour Majeure

### Qu'est-ce qu'une Mise √† Jour Majeure ?

PostgreSQL utilise un syst√®me de versioning √† trois chiffres : **X.Y.Z**

| Composant | Signification | Exemple |
|-----------|---------------|---------|
| **X** (Majeur) | Version majeure, changements importants | 17 ‚Üí **18** |
| **Y** (Mineur) | Corrections de bugs et s√©curit√© | 18.0 ‚Üí 18.**1** |

Une **mise √† jour majeure** (17 ‚Üí 18) n√©cessite une migration des donn√©es, contrairement √† une mise √† jour mineure (18.0 ‚Üí 18.1) qui est transparente.

### Le Probl√®me Historique : La Perte des Statistiques

Avant PostgreSQL 18, apr√®s chaque mise √† jour majeure, vous perdiez toutes les **statistiques de l'optimiseur**. C'√©tait comme si PostgreSQL oubliait tout ce qu'il savait sur vos donn√©es.

**Analogie : Le GPS Amn√©sique**

Imaginez un GPS qui conna√Æt parfaitement votre ville : les embouteillages habituels, les raccourcis, les routes les plus rapides selon l'heure. Apr√®s une mise √† jour logicielle, ce GPS oublie tout et doit r√©apprendre chaque trajet.

C'est exactement ce qui se passait avec PostgreSQL :
- Avant la mise √† jour : PostgreSQL sait que la table `clients` contient 1 million de lignes, que 80% sont en France, que l'index sur `email` est tr√®s s√©lectif...
- Apr√®s la mise √† jour : PostgreSQL ne sait plus rien et doit tout r√©apprendre via `ANALYZE`

### Les Cons√©quences

| Probl√®me | Impact |
|----------|--------|
| **Plans de requ√™te sous-optimaux** | Requ√™tes 10√ó √† 100√ó plus lentes |
| **Temps d'ANALYZE** | Heures voire jours sur de grosses bases |
| **Indisponibilit√© prolong√©e** | Performances d√©grad√©es pendant l'analyse |
| **Risques op√©rationnels** | Incidents en production post-upgrade |

---

## Les Deux Types de Statistiques

Avant d'aller plus loin, il est crucial de distinguer deux types de statistiques dans PostgreSQL.

### 1. Statistiques de l'Optimiseur (Planner Statistics)

Ce sont les informations sur le **contenu et la distribution des donn√©es** :

| Information | Stockage | Utilis√©e par |
|-------------|----------|--------------|
| Nombre de lignes par table | `pg_class.reltuples` | Planificateur |
| Distribution des valeurs | `pg_statistic` | Planificateur |
| Statistiques √©tendues | `pg_statistic_ext_data` | Planificateur |
| Corr√©lation physique | `pg_statistic` | Planificateur |

Ces statistiques sont collect√©es par la commande `ANALYZE` et permettent au planificateur de choisir les meilleurs plans d'ex√©cution.

**PostgreSQL 18 pr√©serve ces statistiques lors des mises √† jour !** ‚úÖ

### 2. Statistiques de Monitoring (Activity Statistics)

Ce sont les informations sur l'**activit√© de la base de donn√©es** :

| Information | Stockage | Utilis√©e par |
|-------------|----------|--------------|
| Nombre de scans s√©quentiels | `pg_stat_user_tables` | DBA / Monitoring |
| Nombre de tuples ins√©r√©s/modifi√©s | `pg_stat_user_tables` | Autovacuum |
| Derni√®re date de vacuum | `pg_stat_user_tables` | Autovacuum |
| Requ√™tes les plus lentes | `pg_stat_statements` | DBA / Tuning |

Ces statistiques sont stock√©es en m√©moire partag√©e et persist√©es dans `pg_stat/`.

**PostgreSQL 18 ne pr√©serve PAS ces statistiques lors des mises √† jour.** ‚ùå

### Impact de la Non-Pr√©servation des Statistiques de Monitoring

Apr√®s une mise √† jour, l'autovacuum et l'autoanalyze "oublient" quelles tables ont besoin de maintenance :

```sql
-- Avant upgrade : PostgreSQL sait que cette table a beaucoup chang√©
SELECT relname, n_tup_ins, n_mod_since_analyze
FROM pg_stat_user_tables
WHERE relname = 'orders';
-- n_tup_ins: 500000, n_mod_since_analyze: 50000

-- Apr√®s upgrade : Tout est remis √† z√©ro
-- n_tup_ins: 0, n_mod_since_analyze: 0
```

**Recommandation** : Apr√®s une mise √† jour, lancez manuellement un `VACUUM ANALYZE` sur vos tables les plus actives.

---

## La R√©volution PostgreSQL 18 : Pr√©servation des Statistiques

### Comment √áa Fonctionne

PostgreSQL 18 introduit un m√©canisme pour **exporter et r√©importer** les statistiques de l'optimiseur.

#### Lors du Dump (Export)

`pg_dump` g√©n√®re maintenant des instructions sp√©ciales pour sauvegarder les statistiques :

```sql
-- Exemple simplifi√© de ce que pg_dump g√©n√®re
SELECT pg_catalog.pg_restore_relation_stats(
    'schemaname', 'public',
    'relname', 'clients',
    'reltuples', 1000000::real,
    'relpages', 50000::integer
    -- ... autres statistiques
);

SELECT pg_catalog.pg_restore_attribute_stats(
    'schemaname', 'public',
    'relname', 'clients',
    'attname', 'country',
    'null_frac', 0.01::real,
    'n_distinct', 195::real
    -- ... autres statistiques
);
```

#### Lors du Restore (Import)

Ces fonctions syst√®me r√©√©crivent les statistiques dans les tables catalogue (`pg_class`, `pg_statistic`), permettant √† PostgreSQL de retrouver imm√©diatement ses connaissances sur les donn√©es.

### Nouvelles Options de pg_dump et pg_restore

PostgreSQL 18 ajoute de nouvelles options pour g√©rer les statistiques :

| Option | Description |
|--------|-------------|
| `--statistics-only` | Exporte uniquement les statistiques (pas le sch√©ma ni les donn√©es) |
| `--no-statistics` | Exporte le sch√©ma et les donn√©es sans les statistiques |
| `--no-data` | Exporte uniquement le sch√©ma (existait d√©j√†) |
| `--no-schema` | Exporte uniquement les donn√©es (existait d√©j√†) |

#### Exemples d'Utilisation

```bash
# Export complet avec statistiques (comportement par d√©faut)
pg_dump -Fc mydb > mydb_full.dump

# Export uniquement les statistiques
pg_dump --statistics-only -Fc mydb > mydb_stats.dump

# Export sans statistiques (utile pour les environnements de test)
pg_dump --no-statistics -Fc mydb > mydb_no_stats.dump

# Restaurer uniquement les statistiques sur une base existante
pg_restore --statistics-only -d mydb mydb_stats.dump
```

### Limitations Actuelles

Certains types de statistiques ne sont **pas encore pr√©serv√©s** :

| Type | Pr√©serv√© ? | Remarque |
|------|------------|----------|
| Statistiques de colonnes | ‚úÖ Oui | Via `pg_statistic` |
| Statistiques de tables | ‚úÖ Oui | Via `pg_class` |
| Statistiques √©tendues | ‚ùå Non | CREATE STATISTICS |
| Statistiques d'extensions | ‚ùå Non | D√©pend de l'extension |

Pour r√©g√©n√©rer les statistiques manquantes apr√®s une mise √† jour, utilisez :

```bash
# Analyser uniquement les objets sans statistiques
vacuumdb --all --analyze-in-stages --missing-stats-only

# Puis compl√©ter avec une analyse compl√®te
vacuumdb --all --analyze-only
```

---

## Les Am√©liorations de pg_upgrade

### Rappel : Qu'est-ce que pg_upgrade ?

`pg_upgrade` est l'outil officiel pour effectuer des mises √† jour majeures de PostgreSQL. Il permet de migrer d'une version √† une autre sans avoir √† faire un dump/restore complet.

### Les Modes de Transfert de Donn√©es

pg_upgrade propose plusieurs modes pour transf√©rer les fichiers de donn√©es :

| Mode | Option | Vitesse | Espace Disque | R√©versibilit√© |
|------|--------|---------|---------------|---------------|
| **Copy** | (d√©faut) | Lent | 2√ó l'espace | ‚úÖ Ancien cluster intact |
| **Link** | `--link` | Rapide | 1√ó l'espace | ‚ùå Ancien cluster inutilisable |
| **Clone** | `--clone` | Rapide | 1√ó l'espace | ‚ùå Ancien cluster inutilisable |
| **Swap** | `--swap` | **Tr√®s rapide** | 1√ó l'espace | ‚ùå Ancien cluster inutilisable |

### Nouveaut√© PostgreSQL 18 : L'Option --swap

Le mode `--swap` est la nouveaut√© la plus spectaculaire pour les performances de mise √† jour.

#### Comment √áa Fonctionne

Au lieu de copier ou lier les fichiers, `--swap` **√©change les r√©pertoires de donn√©es** :

```
Avant --swap :
‚îú‚îÄ‚îÄ /data/pg17/  (ancien cluster avec vos donn√©es)
‚îî‚îÄ‚îÄ /data/pg18/  (nouveau cluster vide)

Apr√®s --swap :
‚îú‚îÄ‚îÄ /data/pg17/  (nouveau cluster avec vos donn√©es !)
‚îî‚îÄ‚îÄ /data/pg17.old/  (ancien cluster, renomm√©)
```

#### Avantages

- **Extr√™mement rapide** : Quelques secondes au lieu de minutes/heures
- **Aucune copie de fichiers** : Juste un renommage de r√©pertoires
- **Minimal d'espace disque** : Pas de duplication des donn√©es

#### Pr√©requis

- Les deux r√©pertoires doivent √™tre sur le **m√™me syst√®me de fichiers**
- L'ancien cluster devient **inutilisable** apr√®s le swap

#### Exemple d'Utilisation

```bash
# Mise √† jour avec swap (le plus rapide)
pg_upgrade \
    --old-datadir=/var/lib/postgresql/17/main \
    --new-datadir=/var/lib/postgresql/18/main \
    --old-bindir=/usr/lib/postgresql/17/bin \
    --new-bindir=/usr/lib/postgresql/18/bin \
    --swap
```

### Nouveaut√© PostgreSQL 18 : V√©rifications Parall√®les avec --jobs

Avant de migrer les donn√©es, `pg_upgrade` effectue de nombreuses v√©rifications de compatibilit√©. PostgreSQL 18 permet d'ex√©cuter ces v√©rifications **en parall√®le**.

#### Le Param√®tre --jobs

```bash
# V√©rifications sur 4 processus parall√®les
pg_upgrade \
    --old-datadir=/var/lib/postgresql/17/main \
    --new-datadir=/var/lib/postgresql/18/main \
    --old-bindir=/usr/lib/postgresql/17/bin \
    --new-bindir=/usr/lib/postgresql/18/bin \
    --jobs=4
```

#### Recommandation

Utilisez le nombre de c≈ìurs CPU de votre machine comme point de d√©part :

```bash
# D√©tecter le nombre de c≈ìurs
nproc
# R√©sultat : 8

# Utiliser ce nombre pour --jobs
pg_upgrade ... --jobs=8
```

Les gains sont particuli√®rement importants pour les serveurs avec :
- **Plusieurs bases de donn√©es**
- **Plusieurs tablespaces**
- **De nombreux objets** (tables, s√©quences, fonctions)

### Option --no-statistics

Si vous pr√©f√©rez repartir avec des statistiques fra√Æches :

```bash
# Mise √† jour sans pr√©server les statistiques
pg_upgrade \
    --old-datadir=/var/lib/postgresql/17/main \
    --new-datadir=/var/lib/postgresql/18/main \
    --old-bindir=/usr/lib/postgresql/17/bin \
    --new-bindir=/usr/lib/postgresql/18/bin \
    --no-statistics
```

Cela peut √™tre utile si :
- Les statistiques de l'ancien cluster √©taient obsol√®tes
- Vous avez significativement modifi√© les donn√©es pendant la migration
- Vous pr√©f√©rez un `ANALYZE` complet apr√®s la mise √† jour

---

## Proc√©dure de Mise √† Jour Compl√®te

### √âtape 1 : Pr√©paration

```bash
# V√©rifier la version actuelle
psql -c "SELECT version();"

# V√©rifier l'√©tat des checksums (important pour PG 18)
pg_controldata /var/lib/postgresql/17/main | grep "Data page checksum"
```

**Note importante** : PostgreSQL 18 active les checksums par d√©faut. Si votre ancien cluster n'a pas de checksums, vous devrez initialiser le nouveau cluster avec `--no-data-checksums` :

```bash
# Si l'ancien cluster n'a pas de checksums
initdb --pgdata=/var/lib/postgresql/18/main --no-data-checksums
```

### √âtape 2 : Installer PostgreSQL 18

```bash
# Exemple sur Debian/Ubuntu
sudo apt update
sudo apt install postgresql-18
```

### √âtape 3 : Arr√™ter les Deux Clusters

```bash
# Arr√™ter l'ancien cluster
sudo systemctl stop postgresql@17-main

# S'assurer que le nouveau cluster est arr√™t√©
sudo systemctl stop postgresql@18-main
```

### √âtape 4 : V√©rifications Pr√©alables

```bash
# Ex√©cuter pg_upgrade en mode v√©rification uniquement
sudo -u postgres /usr/lib/postgresql/18/bin/pg_upgrade \
    --old-datadir=/var/lib/postgresql/17/main \
    --new-datadir=/var/lib/postgresql/18/main \
    --old-bindir=/usr/lib/postgresql/17/bin \
    --new-bindir=/usr/lib/postgresql/18/bin \
    --check \
    --jobs=4
```

Cette commande v√©rifie la compatibilit√© sans effectuer la migration.

### √âtape 5 : Ex√©cuter la Migration

```bash
# Migration avec pr√©servation des statistiques et mode swap
sudo -u postgres /usr/lib/postgresql/18/bin/pg_upgrade \
    --old-datadir=/var/lib/postgresql/17/main \
    --new-datadir=/var/lib/postgresql/18/main \
    --old-bindir=/usr/lib/postgresql/17/bin \
    --new-bindir=/usr/lib/postgresql/18/bin \
    --swap \
    --jobs=4
```

### √âtape 6 : Post-Migration

Apr√®s la migration, pg_upgrade vous indiquera les commandes √† ex√©cuter :

```bash
# 1. R√©g√©n√©rer les statistiques manquantes (statistiques √©tendues)
/usr/lib/postgresql/18/bin/vacuumdb --all --analyze-in-stages --missing-stats-only

# 2. Mettre √† jour les statistiques cumulatives pour autovacuum
/usr/lib/postgresql/18/bin/vacuumdb --all --analyze-only

# 3. Optionnel : Acc√©l√©rer en d√©sactivant le throttling
PGOPTIONS='-c vacuum_cost_delay=0' vacuumdb --all --analyze-only --jobs=4
```

### √âtape 7 : D√©marrer et V√©rifier

```bash
# D√©marrer le nouveau cluster
sudo systemctl start postgresql@18-main

# V√©rifier la version
psql -c "SELECT version();"

# V√©rifier que les statistiques sont pr√©sentes
psql -c "SELECT relname, reltuples FROM pg_class WHERE relkind = 'r' LIMIT 5;"
```

### √âtape 8 : Nettoyage

Une fois satisfait de la migration :

```bash
# Supprimer l'ancien cluster (script g√©n√©r√© par pg_upgrade)
./delete_old_cluster.sh
```

---

## Comparaison : Avant et Apr√®s PostgreSQL 18

### Temps d'Indisponibilit√© Typique

| Sc√©nario | PostgreSQL 17 | PostgreSQL 18 |
|----------|---------------|---------------|
| **Migration (100 Go)** | ~30 min (link) | ~30 sec (swap) |
| **V√©rifications** | S√©quentielles | Parall√®les (--jobs) |
| **ANALYZE post-upgrade** | Obligatoire (heures) | Optionnel (minutes) |
| **Performance optimale** | Apr√®s ANALYZE complet | Imm√©diate |

### Exemple Concret

Base de donn√©es de 500 Go avec 200 tables :

| √âtape | Avant PG 18 | Avec PG 18 |
|-------|-------------|------------|
| V√©rifications | 10 min | 2 min (--jobs=8) |
| Transfert donn√©es | 45 min (link) | 5 sec (swap) |
| ANALYZE obligatoire | 3 heures | 15 min (stats manquantes) |
| **Total indisponibilit√©** | **~4 heures** | **~20 minutes** |

---

## Gestion des Cas Particuliers

### Checksums Non Align√©s

Si votre ancien cluster n'a pas de checksums et que vous voulez les activer :

```bash
# Option 1 : D√©sactiver les checksums sur le nouveau cluster
initdb --pgdata=/var/lib/postgresql/18/main --no-data-checksums

# Option 2 : Activer les checksums sur l'ancien cluster avant migration
# (n√©cessite un arr√™t prolong√©)
pg_checksums --enable --pgdata=/var/lib/postgresql/17/main
```

### Statistiques √âtendues

Si vous utilisez `CREATE STATISTICS`, ces statistiques devront √™tre r√©g√©n√©r√©es :

```bash
# Apr√®s migration, r√©g√©n√©rer les statistiques √©tendues
vacuumdb --all --analyze-in-stages --missing-stats-only
```

### Tables Tr√®s Volumineuses

Pour les tables de plusieurs To, consid√©rez une analyse en plusieurs √©tapes :

```bash
# √âtape 1 : Statistiques minimales (tr√®s rapide)
vacuumdb --all --analyze-in-stages --missing-stats-only

# √âtape 2 : Analyse compl√®te des tables critiques
psql -c "ANALYZE VERBOSE ma_grande_table;"
```

---

## Bonnes Pratiques

### Avant la Migration

1. **Testez d'abord** sur un environnement de pr√©-production
2. **Sauvegardez** toujours avant une mise √† jour majeure
3. **V√©rifiez la compatibilit√©** avec `--check`
4. **Planifiez une fen√™tre de maintenance** m√™me si elle sera courte

### Pendant la Migration

1. **Utilisez `--swap`** si possible (m√™me syst√®me de fichiers)
2. **Utilisez `--jobs`** selon votre nombre de c≈ìurs CPU
3. **Surveillez l'espace disque** surtout en mode copy

### Apr√®s la Migration

1. **Ex√©cutez les scripts post-migration** fournis par pg_upgrade
2. **V√©rifiez les performances** des requ√™tes critiques
3. **Surveillez l'autovacuum** pendant les premiers jours
4. **Gardez l'ancien cluster** quelques jours avant de le supprimer

---

## R√©sum√© des Nouveaut√©s

### Pr√©servation des Statistiques

| Aspect | Description |
|--------|-------------|
| **Fonctionnalit√©** | Les statistiques de l'optimiseur sont conserv√©es |
| **B√©n√©fice** | Performances optimales imm√©diatement apr√®s upgrade |
| **Limitation** | Statistiques √©tendues (CREATE STATISTICS) non pr√©serv√©es |
| **Option** | `--no-statistics` pour d√©sactiver |

### Option --swap

| Aspect | Description |
|--------|-------------|
| **Fonctionnalit√©** | √âchange les r√©pertoires au lieu de copier |
| **B√©n√©fice** | Migration quasi-instantan√©e |
| **Pr√©requis** | M√™me syst√®me de fichiers |
| **Attention** | Ancien cluster inutilisable apr√®s |

### V√©rifications Parall√®les

| Aspect | Description |
|--------|-------------|
| **Fonctionnalit√©** | Ex√©cution parall√®le des v√©rifications |
| **Option** | `--jobs=N` |
| **Recommandation** | N = nombre de c≈ìurs CPU |
| **B√©n√©fice** | V√©rifications plusieurs fois plus rapides |

### Nouvelles Commandes vacuumdb

| Commande | Description |
|----------|-------------|
| `--missing-stats-only` | Analyse uniquement les objets sans statistiques |
| `--analyze-in-stages` | Analyse progressive (rapide puis d√©taill√©e) |

---

## Conclusion

PostgreSQL 18 transforme radicalement l'exp√©rience de mise √† jour majeure :

1. **Pr√©servation des statistiques** : Plus besoin d'attendre des heures pour retrouver des performances optimales

2. **Mode swap** : Les migrations qui prenaient des heures se font maintenant en secondes

3. **V√©rifications parall√®les** : La pr√©paration de la migration est acc√©l√©r√©e

4. **Outils post-migration** : `vacuumdb --missing-stats-only` permet de ne r√©g√©n√©rer que le strict n√©cessaire

Ces am√©liorations r√©duisent consid√©rablement les risques et la dur√©e d'indisponibilit√© lors des mises √† jour, rendant plus facile de rester √† jour avec les derni√®res versions de PostgreSQL.

---


‚è≠Ô∏è [Ressources pour aller plus loin](/21-conclusion-et-perspectives/04-ressources-pour-aller-plus-loin.md)
