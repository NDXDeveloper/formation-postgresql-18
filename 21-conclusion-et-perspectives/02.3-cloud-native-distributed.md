ğŸ” Retour au [Sommaire](/SOMMAIRE.md)

# 21.2.3 Cloud-Native et Distributed PostgreSQL

## Introduction

L'adoption massive du cloud computing a transformÃ© la faÃ§on dont nous dÃ©ployons et gÃ©rons les bases de donnÃ©es. PostgreSQL, traditionnellement conÃ§u pour fonctionner sur un seul serveur, s'est adaptÃ© Ã  cette nouvelle rÃ©alitÃ© grÃ¢ce Ã  des solutions cloud-natives et distribuÃ©es.

Ce chapitre explore comment PostgreSQL s'intÃ¨gre dans les architectures cloud modernes, des services managÃ©s aux dÃ©ploiements Kubernetes, en passant par les solutions qui Ã©tendent PostgreSQL pour une distribution horizontale Ã  grande Ã©chelle.

---

## Partie 1 : Comprendre les Concepts Cloud-Native

### 1.1 Qu'est-ce que Cloud-Native ?

**Cloud-native** dÃ©signe une approche de conception d'applications qui tire pleinement parti des avantages du cloud computing :

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Principes Cloud-Native                               â”‚
â”‚                                                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚   â”‚  Conteneurs     â”‚  â”‚  Microservices  â”‚  â”‚  Orchestration  â”‚         â”‚
â”‚   â”‚                 â”‚  â”‚                 â”‚  â”‚                 â”‚         â”‚
â”‚   â”‚  Packaging      â”‚  â”‚  Architecture   â”‚  â”‚  Kubernetes     â”‚         â”‚
â”‚   â”‚  portable et    â”‚  â”‚  dÃ©couplÃ©e et   â”‚  â”‚  gestion        â”‚         â”‚
â”‚   â”‚  reproductible  â”‚  â”‚  scalable       â”‚  â”‚  automatisÃ©e    â”‚         â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚   â”‚  DevOps/GitOps  â”‚  â”‚  Ã‰lasticitÃ©     â”‚  â”‚  RÃ©silience     â”‚         â”‚
â”‚   â”‚                 â”‚  â”‚                 â”‚  â”‚                 â”‚         â”‚
â”‚   â”‚  Infrastructure â”‚  â”‚  Scale up/down  â”‚  â”‚  TolÃ©rance aux  â”‚         â”‚
â”‚   â”‚  as Code        â”‚  â”‚  automatique    â”‚  â”‚  pannes         â”‚         â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 Les DÃ©fis de PostgreSQL dans le Cloud

PostgreSQL a Ã©tÃ© conÃ§u Ã  l'origine comme une base de donnÃ©es monolithique. Son adaptation au cloud prÃ©sente des dÃ©fis spÃ©cifiques :

| DÃ©fi | Description | Solutions |
|------|-------------|-----------|
| **Ã‰tat persistant** | Les conteneurs sont Ã©phÃ©mÃ¨res, les donnÃ©es ne le sont pas | Volumes persistants, StatefulSets |
| **Haute disponibilitÃ©** | Un pod qui redÃ©marre = indisponibilitÃ© | RÃ©plication, failover automatique |
| **ScalabilitÃ© horizontale** | PostgreSQL ne scale pas nativement | Citus, read replicas, sharding |
| **Gestion des connexions** | Connexions coÃ»teuses en ressources | Connection pooling (PgBouncer) |
| **Sauvegarde/Restauration** | ComplexitÃ© dans les environnements distribuÃ©s | Outils spÃ©cialisÃ©s (pgBackRest) |

### 1.3 ModÃ¨les de DÃ©ploiement

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Spectre des Options de DÃ©ploiement                   â”‚
â”‚                                                                         â”‚
â”‚   Self-Managed                                              Fully       â”‚
â”‚   (Control total)                                          Managed      â”‚
â”‚   â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º   â”‚
â”‚                                                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚   VM /   â”‚  â”‚ Docker / â”‚  â”‚Kubernetesâ”‚  â”‚ Managed  â”‚  â”‚Serverlessâ”‚  â”‚
â”‚   â”‚   Bare   â”‚  â”‚ Compose  â”‚  â”‚ Operatorsâ”‚  â”‚   DBaaS  â”‚  â”‚   DB     â”‚  â”‚
â”‚   â”‚  Metal   â”‚  â”‚          â”‚  â”‚          â”‚  â”‚          â”‚  â”‚          â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                         â”‚
â”‚   Plus de        â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º    Moins de      â”‚
â”‚   contrÃ´le                                                contrÃ´le      â”‚
â”‚                                                                         â”‚
â”‚   Plus de        â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º    Moins de      â”‚
â”‚   maintenance                                             maintenance   â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Partie 2 : PostgreSQL ManagÃ© dans le Cloud

### 2.1 Vue d'Ensemble des Services ManagÃ©s

Les principaux fournisseurs cloud proposent des services PostgreSQL managÃ©s :

| Service | Fournisseur | Points Forts |
|---------|-------------|--------------|
| **Amazon RDS** | AWS | Mature, large Ã©cosystÃ¨me |
| **Amazon Aurora** | AWS | Compatible PostgreSQL, trÃ¨s performant |
| **Azure Database** | Microsoft | IntÃ©gration Azure, Flexible Server |
| **Cloud SQL** | Google | Simple, intÃ©grÃ© GCP |
| **AlloyDB** | Google | Haute performance, compatible PostgreSQL |
| **Neon** | Neon | Serverless, branching |
| **Supabase** | Supabase | Backend-as-a-Service, temps rÃ©el |
| **PlanetScale** | - | MySQL (mentionnÃ© pour comparaison) |
| **CockroachDB** | Cockroach Labs | DistribuÃ©, compatible PostgreSQL |

### 2.2 Amazon RDS pour PostgreSQL

Amazon RDS (Relational Database Service) est le service managÃ© PostgreSQL le plus utilisÃ©.

#### CaractÃ©ristiques

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Architecture RDS PostgreSQL                          â”‚
â”‚                                                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                         VPC Client                              â”‚   â”‚
â”‚   â”‚                                                                 â”‚   â”‚
â”‚   â”‚   Application â”€â”€â”€â”€â”€â–º Security Group â”€â”€â”€â”€â”€â–º RDS Endpoint         â”‚   â”‚
â”‚   â”‚                                                                 â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                      â”‚                                  â”‚
â”‚                                      â–¼                                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                    AWS Managed Infrastructure                   â”‚   â”‚
â”‚   â”‚                                                                 â”‚   â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    RÃ©plication     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚   â”‚
â”‚   â”‚   â”‚   Primary   â”‚ â”€â”€â”€â”€â”€synchroneâ”€â”€â”€â”€â–º â”‚   Standby   â”‚  Multi-AZ â”‚   â”‚
â”‚   â”‚   â”‚   (AZ-a)    â”‚                     â”‚   (AZ-b)    â”‚           â”‚   â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚   â”‚
â”‚   â”‚          â”‚                                                      â”‚   â”‚
â”‚   â”‚          â”‚  RÃ©plication asynchrone                              â”‚   â”‚
â”‚   â”‚          â–¼                                                      â”‚   â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚   â”‚
â”‚   â”‚   â”‚ Read Replicaâ”‚  â”‚ Read Replicaâ”‚   (jusqu'Ã  15)               â”‚   â”‚
â”‚   â”‚   â”‚   (AZ-c)    â”‚  â”‚  (RÃ©gion 2) â”‚   Cross-Region               â”‚   â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚   â”‚
â”‚   â”‚                                                                 â”‚   â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚   â”‚   â”‚  Stockage EBS (SSD gp3/io2) avec rÃ©plication automatiqueâ”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚   â”‚                                                                 â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                         â”‚
â”‚   GÃ©rÃ© par AWS :                                                        â”‚
â”‚   âœ“ Provisioning    âœ“ Patching    âœ“ Backups    âœ“ Monitoring             â”‚
â”‚   âœ“ Failover        âœ“ Scaling     âœ“ Encryption âœ“ Compliance             â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Configuration Typique

```yaml
# Exemple Terraform pour RDS PostgreSQL
resource "aws_db_instance" "postgres" {
  identifier     = "my-postgres-db"
  engine         = "postgres"
  engine_version = "16.3"

  instance_class    = "db.r6g.xlarge"
  allocated_storage = 100
  storage_type      = "gp3"
  storage_encrypted = true

  db_name  = "myapp"
  username = "admin"
  password = var.db_password

  # Haute disponibilitÃ©
  multi_az = true

  # RÃ©seau
  db_subnet_group_name   = aws_db_subnet_group.main.name
  vpc_security_group_ids = [aws_security_group.postgres.id]
  publicly_accessible    = false

  # Sauvegardes
  backup_retention_period = 7
  backup_window          = "03:00-04:00"

  # Maintenance
  maintenance_window         = "Mon:04:00-Mon:05:00"
  auto_minor_version_upgrade = true

  # Performance Insights
  performance_insights_enabled = true

  # ParamÃ¨tres PostgreSQL
  parameter_group_name = aws_db_parameter_group.postgres.name
}

resource "aws_db_parameter_group" "postgres" {
  family = "postgres16"
  name   = "my-postgres-params"

  parameter {
    name  = "shared_preload_libraries"
    value = "pg_stat_statements"
  }

  parameter {
    name  = "log_min_duration_statement"
    value = "1000"
  }
}
```

### 2.3 Amazon Aurora PostgreSQL

Aurora est une rÃ©Ã©criture du moteur de stockage PostgreSQL par AWS, optimisÃ©e pour le cloud.

#### Architecture Aurora

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Architecture Aurora PostgreSQL                       â”‚
â”‚                                                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                      Couche Compute                             â”‚   â”‚
â”‚   â”‚                                                                 â”‚   â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚   â”‚
â”‚   â”‚   â”‚   Writer    â”‚  â”‚   Reader    â”‚  â”‚   Reader    â”‚             â”‚   â”‚
â”‚   â”‚   â”‚  Instance   â”‚  â”‚  Instance   â”‚  â”‚  Instance   â”‚             â”‚   â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜             â”‚   â”‚
â”‚   â”‚          â”‚                â”‚                â”‚                    â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚              â”‚                â”‚                â”‚                        â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚                               â–¼                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚              Couche Stockage DistribuÃ©e Aurora                  â”‚   â”‚
â”‚   â”‚                                                                 â”‚   â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚   â”‚
â”‚   â”‚   â”‚ Storage â”‚  â”‚ Storage â”‚  â”‚ Storage â”‚  â”‚ Storage â”‚  ...       â”‚   â”‚
â”‚   â”‚   â”‚  Node   â”‚  â”‚  Node   â”‚  â”‚  Node   â”‚  â”‚  Node   â”‚            â”‚   â”‚
â”‚   â”‚   â”‚  (AZ-a) â”‚  â”‚  (AZ-a) â”‚  â”‚  (AZ-b) â”‚  â”‚  (AZ-c) â”‚            â”‚   â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚   â”‚
â”‚   â”‚                                                                 â”‚   â”‚
â”‚   â”‚   â€¢ 6 copies des donnÃ©es sur 3 AZs                              â”‚   â”‚
â”‚   â”‚   â€¢ RÃ©plication synchrone au niveau stockage                    â”‚   â”‚
â”‚   â”‚   â€¢ Auto-scaling jusqu'Ã  128 TB                                 â”‚   â”‚
â”‚   â”‚   â€¢ RÃ©paration automatique des blocs corrompus                  â”‚   â”‚
â”‚   â”‚                                                                 â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Avantages d'Aurora

| CaractÃ©ristique | Aurora | RDS Standard |
|-----------------|--------|--------------|
| **Performance** | 3Ã— plus rapide | Baseline |
| **RÃ©plication** | < 10ms (stockage) | Secondes (streaming) |
| **Failover** | < 30 secondes | 1-2 minutes |
| **Stockage** | Auto-scale 128 TB | Manuel, max 64 TB |
| **Backups** | Continus, PITR | Snapshots planifiÃ©s |
| **CoÃ»t** | ~20% plus cher | Baseline |

#### Aurora Serverless v2

Aurora Serverless ajuste automatiquement la capacitÃ© compute :

```yaml
# Exemple de configuration Aurora Serverless v2
resource "aws_rds_cluster" "aurora_serverless" {
  cluster_identifier = "my-aurora-serverless"
  engine            = "aurora-postgresql"
  engine_mode       = "provisioned"  # Serverless v2 utilise provisioned
  engine_version    = "15.4"

  serverlessv2_scaling_configuration {
    min_capacity = 0.5   # 0.5 ACU minimum (peut descendre Ã  0 avec pause)
    max_capacity = 16    # 16 ACU maximum
  }

  # ... autres configurations
}

resource "aws_rds_cluster_instance" "aurora_instance" {
  identifier         = "my-aurora-serverless-instance"
  cluster_identifier = aws_rds_cluster.aurora_serverless.id
  instance_class     = "db.serverless"  # Classe spÃ©ciale pour Serverless v2
  engine             = "aurora-postgresql"
}
```

### 2.4 Google Cloud SQL et AlloyDB

#### Cloud SQL

Service PostgreSQL managÃ© simple et fiable de Google Cloud.

```yaml
# Exemple Terraform pour Cloud SQL
resource "google_sql_database_instance" "postgres" {
  name             = "my-postgres-instance"
  database_version = "POSTGRES_16"
  region           = "europe-west1"

  settings {
    tier = "db-custom-4-16384"  # 4 vCPU, 16 GB RAM

    availability_type = "REGIONAL"  # Haute disponibilitÃ©

    backup_configuration {
      enabled                        = true
      point_in_time_recovery_enabled = true
      start_time                     = "03:00"
    }

    ip_configuration {
      ipv4_enabled    = false
      private_network = google_compute_network.vpc.id
    }

    database_flags {
      name  = "log_min_duration_statement"
      value = "1000"
    }

    insights_config {
      query_insights_enabled  = true
      record_application_tags = true
    }
  }
}
```

#### AlloyDB

AlloyDB est la rÃ©ponse de Google Ã  Aurora : un PostgreSQL rÃ©inventÃ© pour le cloud.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Architecture AlloyDB                                 â”‚
â”‚                                                                         â”‚
â”‚   CaractÃ©ristiques clÃ©s :                                               â”‚
â”‚                                                                         â”‚
â”‚   â€¢ 4Ã— plus rapide que PostgreSQL standard (transactions)               â”‚
â”‚   â€¢ 100Ã— plus rapide pour les requÃªtes analytiques                      â”‚
â”‚   â€¢ SÃ©paration compute/stockage (comme Aurora)                          â”‚
â”‚   â€¢ Columnar engine intÃ©grÃ© pour l'analytique                           â”‚
â”‚   â€¢ Machine Learning intÃ©grÃ© (AlloyDB AI)                               â”‚
â”‚   â€¢ 99.99% SLA disponibilitÃ©                                            â”‚
â”‚                                                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚   Primary Instance    Read Pool (auto-scaling)                  â”‚   â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚   â”‚
â”‚   â”‚   â”‚ Compute â”‚        â”‚ Reader  â”‚ â”‚ Reader  â”‚ â”‚ Reader  â”‚        â”‚   â”‚
â”‚   â”‚   â”‚  (R/W)  â”‚        â”‚   #1    â”‚ â”‚   #2    â”‚ â”‚   #N    â”‚        â”‚   â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜        â”‚   â”‚
â”‚   â”‚        â”‚                  â”‚           â”‚           â”‚             â”‚   â”‚
â”‚   â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚   â”‚
â”‚   â”‚                           â”‚                                     â”‚   â”‚
â”‚   â”‚                           â–¼                                     â”‚   â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚   â”‚   â”‚            Stockage DistribuÃ© Intelligent               â”‚   â”‚   â”‚
â”‚   â”‚   â”‚   â€¢ Log-structured storage                              â”‚   â”‚   â”‚
â”‚   â”‚   â”‚   â€¢ Columnar cache pour analytics                       â”‚   â”‚   â”‚
â”‚   â”‚   â”‚   â€¢ RÃ©plication synchrone multi-zone                    â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.5 Azure Database for PostgreSQL

Microsoft propose deux options principales :

#### Flexible Server (RecommandÃ©)

```yaml
# Exemple Terraform pour Azure Flexible Server
resource "azurerm_postgresql_flexible_server" "postgres" {
  name                   = "my-postgres-flexible"
  resource_group_name    = azurerm_resource_group.main.name
  location               = "West Europe"
  version                = "16"

  administrator_login    = "adminuser"
  administrator_password = var.db_password

  sku_name               = "GP_Standard_D4s_v3"
  storage_mb             = 131072

  delegated_subnet_id    = azurerm_subnet.postgres.id
  private_dns_zone_id    = azurerm_private_dns_zone.postgres.id

  high_availability {
    mode                      = "ZoneRedundant"
    standby_availability_zone = "2"
  }

  backup_retention_days = 7

  maintenance_window {
    day_of_week  = 0
    start_hour   = 3
    start_minute = 0
  }
}
```

### 2.6 Comparaison des Services ManagÃ©s

| CritÃ¨re | RDS | Aurora | Cloud SQL | AlloyDB | Azure Flexible |
|---------|-----|--------|-----------|---------|----------------|
| **Performance** | â˜…â˜…â˜… | â˜…â˜…â˜…â˜…â˜… | â˜…â˜…â˜… | â˜…â˜…â˜…â˜…â˜… | â˜…â˜…â˜…â˜… |
| **CoÃ»t** | $$ | $$$ | $$ | $$$ | $$ |
| **Serverless** | Non | Oui (v2) | Non | Oui | Oui (preview) |
| **Max stockage** | 64 TB | 128 TB | 64 TB | 128+ TB | 32 TB |
| **Read replicas** | 15 | 15 | 10 | Pool auto | 5 |
| **Cross-region** | Oui | Oui (Global DB) | Oui | Oui | Oui |

---

## Partie 3 : PostgreSQL sur Kubernetes

### 3.1 Pourquoi Kubernetes pour PostgreSQL ?

Kubernetes offre des avantages pour les bases de donnÃ©es stateful :

- **DÃ©claratif** : Infrastructure as Code native
- **Auto-healing** : RedÃ©marrage automatique des pods dÃ©faillants
- **PortabilitÃ©** : MÃªme configuration sur n'importe quel cloud
- **Ã‰cosystÃ¨me** : Operators spÃ©cialisÃ©s pour PostgreSQL

### 3.2 Concepts Kubernetes pour les Bases de DonnÃ©es

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Concepts Kubernetes pour PostgreSQL                  â”‚
â”‚                                                                         â”‚
â”‚   StatefulSet (pas Deployment!)                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                                                                 â”‚   â”‚
â”‚   â”‚   Pod postgres-0         Pod postgres-1         Pod postgres-2  â”‚   â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚
â”‚   â”‚   â”‚   Container   â”‚     â”‚   Container   â”‚     â”‚   Container   â”‚ â”‚   â”‚
â”‚   â”‚   â”‚   PostgreSQL  â”‚     â”‚   PostgreSQL  â”‚     â”‚   PostgreSQL  â”‚ â”‚   â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
â”‚   â”‚           â”‚                     â”‚                     â”‚         â”‚   â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚
â”‚   â”‚   â”‚      PVC      â”‚     â”‚      PVC      â”‚     â”‚      PVC      â”‚ â”‚   â”‚
â”‚   â”‚   â”‚  postgres-0   â”‚     â”‚  postgres-1   â”‚     â”‚  postgres-2   â”‚ â”‚   â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
â”‚   â”‚                                                                 â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                         â”‚
â”‚   Services                                                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                                                                 â”‚   â”‚
â”‚   â”‚   postgres-rw (ClusterIP)  â”€â”€â–º Pointe vers le Primary           â”‚   â”‚
â”‚   â”‚   postgres-ro (ClusterIP)  â”€â”€â–º Load balance vers les Replicas   â”‚   â”‚
â”‚   â”‚   postgres-0 (Headless)    â”€â”€â–º AccÃ¨s direct au pod 0            â”‚   â”‚
â”‚   â”‚                                                                 â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                         â”‚
â”‚   DiffÃ©rences avec Deployment :                                         â”‚
â”‚   â€¢ IdentitÃ© stable (postgres-0, postgres-1...)                         â”‚
â”‚   â€¢ Stockage persistant par pod (PVC individuels)                       â”‚
â”‚   â€¢ DÃ©marrage/arrÃªt ordonnÃ©s                                            â”‚
â”‚   â€¢ Nom DNS stable (postgres-0.postgres-svc.namespace.svc)              â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.3 Les Operators PostgreSQL

Un **Operator** est un contrÃ´leur Kubernetes qui automatise la gestion d'applications complexes. Plusieurs operators PostgreSQL existent :

| Operator | Mainteneur | Points Forts |
|----------|------------|--------------|
| **CloudNativePG** | CloudNative PG | CNCF, trÃ¨s actif, natif K8s |
| **Zalando Postgres Operator** | Zalando | Mature, utilisÃ© en production |
| **Crunchy PGO** | Crunchy Data | Entreprise, fonctionnalitÃ©s avancÃ©es |
| **StackGres** | OnGres | Interface UI, extensions packagÃ©es |
| **Percona Operator** | Percona | Multi-cloud, backup intÃ©grÃ© |

### 3.4 CloudNativePG (CNPG)

CloudNativePG est l'operator recommandÃ© par la CNCF (Cloud Native Computing Foundation).

#### Installation

```bash
# Installation via kubectl
kubectl apply -f \
  https://raw.githubusercontent.com/cloudnative-pg/cloudnative-pg/release-1.22/releases/cnpg-1.22.0.yaml

# Ou via Helm
helm repo add cnpg https://cloudnative-pg.github.io/charts
helm install cnpg cnpg/cloudnative-pg -n cnpg-system --create-namespace
```

#### DÃ©ployer un Cluster PostgreSQL

```yaml
# cluster-postgres.yaml
apiVersion: postgresql.cnpg.io/v1
kind: Cluster
metadata:
  name: my-postgres-cluster
  namespace: database
spec:
  instances: 3  # 1 primary + 2 replicas

  imageName: ghcr.io/cloudnative-pg/postgresql:16.2

  # Configuration PostgreSQL
  postgresql:
    parameters:
      shared_buffers: "256MB"
      max_connections: "200"
      log_min_duration_statement: "1000"
      pg_stat_statements.track: all
    pg_hba:
      - host all all 10.0.0.0/8 scram-sha-256

  # Stockage
  storage:
    size: 50Gi
    storageClass: fast-ssd

  # Ressources
  resources:
    requests:
      memory: "1Gi"
      cpu: "500m"
    limits:
      memory: "2Gi"
      cpu: "2"

  # Sauvegardes vers S3
  backup:
    barmanObjectStore:
      destinationPath: s3://my-bucket/backups
      s3Credentials:
        accessKeyId:
          name: aws-creds
          key: ACCESS_KEY_ID
        secretAccessKey:
          name: aws-creds
          key: SECRET_ACCESS_KEY
      wal:
        compression: gzip
    retentionPolicy: "7d"

  # Monitoring
  monitoring:
    enablePodMonitor: true

  # AffinitÃ© pour rÃ©partir les pods
  affinity:
    topologyKey: topology.kubernetes.io/zone
```

```bash
# DÃ©ployer le cluster
kubectl apply -f cluster-postgres.yaml

# VÃ©rifier l'Ã©tat
kubectl get clusters -n database
kubectl get pods -n database -l cnpg.io/cluster=my-postgres-cluster
```

#### Se Connecter au Cluster

```bash
# RÃ©cupÃ©rer les credentials
kubectl get secret my-postgres-cluster-app -n database -o jsonpath='{.data.password}' | base64 -d

# Port-forward pour accÃ¨s local
kubectl port-forward svc/my-postgres-cluster-rw 5432:5432 -n database

# Ou utiliser le plugin kubectl cnpg
kubectl cnpg psql my-postgres-cluster -n database
```

### 3.5 Zalando Postgres Operator

L'operator de Zalando est mature et utilisÃ© en production par de nombreuses entreprises.

```yaml
# postgresql-cluster.yaml (Zalando)
apiVersion: acid.zalan.do/v1
kind: postgresql
metadata:
  name: my-postgres-cluster
  namespace: database
spec:
  teamId: "myteam"
  numberOfInstances: 3

  postgresql:
    version: "16"
    parameters:
      shared_buffers: "256MB"
      max_connections: "200"

  volume:
    size: 50Gi
    storageClass: fast-ssd

  resources:
    requests:
      cpu: 500m
      memory: 1Gi
    limits:
      cpu: 2
      memory: 2Gi

  users:
    myapp:
      - superuser
      - createdb

  databases:
    myappdb: myapp

  patroni:
    synchronous_mode: true
    synchronous_mode_strict: false

  sidecars:
    - name: exporter
      image: quay.io/prometheuscommunity/postgres-exporter:latest
      ports:
        - containerPort: 9187
```

### 3.6 Architecture Haute DisponibilitÃ© sur Kubernetes

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    HA PostgreSQL sur Kubernetes                         â”‚
â”‚                                                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                        Ingress / LoadBalancer                   â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                          â”‚                    â”‚                         â”‚
â”‚                          â–¼                    â–¼                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚   â”‚   Service postgres-rw       â”‚  â”‚   Service postgres-ro       â”‚      â”‚
â”‚   â”‚   (Primary uniquement)      â”‚  â”‚   (Read replicas)           â”‚      â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                  â”‚                                â”‚                     â”‚
â”‚                  â–¼                                â–¼                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                        StatefulSet                              â”‚   â”‚
â”‚   â”‚                                                                 â”‚   â”‚
â”‚   â”‚   Zone A              Zone B              Zone C                â”‚   â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚   â”‚
â”‚   â”‚   â”‚ postgres-0  â”‚    â”‚ postgres-1  â”‚    â”‚ postgres-2  â”‚         â”‚   â”‚
â”‚   â”‚   â”‚  (Primary)  â”‚â”€â”€â”€â–ºâ”‚  (Replica)  â”‚    â”‚  (Replica)  â”‚         â”‚   â”‚
â”‚   â”‚   â”‚             â”‚    â”‚             â”‚â—„â”€â”€â”€â”‚             â”‚         â”‚   â”‚
â”‚   â”‚   â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚         â”‚   â”‚
â”‚   â”‚   â”‚ â”‚Patroni/ â”‚ â”‚    â”‚ â”‚Patroni/ â”‚ â”‚    â”‚ â”‚Patroni/ â”‚ â”‚         â”‚   â”‚
â”‚   â”‚   â”‚ â”‚ CNPG    â”‚ â”‚    â”‚ â”‚ CNPG    â”‚ â”‚    â”‚ â”‚ CNPG    â”‚ â”‚         â”‚   â”‚
â”‚   â”‚   â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚         â”‚   â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜         â”‚   â”‚
â”‚   â”‚          â”‚                  â”‚                  â”‚                â”‚   â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”         â”‚   â”‚
â”‚   â”‚   â”‚    PVC      â”‚    â”‚    PVC      â”‚    â”‚    PVC      â”‚         â”‚   â”‚
â”‚   â”‚   â”‚   50Gi      â”‚    â”‚   50Gi      â”‚    â”‚   50Gi      â”‚         â”‚   â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚   â”‚
â”‚   â”‚                                                                 â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                         â”‚
â”‚   Failover automatique :                                                â”‚
â”‚   1. Patroni/CNPG dÃ©tecte la panne du primary                           â”‚
â”‚   2. Ã‰lection d'un nouveau primary parmi les replicas                   â”‚
â”‚   3. Mise Ã  jour du Service postgres-rw vers le nouveau primary         â”‚
â”‚   4. Temps de failover : ~10-30 secondes                                â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Partie 4 : PostgreSQL DistribuÃ©

### 4.1 Qu'est-ce qu'une Base de DonnÃ©es DistribuÃ©e ?

Une base de donnÃ©es distribuÃ©e rÃ©partit les donnÃ©es sur plusieurs nÅ“uds, offrant :
- **ScalabilitÃ© horizontale** : Ajouter des nÅ“uds pour augmenter la capacitÃ©
- **Haute disponibilitÃ©** : TolÃ©rance aux pannes de nÅ“uds
- **Distribution gÃ©ographique** : DonnÃ©es proches des utilisateurs

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    PostgreSQL Standard vs DistribuÃ©                     â”‚
â”‚                                                                         â”‚
â”‚   PostgreSQL Standard            PostgreSQL DistribuÃ© (ex: Citus)       â”‚
â”‚                                                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚   â”‚                 â”‚            â”‚   Coordinator    â”‚                   â”‚
â”‚   â”‚   Single Node   â”‚            â”‚    (routage)     â”‚                   â”‚
â”‚   â”‚                 â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚   â”‚  Toutes les     â”‚                     â”‚                             â”‚
â”‚   â”‚  donnÃ©es ici    â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚   â”‚                 â”‚            â–¼        â–¼        â–¼                    â”‚
â”‚   â”‚                 â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚ Worker  â”‚ â”‚ Worker  â”‚ â”‚ Worker  â”‚          â”‚
â”‚                            â”‚  Node 1 â”‚ â”‚  Node 2 â”‚ â”‚  Node 3 â”‚          â”‚
â”‚                            â”‚ Shard A â”‚ â”‚ Shard B â”‚ â”‚ Shard C â”‚          â”‚
â”‚                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                                                         â”‚
â”‚   Scale vertical             Scale horizontal                           â”‚
â”‚   (plus gros serveur)        (plus de serveurs)                         â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 Citus : PostgreSQL DistribuÃ©

**Citus** transforme PostgreSQL en base de donnÃ©es distribuÃ©e tout en conservant la compatibilitÃ© SQL.

#### Concepts Citus

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Architecture Citus                                   â”‚
â”‚                                                                         â”‚
â”‚   Application                                                           â”‚
â”‚       â”‚                                                                 â”‚
â”‚       â–¼                                                                 â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                     Coordinator Node                            â”‚   â”‚
â”‚   â”‚                                                                 â”‚   â”‚
â”‚   â”‚   â€¢ ReÃ§oit les requÃªtes SQL                                     â”‚   â”‚
â”‚   â”‚   â€¢ Parse et planifie la distribution                           â”‚   â”‚
â”‚   â”‚   â€¢ AgrÃ¨ge les rÃ©sultats des workers                            â”‚   â”‚
â”‚   â”‚   â€¢ Stocke les mÃ©tadonnÃ©es de distribution                      â”‚   â”‚
â”‚   â”‚                                                                 â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                               â”‚                                         â”‚
â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚           â–¼                   â–¼                   â–¼                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚   â”‚   Worker Node   â”‚ â”‚   Worker Node   â”‚ â”‚   Worker Node   â”‚           â”‚
â”‚   â”‚                 â”‚ â”‚                 â”‚ â”‚                 â”‚           â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚           â”‚
â”‚   â”‚  â”‚ Shard 1   â”‚  â”‚ â”‚  â”‚ Shard 2   â”‚  â”‚ â”‚  â”‚ Shard 3   â”‚  â”‚           â”‚
â”‚   â”‚  â”‚ Shard 4   â”‚  â”‚ â”‚  â”‚ Shard 5   â”‚  â”‚ â”‚  â”‚ Shard 6   â”‚  â”‚           â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚           â”‚
â”‚   â”‚                 â”‚ â”‚                 â”‚ â”‚                 â”‚           â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                                                         â”‚
â”‚   Types de tables :                                                     â”‚
â”‚   â€¢ Distributed : ShardÃ©es par clÃ© de distribution                      â”‚
â”‚   â€¢ Reference : RÃ©pliquÃ©es sur tous les workers (petites tables)        â”‚
â”‚   â€¢ Local : Tables normales sur le coordinator                          â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Utilisation de Citus

```sql
-- Activer l'extension Citus
CREATE EXTENSION citus;

-- Ajouter des workers au cluster
SELECT citus_add_node('worker1.example.com', 5432);
SELECT citus_add_node('worker2.example.com', 5432);
SELECT citus_add_node('worker3.example.com', 5432);

-- CrÃ©er une table distribuÃ©e
CREATE TABLE events (
    tenant_id INTEGER,
    event_id BIGSERIAL,
    event_type VARCHAR(50),
    event_data JSONB,
    created_at TIMESTAMP DEFAULT NOW(),
    PRIMARY KEY (tenant_id, event_id)
);

-- Distribuer la table par tenant_id (64 shards par dÃ©faut)
SELECT create_distributed_table('events', 'tenant_id');

-- CrÃ©er une table de rÃ©fÃ©rence (rÃ©pliquÃ©e partout)
CREATE TABLE event_types (
    id SERIAL PRIMARY KEY,
    name VARCHAR(50) UNIQUE
);

SELECT create_reference_table('event_types');

-- Les requÃªtes SQL standard fonctionnent !
INSERT INTO events (tenant_id, event_type, event_data)
VALUES (1, 'page_view', '{"url": "/home"}');

SELECT tenant_id, COUNT(*)
FROM events
WHERE created_at > NOW() - INTERVAL '1 day'
GROUP BY tenant_id;

-- RequÃªte sur un seul tenant (routÃ©e vers un seul shard)
SELECT * FROM events WHERE tenant_id = 42;
```

#### Citus sur Azure (Hyperscale)

Azure propose Citus en tant que service managÃ© :

```
Azure Database for PostgreSQL - Hyperscale (Citus)

CaractÃ©ristiques :
â€¢ Citus managÃ© par Microsoft
â€¢ Auto-scaling des workers
â€¢ Backups automatiques
â€¢ Monitoring intÃ©grÃ©
â€¢ SLA 99.99%
```

### 4.3 YugabyteDB

**YugabyteDB** est une base de donnÃ©es distribuÃ©e compatible PostgreSQL, conÃ§ue from scratch pour le cloud.

#### Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Architecture YugabyteDB                              â”‚
â”‚                                                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                       YSQL Layer                                â”‚   â”‚
â”‚   â”‚              (Compatible PostgreSQL Wire Protocol)              â”‚   â”‚
â”‚   â”‚                                                                 â”‚   â”‚
â”‚   â”‚   â€¢ Parser PostgreSQL                                           â”‚   â”‚
â”‚   â”‚   â€¢ Optimizer                                                   â”‚   â”‚
â”‚   â”‚   â€¢ Extensions PostgreSQL supportÃ©es                            â”‚   â”‚
â”‚   â”‚                                                                 â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                â”‚                                        â”‚
â”‚                                â–¼                                        â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                    DocDB (Storage Layer)                        â”‚   â”‚
â”‚   â”‚                                                                 â”‚   â”‚
â”‚   â”‚   â€¢ InspirÃ© de Google Spanner                                   â”‚   â”‚
â”‚   â”‚   â€¢ Stockage clÃ©-valeur distribuÃ©                               â”‚   â”‚
â”‚   â”‚   â€¢ Consensus Raft pour la rÃ©plication                          â”‚   â”‚
â”‚   â”‚   â€¢ Transactions distribuÃ©es (2PC)                              â”‚   â”‚
â”‚   â”‚   â€¢ Sharding automatique                                        â”‚   â”‚
â”‚   â”‚                                                                 â”‚   â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚   â”‚
â”‚   â”‚   â”‚ Tablet  â”‚  â”‚ Tablet  â”‚  â”‚ Tablet  â”‚  â”‚ Tablet  â”‚   ...      â”‚   â”‚
â”‚   â”‚   â”‚(Shard)  â”‚  â”‚(Shard)  â”‚  â”‚(Shard)  â”‚  â”‚(Shard)  â”‚            â”‚   â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚   â”‚
â”‚   â”‚                                                                 â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                         â”‚
â”‚   RÃ©partition gÃ©ographique :                                            â”‚
â”‚                                                                         â”‚
â”‚   US-East           EU-West           Asia-Pacific                      â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚   â”‚ YB Node â”‚ â—„â”€â”€â–º â”‚ YB Node â”‚ â—„â”€â”€â”€â–º â”‚ YB Node â”‚                        â”‚
â”‚   â”‚ (RF=3)  â”‚      â”‚ (RF=3)  â”‚       â”‚ (RF=3)  â”‚                        â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### CaractÃ©ristiques YugabyteDB

| CaractÃ©ristique | Description |
|-----------------|-------------|
| **CompatibilitÃ©** | PostgreSQL wire protocol + SQL |
| **Distribution** | Sharding automatique |
| **RÃ©plication** | Raft consensus (synchrone) |
| **Consistance** | Strong consistency (CP dans CAP) |
| **Transactions** | DistribuÃ©es ACID |
| **GÃ©o-distribution** | Multi-rÃ©gion native |

```sql
-- YugabyteDB utilise la syntaxe PostgreSQL standard
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    email VARCHAR(255) UNIQUE,
    name VARCHAR(100),
    created_at TIMESTAMP DEFAULT NOW()
);

-- Tablespaces pour le placement gÃ©ographique
CREATE TABLESPACE eu_west WITH (
    replica_placement = '{"num_replicas": 3, "placement_blocks": [
        {"cloud": "aws", "region": "eu-west-1", "zone": "eu-west-1a", "min_num_replicas": 1},
        {"cloud": "aws", "region": "eu-west-1", "zone": "eu-west-1b", "min_num_replicas": 1},
        {"cloud": "aws", "region": "eu-west-1", "zone": "eu-west-1c", "min_num_replicas": 1}
    ]}'
);

CREATE TABLE eu_users (LIKE users) TABLESPACE eu_west;
```

### 4.4 Comparaison des Solutions DistribuÃ©es

| CritÃ¨re | Citus | YugabyteDB | CockroachDB | Vitess |
|---------|-------|------------|-------------|--------|
| **Base** | PostgreSQL | Custom (compat PG) | Custom (compat PG) | MySQL |
| **CompatibilitÃ© PG** | â˜…â˜…â˜…â˜…â˜… | â˜…â˜…â˜…â˜… | â˜…â˜…â˜… | N/A |
| **Transactions distribuÃ©es** | LimitÃ©es | Oui | Oui | LimitÃ©es |
| **GÃ©o-distribution** | Manuel | Native | Native | Manuel |
| **ComplexitÃ©** | Faible | Moyenne | Moyenne | Ã‰levÃ©e |
| **Cas d'usage** | Multi-tenant SaaS | Global apps | Global apps | Large scale |

---

## Partie 5 : Architectures Serverless

### 5.1 Qu'est-ce que Serverless PostgreSQL ?

Le serverless PostgreSQL Ã©limine la gestion de l'infrastructure :
- **Auto-scaling** : CapacitÃ© ajustÃ©e automatiquement Ã  la charge
- **Pay-per-use** : Facturation Ã  l'utilisation rÃ©elle
- **Scale-to-zero** : Aucun coÃ»t quand inactif
- **Instant provisioning** : Base disponible en secondes

### 5.2 Neon : Le Leader Serverless

**Neon** a rÃ©inventÃ© PostgreSQL pour le serverless avec une architecture de sÃ©paration compute/stockage.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Architecture Neon                                    â”‚
â”‚                                                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                      Compute Layer                              â”‚   â”‚
â”‚   â”‚                                                                 â”‚   â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚   â”‚
â”‚   â”‚   â”‚ Compute Endpointâ”‚  â”‚ Compute Endpointâ”‚  (scale 0â†’N)         â”‚   â”‚
â”‚   â”‚   â”‚   (PostgreSQL)  â”‚  â”‚   (PostgreSQL)  â”‚                      â”‚   â”‚
â”‚   â”‚   â”‚    "main"       â”‚  â”‚   "dev-branch"  â”‚                      â”‚   â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚   â”‚
â”‚   â”‚            â”‚                    â”‚                               â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                â”‚                    â”‚                                   â”‚
â”‚                â”‚     Neon Proxy     â”‚                                   â”‚
â”‚                â”‚  (connection pool) â”‚                                   â”‚
â”‚                â”‚                    â”‚                                   â”‚
â”‚                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                   â”‚
â”‚                          â”‚                                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                    Pageserver                                   â”‚   â”‚
â”‚   â”‚              (Stockage virtualisÃ©)                              â”‚   â”‚
â”‚   â”‚                                                                 â”‚   â”‚
â”‚   â”‚   â€¢ Sert les pages Ã  la demande                                 â”‚   â”‚
â”‚   â”‚   â€¢ Cache intelligent                                           â”‚   â”‚
â”‚   â”‚   â€¢ Copy-on-write pour le branching                             â”‚   â”‚
â”‚   â”‚                                                                 â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                          â”‚                                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                    Safekeepers                                  â”‚   â”‚
â”‚   â”‚              (WAL distribuÃ©, Paxos)                             â”‚   â”‚
â”‚   â”‚                                                                 â”‚   â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚   â”‚
â”‚   â”‚   â”‚   SK1   â”‚  â”‚   SK2   â”‚  â”‚   SK3   â”‚  (quorum = 2/3)         â”‚   â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚   â”‚
â”‚   â”‚                                                                 â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                          â”‚                                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                    Object Storage (S3)                          â”‚   â”‚
â”‚   â”‚              (Stockage durable et Ã©conomique)                   â”‚   â”‚
â”‚   â”‚                                                                 â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                         â”‚
â”‚   FonctionnalitÃ©s uniques :                                             â”‚
â”‚   â€¢ Branching instantanÃ© (comme Git pour les donnÃ©es!)                  â”‚
â”‚   â€¢ Scale-to-zero (0 coÃ»t quand inactif)                                â”‚
â”‚   â€¢ Point-in-time restore Ã  la seconde                                  â”‚
â”‚   â€¢ Connection pooling intÃ©grÃ©                                          â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Branching Neon

Le branching permet de crÃ©er des copies instantanÃ©es de votre base :

```bash
# CrÃ©er une branche pour le dÃ©veloppement
neon branch create --name dev-feature-123 --parent main

# La branche est disponible immÃ©diatement avec toutes les donnÃ©es
# Aucune copie physique n'est faite (copy-on-write)

# Connexion Ã  la branche
psql "postgres://user:pass@dev-feature-123.neon.tech/mydb"
```

**Cas d'usage du branching** :
- **Preview environments** : Une branche par PR
- **Tests** : Tester les migrations sur une copie
- **Analytics** : RequÃªtes lourdes sur une branche isolÃ©e
- **Debug** : Reproduire un bug avec les vraies donnÃ©es

### 5.3 Supabase

**Supabase** est une alternative open-source Ã  Firebase, basÃ©e sur PostgreSQL.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Architecture Supabase                                â”‚
â”‚                                                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                      Supabase Studio                            â”‚   â”‚
â”‚   â”‚              (Interface d'administration web)                   â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚   â”‚   Auth (GoTrue) â”‚  â”‚  Storage (S3)   â”‚  â”‚   Realtime      â”‚         â”‚
â”‚   â”‚                 â”‚  â”‚                 â”‚  â”‚  (WebSocket)    â”‚         â”‚
â”‚   â”‚  â€¢ JWT tokens   â”‚  â”‚  â€¢ File upload  â”‚  â”‚  â€¢ Subscriptionsâ”‚         â”‚
â”‚   â”‚  â€¢ OAuth/SAML   â”‚  â”‚  â€¢ CDN          â”‚  â”‚  â€¢ Broadcasts   â”‚         â”‚
â”‚   â”‚  â€¢ Row Level    â”‚  â”‚  â€¢ Policies     â”‚  â”‚  â€¢ Presence     â”‚         â”‚
â”‚   â”‚    Security     â”‚  â”‚                 â”‚  â”‚                 â”‚         â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚            â”‚                    â”‚                    â”‚                  â”‚
â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                                 â”‚                                       â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                        PostgREST                                â”‚   â”‚
â”‚   â”‚              (API REST auto-gÃ©nÃ©rÃ©e depuis le schÃ©ma)           â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                 â”‚                                       â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                        PostgreSQL                               â”‚   â”‚
â”‚   â”‚                                                                 â”‚   â”‚
â”‚   â”‚   Extensions incluses :                                         â”‚   â”‚
â”‚   â”‚   â€¢ pgvector (IA/ML)                                            â”‚   â”‚
â”‚   â”‚   â€¢ PostGIS (gÃ©ospatial)                                        â”‚   â”‚
â”‚   â”‚   â€¢ pg_graphql                                                  â”‚   â”‚
â”‚   â”‚   â€¢ pgsodium (encryption)                                       â”‚   â”‚
â”‚   â”‚   â€¢ pg_stat_statements                                          â”‚   â”‚
â”‚   â”‚                                                                 â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Exemple Supabase avec JavaScript

```javascript
import { createClient } from '@supabase/supabase-js'

const supabase = createClient(
  'https://xxx.supabase.co',
  'your-anon-key'
)

// RequÃªte simple
const { data, error } = await supabase
  .from('users')
  .select('*')
  .eq('status', 'active')

// Insertion
const { data, error } = await supabase
  .from('posts')
  .insert({ title: 'Hello World', user_id: 1 })
  .select()

// Temps rÃ©el
supabase
  .channel('posts')
  .on('postgres_changes',
    { event: 'INSERT', schema: 'public', table: 'posts' },
    (payload) => console.log('New post:', payload.new)
  )
  .subscribe()

// Recherche vectorielle (pgvector)
const { data } = await supabase.rpc('match_documents', {
  query_embedding: [0.1, 0.2, ...],
  match_threshold: 0.8,
  match_count: 5
})
```

### 5.4 Comparaison des Solutions Serverless

| CritÃ¨re | Neon | Supabase | PlanetScale* | Aurora Serverless |
|---------|------|----------|--------------|-------------------|
| **Base** | PostgreSQL | PostgreSQL | MySQL | PostgreSQL |
| **Scale-to-zero** | Oui | Non (plan Pro) | Oui | Oui (v2) |
| **Branching** | Oui | Non | Oui | Non |
| **Temps rÃ©el** | Non | Oui | Non | Non |
| **Auth intÃ©grÃ©** | Non | Oui | Non | Non |
| **Open source** | Oui | Oui | Non | Non |
| **Prix entrÃ©e** | Gratuit | Gratuit | Gratuit | ~$50/mois |

*PlanetScale est MySQL mais souvent comparÃ©

---

## Partie 6 : Bonnes Pratiques Cloud-Native

### 6.1 Connection Pooling

Dans le cloud, les connexions sont prÃ©cieuses. Utilisez toujours un pooler.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Sans vs Avec Connection Pooling                      â”‚
â”‚                                                                         â”‚
â”‚   SANS POOLING (problÃ¨me)                                               â”‚
â”‚                                                                         â”‚
â”‚   Lambda/Container 1 â”€â”€â”€â”€â”                                              â”‚
â”‚   Lambda/Container 2 â”€â”€â”€â”€â”¼â”€â”€â”€â”€â–º PostgreSQL (max_connections = 100)      â”‚
â”‚   Lambda/Container 3 â”€â”€â”€â”€â”¤      Ã‰puisement rapide des connexions!       â”‚
â”‚   ...                    â”‚                                              â”‚
â”‚   Lambda/Container 100 â”€â”€â”˜                                              â”‚
â”‚                                                                         â”‚
â”‚   AVEC POOLING (solution)                                               â”‚
â”‚                                                                         â”‚
â”‚   Lambda/Container 1 â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
â”‚   Lambda/Container 2 â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â–ºâ”‚  PgBouncer  â”‚â”€â”€â”€â”€â–º PostgreSQL         â”‚
â”‚   Lambda/Container 3 â”€â”€â”€â”€â”¤      â”‚  (pooler)   â”‚     (20 connexions)     â”‚
â”‚   ...                    â”‚      â”‚ 1000 clientsâ”‚                         â”‚
â”‚   Lambda/Container 1000 â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

```yaml
# DÃ©ploiement PgBouncer sur Kubernetes
apiVersion: apps/v1
kind: Deployment
metadata:
  name: pgbouncer
spec:
  replicas: 2
  template:
    spec:
      containers:
        - name: pgbouncer
          image: bitnami/pgbouncer:latest
          env:
            - name: POSTGRESQL_HOST
              value: "postgres-primary"
            - name: POSTGRESQL_DATABASE
              value: "mydb"
            - name: PGBOUNCER_POOL_MODE
              value: "transaction"
            - name: PGBOUNCER_MAX_CLIENT_CONN
              value: "1000"
            - name: PGBOUNCER_DEFAULT_POOL_SIZE
              value: "20"
```

### 6.2 Secrets et Configuration

```yaml
# Kubernetes Secret pour les credentials
apiVersion: v1
kind: Secret
metadata:
  name: postgres-credentials
type: Opaque
stringData:
  POSTGRES_USER: "myuser"
  POSTGRES_PASSWORD: "super-secret-password"
  POSTGRES_DB: "mydb"
---
# Utilisation dans un Pod
apiVersion: v1
kind: Pod
spec:
  containers:
    - name: app
      env:
        - name: DATABASE_URL
          valueFrom:
            secretKeyRef:
              name: postgres-credentials
              key: POSTGRES_PASSWORD
```

```bash
# AWS Secrets Manager
aws secretsmanager create-secret \
  --name prod/postgres/credentials \
  --secret-string '{"username":"admin","password":"xxx"}'

# Rotation automatique
aws secretsmanager rotate-secret \
  --secret-id prod/postgres/credentials \
  --rotation-lambda-arn arn:aws:lambda:...
```

### 6.3 ObservabilitÃ©

```yaml
# Stack d'observabilitÃ© cloud-native
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                         â”‚
â”‚   MÃ©triques                    Logs                     Traces          â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚ Prometheus  â”‚             â”‚   Loki /    â”‚         â”‚   Jaeger /  â”‚   â”‚
â”‚   â”‚ + postgres  â”‚             â”‚ CloudWatch  â”‚         â”‚   Tempo     â”‚   â”‚
â”‚   â”‚   exporter  â”‚             â”‚             â”‚         â”‚             â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜             â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚          â”‚                           â”‚                       â”‚          â”‚
â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                      â”‚                                  â”‚
â”‚                              â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚                              â”‚    Grafana    â”‚                          â”‚
â”‚                              â”‚  (Dashboard)  â”‚                          â”‚
â”‚                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

```yaml
# ServiceMonitor pour Prometheus (avec postgres_exporter)
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: postgres-monitor
spec:
  selector:
    matchLabels:
      app: postgres
  endpoints:
    - port: metrics
      interval: 30s
      path: /metrics
```

### 6.4 Disaster Recovery Multi-Cloud

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Architecture DR Multi-Cloud                         â”‚
â”‚                                                                        â”‚
â”‚   Cloud Principal (AWS)                Cloud DR (GCP)                  â”‚
â”‚                                                                        â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚   â”‚   Region us-east-1  â”‚              â”‚   Region us-central â”‚         â”‚
â”‚   â”‚                     â”‚              â”‚                     â”‚         â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚    WAL       â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚         â”‚
â”‚   â”‚  â”‚   Primary   â”‚â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â–ºâ”‚   Standby   â”‚    â”‚         â”‚
â”‚   â”‚  â”‚  (Aurora)   â”‚    â”‚   Streaming  â”‚  â”‚ (Cloud SQL) â”‚    â”‚         â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚              â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚         â”‚
â”‚   â”‚        â”‚            â”‚              â”‚                     â”‚         â”‚
â”‚   â”‚        â–¼            â”‚              â”‚                     â”‚         â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚              â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚         â”‚
â”‚   â”‚  â”‚  S3 Bucket  â”‚â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â–ºâ”‚  GCS Bucket  â”‚   â”‚         â”‚
â”‚   â”‚  â”‚  (Backups)  â”‚    â”‚  Cross-cloud â”‚  â”‚  (Backups)   â”‚   â”‚         â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  replication â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚         â”‚
â”‚   â”‚                     â”‚              â”‚                     â”‚         â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                                                        â”‚
â”‚   RPO (Recovery Point Objective) : < 1 minute                          â”‚
â”‚   RTO (Recovery Time Objective) : < 15 minutes                         â”‚
â”‚                                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## RÃ©sumÃ©

Ce chapitre a explorÃ© PostgreSQL dans les architectures cloud modernes :

| Concept | Ce qu'il faut retenir |
|---------|----------------------|
| **Services managÃ©s** | RDS, Aurora, Cloud SQL, AlloyDB |
| **Kubernetes** | Operators (CNPG, Zalando), StatefulSets |
| **DistribuÃ©** | Citus, YugabyteDB pour le scale horizontal |
| **Serverless** | Neon, Supabase, Aurora Serverless v2 |
| **Bonnes pratiques** | Pooling, secrets, observabilitÃ© |

### Points ClÃ©s

- Les services managÃ©s simplifient l'opÃ©rationnel mais rÃ©duisent le contrÃ´le
- Kubernetes + Operators offrent un bon Ã©quilibre contrÃ´le/automatisation
- Citus est idÃ©al pour le multi-tenant SaaS
- YugabyteDB et CockroachDB pour les applications globales
- Neon rÃ©volutionne le dÃ©veloppement avec le branching
- Le connection pooling est **obligatoire** dans le cloud

### Choisir la Bonne Solution

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Arbre de DÃ©cision                                    â”‚
â”‚                                                                         â”‚
â”‚   Besoin de scale horizontal ?                                          â”‚
â”‚   â”œâ”€â–º Oui â”€â”€â–º Transactions distribuÃ©es importantes ?                    â”‚
â”‚   â”‚           â”œâ”€â–º Oui â”€â”€â–º YugabyteDB / CockroachDB                      â”‚
â”‚   â”‚           â””â”€â–º Non â”€â”€â–º Citus (surtout si multi-tenant)               â”‚
â”‚   â”‚                                                                     â”‚
â”‚   â””â”€â–º Non â”€â”€â–º Besoin de simplicitÃ© maximale ?                           â”‚
â”‚               â”œâ”€â–º Oui â”€â”€â–º Service managÃ© (RDS, Cloud SQL)               â”‚
â”‚               â””â”€â–º Non â”€â”€â–º Besoin de contrÃ´le ?                          â”‚
â”‚                           â”œâ”€â–º Oui â”€â”€â–º Kubernetes + Operator             â”‚
â”‚                           â””â”€â–º Non â”€â”€â–º Serverless (Neon, Supabase)       â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---


â­ï¸ [Columnar storage (Hydra, pg_analytics)](/21-conclusion-et-perspectives/02.4-columnar-storage.md)
