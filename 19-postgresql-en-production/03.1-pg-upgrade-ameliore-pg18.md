üîù Retour au [Sommaire](/SOMMAIRE.md)

# 19.3.1. Nouveaut√© PG 18 : pg_upgrade am√©lior√© et pr√©servation des statistiques

## Introduction

Lors de la mise √† jour d'une base de donn√©es PostgreSQL vers une version majeure, l'outil `pg_upgrade` est votre meilleur alli√©. PostgreSQL 18 apporte des am√©liorations significatives √† cet outil, notamment la **pr√©servation des statistiques**, une fonctionnalit√© qui simplifie grandement les migrations.

## Qu'est-ce que pg_upgrade ?

### Le d√©fi des mises √† jour majeures

PostgreSQL utilise un syst√®me de versionnage o√π les versions majeures (comme 16, 17, 18) peuvent introduire des changements dans le format de stockage des donn√©es. Contrairement aux mises √† jour mineures (comme 18.0 ‚Üí 18.1), une mise √† jour majeure n√©cessite une migration compl√®te des donn√©es.

### Les anciennes m√©thodes (avant pg_upgrade)

Traditionnellement, pour migrer vers une version majeure, il fallait :

1. **Exporter** toutes les donn√©es avec `pg_dump` (sauvegarde logique)
2. **Installer** la nouvelle version de PostgreSQL
3. **Importer** toutes les donn√©es avec `pg_restore`

**Probl√®mes** : Cette approche √©tait tr√®s lente pour les bases volumineuses. Une base de 500 Go pouvait n√©cessiter plusieurs heures, voire jours, d'indisponibilit√©.

### L'arriv√©e de pg_upgrade

`pg_upgrade` est un outil sp√©cialis√© qui permet de migrer une instance PostgreSQL vers une version majeure sup√©rieure de mani√®re beaucoup plus rapide. Au lieu de recr√©er toutes les donn√©es, il utilise des techniques intelligentes pour r√©utiliser les fichiers existants.

**Avantages** :
- ‚ö° Migration jusqu'√† 10√ó plus rapide qu'une sauvegarde/restauration
- üîÑ Minimise le temps d'indisponibilit√©
- üíæ Peut fonctionner en mode "lien" pour √©conomiser l'espace disque

## Comment fonctionne pg_upgrade ?

### Principe g√©n√©ral

`pg_upgrade` effectue les op√©rations suivantes :

1. **V√©rification de compatibilit√©** : S'assure que la migration est possible
2. **Cr√©ation du nouveau cluster** : Installe la structure de la nouvelle version
3. **Migration du sch√©ma** : Recr√©e les tables, index, contraintes, etc.
4. **Migration des donn√©es** :
   - Mode `--copy` : Copie physiquement les fichiers de donn√©es
   - Mode `--link` : Cr√©e des liens physiques (hardlinks) vers les fichiers existants
5. **Mise √† jour des m√©tadonn√©es** : Adapte les catalogues syst√®me

### Sch√©ma conceptuel

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Ancien Cluster (PostgreSQL 17)                             ‚îÇ
‚îÇ  /var/lib/postgresql/17/main                                ‚îÇ
‚îÇ                                                             ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                 ‚îÇ
‚îÇ  ‚îÇ Tables   ‚îÇ  ‚îÇ  Index   ‚îÇ  ‚îÇStatistiques‚îÇ                 ‚îÇ
‚îÇ  ‚îÇ  (data)  ‚îÇ  ‚îÇ  (data)  ‚îÇ  ‚îÇ  (pg_stats)‚îÇ                 ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                         ‚îÇ
                         ‚îÇ pg_upgrade
                         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Nouveau Cluster (PostgreSQL 18)                            ‚îÇ
‚îÇ  /var/lib/postgresql/18/main                                ‚îÇ
‚îÇ                                                             ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                 ‚îÇ
‚îÇ  ‚îÇ Tables   ‚îÇ  ‚îÇ  Index   ‚îÇ  ‚îÇStatistiques‚îÇ ‚Üê PR√âSERV√âES !  ‚îÇ
‚îÇ  ‚îÇ  (data)  ‚îÇ  ‚îÇ  (data)  ‚îÇ  ‚îÇ  (pg_stats)‚îÇ                 ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## La grande nouveaut√© de PostgreSQL 18 : Pr√©servation des statistiques

### Qu'est-ce que les statistiques dans PostgreSQL ?

Les **statistiques** sont des informations cruciales que PostgreSQL collecte sur vos donn√©es pour optimiser l'ex√©cution des requ√™tes.

#### Types de statistiques collect√©es :

1. **Statistiques de colonnes** :
   - Nombre de valeurs distinctes (cardinalit√©)
   - Distribution des valeurs (histogrammes)
   - Valeurs les plus fr√©quentes (most common values - MCV)
   - Corr√©lation entre l'ordre physique et l'ordre logique

2. **Statistiques de tables** :
   - Nombre de lignes (tuples)
   - Nombre de pages (blocs de donn√©es)
   - Taux de remplissage
   - Derni√®re date d'ANALYZE

3. **Statistiques d'index** :
   - Taille des index
   - Nombre de pages parcourues

#### Exemple concret

Imaginons une table `commandes` avec 10 millions de lignes :

```sql
-- PostgreSQL collecte ces informations :
- n_distinct (produit_id) : 5000 produits diff√©rents
- n_distinct (client_id) : 200 000 clients diff√©rents
- most_common_vals (statut) : ['livr√©': 60%, 'en_cours': 25%, 'annul√©': 15%]
- correlation (date_commande) : 0.95 (fortement corr√©l√© √† l'ordre physique)
```

Ces statistiques permettent au **planificateur de requ√™tes** de prendre des d√©cisions intelligentes.

### Le r√¥le du planificateur de requ√™tes

Le planificateur de requ√™tes (query planner) est le "cerveau" de PostgreSQL. Avant d'ex√©cuter une requ√™te, il :

1. **Analyse** la requ√™te SQL
2. **Explore** les diff√©rentes strat√©gies possibles (utiliser un index ? faire un scan s√©quentiel ?)
3. **Estime les co√ªts** de chaque strat√©gie gr√¢ce aux statistiques
4. **Choisit** le plan d'ex√©cution optimal

#### Exemple de d√©cision bas√©e sur les statistiques

```sql
SELECT * FROM commandes WHERE statut = 'annul√©';
```

**Avec statistiques** : Le planificateur sait que seulement 15% des commandes sont annul√©es (1,5 million de lignes). Il choisira probablement un index sur `statut`.

**Sans statistiques** : Le planificateur ne sait pas. Il pourrait faire une mauvaise estimation et choisir un scan s√©quentiel complet (plus lent).

### Le probl√®me avant PostgreSQL 18

#### Situation avec les versions ant√©rieures (PG ‚â§ 17)

Lors d'une migration avec `pg_upgrade` avant PostgreSQL 18 :

1. ‚úÖ Les **donn√©es** sont migr√©es (tables, index)
2. ‚úÖ Le **sch√©ma** est migr√© (structure des tables)
3. ‚ùå Les **statistiques** sont perdues

**Cons√©quence** : Apr√®s la migration, la nouvelle base ne poss√®de aucune statistique sur les donn√©es.

#### Impact sur les performances

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  √âtat juste apr√®s pg_upgrade (PG ‚â§ 17)                     ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                            ‚îÇ
‚îÇ  ‚ö†Ô∏è  Statistiques : AUCUNE                                 ‚îÇ
‚îÇ                                                            ‚îÇ
‚îÇ  Le planificateur est "aveugle" :                          ‚îÇ
‚îÇ  - Estime toutes les tables √† 1000 lignes par d√©faut       ‚îÇ
‚îÇ  - Ne conna√Æt pas la distribution des valeurs              ‚îÇ
‚îÇ  - Fait des choix d'optimisation al√©atoires                ‚îÇ
‚îÇ                                                            ‚îÇ
‚îÇ  R√©sultat : Performances d√©grad√©es de 10√ó √† 100√ó           ‚îÇ
‚îÇ                                                            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

#### Exemple de requ√™te affect√©e

```sql
-- Avant migration (avec statistiques) : 50ms
SELECT *
FROM commandes c
JOIN clients cl ON c.client_id = cl.id
WHERE c.date_commande >= '2024-01-01';

-- Apr√®s migration PG ‚â§ 17 (sans statistiques) : 5000ms
-- Le planificateur choisit un mauvais plan d'ex√©cution !
```

#### La solution traditionnelle : ANALYZE manuel

Apr√®s la migration, il fallait manuellement :

```bash
# Lancer ANALYZE sur toute la base
psql -d ma_base -c "ANALYZE VERBOSE;"
```

**Probl√®mes** :
- ‚è∞ Peut prendre des **heures** sur de grosses bases (plusieurs To)
- üìâ Pendant ce temps, les performances sont **catastrophiques**
- üî• Cr√©e une charge suppl√©mentaire sur la base fra√Æchement migr√©e
- üò∞ Stress pour les √©quipes : "La migration est finie, mais tout est lent !"

### La solution dans PostgreSQL 18 : Pr√©servation automatique

#### Comment √ßa fonctionne ?

PostgreSQL 18 introduit un m√©canisme de **pr√©servation des statistiques** lors de `pg_upgrade` :

1. **Avant la migration** :
   - `pg_upgrade` exporte les statistiques de l'ancien cluster
   - Format interne optimis√© pour la r√©importation

2. **Pendant la migration** :
   - Les donn√©es et le sch√©ma sont migr√©s comme avant
   - Les statistiques sont √©galement transf√©r√©es

3. **Apr√®s la migration** :
   - Les statistiques sont imm√©diatement disponibles
   - Le planificateur fonctionne √† pleine capacit√© d√®s le red√©marrage

#### Comparaison avant/apr√®s

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  PostgreSQL ‚â§ 17                                            ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  1. pg_upgrade              ‚Üí 2 heures                      ‚îÇ
‚îÇ  2. Red√©marrage             ‚Üí 2 minutes                     ‚îÇ
‚îÇ  3. ‚ùå Performances LENTES   ‚Üí Jusqu'au ANALYZE             ‚îÇ
‚îÇ  4. ANALYZE VERBOSE         ‚Üí 6 heures                      ‚îÇ
‚îÇ  5. ‚úÖ Performances normales                                ‚îÇ
‚îÇ                                                             ‚îÇ
‚îÇ  Total downtime effectif : ~8 heures                        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  PostgreSQL 18 (avec pr√©servation)                          ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  1. pg_upgrade              ‚Üí 2 heures                      ‚îÇ
‚îÇ  2. Red√©marrage             ‚Üí 2 minutes                     ‚îÇ
‚îÇ  3. ‚úÖ Performances NORMALES ‚Üí Imm√©diatement !              ‚îÇ
‚îÇ                                                             ‚îÇ
‚îÇ  Total downtime effectif : ~2 heures                        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

#### Gains concrets

- üöÄ **Performances imm√©diates** : Plus de p√©riode de "chauffe"
- ‚è±Ô∏è **Temps de migration r√©duit** : Pas besoin d'ANALYZE post-migration
- üí∞ **√âconomies** : Moins de downtime = moins de co√ªts
- üòå **S√©r√©nit√©** : Migration plus pr√©visible

## Comprendre l'architecture technique (niveau interm√©diaire)

### O√π sont stock√©es les statistiques ?

Les statistiques PostgreSQL sont conserv√©es dans plusieurs tables syst√®me :

1. **pg_statistic** : Table interne (catalogue syst√®me)
   - Contient les statistiques brutes
   - Non lisible directement par l'utilisateur

2. **pg_stats** : Vue publique
   - Version "lisible" de pg_statistic
   - Accessible pour consultation

3. **pg_class** : M√©tadonn√©es des relations
   - Nombre de tuples (reltuples)
   - Nombre de pages (relpages)

### M√©canisme de pr√©servation dans PG 18

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Phase 1 : Extraction (ancien cluster PG 17)               ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                            ‚îÇ
‚îÇ  pg_upgrade lit :                                          ‚îÇ
‚îÇ  ‚Ä¢ pg_statistic (statistiques d√©taill√©es)                  ‚îÇ
‚îÇ  ‚Ä¢ pg_class (m√©tadonn√©es tables)                           ‚îÇ
‚îÇ  ‚Ä¢ pg_attribute (m√©tadonn√©es colonnes)                     ‚îÇ
‚îÇ                                                            ‚îÇ
‚îÇ  ‚Üí S√©rialisation dans un format interm√©diaire              ‚îÇ
‚îÇ  ‚Üí Fichier temporaire : pg_upgrade_stats.dump              ‚îÇ
‚îÇ                                                            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                           ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Phase 2 : Import (nouveau cluster PG 18)                  ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                            ‚îÇ
‚îÇ  pg_upgrade restaure :                                     ‚îÇ
‚îÇ  ‚Ä¢ Recr√©e les entr√©es dans pg_statistic                    ‚îÇ
‚îÇ  ‚Ä¢ Met √† jour pg_class avec reltuples/relpages             ‚îÇ
‚îÇ  ‚Ä¢ Adapte au format interne de PG 18 si n√©cessaire         ‚îÇ
‚îÇ                                                            ‚îÇ
‚îÇ  ‚Üí Statistiques imm√©diatement exploitables                 ‚îÇ
‚îÇ                                                            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Gestion de la compatibilit√©

PostgreSQL 18 g√®re intelligemment les cas limites :

#### Cas 1 : Migration depuis une version tr√®s ancienne

```
PG 11 ‚Üí PG 18 : Certaines statistiques peuvent √™tre obsol√®tes
‚Üí pg_upgrade pr√©serve ce qui est compatible
‚Üí Log des statistiques non transf√©rables
‚Üí Recommande un ANALYZE cibl√© sur les objets concern√©s
```

#### Cas 2 : Nouvelles statistiques dans PG 18

```
Si PG 18 collecte de nouveaux types de statistiques :
‚Üí Les anciennes sont pr√©serv√©es
‚Üí Les nouvelles seront collect√©es au prochain ANALYZE
‚Üí Pas de d√©gradation de performance
```

#### Cas 3 : Statistiques corrompues

```
Si des statistiques sont d√©tect√©es comme invalides :
‚Üí pg_upgrade les ignore
‚Üí Log d'avertissement
‚Üí Ces tables n√©cessiteront un ANALYZE manuel
```

## Commandes et utilisation pratique

### Utilisation de pg_upgrade avec pr√©servation des statistiques

La pr√©servation des statistiques est **automatique et activ√©e par d√©faut** dans PostgreSQL 18. Aucune option sp√©ciale n'est requise.

#### Commande de base

```bash
pg_upgrade \
  --old-datadir=/var/lib/postgresql/17/main \
  --new-datadir=/var/lib/postgresql/18/main \
  --old-bindir=/usr/lib/postgresql/17/bin \
  --new-bindir=/usr/lib/postgresql/18/bin \
  --check  # Mode v√©rification (sans modification)
```

#### Mode v√©rification (--check)

Avant de lancer la migration r√©elle, il est **fortement recommand√©** de faire une v√©rification :

```bash
# V√©rifie la faisabilit√© de la migration
pg_upgrade --check [options...]

# Sortie possible :
# ‚úÖ Performing Consistency Checks
# ‚úÖ Checking cluster versions
# ‚úÖ Checking database connection settings
# ‚úÖ Checking for prepared transactions
# ‚úÖ Checking statistics preservation capability  ‚Üê Nouveau !
#
# Statistics preservation: ENABLED
# - 1,247 tables will have statistics preserved
# - Estimated stats data size: 87 MB
#
# Clusters are compatible (peut proc√©der √† la migration)
```

#### Migration r√©elle

```bash
# Enlever --check pour lancer la vraie migration
pg_upgrade \
  --old-datadir=/var/lib/postgresql/17/main \
  --new-datadir=/var/lib/postgresql/18/main \
  --old-bindir=/usr/lib/postgresql/17/bin \
  --new-bindir=/usr/lib/postgresql/18/bin \
  --link  # Optionnel : utilise des liens au lieu de copier
```

### V√©rification post-migration

#### 1. Consulter les logs de pg_upgrade

```bash
# Le log indique les statistiques pr√©serv√©es
cat pg_upgrade_server.log | grep -i "statistic"

# Exemple de sortie :
# Preserving statistics for table "public.commandes"
# Preserving statistics for table "public.clients"
# Statistics preservation: 1,247 objects transferred
# Statistics preservation: 3 objects skipped (incompatible)
```

#### 2. V√©rifier les statistiques dans la nouvelle base

```sql
-- Connexion √† la nouvelle base PostgreSQL 18
psql -d ma_base

-- V√©rifier qu'une table a des statistiques
SELECT
    schemaname,
    tablename,
    last_analyze,
    last_autoanalyze,
    n_live_tup
FROM pg_stat_user_tables
WHERE tablename = 'commandes';

-- Si last_analyze est NULL mais n_live_tup > 0
-- ‚Üí Les statistiques ont √©t√© pr√©serv√©es (pas de nouvel ANALYZE)
```

#### 3. Consulter les statistiques d'une colonne

```sql
-- Voir les statistiques d√©taill√©es d'une colonne
SELECT
    attname AS column_name,
    n_distinct,
    most_common_vals,
    most_common_freqs,
    histogram_bounds
FROM pg_stats
WHERE tablename = 'commandes'
  AND attname = 'statut';

-- Exemple de r√©sultat :
-- column_name | n_distinct | most_common_vals      | most_common_freqs
-- statut      | 3          | {livr√©,en_cours,ann.} | {0.6,0.25,0.15}
--
-- Si ces valeurs existent ‚Üí statistiques pr√©serv√©es ‚úÖ
```

### Cas o√π ANALYZE reste n√©cessaire

M√™me avec la pr√©servation, certains cas n√©cessitent un ANALYZE apr√®s migration :

#### 1. Tables tr√®s volatiles

```sql
-- Si les donn√©es ont beaucoup chang√© depuis le dernier ANALYZE
-- (avant la migration)
ANALYZE VERBOSE ma_table_volatile;
```

#### 2. Nouvelles fonctionnalit√©s PG 18

```sql
-- Si vous voulez profiter de nouveaux types de statistiques
-- introduits dans PG 18
ANALYZE VERBOSE;  -- Sur toute la base (si rapide)
```

#### 3. Objets signal√©s dans les logs

```bash
# Si pg_upgrade a indiqu√© :
# "Statistics for table 'public.ancien_format' could not be preserved"

# Alors :
psql -d ma_base -c "ANALYZE VERBOSE public.ancien_format;"
```

## Bonnes pratiques et recommandations

### Avant la migration

#### 1. Lancer un ANALYZE complet sur l'ancienne base

```sql
-- Garantit que les statistiques sont √† jour
-- avant d'√™tre pr√©serv√©es
ANALYZE VERBOSE;
```

**Pourquoi ?** Les statistiques pr√©serv√©es sont celles existantes. Si elles sont obsol√®tes, elles le resteront apr√®s migration.

#### 2. V√©rifier l'√©tat des statistiques

```sql
-- Identifier les tables sans statistiques r√©centes
SELECT
    schemaname,
    tablename,
    last_analyze,
    last_autoanalyze,
    GREATEST(last_analyze, last_autoanalyze) AS derniere_analyse
FROM pg_stat_user_tables
WHERE GREATEST(last_analyze, last_autoanalyze) < NOW() - INTERVAL '7 days'
   OR GREATEST(last_analyze, last_autoanalyze) IS NULL
ORDER BY n_live_tup DESC;

-- Lancer ANALYZE sur ces tables avant migration
```

#### 3. V√©rifier l'espace disque

```bash
# La pr√©servation des statistiques ajoute quelques MB/GB
# selon la taille de votre base

# V√©rifier l'espace disponible
df -h /var/lib/postgresql/
```

### Pendant la migration

#### 1. Utiliser --check d'abord

```bash
# TOUJOURS faire un dry-run
pg_upgrade --check [options]
```

#### 2. Monitorer les logs en temps r√©el

```bash
# Dans un autre terminal
tail -f pg_upgrade_server.log | grep -E "(statistic|error|warning)"
```

#### 3. Prendre des sauvegardes

```bash
# Avant TOUTE migration majeure
pg_basebackup -D /backup/pg17_before_upgrade -Fp -Xs -P
```

### Apr√®s la migration

#### 1. Validation rapide

```sql
-- Script de validation post-migration
SELECT
    'Statistics preserved' AS status,
    COUNT(*) AS tables_count,
    SUM(CASE WHEN last_analyze IS NOT NULL
             OR last_autoanalyze IS NOT NULL THEN 1 ELSE 0 END) AS with_stats
FROM pg_stat_user_tables;

-- R√©sultat attendu :
-- status               | tables_count | with_stats
-- Statistics preserved | 1247         | 1247
```

#### 2. Tests de performance

```sql
-- Comparer quelques requ√™tes critiques
-- V√©rifier que les plans d'ex√©cution sont similaires

EXPLAIN (ANALYZE, BUFFERS)
SELECT * FROM commandes
WHERE date_commande >= '2024-01-01';

-- Comparer avec le plan de l'ancienne version
```

#### 3. Monitoring des requ√™tes lentes

```sql
-- Activer pg_stat_statements si pas d√©j√† fait
CREATE EXTENSION IF NOT EXISTS pg_stat_statements;

-- Surveiller les requ√™tes lentes dans les premi√®res heures
SELECT
    query,
    calls,
    mean_exec_time,
    total_exec_time
FROM pg_stat_statements
WHERE mean_exec_time > 1000  -- > 1 seconde
ORDER BY mean_exec_time DESC
LIMIT 20;
```

## Limitations et consid√©rations

### Limites de la pr√©servation des statistiques

#### 1. Compatibilit√© des statistiques

Toutes les statistiques ne peuvent pas toujours √™tre pr√©serv√©es :

- **Changements de format** : Si PG 18 a modifi√© la structure interne d'un type de statistique
- **Types de donn√©es obsol√®tes** : Si vous utilisez des types deprecated
- **Extensions tierces** : Les statistiques d'extensions (ex: PostGIS) peuvent n√©cessiter une recollection

#### 2. Qualit√© des statistiques sources

```
Principe fondamental :
Garbage In ‚Üí Garbage Out

Si les statistiques de PG 17 √©taient mauvaises,
les statistiques de PG 18 le seront aussi !
```

#### 3. Tables tr√®s modifi√©es pendant la migration

Si des donn√©es changent drastiquement entre l'ancien et le nouveau cluster (ce qui ne devrait pas arriver en production), les statistiques pr√©serv√©es peuvent √™tre inadapt√©es.

### Impact sur le temps de migration

La pr√©servation des statistiques ajoute un **l√©ger surco√ªt** au temps de migration :

```
Ordre de grandeur :
- Base 10 GB   : +1-2 secondes
- Base 100 GB  : +10-30 secondes
- Base 1 TB    : +2-5 minutes
- Base 10 TB   : +10-20 minutes

G√©n√©ralement n√©gligeable compar√© au temps total de migration.
```

### Consid√©rations m√©moire

L'export et l'import des statistiques consomment de la m√©moire :

```
M√©moire utilis√©e ‚âà (nombre de colonnes statistiques √ó 50 KB)

Exemple :
- 10,000 colonnes ‚Üí ~500 MB de RAM
- 100,000 colonnes ‚Üí ~5 GB de RAM

G√©n√©ralement acceptable sur des serveurs modernes.
```

## Comparaison avec d'autres approches de migration

### pg_upgrade vs pg_dump/restore

| Crit√®re | pg_upgrade (PG 18) | pg_dump/restore |
|---------|-------------------|-----------------|
| **Vitesse** | ‚ö° Tr√®s rapide (heures) | üêå Lent (jours pour To) |
| **Pr√©servation stats** | ‚úÖ Oui (automatique) | ‚ùå Non |
| **Downtime** | ‚è±Ô∏è Minimal | ‚è±Ô∏è‚è±Ô∏è Important |
| **S√©curit√©** | ‚ö†Ô∏è Modification en place | ‚úÖ Copie ind√©pendante |
| **R√©organisation** | ‚ùå Pas de nettoyage | ‚úÖ Tables r√©organis√©es |
| **Rollback** | üîÑ Possible (avec backup) | üîÑ Facile (garder ancien) |

### pg_upgrade vs R√©plication Logique

| Crit√®re | pg_upgrade (PG 18) | R√©plication Logique |
|---------|-------------------|---------------------|
| **Complexit√©** | üü¢ Simple | üî¥ Complexe |
| **Downtime** | ‚è±Ô∏è Court (heures) | ‚è±Ô∏è Quasi-nul (minutes) |
| **Pr√©servation stats** | ‚úÖ Oui | ‚ùå Non (nouveau cluster) |
| **Migration s√©lective** | ‚ùå Tout ou rien | ‚úÖ Table par table possible |
| **Risque** | üü° Moyen | üü° Moyen |
| **Rollback** | üîÑ N√©cessite sauvegarde | üîÑ Changement de cible |

**Recommandation g√©n√©rale** :
- `pg_upgrade` pour la majorit√© des cas (simple, rapide, fiable)
- R√©plication logique pour les migrations critiques avec downtime minimal (<15 min)

## Sc√©narios d'utilisation r√©els

### Sc√©nario 1 : PME avec base de 50 GB

**Contexte** :
- Base de donn√©es : 50 GB
- Tables : ~300
- Colonnes : ~2,000
- Downtime acceptable : 2-4 heures

**Proc√©dure avec PG 18** :

```bash
# 1. V√©rification (5 min)
pg_upgrade --check [...options]

# 2. Migration (30 min - 1h)
pg_upgrade [...options]

# 3. V√©rification statistiques (2 min)
psql -c "SELECT COUNT(*) FROM pg_stats;"

# 4. Red√©marrage et tests (15 min)
# Total : ~2 heures
```

**Avant PG 18** : +4 heures d'ANALYZE ‚Üí Total ~6 heures

### Sc√©nario 2 : Grande entreprise avec 2 TB de donn√©es

**Contexte** :
- Base de donn√©es : 2 TB
- Tables : ~5,000
- Colonnes : ~80,000
- Downtime acceptable : 12 heures max

**Proc√©dure avec PG 18** :

```bash
# 1. Pr√©paration (1 jour avant)
ANALYZE VERBOSE;  # 2-3 heures

# 2. V√©rification (20 min)
pg_upgrade --check [...options]

# 3. Migration (8 heures)
pg_upgrade --link [...options]

# 4. V√©rification et red√©marrage (1 heure)
# Total downtime : ~9 heures
```

**Avant PG 18** : +24h d'ANALYZE ‚Üí Impossible dans la fen√™tre de 12h !

### Sc√©nario 3 : Startup en croissance (100 GB)

**Contexte** :
- Base de donn√©es : 100 GB
- Forte volatilit√© des donn√©es
- Downtime acceptable : 4 heures

**Strat√©gie optimale** :

```bash
# 1. ANALYZE complet JUSTE avant migration
psql -c "ANALYZE VERBOSE;"  # 20-30 min

# 2. Migration imm√©diate
pg_upgrade [...options]  # 1-2 heures

# 3. V√©rification cibl√©e post-migration
# ANALYZE uniquement sur tables tr√®s volatiles identifi√©es
psql -c "ANALYZE VERBOSE table_events, table_metrics;"  # 5 min

# Total : ~3 heures
```

## Questions fr√©quentes (FAQ)

### Q1 : Les statistiques sont-elles pr√©serv√©es automatiquement ?

**R√©ponse** : Oui, dans PostgreSQL 18, la pr√©servation des statistiques est **automatique et activ√©e par d√©faut**. Aucune configuration particuli√®re n'est requise.

### Q2 : Que se passe-t-il si des statistiques ne peuvent pas √™tre pr√©serv√©es ?

**R√©ponse** : `pg_upgrade` :
- Log un avertissement pour chaque objet concern√©
- Continue la migration normalement
- Vous pouvez lancer un ANALYZE cibl√© apr√®s migration sur ces objets

### Q3 : Dois-je quand m√™me lancer ANALYZE apr√®s migration ?

**R√©ponse** : En g√©n√©ral, **non**. Les statistiques pr√©serv√©es sont suffisantes. Exceptions :
- Tables tr√®s volatiles dont les donn√©es ont beaucoup chang√© r√©cemment
- Objets signal√©s dans les logs de pg_upgrade comme non pr√©serv√©s
- Si vous voulez profiter de nouveaux types de statistiques PG 18

### Q4 : La pr√©servation des statistiques fonctionne-t-elle avec --link ?

**R√©ponse** : **Oui**, la pr√©servation fonctionne avec toutes les options de pg_upgrade :
- Mode `--copy` (copie des fichiers)
- Mode `--link` (cr√©ation de liens physiques)

### Q5 : Puis-je migrer de PG 13 vers PG 18 avec pr√©servation ?

**R√©ponse** : **Oui**, mais avec limitations. Plus l'√©cart de versions est grand, plus certaines statistiques peuvent √™tre incompatibles. `pg_upgrade` pr√©servera ce qui est compatible et logguera le reste.

### Q6 : Quel est l'impact sur l'espace disque ?

**R√©ponse** : Minimal. Les statistiques repr√©sentent g√©n√©ralement **moins de 0.1% de la taille totale** de la base :
- Base 100 GB ‚Üí ~50-100 MB de statistiques
- Base 1 TB ‚Üí ~500 MB - 1 GB de statistiques

### Q7 : Les statistiques des index sont-elles aussi pr√©serv√©es ?

**R√©ponse** : **Oui**, toutes les statistiques disponibles dans pg_statistic et pg_class sont pr√©serv√©es, incluant :
- Statistiques de colonnes
- Statistiques de tables
- M√©tadonn√©es d'index (nombre de pages, etc.)

### Q8 : Que faire si les performances sont mauvaises malgr√© la pr√©servation ?

**R√©ponse** : V√©rifiez d'abord si les statistiques sont bien pr√©sentes :

```sql
-- V√©rification
SELECT tablename, last_analyze, last_autoanalyze
FROM pg_stat_user_tables
WHERE schemaname = 'public';
```

Si les statistiques sont pr√©sentes mais performances mauvaises :
1. V√©rifier les plans d'ex√©cution (EXPLAIN ANALYZE)
2. V√©rifier les changements de configuration PostgreSQL
3. Lancer un VACUUM si bloat important
4. En dernier recours : ANALYZE VERBOSE

## Conclusion

La pr√©servation des statistiques dans PostgreSQL 18 est une am√©lioration majeure de `pg_upgrade` qui :

- ‚úÖ **Simplifie** les migrations majeures
- ‚úÖ **R√©duit** drastiquement le temps de downtime effectif
- ‚úÖ **√âlimine** la p√©riode de performances d√©grad√©es post-migration
- ‚úÖ **Am√©liore** la pr√©visibilit√© des migrations
- ‚úÖ **Permet** des migrations plus sereines en production

Cette fonctionnalit√© est particuli√®rement b√©n√©fique pour :
- Les bases de donn√©es volumineuses (> 500 GB)
- Les environnements avec des contraintes de downtime strictes
- Les √©quipes DevOps cherchant √† automatiser les upgrades

### Points cl√©s √† retenir

1. **Automatique** : Aucune configuration requise, activ√© par d√©faut
2. **Transparent** : Fonctionne avec toutes les options de pg_upgrade
3. **Fiable** : Gestion intelligente des incompatibilit√©s
4. **Performant** : Impact n√©gligeable sur le temps de migration
5. **Production-ready** : Test√© et valid√© par la communaut√©

### Prochaines √©tapes sugg√©r√©es

Pour aller plus loin dans votre compr√©hension de pg_upgrade et des migrations PostgreSQL :

- **Section 19.3.2** : Option --swap pour upgrade rapide (nouveau PG 18)
- **Section 19.3.3** : V√©rifications parall√®les avec --jobs (nouveau PG 18)
- **Section 19.3.4** : Strat√©gies Blue/Green et R√©plication Logique
- **Section 16.10** : Maintenance VACUUM/ANALYZE pour optimiser avant migration

---

**Note** : Cette section peut sembler technique, mais retenez l'essentiel : PostgreSQL 18 rend les migrations plus simples et plus rapides. Si vous utilisez `pg_upgrade`, vos requ√™tes fonctionneront imm√©diatement √† vitesse normale apr√®s la migration, sans p√©riode de "rodage" n√©cessaire. C'est un progr√®s majeur pour la production !

‚è≠Ô∏è [Nouveaut√© PG 18 : Option --swap pour upgrade rapide](/19-postgresql-en-production/03.2-option-swap-pg18.md)
