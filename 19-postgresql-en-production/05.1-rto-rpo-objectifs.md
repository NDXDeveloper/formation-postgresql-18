ğŸ” Retour au [Sommaire](/SOMMAIRE.md)

# 19.5.1. RTO et RPO : DÃ©finir les objectifs

## Introduction

Dans le monde de la gestion des bases de donnÃ©es et du Disaster Recovery (rÃ©cupÃ©ration aprÃ¨s sinistre), deux acronymes reviennent constamment : **RTO** et **RPO**. Ces concepts sont fondamentaux pour dÃ©finir votre stratÃ©gie de sauvegarde et de rÃ©cupÃ©ration, et comprendre leur signification est essentiel pour tout professionnel travaillant avec PostgreSQL.

Imaginez que votre base de donnÃ©es tombe en panne suite Ã  une dÃ©faillance matÃ©rielle, une erreur humaine, ou un sinistre (incendie, inondation, cyberattaque). Deux questions cruciales se posent immÃ©diatement :

1. **Combien de temps pouvez-vous vous permettre d'Ãªtre hors ligne ?**
2. **Quelle quantitÃ© de donnÃ©es pouvez-vous accepter de perdre ?**

C'est exactement ce que RTO et RPO vous aident Ã  quantifier.

---

## Qu'est-ce que le RTO ? (Recovery Time Objective)

### DÃ©finition

Le **RTO** (Recovery Time Objective) est le **temps maximum acceptable pendant lequel votre systÃ¨me peut Ãªtre indisponible** aprÃ¨s un incident. C'est la durÃ©e maximale de l'interruption de service que votre organisation peut tolÃ©rer.

En d'autres termes : **Combien de temps pouvez-vous rester Â« hors ligne Â» ?**

### Exemple concret

Prenons l'exemple d'une boutique e-commerce :

- **RTO de 4 heures** : Votre site peut Ãªtre indisponible pendant maximum 4 heures. Au-delÃ , les pertes financiÃ¨res et l'impact sur la rÃ©putation deviennent inacceptables.
- **RTO de 15 minutes** : Pour une plateforme bancaire en ligne, 15 minutes d'indisponibilitÃ© peuvent dÃ©jÃ  causer des pertes importantes.
- **RTO de 30 secondes** : Pour un systÃ¨me de trading haute frÃ©quence, mÃªme 30 secondes peuvent reprÃ©senter des millions d'euros de pertes.

### Composantes du RTO

Le RTO inclut plusieurs phases :

1. **DÃ©tection de l'incident** : Temps pour identifier qu'un problÃ¨me existe
2. **Diagnostic** : Temps pour comprendre la nature du problÃ¨me
3. **DÃ©cision** : Temps pour dÃ©cider de la stratÃ©gie de rÃ©cupÃ©ration
4. **Restauration** : Temps effectif pour restaurer le service
5. **Validation** : Temps pour vÃ©rifier que tout fonctionne correctement

**Exemple de calcul :**
```
DÃ©tection     : 5 minutes
Diagnostic    : 10 minutes
DÃ©cision      : 5 minutes
Restauration  : 30 minutes
Validation    : 10 minutes
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
RTO Total     : 60 minutes (1 heure)
```

---

## Qu'est-ce que le RPO ? (Recovery Point Objective)

### DÃ©finition

Le **RPO** (Recovery Point Objective) est la **quantitÃ© maximale de donnÃ©es que votre organisation peut accepter de perdre**, mesurÃ©e en temps. Il reprÃ©sente l'Ã¢ge maximal acceptable de vos donnÃ©es aprÃ¨s une restauration.

En d'autres termes : **Jusqu'oÃ¹ pouvez-vous Â« remonter dans le temps Â» en perdant des donnÃ©es ?**

### Exemple concret

Continuons avec notre boutique e-commerce :

- **RPO de 24 heures** : Vous pouvez accepter de perdre les transactions des derniÃ¨res 24 heures. Si l'incident survient Ã  14h le mardi, vous restaurez les donnÃ©es de lundi 14h.
- **RPO de 1 heure** : Vous ne pouvez perdre qu'une heure de donnÃ©es maximum.
- **RPO de 0 (zÃ©ro)** : Aucune perte de donnÃ©es n'est acceptable. Chaque transaction doit Ãªtre prÃ©servÃ©e (rÃ©plication synchrone).

### Illustration temporelle

```
        DerniÃ¨re sauvegarde          Incident
              â†“                          â†“
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â—â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â—â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ Temps
              â”‚â—„â”€â”€â”€â”€â”€â”€ RPO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
              â”‚                           â”‚
         DonnÃ©es OK              DonnÃ©es perdues
```

Les donnÃ©es entre la derniÃ¨re sauvegarde et l'incident sont **potentiellement perdues**. Le RPO dÃ©finit cette fenÃªtre de risque acceptable.

---

## RTO vs RPO : Les diffÃ©rences clÃ©s

| Aspect | RTO | RPO |
|--------|-----|-----|
| **Question** | Combien de temps d'indisponibilitÃ© ? | Combien de donnÃ©es perdues ? |
| **Mesure** | DurÃ©e (minutes, heures) | PÃ©riode temporelle (minutes, heures) |
| **Impact sur** | DisponibilitÃ© du service | IntÃ©gritÃ© des donnÃ©es |
| **CoÃ»t principal** | Infrastructure de rÃ©cupÃ©ration rapide | FrÃ©quence et type de sauvegardes |
| **Exemple** | "Le site doit Ãªtre en ligne en 2h" | "On peut perdre max 30 min de transactions" |

### SchÃ©ma rÃ©capitulatif

```
INCIDENT SURVIENT
        â†“
        â”‚
        â”‚ â—„â”€â”€â”€ RPO : DonnÃ©es perdues (ex: 1 heure)
        â”‚       (entre derniÃ¨re sauvegarde et incident)
        â†“
   RESTAURATION COMMENCE
        â”‚
        â”‚ â—„â”€â”€â”€ RTO : Temps d'indisponibilitÃ© (ex: 4 heures)
        â”‚       (temps pour remettre le systÃ¨me en ligne)
        â†“
  SERVICE RESTAURÃ‰
```

---

## Comment dÃ©finir vos objectifs RTO et RPO ?

### 1. Ã‰valuer l'impact mÃ©tier

Posez-vous les questions suivantes :

#### Pour le RTO :
- Quel est le coÃ»t de l'indisponibilitÃ© par heure ?
- Quel est l'impact sur la rÃ©putation ?
- Existe-t-il des obligations lÃ©gales ou contractuelles (SLA) ?
- Quelles sont les consÃ©quences pour les utilisateurs ?

#### Pour le RPO :
- Quel est le volume de transactions par heure ?
- Quelle est la valeur des donnÃ©es gÃ©nÃ©rÃ©es ?
- Peut-on reconstituer les donnÃ©es perdues manuellement ?
- Existe-t-il des obligations de conformitÃ© (RGPD, finance) ?

### 2. Analyser diffÃ©rents scÃ©narios

CrÃ©ez un tableau d'analyse par criticitÃ© :

| Type de systÃ¨me | RTO suggÃ©rÃ© | RPO suggÃ©rÃ© | Justification |
|----------------|-------------|-------------|---------------|
| **Site vitrine** | 24-48h | 24h | Impact faible, contenu statique |
| **Blog/CMS** | 4-8h | 4-12h | Impact modÃ©rÃ©, perte de commentaires acceptable |
| **E-commerce** | 1-4h | 15min-1h | Perte de revenus directe |
| **Banque en ligne** | 15min-1h | 0-5min | Obligations rÃ©glementaires strictes |
| **SystÃ¨me de paiement** | 5-15min | 0 (temps rÃ©el) | Transactions financiÃ¨res critiques |
| **Application interne** | 8-24h | 8-24h | Impact limitÃ© aux employÃ©s |

### 3. Ã‰valuer le coÃ»t vs bÃ©nÃ©fice

Plus vos objectifs sont ambitieux (RTO et RPO faibles), plus l'infrastructure nÃ©cessaire est coÃ»teuse.

#### CoÃ»t croissant selon les objectifs :

```
RPO : 24h â†’ 4h â†’ 1h â†’ 15min â†’ 5min â†’ 0 (temps rÃ©el)
  â”‚       â”‚     â”‚      â”‚       â”‚      â”‚
  â”‚       â”‚     â”‚      â”‚       â”‚      â””â”€ RÃ©plication synchrone
  â”‚       â”‚     â”‚      â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€ Streaming replication + WAL archiving
  â”‚       â”‚     â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Sauvegardes frÃ©quentes + PITR
  â”‚       â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Sauvegardes rÃ©guliÃ¨res
  â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Sauvegarde quotidienne
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Sauvegarde hebdomadaire

CoÃ»t : Faible â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ TrÃ¨s Ã©levÃ©
```

### 4. Exemple pratique de dÃ©finition

**Cas d'usage : Site e-commerce de taille moyenne**

**Analyse mÃ©tier :**
- Chiffre d'affaires : 500 000â‚¬/mois (environ 20 000â‚¬/jour)
- Pic d'activitÃ© : 14h-18h (40% du CA quotidien)
- Moyenne : 100 commandes/heure
- Valeur moyenne commande : 50â‚¬

**Calcul de l'impact :**
- **IndisponibilitÃ© de 1h en heures creuses** : ~800â‚¬ de perte
- **IndisponibilitÃ© de 1h en heures pleines** : ~3 300â‚¬ de perte
- **Perte de donnÃ©es de 1h** : ~100 commandes Ã— 50â‚¬ = 5 000â‚¬

**Objectifs dÃ©finis :**
- **RTO : 2 heures** (compromis entre coÃ»t et impact)
- **RPO : 15 minutes** (limite les pertes de commandes)

**Solution technique correspondante :**
- Streaming replication asynchrone (standby serveur)
- Sauvegardes continues avec archivage WAL
- Point-In-Time Recovery (PITR) activÃ©
- Monitoring et alerting automatiques

---

## Impact sur l'architecture PostgreSQL

### Pour un RPO faible (< 1 heure)

Vous aurez besoin de :

1. **WAL Archiving continu** : Archive des Write-Ahead Logs en temps quasi-rÃ©el
2. **Point-In-Time Recovery (PITR)** : CapacitÃ© Ã  restaurer Ã  n'importe quel point dans le temps
3. **RÃ©plication asynchrone ou synchrone** : Serveur standby maintenu Ã  jour

**Configuration PostgreSQL :**
```sql
-- Dans postgresql.conf
wal_level = replica
archive_mode = on
archive_command = 'cp %p /archive/%f'
max_wal_senders = 3
```

### Pour un RPO trÃ¨s faible (< 5 minutes) ou zÃ©ro

Vous aurez besoin de :

1. **RÃ©plication synchrone (Streaming Replication)** : Les transactions ne sont validÃ©es que lorsque confirmÃ©es sur le standby
2. **Monitoring en temps rÃ©el** : DÃ©tection immÃ©diate des problÃ¨mes
3. **Failover automatisÃ©** : Basculement rapide avec Patroni ou repmgr

**Configuration PostgreSQL :**
```sql
-- Dans postgresql.conf
synchronous_commit = on
synchronous_standby_names = 'standby1'
```

### Pour un RTO faible (< 1 heure)

Vous aurez besoin de :

1. **Infrastructure de haute disponibilitÃ©** : Serveur standby prÃªt Ã  l'emploi (hot standby)
2. **ProcÃ©dures de failover testÃ©es** : Scripts et runbooks documentÃ©s
3. **Monitoring et alerting** : DÃ©tection rapide des incidents
4. **Ã‰quipe d'astreinte** : Personnel disponible 24/7

### Pour un RTO trÃ¨s faible (< 15 minutes)

Vous aurez besoin de :

1. **Failover automatique** : Patroni avec etcd/Consul pour consensus distribuÃ©
2. **Load balancer** : Redirection automatique du trafic (HAProxy, PgBouncer)
3. **Health checks automatisÃ©s** : DÃ©tection et rÃ©action en secondes
4. **Infrastructure cloud ou multi-rÃ©gion** : RÃ©silience gÃ©ographique

---

## Exemples de scÃ©narios rÃ©els

### ScÃ©nario 1 : Startup en croissance

**Contexte :** Application SaaS B2B, 500 clients, Ã©quipe de 3 dÃ©veloppeurs

**Objectifs :**
- RTO : 4 heures (acceptable pour une petite structure)
- RPO : 1 heure (perte limitÃ©e de donnÃ©es)

**Solution :**
- Sauvegardes automatiques quotidiennes (pg_dump)
- WAL archiving toutes les 15 minutes
- Serveur de backup sur cloud (AWS S3)
- ProcÃ©dure de restauration documentÃ©e et testÃ©e mensuellement

**CoÃ»t mensuel estimÃ© :** ~200â‚¬ (stockage + compute)

---

### ScÃ©nario 2 : E-commerce national

**Contexte :** 50 000 commandes/jour, Ã©quipe DevOps de 5 personnes

**Objectifs :**
- RTO : 30 minutes (obligation SLA clients)
- RPO : 5 minutes (minimiser les pertes de commandes)

**Solution :**
- RÃ©plication synchrone avec 1 standby hot
- WAL archiving continu vers S3
- Patroni + etcd pour failover automatique
- Monitoring (Prometheus + Grafana)
- Tests de DR trimestriels

**CoÃ»t mensuel estimÃ© :** ~2 000â‚¬ (infrastructure HA)

---

### ScÃ©nario 3 : Institution financiÃ¨re

**Contexte :** Banque en ligne, millions de transactions/jour, obligations rÃ©glementaires

**Objectifs :**
- RTO : 5 minutes (criticitÃ© maximale)
- RPO : 0 (zÃ©ro perte de donnÃ©es)

**Solution :**
- RÃ©plication synchrone avec quorum (2+ standbys)
- Multi-rÃ©gion (gÃ©o-rÃ©plication)
- Patroni avec consensus distribuÃ© (etcd cluster)
- Backup continu avec validation d'intÃ©gritÃ©
- Infrastructure redondante (N+2)
- Tests de DR mensuels obligatoires
- Ã‰quipe d'astreinte 24/7

**CoÃ»t mensuel estimÃ© :** ~50 000â‚¬+ (infrastructure enterprise)

---

## Les piÃ¨ges courants Ã  Ã©viter

### âŒ PiÃ¨ge 1 : DÃ©finir des objectifs irrÃ©alistes

**Erreur :** "Notre RPO doit Ãªtre zÃ©ro et notre RTO de 5 minutes" sans avoir l'infrastructure ni le budget correspondant.

**Solution :** Soyez rÃ©aliste et alignez vos objectifs avec vos ressources.

---

### âŒ PiÃ¨ge 2 : Ne jamais tester les procÃ©dures de restauration

**Erreur :** Avoir une stratÃ©gie de backup parfaite sur le papier, mais dÃ©couvrir qu'elle ne fonctionne pas lors d'un incident rÃ©el.

**Solution :** Testez rÃ©guliÃ¨rement vos restaurations (au moins trimestriellement).

```bash
# Exemple de test de restauration planifiÃ©
# Ã€ exÃ©cuter sur environnement de test

# 1. CrÃ©er une sauvegarde
pg_basebackup -D /backup/test -F tar -z -P

# 2. Simuler une perte
# (sur serveur de test uniquement !)

# 3. Restaurer
tar -xzf /backup/test/base.tar.gz -C /var/lib/postgresql/data

# 4. VÃ©rifier l'intÃ©gritÃ©
psql -c "SELECT count(*) FROM critical_table;"

# 5. Mesurer le temps total
# RTO rÃ©el = temps de dÃ©tection + restauration + validation
```

---

### âŒ PiÃ¨ge 3 : Oublier la documentation

**Erreur :** Seul le DBA senior connaÃ®t la procÃ©dure de rÃ©cupÃ©ration.

**Solution :** Documentez tout dans un runbook accessible 24/7.

**Contenu minimum d'un runbook DR :**
- Diagramme de l'architecture
- ProcÃ©dure step-by-step de restauration
- Commandes exactes Ã  exÃ©cuter
- Contacts d'urgence (on-call)
- Checklist de validation
- Post-mortem template

---

### âŒ PiÃ¨ge 4 : Ignorer le RPO des sauvegardes elles-mÃªmes

**Erreur :** Vos sauvegardes sont stockÃ©es uniquement sur le mÃªme datacenter que votre production.

**Solution :** Appliquez la rÃ¨gle **3-2-1** :
- **3** copies de vos donnÃ©es
- Sur **2** types de supports diffÃ©rents
- Dont **1** copie hors site (off-site)

**Exemple PostgreSQL :**
```
Production DB (Primary)
   â†“
   â”œâ”€â†’ Standby local (Streaming replication)
   â”œâ”€â†’ WAL Archive S3 (mÃªme rÃ©gion)
   â””â”€â†’ Backup S3 (rÃ©gion diffÃ©rente) â† Off-site
```

---

## Checklist : DÃ©finir vos RTO et RPO

Utilisez cette checklist pour structurer votre rÃ©flexion :

### âœ… Analyse mÃ©tier
- [ ] J'ai calculÃ© le coÃ»t de l'indisponibilitÃ© par heure
- [ ] J'ai identifiÃ© les heures critiques (pics d'activitÃ©)
- [ ] J'ai Ã©valuÃ© l'impact sur les utilisateurs/clients
- [ ] J'ai vÃ©rifiÃ© les obligations lÃ©gales/SLA
- [ ] J'ai consultÃ© les parties prenantes (direction, mÃ©tier)

### âœ… DÃ©finition des objectifs
- [ ] RTO dÃ©fini et documentÃ©
- [ ] RPO dÃ©fini et documentÃ©
- [ ] Objectifs validÃ©s par la direction
- [ ] Budget allouÃ© pour l'infrastructure nÃ©cessaire

### âœ… Infrastructure et procÃ©dures
- [ ] Solution technique choisie (rÃ©plication, backup, etc.)
- [ ] ProcÃ©dures de restauration documentÃ©es
- [ ] Tests de restauration planifiÃ©s
- [ ] Monitoring et alerting configurÃ©s
- [ ] Ã‰quipe formÃ©e aux procÃ©dures DR

### âœ… Validation continue
- [ ] Tests de restauration rÃ©guliers (au moins trimestriels)
- [ ] MÃ©triques RTO/RPO rÃ©els mesurÃ©es
- [ ] Documentation Ã  jour
- [ ] Post-mortems aprÃ¨s chaque incident
- [ ] RÃ©vision annuelle des objectifs

---

## Conclusion

Le RTO et le RPO ne sont pas de simples acronymes techniques : ce sont des **dÃ©cisions business critiques** qui doivent Ãªtre prises en collaboration entre l'Ã©quipe technique, le mÃ©tier et la direction.

**Points clÃ©s Ã  retenir :**

1. **RTO = Temps d'indisponibilitÃ© acceptable** â†’ Impact sur la disponibilitÃ©
2. **RPO = Perte de donnÃ©es acceptable** â†’ Impact sur l'intÃ©gritÃ©
3. Plus vos objectifs sont ambitieux, plus le coÃ»t est Ã©levÃ©
4. Il n'existe pas de "bon" RTO/RPO universel, uniquement ce qui correspond Ã  **votre** contexte
5. Testez, testez, testez vos procÃ©dures de restauration !

**Prochaine Ã©tape :** Une fois vos objectifs dÃ©finis, vous devez mettre en place l'infrastructure technique correspondante (rÃ©plication, backup, monitoring) pour les atteindre rÃ©ellement. C'est ce que nous verrons dans les sections suivantes du chapitre sur le Disaster Recovery.

---

## Ressources complÃ©mentaires

- Documentation PostgreSQL : [High Availability, Load Balancing, and Replication](https://www.postgresql.org/docs/current/high-availability.html)
- Documentation PostgreSQL : [Backup and Restore](https://www.postgresql.org/docs/current/backup.html)
- Article : "The Cost of Downtime" (Gartner, 2023)
- Livre recommandÃ© : *PostgreSQL High Availability Cookbook* par Shaun Thomas

---


â­ï¸ [Tests de restauration rÃ©guliers](/19-postgresql-en-production/05.2-tests-restauration.md)
