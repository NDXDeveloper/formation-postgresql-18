üîù Retour au [Sommaire](/SOMMAIRE.md)

# 19.6.1. Hardening S√©curit√©

## Introduction

Le **hardening** (durcissement en fran√ßais) est l'ensemble des pratiques visant √† renforcer la s√©curit√© d'un syst√®me en r√©duisant sa surface d'attaque. Pour PostgreSQL en production, cela signifie configurer et maintenir votre base de donn√©es de mani√®re √† minimiser les risques de compromission, de fuite de donn√©es ou d'acc√®s non autoris√©.

Cette section vous guidera √† travers les mesures essentielles de s√©curisation d'une instance PostgreSQL, que vous soyez d√©veloppeur ou DevOps d√©butant dans l'administration de bases de donn√©es.

> **Principe fondamental** : La s√©curit√© repose sur une approche en **d√©fense en profondeur** (defense in depth) - plusieurs couches de protection pour qu'une d√©faillance unique ne compromette pas l'ensemble du syst√®me.

---

## Les Couches de S√©curit√© PostgreSQL

PostgreSQL offre plusieurs niveaux de protection :

1. **R√©seau** : Qui peut acc√©der au serveur ?
2. **Authentification** : Qui √™tes-vous ?
3. **Autorisation** : Qu'avez-vous le droit de faire ?
4. **Chiffrement** : Les donn√©es sont-elles prot√©g√©es en transit et au repos ?
5. **Audit** : Pouvons-nous tracer les actions ?
6. **Maintenance** : Le syst√®me est-il √† jour et surveill√© ?

Chaque couche doit √™tre configur√©e correctement pour garantir une s√©curit√© optimale.

---

## 1. S√©curit√© R√©seau

### 1.1. Limitation de l'√âcoute R√©seau

Par d√©faut, PostgreSQL √©coute sur toutes les interfaces r√©seau. En production, vous devez **restreindre** cela.

**Fichier** : `postgresql.conf`

```conf
# ‚ùå Mauvaise pratique (par d√©faut dans certaines configs)
listen_addresses = '*'

# ‚úÖ Bonne pratique : √©couter uniquement sur localhost
listen_addresses = 'localhost'

# ‚úÖ Ou sp√©cifier les IPs autoris√©es
listen_addresses = '10.0.1.5,127.0.0.1'
```

**Explication** :
- `'*'` : Accepte les connexions depuis n'importe quelle interface r√©seau (dangereux)
- `'localhost'` : Limite aux connexions locales uniquement
- IPs sp√©cifiques : Permet un contr√¥le granulaire

### 1.2. Configuration du Firewall

Ne vous reposez pas uniquement sur PostgreSQL - utilisez un **firewall syst√®me** (iptables, firewalld, nftables, ou les Security Groups en cloud).

**Exemple avec firewalld (RHEL/CentOS)** :

```bash
# Autoriser PostgreSQL uniquement depuis un r√©seau priv√©
sudo firewall-cmd --permanent --add-rich-rule='
  rule family="ipv4"
  source address="10.0.1.0/24"
  port protocol="tcp" port="5432"
  accept'
sudo firewall-cmd --reload
```

**Principe** : Bloquez le port PostgreSQL (5432 par d√©faut) pour tout le monde, sauf les IPs/r√©seaux autoris√©s.

### 1.3. Modification du Port par D√©faut (Optionnel)

Bien que la **s√©curit√© par l'obscurit√©** ne soit pas une d√©fense robuste, changer le port par d√©faut peut r√©duire le bruit des scans automatis√©s.

```conf
# postgresql.conf
port = 5433  # Au lieu de 5432
```

> ‚ö†Ô∏è **Note** : Ce n'est pas une mesure de s√©curit√© forte, mais un compl√©ment. Ne vous y fiez jamais comme protection principale.

---

## 2. Authentification Robuste

### 2.1. Le Fichier pg_hba.conf

Le fichier `pg_hba.conf` (Host-Based Authentication) contr√¥le **qui** peut se connecter, **depuis o√π**, et **comment**.

**Structure** :
```
# TYPE  DATABASE  USER  ADDRESS      METHOD
```

### 2.2. D√©sactiver la M√©thode "trust"

La m√©thode `trust` autorise les connexions **sans mot de passe**. Elle ne doit **JAMAIS** √™tre utilis√©e en production.

```conf
# ‚ùå DANGEREUX - Jamais en production !
local   all       all                trust

# ‚úÖ Bon - Exiger une authentification
local   all       all                scram-sha-256
```

### 2.3. Utiliser SCRAM-SHA-256

**PostgreSQL 18 et versions r√©centes** : MD5 est obsol√®te et d√©pr√©ci√©. Utilisez **SCRAM-SHA-256**.

**Configuration** :

```conf
# postgresql.conf
password_encryption = scram-sha-256
```

**pg_hba.conf** :
```conf
# Connexions locales
local   all       all                scram-sha-256

# Connexions depuis le r√©seau interne
host    all       all   10.0.1.0/24  scram-sha-256

# Connexions SSL obligatoires depuis l'ext√©rieur
hostssl all       all   0.0.0.0/0    scram-sha-256
```

**Migration depuis MD5** :
```sql
-- R√©g√©n√©rer les mots de passe pour utiliser SCRAM
ALTER USER mon_user WITH PASSWORD 'nouveau_mot_de_passe';
```

### 2.4. Authentification OAuth 2.0 (Nouveaut√© PostgreSQL 18)

Pour les environnements modernes, PostgreSQL 18 introduit le support d'OAuth 2.0.

```conf
# pg_hba.conf
host all all 0.0.0.0/0 oauth issuer="https://auth.example.com"
```

**Avantages** :
- Centralisation de l'authentification (IdP)
- Support de l'authentification multi-facteurs (MFA)
- Gestion simplifi√©e des identit√©s

### 2.5. Authentification par Certificat Client

Pour les connexions automatis√©es (applications, r√©plication), utilisez des **certificats SSL/TLS**.

```conf
# pg_hba.conf
hostssl all app_user 0.0.0.0/0 cert clientcert=verify-full
```

**Configuration** :
1. G√©n√©rer un certificat client
2. Configurer PostgreSQL pour v√©rifier le certificat
3. L'application pr√©sente son certificat lors de la connexion

---

## 3. Principe du Moindre Privil√®ge

### 3.1. Ne Pas Utiliser le Superutilisateur

Le r√¥le `postgres` (superutilisateur) a **tous les droits**. Ne l'utilisez **jamais** pour les applications.

**Mauvaise pratique** :
```sql
-- ‚ùå Application connect√©e en superutilisateur
GRANT ALL ON DATABASE myapp TO postgres;
```

**Bonne pratique** :
```sql
-- ‚úÖ Cr√©er un utilisateur d√©di√© avec droits minimaux
CREATE ROLE app_user WITH LOGIN PASSWORD 'secure_password';
GRANT CONNECT ON DATABASE myapp TO app_user;
GRANT USAGE ON SCHEMA public TO app_user;
GRANT SELECT, INSERT, UPDATE, DELETE ON ALL TABLES IN SCHEMA public TO app_user;
```

### 3.2. R√¥les Sp√©cialis√©s

Cr√©ez des r√¥les pour chaque fonction :

```sql
-- R√¥le lecture seule (reporting, analytics)
CREATE ROLE readonly;
GRANT CONNECT ON DATABASE myapp TO readonly;
GRANT USAGE ON SCHEMA public TO readonly;
GRANT SELECT ON ALL TABLES IN SCHEMA public TO readonly;
ALTER DEFAULT PRIVILEGES IN SCHEMA public
  GRANT SELECT ON TABLES TO readonly;

-- Utilisateur de reporting
CREATE ROLE report_user LOGIN PASSWORD 'secure_password' IN ROLE readonly;

-- R√¥le application (lecture/√©criture limit√©e)
CREATE ROLE app_rw;
GRANT CONNECT ON DATABASE myapp TO app_rw;
GRANT USAGE ON SCHEMA public TO app_rw;
GRANT SELECT, INSERT, UPDATE, DELETE ON ALL TABLES IN SCHEMA public TO app_rw;

-- Utilisateur application
CREATE ROLE app_user LOGIN PASSWORD 'secure_password' IN ROLE app_rw;
```

### 3.3. R√©vocation des Privil√®ges par D√©faut

PostgreSQL donne des droits par d√©faut sur le sch√©ma `public`. R√©voquez-les :

```sql
-- R√©voquer les privil√®ges publics
REVOKE CREATE ON SCHEMA public FROM PUBLIC;
REVOKE ALL ON DATABASE myapp FROM PUBLIC;
```

### 3.4. Row-Level Security (RLS)

Pour aller plus loin, impl√©mentez des **politiques de s√©curit√© au niveau des lignes**.

```sql
-- Activer RLS sur une table
ALTER TABLE users ENABLE ROW LEVEL SECURITY;

-- Politique : chaque utilisateur ne voit que ses propres donn√©es
CREATE POLICY user_isolation ON users
  FOR ALL
  TO app_user
  USING (user_id = current_user::integer);
```

---

## 4. Chiffrement des Donn√©es

### 4.1. Chiffrement en Transit (SSL/TLS)

**Obligatoire en production** : Toutes les connexions doivent √™tre chiffr√©es.

**Configuration SSL** :

1. G√©n√©rer les certificats :
```bash
# Certificat auto-sign√© (d√©veloppement)
openssl req -new -x509 -days 365 -nodes -text \
  -out server.crt -keyout server.key \
  -subj "/CN=pgserver.example.com"

chmod 600 server.key
chown postgres:postgres server.key server.crt
```

2. Configurer PostgreSQL :
```conf
# postgresql.conf
ssl = on
ssl_cert_file = '/path/to/server.crt'
ssl_key_file = '/path/to/server.key'
ssl_min_protocol_version = 'TLSv1.3'  # PostgreSQL 18+
```

3. Forcer SSL dans pg_hba.conf :
```conf
# Seules les connexions SSL sont accept√©es
hostssl all all 0.0.0.0/0 scram-sha-256
```

**Nouveaut√© PostgreSQL 18** : Configuration TLS 1.3 avanc√©e

```conf
# postgresql.conf
ssl_tls13_ciphers = 'TLS_AES_256_GCM_SHA384:TLS_AES_128_GCM_SHA256'
```

### 4.2. Mode FIPS (PostgreSQL 18)

Pour les environnements gouvernementaux ou r√©glement√©s (sant√©, finance) :

```conf
# postgresql.conf
ssl_fips_mode = on
```

**FIPS** (Federal Information Processing Standard) garantit l'utilisation d'algorithmes cryptographiques certifi√©s.

### 4.3. Chiffrement au Repos

PostgreSQL ne chiffre pas les donn√©es sur disque par d√©faut. Options :

1. **Chiffrement du syst√®me de fichiers** :
   - LUKS (Linux)
   - BitLocker (Windows)
   - dm-crypt

2. **Transparent Data Encryption (TDE)** :
   - Solutions commerciales (EnterpriseDB, Percona)
   - Extension pgcrypto pour chiffrement au niveau colonne (limit√©)

3. **Chiffrement Cloud natif** :
   - AWS RDS : Encryption at rest
   - Azure : Transparent Data Encryption
   - GCP : Automatic encryption

**Exemple pgcrypto (chiffrement colonnes sensibles)** :

```sql
CREATE EXTENSION pgcrypto;

-- Chiffrer une donn√©e
INSERT INTO users (email, ssn_encrypted)
VALUES ('user@example.com', pgp_sym_encrypt('123-45-6789', 'secret_key'));

-- D√©chiffrer
SELECT email, pgp_sym_decrypt(ssn_encrypted, 'secret_key') AS ssn
FROM users;
```

> ‚ö†Ô∏è **Limitation** : pgcrypto chiffre au niveau application, pas transparent, et n'est pas adapt√© pour tout le dataset.

---

## 5. Audit et Logging

### 5.1. Configuration des Logs

Activez un logging d√©taill√© pour tracer les activit√©s suspectes.

```conf
# postgresql.conf

# Activer le logging
logging_collector = on
log_directory = 'log'
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
log_rotation_age = 1d
log_rotation_size = 100MB

# Que logger ?
log_connections = on
log_disconnections = on
log_duration = off  # Attention, verbeux
log_statement = 'ddl'  # DDL uniquement (CREATE, ALTER, DROP)

# Log des erreurs et warnings
log_min_messages = warning
log_min_error_statement = error

# Dur√©e des requ√™tes lentes
log_min_duration_statement = 1000  # Log si > 1 seconde

# Format du log (pr√©fixe enrichi)
log_line_prefix = '%t [%p]: user=%u,db=%d,app=%a,client=%h '
```

**Explication des param√®tres** :
- `log_connections/disconnections` : Tracer qui se connecte
- `log_statement = 'ddl'` : Auditer les modifications de sch√©ma
- `log_min_duration_statement` : Identifier les requ√™tes lentes
- `log_line_prefix` : Enrichir les logs avec contexte (user, db, IP)

### 5.2. Extension pgAudit

Pour un audit plus fin (conformit√© SOX, PCI-DSS, GDPR) :

```sql
CREATE EXTENSION pgaudit;
```

Configuration :
```conf
# postgresql.conf
pgaudit.log = 'write, ddl'  # Auditer les √©critures et DDL
pgaudit.log_catalog = off   # Exclure les tables syst√®me
pgaudit.log_parameter = on  # Logger les param√®tres des requ√™tes
```

**Types d'audit** :
- `READ` : SELECT
- `WRITE` : INSERT, UPDATE, DELETE, TRUNCATE
- `DDL` : CREATE, ALTER, DROP
- `ROLE` : GRANT, REVOKE
- `FUNCTION` : Ex√©cution de fonctions

### 5.3. Centralisation des Logs

Envoyez les logs vers un syst√®me centralis√© (SIEM) :

- **Syslog** : Configuration dans `postgresql.conf`
  ```conf
  log_destination = 'syslog'
  syslog_facility = 'LOCAL0'
  syslog_ident = 'postgres'
  ```

- **Solutions modernes** :
  - ELK Stack (Elasticsearch, Logstash, Kibana)
  - Splunk
  - Datadog
  - AWS CloudWatch / Azure Monitor

---

## 6. Data Checksums (Int√©grit√© des Donn√©es)

### 6.1. Activation des Checksums

**Nouveaut√© PostgreSQL 18** : Les **checksums de donn√©es** sont activ√©s **par d√©faut** lors de l'initialisation (`initdb`).

**Pourquoi c'est important** :
- D√©tecte la corruption de donn√©es sur disque
- Alerte en cas de probl√®me mat√©riel
- Garantit l'int√©grit√© physique

**V√©rifier l'√©tat** :
```sql
SHOW data_checksums;
-- R√©sultat attendu : on
```

**Si d√©sactiv√©** (anciennes versions ou `--no-data-checksums` utilis√©) :
- Pour activer : N√©cessite un `pg_checksums` en offline (cluster arr√™t√©)
- Ou recr√©er le cluster avec `initdb --data-checksums`

> ‚ö†Ô∏è **Co√ªt** : Les checksums ont un **l√©ger impact performance** (1-5%), mais c'est n√©gligeable face au gain en d√©tection d'erreurs.

---

## 7. Protection Contre les Attaques Courantes

### 7.1. Injection SQL (SQL Injection)

Bien que ce soit une **responsabilit√© applicative**, configurez PostgreSQL pour limiter les d√©g√¢ts.

**C√¥t√© PostgreSQL** :
- Limiter les permissions (voir section 3)
- D√©sactiver les fonctions dangereuses pour les utilisateurs non admin

**C√¥t√© application** (rappel) :
- Toujours utiliser des **requ√™tes pr√©par√©es** (Prepared Statements)
- Jamais de concat√©nation de cha√Ænes pour construire du SQL

**Exemple s√©curis√© (Python/psycopg3)** :
```python
# ‚úÖ Bon - Requ√™te pr√©par√©e
cursor.execute(
    "SELECT * FROM users WHERE email = %s",
    (user_input,)
)

# ‚ùå Dangereux - Vuln√©rable √† l'injection
cursor.execute(
    f"SELECT * FROM users WHERE email = '{user_input}'"
)
```

### 7.2. Limitation des Ressources par Utilisateur

Emp√™chez un utilisateur malveillant (ou bugg√©) de saturer le serveur.

```sql
-- Limiter les connexions par r√¥le
ALTER ROLE app_user CONNECTION LIMIT 10;

-- Timeout des requ√™tes (au niveau base ou r√¥le)
ALTER DATABASE myapp SET statement_timeout = '30s';
ALTER ROLE app_user SET statement_timeout = '30s';

-- Limiter la m√©moire de travail
ALTER ROLE app_user SET work_mem = '64MB';
```

### 7.3. D√©sactiver les Fonctions Dangereuses

Certaines fonctions permettent l'ex√©cution de code syst√®me.

```sql
-- R√©voquer l'acc√®s aux fonctions syst√®me sensibles
REVOKE EXECUTE ON FUNCTION pg_read_file(text) FROM PUBLIC;
REVOKE EXECUTE ON FUNCTION pg_ls_dir(text) FROM PUBLIC;
```

---

## 8. Maintenance S√©curit√© R√©guli√®re

### 8.1. Mises √† Jour (Patches)

PostgreSQL publie des **mises √† jour de s√©curit√©** r√©guli√®rement.

**Bonnes pratiques** :
- Surveiller les annonces de s√©curit√© : https://www.postgresql.org/support/security/
- Appliquer les patches mineurs rapidement (ex: 18.0 ‚Üí 18.1)
- Tester d'abord en environnement de staging

**Exemple de strat√©gie** :
- **Critique** (CVE high) : Appliquer sous 7 jours
- **Important** (CVE medium) : Appliquer sous 30 jours
- **Mineures** : Appliquer au prochain cycle de maintenance

### 8.2. Revue des Comptes et Permissions

**Audit r√©gulier** (mensuel ou trimestriel) :

```sql
-- Lister tous les r√¥les et leurs privil√®ges
\du

-- Lister les superutilisateurs
SELECT rolname FROM pg_roles WHERE rolsuper = true;

-- V√©rifier les r√¥les sans mot de passe
SELECT rolname FROM pg_authid WHERE rolpassword IS NULL AND rolcanlogin = true;

-- Permissions sur les tables sensibles
SELECT grantee, privilege_type
FROM information_schema.table_privileges
WHERE table_name = 'users';
```

**Actions** :
- D√©sactiver les comptes inutilis√©s
- Supprimer les permissions obsol√®tes
- Forcer le renouvellement des mots de passe

### 8.3. Rotation des Mots de Passe

Imposez une politique de rotation :

```sql
-- Expiration du mot de passe
ALTER ROLE app_user VALID UNTIL '2026-03-01';

-- Forcer le changement au prochain login (via application)
ALTER ROLE app_user PASSWORD 'new_password' VALID UNTIL '2026-03-01';
```

> **Note** : PostgreSQL ne force pas automatiquement le changement de mot de passe. C'est √† g√©rer au niveau applicatif ou via un syst√®me IAM.

### 8.4. Surveillance des Vuln√©rabilit√©s

Utilisez des outils de scan de vuln√©rabilit√©s :

- **Lynis** : Audit de s√©curit√© syst√®me
- **OpenVAS** : Scanner de vuln√©rabilit√©s r√©seau
- **CloudWatch / Defender for SQL** (Cloud) : D√©tection d'anomalies

---

## 9. Checklist de Hardening S√©curit√©

Voici une **checklist r√©capitulative** √† valider avant la mise en production :

### ‚úÖ R√©seau
- [ ] `listen_addresses` limit√© (pas `'*'`)
- [ ] Firewall configur√© (seules IPs autoris√©es)
- [ ] Port modifi√© si pertinent
- [ ] Acc√®s via VPN ou bastion host pour administration

### ‚úÖ Authentification
- [ ] M√©thode `trust` d√©sactiv√©e dans pg_hba.conf
- [ ] SCRAM-SHA-256 activ√© (pas MD5)
- [ ] SSL/TLS obligatoire pour connexions externes
- [ ] Certificats SSL valides et √† jour
- [ ] TLS 1.3 configur√© (PostgreSQL 18)
- [ ] OAuth 2.0 configur√© si applicable

### ‚úÖ Autorisation
- [ ] Pas de connexions applicatives en superutilisateur
- [ ] R√¥les d√©di√©s par fonction (app, readonly, admin)
- [ ] Principe du moindre privil√®ge appliqu√©
- [ ] Privil√®ges PUBLIC r√©voqu√©s
- [ ] Row-Level Security (RLS) impl√©ment√© si n√©cessaire

### ‚úÖ Chiffrement
- [ ] SSL activ√© pour toutes les connexions
- [ ] Certificats SSL valides (pas auto-sign√©s en prod)
- [ ] Chiffrement au repos (filesystem ou TDE)
- [ ] Mode FIPS activ√© si requis

### ‚úÖ Audit et Logging
- [ ] Logging activ√© (connections, disconnections, DDL)
- [ ] Logs centralis√©s (syslog, ELK, SIEM)
- [ ] pgAudit install√© et configur√© (si conformit√©)
- [ ] Rotation des logs configur√©e
- [ ] Alertes configur√©es sur logs critiques

### ‚úÖ Int√©grit√©
- [ ] Data checksums activ√©s
- [ ] Sauvegardes r√©guli√®res et test√©es
- [ ] R√©plication configur√©e (HA)

### ‚úÖ Protection Applicative
- [ ] Requ√™tes pr√©par√©es utilis√©es (pas de concat√©nation)
- [ ] Timeouts configur√©s (statement_timeout)
- [ ] Limites de connexions par r√¥le
- [ ] Fonctions syst√®me d√©sactiv√©es pour users non-admin

### ‚úÖ Maintenance
- [ ] Process de mise √† jour de s√©curit√© d√©fini
- [ ] Audit des comptes et permissions mensuel
- [ ] Rotation des mots de passe planifi√©e
- [ ] Monitoring de s√©curit√© actif
- [ ] Documentation √† jour (runbook s√©curit√©)

---

## 10. Ressources Compl√©mentaires

### Documentation Officielle
- [PostgreSQL Security Documentation](https://www.postgresql.org/docs/18/security.html)
- [SSL/TLS Configuration](https://www.postgresql.org/docs/18/ssl-tcp.html)
- [pg_hba.conf Documentation](https://www.postgresql.org/docs/18/auth-pg-hba-conf.html)

### Outils et Scripts
- **pgAudit** : https://github.com/pgaudit/pgaudit
- **Lynis** : https://cisofy.com/lynis/
- **pg_permissions** : Outil d'audit des permissions

### Standards de S√©curit√©
- **CIS PostgreSQL Benchmark** : Guide de hardening
- **NIST Cybersecurity Framework**
- **OWASP Database Security Cheat Sheet**

### Communaut√©
- Mailing list pgsql-security
- PostgreSQL Security Announcements : https://www.postgresql.org/support/security/

---

## Conclusion

Le hardening s√©curit√© n'est **pas une √©tape unique**, mais un **processus continu** :

1. **Configuration initiale** : Appliquer les mesures de base
2. **Audit r√©gulier** : V√©rifier les permissions, logs, mises √† jour
3. **Adaptation** : Ajuster en fonction des nouvelles menaces et besoins

**Principe cl√©** : Une s√©curit√© efficace repose sur la **d√©fense en profondeur**. Aucune mesure unique ne suffit - c'est la combinaison de toutes ces pratiques qui prot√®ge r√©ellement votre base de donn√©es.

En suivant cette checklist et en maintenant une vigilance constante, vous r√©duisez consid√©rablement la surface d'attaque de votre instance PostgreSQL et assurez la protection des donn√©es confi√©es √† votre syst√®me.

---

**Prochaine section** : 19.6.2. Configuration optimale

‚è≠Ô∏è [Configuration optimale](/19-postgresql-en-production/06.2-configuration-optimale.md)
