ğŸ” Retour au [Sommaire](/SOMMAIRE.md)

# 19.2.3. Google Cloud SQL et AlloyDB

## Introduction

**Google Cloud Platform (GCP)** propose deux solutions distinctes pour hÃ©berger PostgreSQL dans le cloud : **Cloud SQL for PostgreSQL** et **AlloyDB for PostgreSQL**. Cette dualitÃ© reflÃ¨te une stratÃ©gie similaire Ã  celle d'AWS (RDS vs Aurora), mais avec des diffÃ©rences importantes dans l'approche technique.

Dans cette section, nous allons explorer ces deux offres, comprendre leurs architectures respectives, leurs diffÃ©rences fondamentales et comment choisir entre elles selon vos besoins.

---

## Vue d'ensemble de l'Offre Google Cloud

Google Cloud propose **deux options principales** pour PostgreSQL :

1. **Cloud SQL for PostgreSQL** : Service managÃ© standard, mature et Ã©prouvÃ©
2. **AlloyDB for PostgreSQL** : Service nouvelle gÃ©nÃ©ration, ultra-performant (lancÃ© en 2022)

### Positionnement des Services

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Google Cloud PostgreSQL Services                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  Cloud SQL for PostgreSQL                                   â”‚
â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”     â”‚
â”‚  â€¢ LancÃ© : 2016                                             â”‚
â”‚  â€¢ PostgreSQL standard                                      â”‚
â”‚  â€¢ 100% compatible                                          â”‚
â”‚  â€¢ CoÃ»t modÃ©rÃ©                                              â”‚
â”‚  â€¢ Performances bonnes                                      â”‚
â”‚  â€¢ Cas d'usage : 80% des applications                       â”‚
â”‚                                                             â”‚
â”‚  AlloyDB for PostgreSQL                                     â”‚
â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”     â”‚
â”‚  â€¢ LancÃ© : 2022 (GA 2023)                                   â”‚
â”‚  â€¢ Moteur propriÃ©taire Google                               â”‚
â”‚  â€¢ ~100% compatible PostgreSQL                              â”‚
â”‚  â€¢ CoÃ»t Ã©levÃ©                                               â”‚
â”‚  â€¢ Performances exceptionnelles (4Ã— Cloud SQL)              â”‚
â”‚  â€¢ Cas d'usage : Applications exigeantes, analytique        â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Analogie avec AWS :**
- Cloud SQL â‰ˆ RDS PostgreSQL
- AlloyDB â‰ˆ Aurora PostgreSQL (mais avec des diffÃ©rences importantes)

---

## Google Cloud SQL for PostgreSQL

### Qu'est-ce que Cloud SQL ?

**Cloud SQL** est le service de base de donnÃ©es relationnelle managÃ© de Google Cloud, supportant PostgreSQL, MySQL et SQL Server. C'est une solution mature, fiable et largement utilisÃ©e.

### Architecture de Cloud SQL

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Google Cloud Region                      â”‚
â”‚                  (ex: europe-west1)                       â”‚
â”‚                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚              VPC Network (RÃ©seau PrivÃ©)              â”‚ â”‚
â”‚  â”‚                                                      â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â”‚  â”‚     Cloud SQL Instance (Primary)               â”‚  â”‚ â”‚
â”‚  â”‚  â”‚                                                â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  PostgreSQL      â”‚                          â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  Engine          â”‚                          â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚  â”‚ â”‚
â”‚  â”‚  â”‚           â”‚                                    â”‚  â”‚ â”‚
â”‚  â”‚  â”‚           â–¼                                    â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  Persistent Disk â”‚                          â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  (SSD ou HDD)    â”‚                          â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚  â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚  â”‚                                                      â”‚ â”‚
â”‚  â”‚  (Option High Availability)                          â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â”‚  â”‚     Standby Replica (Zone B)                   â”‚  â”‚ â”‚
â”‚  â”‚  â”‚     â€¢ RÃ©plication synchrone                    â”‚  â”‚ â”‚
â”‚  â”‚  â”‚     â€¢ Failover automatique                     â”‚  â”‚ â”‚
â”‚  â”‚  â”‚     â€¢ Promoted en cas de panne                 â”‚  â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚  â”‚                                                      â”‚ â”‚
â”‚  â”‚  (Option Read Replicas)                              â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚ â”‚
â”‚  â”‚  â”‚  Read    â”‚  â”‚  Read    â”‚  â”‚  Read    â”‚            â”‚ â”‚
â”‚  â”‚  â”‚ Replica 1â”‚  â”‚ Replica 2â”‚  â”‚ Replica 3â”‚            â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Automated Backups (Cloud Storage)                   â”‚ â”‚
â”‚  â”‚  â€¢ Sauvegardes quotidiennes                          â”‚ â”‚
â”‚  â”‚  â”‚  â€¢ RÃ©tention : 1-365 jours                        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Concepts ClÃ©s Google Cloud

Avant d'approfondir, voici quelques concepts GCP importants :

#### Project (Projet)
- **UnitÃ© d'organisation** de base dans GCP
- Toutes les ressources appartiennent Ã  un projet
- Facturation et quotas par projet

#### VPC (Virtual Private Cloud)
- **RÃ©seau privÃ© virtuel** global (s'Ã©tend sur plusieurs rÃ©gions)
- Sous-rÃ©seaux rÃ©gionaux
- Firewall rules pour contrÃ´le d'accÃ¨s

#### Zone et Region
- **Region** : Localisation gÃ©ographique (ex: europe-west1 = Belgique)
- **Zone** : Datacenter isolÃ© dans une rÃ©gion (ex: europe-west1-b)
- Cloud SQL peut utiliser plusieurs zones pour HA

### CaractÃ©ristiques Principales de Cloud SQL PostgreSQL

#### 1. Versions PostgreSQL SupportÃ©es

Cloud SQL supporte activement :
- PostgreSQL **11** (support Ã©tendu)
- PostgreSQL **12**
- PostgreSQL **13**
- PostgreSQL **14**
- PostgreSQL **15**
- PostgreSQL **16**
- PostgreSQL **17** (selon disponibilitÃ©)

**ParticularitÃ© Google :** Mises Ã  jour mineures automatiques par dÃ©faut (configurable)

#### 2. Tiers de Machine (Types d'Instances)

Cloud SQL propose diffÃ©rentes configurations :

##### Shared-core (PartagÃ©)
- **db-f1-micro** : 0,6 GB RAM (1 vCPU partagÃ©)
- **db-g1-small** : 1,7 GB RAM (1 vCPU partagÃ©)
- **Cas d'usage** : DÃ©veloppement, tests, trÃ¨s petites charges
- **Limitation** : Performance non garantie (partagÃ© avec d'autres)

##### Dedicated-core (DÃ©diÃ©)
Plusieurs familles disponibles :

**Standard (N1, N2, N2D)**
- **n1-standard-1** : 1 vCPU, 3,75 GB RAM
- **n1-standard-2** : 2 vCPU, 7,5 GB RAM
- **n1-standard-4** : 4 vCPU, 15 GB RAM
- Jusqu'Ã  **n1-standard-96** : 96 vCPU, 360 GB RAM

**High-Memory (N1, N2, N2D)**
- **n1-highmem-2** : 2 vCPU, 13 GB RAM
- **n1-highmem-4** : 4 vCPU, 26 GB RAM
- Jusqu'Ã  **n1-highmem-96** : 96 vCPU, 624 GB RAM
- Ratio : 1 vCPU pour ~6,5 GB RAM

**High-CPU (N1, N2)**
- **n1-highcpu-2** : 2 vCPU, 1,8 GB RAM
- Pour charges CPU-intensives
- Moins courant pour PostgreSQL

**Exemple de dimensionnement :**

| Charge | Machine Type | Specs | Prix approximatif |
|--------|--------------|-------|-------------------|
| Dev/Test | db-g1-small | 1 vCPU partagÃ©, 1,7 GB | ~25â‚¬/mois |
| Production Petite | n1-standard-2 | 2 vCPU, 7,5 GB | ~100â‚¬/mois |
| Production Moyenne | n1-standard-4 | 4 vCPU, 15 GB | ~200â‚¬/mois |
| Production Intensive | n1-highmem-8 | 8 vCPU, 52 GB | ~550â‚¬/mois |

#### 3. Stockage

Cloud SQL propose deux types de stockage :

##### SSD (Solid State Drive) - RecommandÃ©
- **Performance** : Jusqu'Ã  60 000 IOPS et 1 200 MB/s
- **Latence** : TrÃ¨s faible (millisecondes)
- **Taille** : 10 GB Ã  64 TB
- **Auto-scaling** : Croissance automatique possible
- **Cas d'usage** : Production, charges I/O intensives

##### HDD (Hard Disk Drive) - Legacy
- **Performance** : Jusqu'Ã  1 200 IOPS
- **Latence** : Plus Ã©levÃ©e
- **Taille** : 10 GB Ã  64 TB
- **CoÃ»t** : ~50% moins cher que SSD
- **Cas d'usage** : DÃ©veloppement, donnÃ©es froides, backup

**Important :** Le type de stockage ne peut pas Ãªtre changÃ© aprÃ¨s crÃ©ation. Il faut migrer vers une nouvelle instance.

**Performance Stockage SSD :**

| Taille Stockage | IOPS Lecture | IOPS Ã‰criture | DÃ©bit |
|-----------------|--------------|---------------|-------|
| 10-500 GB | 3000 | 3000 | 624 MB/s |
| 500-1000 GB | 6000 | 6000 | 624 MB/s |
| 1-2 TB | 12000 | 12000 | 624 MB/s |
| 2-4 TB | 24000 | 24000 | 1200 MB/s |
| 4+ TB | 60000 | 60000 | 1200 MB/s |

#### 4. Haute DisponibilitÃ© (HA)

Cloud SQL propose une configuration **Regional HA** :

##### Configuration HA
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Cloud SQL Regional Configuration          â”‚
â”‚                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Zone A        â”‚         â”‚  Zone B        â”‚    â”‚
â”‚  â”‚                â”‚         â”‚                â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚         â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚
â”‚  â”‚  â”‚ Primary  â”‚  â”‚ Sync    â”‚  â”‚ Standby  â”‚  â”‚    â”‚
â”‚  â”‚  â”‚ Instance â”‚â—„â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚  â”‚ Instance â”‚  â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â”‚  Repl   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚
â”‚  â”‚       â”‚        â”‚         â”‚                â”‚    â”‚
â”‚  â”‚       â–¼        â”‚         â”‚                â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚         â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚
â”‚  â”‚  â”‚Regional  â”‚  â”‚         â”‚  â”‚Regional  â”‚  â”‚    â”‚
â”‚  â”‚  â”‚Persistentâ”‚â—„â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚  â”‚Persistentâ”‚  â”‚    â”‚
â”‚  â”‚  â”‚  Disk    â”‚  â”‚  Mirror â”‚  â”‚  Disk    â”‚  â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚         â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                   â”‚
â”‚  En cas de panne Zone A : Failover vers Zone B    â”‚
â”‚  DurÃ©e : 30-60 secondes                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**CaractÃ©ristiques HA :**
- RÃ©plication **synchrone** entre zones
- **Failover automatique** en 30-60 secondes
- **RPO = 0** (aucune perte de donnÃ©es)
- **RTO < 1 minute**
- Regional Persistent Disk : rÃ©pliquÃ© automatiquement
- Pas d'impact sur les performances

**CoÃ»t HA :**
- Compute : 2Ã— le coÃ»t de l'instance
- Stockage : Inclus dans le prix (Regional Disk)

**Sans HA :**
- Instance **Zonal** : Dans une seule zone
- Moins cher (pas de doublement compute)
- VulnÃ©rable aux pannes de zone
- **Non recommandÃ© pour production**

#### 5. Read Replicas (RÃ©plicas de Lecture)

Cloud SQL supporte plusieurs types de rÃ©plicas :

##### Read Replica Standard
- RÃ©plication **asynchrone** depuis l'instance primaire
- Peut Ãªtre dans la **mÃªme rÃ©gion** ou **cross-region**
- Jusqu'Ã  **10 Read Replicas** par instance primaire
- UtilisÃ© pour scalabilitÃ© en lecture

##### Cross-Region Read Replica
- RÃ©plica dans une **rÃ©gion diffÃ©rente**
- Utile pour :
  - GÃ©o-distribution (latence rÃ©duite)
  - Disaster Recovery
  - ConformitÃ© rÃ©glementaire (donnÃ©es dans pays spÃ©cifique)

##### Cascading Read Replica
- RÃ©plica qui se rÃ©plique depuis un autre **Read Replica**
- Permet de crÃ©er des chaÃ®nes de rÃ©plication
- RÃ©duit la charge sur l'instance primaire

**Lag de RÃ©plication :**
- MÃªme rÃ©gion : Quelques secondes
- Cross-region : Variable (rÃ©seau, charge)
- Visible via mÃ©triques Cloud Monitoring

#### 6. Sauvegardes et Restauration

##### Sauvegardes Automatiques
- **FrÃ©quence** : Quotidienne pendant fenÃªtre configurable
- **RÃ©tention** : 1 Ã  365 jours (7 jours par dÃ©faut)
- **Type** : Snapshot complet + logs binaires
- **Stockage** : Multi-rÃ©gional automatiquement (rÃ©silience)
- **Impact** : Minimal sur performances (I/O lÃ©gÃ¨rement augmentÃ©es)

##### Point-in-Time Recovery (PITR)
- Restauration Ã  **n'importe quelle seconde** durant pÃ©riode de rÃ©tention
- BasÃ© sur sauvegardes + logs de transactions
- CrÃ©e une **nouvelle instance** (l'originale reste inchangÃ©e)
- GranularitÃ© : Ã€ la seconde prÃ¨s

##### Sauvegardes On-Demand
- Snapshots manuels Ã  tout moment
- Conservation indÃ©finie (jusqu'Ã  suppression manuelle)
- Utile avant migrations, upgrades, changements majeurs

##### Export vers Cloud Storage
- Export SQL (pg_dump) ou CSV
- StockÃ© dans Google Cloud Storage (GCS)
- Permet des restaurations cross-project ou cross-cloud

**Processus de Restauration :**
```
1. SÃ©lection du point de restauration
   â†“
2. Cloud SQL crÃ©e une nouvelle instance
   â†“
3. Restauration des donnÃ©es (peut prendre du temps)
   â†“
4. Validation de l'intÃ©gritÃ©
   â†“
5. Basculement de l'application
   â†“
6. (Optionnel) Suppression de l'ancienne instance
```

#### 7. Options de ConnectivitÃ©

Cloud SQL propose plusieurs mÃ©thodes de connexion :

##### Public IP (Adresse IP Publique)
- Instance accessible via Internet
- SÃ©curisÃ© par **Authorized Networks** (whitelist IP)
- SSL/TLS obligatoire
- **Moins sÃ©curisÃ©**, mais plus simple

##### Private IP (VPC Peering)
- Instance dÃ©ployÃ©e dans votre **VPC**
- Accessible uniquement depuis le VPC (ou VPCs appairÃ©s)
- Pas d'exposition Internet
- **RecommandÃ© pour production**

##### Cloud SQL Proxy
- Outil client Google pour connexion sÃ©curisÃ©e
- Chiffrement automatique
- Pas besoin de gÃ©rer SSL/TLS manuellement
- Authentification via IAM
- Fonctionne avec Public ou Private IP

**Architecture Private IP :**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           VPC Network (Projet Client)       â”‚
â”‚                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   Subnet App (10.0.1.0/24)             â”‚ â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚ â”‚
â”‚  â”‚   â”‚  GKE Pod â”‚   â”‚  Compute â”‚          â”‚ â”‚
â”‚  â”‚   â”‚          â”‚   â”‚  Engine  â”‚          â”‚ â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜          â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚           â”‚              â”‚                  â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                  â”‚ Private Connection       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚ VPC Peering
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      Google Service Networking VPC          â”‚
â”‚                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   Cloud SQL Instance                   â”‚ â”‚
â”‚  â”‚   Private IP: 10.x.x.x                 â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

##### Cloud SQL Auth Proxy (Exemple)
```bash
# Installation
wget https://dl.google.com/cloudsql/cloud_sql_proxy.linux.amd64
chmod +x cloud_sql_proxy

# Lancement du proxy
./cloud_sql_proxy -instances=PROJECT:REGION:INSTANCE=tcp:5432

# Connexion via le proxy (localhost:5432)
psql "host=127.0.0.1 port=5432 dbname=mydb user=postgres"
```

#### 8. SÃ©curitÃ©

##### Authentification
- **PostgreSQL native** : Utilisateur/mot de passe
- **Cloud SQL IAM Authentication** :
  - Connexion via IAM (sans mot de passe PostgreSQL)
  - IntÃ©gration avec Google Cloud Identity
  - Tokens temporaires

**Exemple IAM Authentication :**
```bash
# L'utilisateur utilise son compte Google Cloud
gcloud sql connect my-instance --user=user@example.com
```

##### Chiffrement
- **En transit** : SSL/TLS obligatoire par dÃ©faut
  - Certificats gÃ©rÃ©s automatiquement
  - TLS 1.2+ uniquement
- **Au repos** : Chiffrement **automatique** et **transparent**
  - Utilise Google-managed encryption keys (par dÃ©faut)
  - **Customer-managed encryption keys (CMEK)** via Cloud KMS
  - Chiffrement du stockage, backups, rÃ©plicas

##### Audit Logging
- **Cloud Audit Logs** : Enregistre toutes les opÃ©rations administratives
- **Database Audit Plugin** : Audit des connexions et requÃªtes SQL
  - pgaudit extension disponible
  - Export vers Cloud Logging

##### Firewall et RÃ©seau
- **Authorized Networks** : Whitelist d'adresses IP (Public IP)
- **VPC Firewall Rules** : ContrÃ´le d'accÃ¨s rÃ©seau (Private IP)
- **Private Service Connection** : Isolation complÃ¨te

##### Compliance
- Certifications : ISO 27001, SOC 2/3, PCI DSS, HIPAA, GDPR
- Data residency : Choix de la rÃ©gion pour conformitÃ©

#### 9. Flags de Configuration (PostgreSQL Parameters)

Cloud SQL permet de modifier de nombreux paramÃ¨tres PostgreSQL via des **flags** :

##### CatÃ©gories de Flags
- **Dynamiques** : Applicables sans redÃ©marrage
- **Statiques** : NÃ©cessitent un redÃ©marrage

##### Flags Couramment ModifiÃ©s
```
MÃ©moire :
- shared_buffers
- work_mem
- maintenance_work_mem
- effective_cache_size

Connexions :
- max_connections
- idle_in_transaction_session_timeout

Logging :
- log_statement (none, ddl, mod, all)
- log_min_duration_statement
- log_connections
- log_disconnections

Autovacuum :
- autovacuum
- autovacuum_max_workers
- autovacuum_naptime

Performance :
- random_page_cost
- effective_io_concurrency
```

**Application de Flags :**
- Via Console GCP
- Via gcloud CLI : `gcloud sql instances patch INSTANCE --database-flags=flag1=value1,flag2=value2`
- Certains flags nÃ©cessitent un redÃ©marrage (maintenance window)

#### 10. Extensions PostgreSQL

Cloud SQL supporte la plupart des extensions PostgreSQL populaires :

##### Extensions Disponibles
```
Core :
- pg_stat_statements (monitoring)
- pgcrypto (cryptographie)
- uuid-ossp (UUID)
- citext (case-insensitive text)
- hstore (key-value)
- btree_gin, btree_gist

GÃ©ospatial :
- PostGIS (complet)

Full-Text Search :
- pg_trgm (similaritÃ©)
- fuzzystrmatch

Autres :
- pgaudit (audit)
- pg_partman (partitionnement)
- plv8 (JavaScript)
- timescaledb (sÃ©ries temporelles)
- pgvector (vecteurs IA)
```

**Installation :**
```sql
-- Lister les extensions disponibles
SELECT * FROM pg_available_extensions;

-- Installer une extension
CREATE EXTENSION IF NOT EXISTS postgis;
CREATE EXTENSION IF NOT EXISTS pg_stat_statements;
```

**Note :** Certaines extensions nÃ©cessitent des flags spÃ©cifiques et redÃ©marrage.

#### 11. Monitoring et ObservabilitÃ©

Cloud SQL s'intÃ¨gre nativement avec **Cloud Monitoring** (anciennement Stackdriver) :

##### MÃ©triques Disponibles
- **Database Metrics** :
  - CPU Utilization (%)
  - Memory Utilization (%)
  - Disk Utilization (%)
  - Active Connections
  - Read/Write Operations (IOPS)
  - Network Bytes Sent/Received

- **Replication Metrics** :
  - Replica Lag (secondes)
  - Replication Bytes Sent

- **PostgreSQL Specifics** :
  - Transactions per Second
  - Dead Tuples (pour vacuum monitoring)
  - Locks

##### Logs
- **PostgreSQL Logs** : ExportÃ©s automatiquement vers Cloud Logging
- **RequÃªtes lentes** : Configurable via log_min_duration_statement
- **Erreurs et warnings**

##### Query Insights (Preview)
- Top requÃªtes par :
  - Temps d'exÃ©cution total
  - FrÃ©quence
  - Latence moyenne
- Recommandations d'index
- DÃ©tection de requÃªtes problÃ©matiques

##### Alerting
- CrÃ©ation d'**alertes** sur n'importe quelle mÃ©trique
- Notification via :
  - Email
  - SMS
  - PagerDuty
  - Slack (via webhooks)

**Exemples d'alertes critiques :**
```
- CPU > 85% pendant 5 minutes
- Disk > 90%
- Connections > 90% de max_connections
- Replica Lag > 60 secondes
- Failed Connections spike
```

---

## AlloyDB for PostgreSQL

### Qu'est-ce qu'AlloyDB ?

**AlloyDB** est le service de base de donnÃ©es **nouvelle gÃ©nÃ©ration** de Google Cloud, lancÃ© en 2022. Il s'agit d'un moteur **propriÃ©taire** dÃ©veloppÃ© par Google, compatible avec PostgreSQL, et optimisÃ© pour des performances exceptionnelles.

### Philosophie d'AlloyDB

AlloyDB est conÃ§u pour Ãªtre **4Ã— plus rapide** que Cloud SQL (selon Google) pour les charges transactionnelles, et **100Ã— plus rapide** pour les requÃªtes analytiques grÃ¢ce Ã  son moteur de colonnes intÃ©grÃ©.

### Architecture d'AlloyDB

AlloyDB repose sur une architecture **sÃ©paration compute/storage** similaire Ã  Aurora AWS :

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 AlloyDB Cluster Architecture              â”‚
â”‚                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚              Cluster (UnitÃ© logique)                 â”‚ â”‚
â”‚  â”‚                                                      â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚ â”‚
â”‚  â”‚  â”‚   Primary      â”‚       â”‚   Read Pool    â”‚         â”‚ â”‚
â”‚  â”‚  â”‚   Instance     â”‚       â”‚   Instance 1   â”‚         â”‚ â”‚
â”‚  â”‚  â”‚   (Lecture +   â”‚       â”‚   (Lecture     â”‚         â”‚ â”‚
â”‚  â”‚  â”‚   Ã‰criture)    â”‚       â”‚   seule)       â”‚         â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚ â”‚
â”‚  â”‚          â”‚                        â”‚                  â”‚ â”‚
â”‚  â”‚          â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚                  â”‚ â”‚
â”‚  â”‚          â”‚      â”‚   Read Pool    â”‚â”‚                  â”‚ â”‚
â”‚  â”‚          â”‚      â”‚   Instance 2   â”‚â”‚                  â”‚ â”‚
â”‚  â”‚          â”‚      â”‚   (Analytique) â”‚â”‚                  â”‚ â”‚
â”‚  â”‚          â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚                  â”‚ â”‚
â”‚  â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚ â”‚
â”‚  â”‚                     â”‚                                â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                        â”‚                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚       Shared Distributed Storage Layer               â”‚ â”‚
â”‚  â”‚                                                      â”‚ â”‚
â”‚  â”‚  â€¢ RÃ©plication automatique (3 copies minimum)        â”‚ â”‚
â”‚  â”‚  â€¢ Stockage log-structured (LSM)                     â”‚ â”‚
â”‚  â”‚  â€¢ Cache distribuÃ© intelligent                       â”‚ â”‚
â”‚  â”‚  â€¢ Columnar engine intÃ©grÃ© (analytique)              â”‚ â”‚
â”‚  â”‚  â€¢ CapacitÃ© : Jusqu'Ã  64 TB auto-scaling             â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### DiffÃ©rences Fondamentales avec Cloud SQL

| Aspect | Cloud SQL | AlloyDB |
|--------|-----------|---------|
| **Moteur** | PostgreSQL standard | Moteur propriÃ©taire Google |
| **Architecture** | Instance + Persistent Disk | Compute/Storage sÃ©parÃ©s |
| **RÃ©plication** | Streaming replication | Log-based, storage-level |
| **Performances OLTP** | Baseline | 4Ã— plus rapide (selon Google) |
| **Performances OLAP** | Standard | 100Ã— plus rapide (columnar) |
| **Scaling Lecture** | Jusqu'Ã  10 rÃ©plicas | Read Pool illimitÃ© |
| **Stockage Max** | 64 TB | 64 TB (auto-scaling) |
| **CompatibilitÃ©** | 100% PostgreSQL | ~100% (quelques extensions manquantes) |
| **CoÃ»t** | ModÃ©rÃ© | 2-3Ã— plus cher |

### CaractÃ©ristiques Principales d'AlloyDB

#### 1. Versions PostgreSQL SupportÃ©es

AlloyDB supporte actuellement :
- PostgreSQL **14**
- PostgreSQL **15**
- PostgreSQL **16**

**Note :** Support de versions plus rÃ©cent que PostgreSQL standard (Google ajoute rapidement les nouvelles versions).

#### 2. Types d'Instances

##### Primary Instance (Instance Primaire)
- **Lecture + Ã‰criture**
- Machine types disponibles :
  - **2 vCPU, 16 GB RAM** (minimum)
  - **4 vCPU, 32 GB RAM**
  - **8 vCPU, 64 GB RAM**
  - Jusqu'Ã  **128 vCPU, 864 GB RAM**

**Ratio fixe** : 1 vCPU = 8 GB RAM (optimisÃ© mÃ©moire)

##### Read Pool Instances (Instances en Lecture)
- **Lecture seule**
- RÃ©plication **quasi-synchrone** (lag < 10ms)
- **Nombre illimitÃ©** d'instances (scaling horizontal)
- MÃªme choix de machine types

##### Configuration HA
- **Instance primaire** dans une zone
- **Standby synchrone** dans une autre zone (automatique)
- Failover **automatique** en ~10-20 secondes
- **HA toujours activÃ©e** (pas d'option pour la dÃ©sactiver)

#### 3. Columnar Engine (Moteur Colonnes)

**Innovation majeure d'AlloyDB :**

##### Fonctionnement
- DonnÃ©es stockÃ©es **en colonnes** en plus du format ligne traditionnel
- **Transparent** : Aucune modification applicative nÃ©cessaire
- **Optimiseur intelligent** : Choisit automatiquement le format optimal
- **Synchronisation automatique** : Conversion ligneâ†’colonne en arriÃ¨re-plan

##### Avantages
- **100Ã— plus rapide** pour requÃªtes analytiques (agrÃ©gations, scans)
- Compression supÃ©rieure
- IdÃ©al pour :
  - Rapports et dashboards
  - Analytics en temps rÃ©el
  - OLTP + OLAP mixte (HTAP)

**Exemple de Gain :**
```sql
-- RequÃªte analytique sur 1 milliard de lignes
SELECT product_category, SUM(sales_amount)
FROM sales
WHERE sale_date BETWEEN '2024-01-01' AND '2024-12-31'
GROUP BY product_category;

Cloud SQL :    45 secondes
AlloyDB :      0.5 secondes (90Ã— plus rapide)
```

##### Activation
- **Automatique** par dÃ©faut
- Peut Ãªtre dÃ©sactivÃ© par table si nÃ©cessaire
- Monitoring du ratio ligne/colonne via mÃ©triques

#### 4. Intelligent Query Planner

AlloyDB intÃ¨gre un **planificateur de requÃªtes avancÃ©** :

##### Machine Learning IntÃ©grÃ©
- **Auto-tuning** : Apprend des patterns de requÃªtes
- **PrÃ©diction de coÃ»t** : Meilleure estimation des plans d'exÃ©cution
- **Adaptation dynamique** : Ajuste les stratÃ©gies selon la charge

##### Optimisations SpÃ©cifiques
- **Join optimization** : RÃ©ordonnancement intelligent
- **Index hints** : Suggestions automatiques
- **Parallel query execution** : ParallÃ©lisation agressive

#### 5. Caching Intelligent

##### Multi-Level Cache
- **Shared cache** : PartagÃ© entre toutes les instances du cluster
- **Local cache** : Par instance read pool
- **PrÃ©chargement intelligent** : Anticipe les donnÃ©es nÃ©cessaires

##### RÃ©sultat
- **Hit ratio Ã©levÃ©** : Moins d'I/O sur le stockage
- **Latence rÃ©duite** : RÃ©ponses sub-milliseconde
- **ScalabilitÃ©** : Ajout d'instances read pool amÃ©liore le cache global

#### 6. Continuous Protection (Protection Continue)

##### Point-in-Time Recovery AmÃ©liorÃ©
- **GranularitÃ©** : Ã€ la seconde prÃ¨s
- **RÃ©tention** : Jusqu'Ã  35 jours
- **Restauration rapide** : Minutes (vs heures pour dump/restore)

##### Backup Continu
- Sauvegardes **incrÃ©mentales continues**
- Stockage dans Cloud Storage multi-rÃ©gional
- **Aucun impact** sur les performances
- Restore vers n'importe quel point dans la pÃ©riode de rÃ©tention

##### Clone de Base de DonnÃ©es
- **Instant cloning** : CrÃ©ation en quelques secondes
- **Copy-on-write** : Pas de duplication initiale
- IdÃ©al pour :
  - Tests de migration
  - DÃ©veloppement
  - Analyse de donnÃ©es

#### 7. Networking et ConnectivitÃ©

##### Private Services Access (Obligatoire)
- AlloyDB **nÃ©cessite** un VPC avec Private Services Access
- Pas d'option Public IP
- **SÃ©curitÃ© maximale** : Aucune exposition Internet

##### Connection Pooling IntÃ©grÃ©
- **PgBouncer intÃ©grÃ©** dans le cluster
- Gestion automatique des connexions
- RÃ©duit la charge sur l'instance primaire

##### Endpoints
- **Primary endpoint** : Toujours pointe vers l'instance primaire
- **Read pool endpoint** : Load balancing automatique entre read instances
- Basculement transparent en cas de failover

#### 8. SÃ©curitÃ© AlloyDB

##### Authentification
- **IAM Database Authentication** (recommandÃ©)
- PostgreSQL native (utilisateur/mot de passe)
- IntÃ©gration Google Cloud Identity

##### Chiffrement
- **En transit** : TLS 1.2+ obligatoire
- **Au repos** : Chiffrement automatique
  - Google-managed keys (par dÃ©faut)
  - Customer-managed keys (CMEK) via Cloud KMS
- Chiffrement des sauvegardes et clones

##### Audit et Compliance
- Cloud Audit Logs pour opÃ©rations administratives
- pgaudit extension pour audit SQL
- Certifications : ISO, SOC, PCI DSS, HIPAA, GDPR

#### 9. Database Flags

Comme Cloud SQL, AlloyDB permet de configurer PostgreSQL via flags :

##### Flags SupportÃ©s
- MajoritÃ© des paramÃ¨tres PostgreSQL standard
- Quelques flags spÃ©cifiques AlloyDB (columnar engine, caching)

##### Limitations
- Certains paramÃ¨tres liÃ©s au stockage ne sont pas modifiables
- ParamÃ¨tres HA gÃ©rÃ©s automatiquement

#### 10. Extensions PostgreSQL

AlloyDB supporte la plupart des extensions PostgreSQL :

##### Extensions Disponibles
```
Core :
- pg_stat_statements
- pgcrypto
- uuid-ossp
- citext
- hstore

PostGIS : Complet

IA/ML :
- pgvector (vecteurs pour ML)

Autres :
- pg_trgm
- fuzzystrmatch
- btree_gin, btree_gist
```

**Limitation :** Certaines extensions tierces peuvent ne pas Ãªtre supportÃ©es.

#### 11. Monitoring AlloyDB

##### MÃ©triques AvancÃ©es
- **MÃ©triques standards** : CPU, RAM, IOPS, Connections
- **MÃ©triques AlloyDB spÃ©cifiques** :
  - Columnar engine hit ratio
  - Cache efficiency
  - Replication lag (< 10ms typiquement)
  - Query performance insights

##### Query Insights
- **Analyse automatique** des requÃªtes lentes
- Recommandations d'optimisation
- DÃ©tection d'anomalies

##### Integration Cloud Monitoring
- Dashboards prÃ©configurÃ©s
- Alertes personnalisables
- Export vers BigQuery pour analyse avancÃ©e

---

## Comparaison : Cloud SQL vs AlloyDB

### Tableau Comparatif DÃ©taillÃ©

| Aspect | Cloud SQL | AlloyDB |
|--------|-----------|---------|
| **MaturitÃ©** | Mature (2016) | Nouveau (2022) |
| **Architecture** | Traditionnelle | SÃ©paration compute/storage |
| **Performances OLTP** | Excellentes | 4Ã— supÃ©rieures |
| **Performances OLAP** | Bonnes | 100Ã— supÃ©rieures |
| **Columnar engine** | âŒ Non | âœ… Oui |
| **ML Query Optimizer** | âŒ Non | âœ… Oui |
| **HA Failover** | 30-60 secondes | 10-20 secondes |
| **Read Replicas** | 10 max | IllimitÃ© (Read Pool) |
| **Replication Lag** | Secondes | < 10 millisecondes |
| **Clone InstantanÃ©** | âŒ Non | âœ… Oui |
| **Stockage Max** | 64 TB | 64 TB |
| **Public IP** | âœ… Optionnel | âŒ Non (VPC only) |
| **PITR** | âœ… Oui | âœ… Oui (plus rapide) |
| **CompatibilitÃ© PG** | 100% | ~100% |
| **CoÃ»t (2 vCPU, 8 GB)** | ~100â‚¬/mois | ~250â‚¬/mois |
| **Cas d'usage** | 80% des apps | Apps haute performance |

### Quand Choisir Cloud SQL ?

- âœ… **Budget limitÃ©** : CoÃ»t 2-3Ã— infÃ©rieur
- âœ… **Application standard** : Performances Cloud SQL suffisantes
- âœ… **CompatibilitÃ© stricte** : 100% PostgreSQL garanti
- âœ… **Public IP nÃ©cessaire** : ConnectivitÃ© flexible
- âœ… **Workload OLTP pur** : Pas besoin d'analytique rapide
- âœ… **Ã‰quipe moins expÃ©rimentÃ©e** : Plus simple, mature, documentÃ©
- âœ… **Migration depuis PostgreSQL** : Transition directe

### Quand Choisir AlloyDB ?

- âœ… **Performances critiques** : OLTP intensif, besoin de vitesse maximale
- âœ… **HTAP** : Mix transactionnel + analytique en temps rÃ©el
- âœ… **RequÃªtes analytiques complexes** : Columnar engine essentiel
- âœ… **Scaling en lecture** : > 10 Read Replicas nÃ©cessaires
- âœ… **Failover ultra-rapide** : RTO < 20 secondes
- âœ… **Budget consÃ©quent** : ROI justifiÃ© par les performances
- âœ… **Innovation** : Profiter des derniÃ¨res technologies Google
- âœ… **Cloning frÃ©quent** : Dev/test avec donnÃ©es production-like

---

## Comparaison avec AWS et Azure

### Cloud SQL vs RDS vs Flexible Server

| Aspect | Cloud SQL | AWS RDS | Azure Flexible |
|--------|-----------|---------|----------------|
| **MaturitÃ©** | Mature | TrÃ¨s mature | Mature |
| **HA Failover** | 30-60s | 60-120s | 60-120s |
| **Read Replicas** | 10 | 5 | 5 |
| **Stockage Max** | 64 TB | 64 TB | 32 TB |
| **IOPS Max** | 60k | 256k (io2) | 80k (optimisÃ©) |
| **Public IP** | âœ… | âœ… | âœ… |
| **IAM Auth** | âœ… | âœ… | âœ… (AAD) |
| **CoÃ»t** | Similaire | Similaire | Similaire |
| **Serverless** | âŒ | âŒ | âŒ |

**RÃ©sumÃ© :** Les trois services sont trÃ¨s comparables. Le choix dÃ©pend principalement de votre Ã©cosystÃ¨me cloud.

### AlloyDB vs Aurora vs Hyperscale

| Aspect | AlloyDB | Aurora PG | Azure Hyperscale |
|--------|---------|-----------|------------------|
| **Architecture** | Compute/Storage sÃ©parÃ© | Stockage distribuÃ© | DistribuÃ© (Citus) |
| **Performances OLTP** | 4Ã— Cloud SQL | 2Ã— RDS | Variable |
| **Columnar** | âœ… Natif | âŒ Non | âŒ Non |
| **ML Optimizer** | âœ… Oui | âš ï¸ Partiel | âŒ Non |
| **Read Replicas** | IllimitÃ© | 15 | 15 |
| **Failover** | 10-20s | 15-30s | 60-120s |
| **Scaling** | Vertical + Read Pool | Vertical + Replicas | Horizontal (workers) |
| **Clone** | âœ… Instant | âœ… Instant | âŒ Non |
| **Multi-tenant** | âš ï¸ Possible | âš ï¸ Possible | âœ… Excellent |
| **CoÃ»t** | Ã‰levÃ© | Ã‰levÃ© | Variable |

**Points ClÃ©s :**
- **AlloyDB** : Meilleur pour HTAP (OLTP + OLAP mixte), columnar natif
- **Aurora** : Excellent compromis gÃ©nÃ©ral, large adoption
- **Hyperscale** : Meilleur pour true scale-out, multi-tenant SaaS

---

## Migration vers Cloud SQL ou AlloyDB

### Outils de Migration Google Cloud

#### 1. Database Migration Service (DMS)

**DMS** est l'outil principal de Google pour les migrations :

##### Fonctionnement
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Source (PostgreSQL existant)                  â”‚
â”‚    â€¢ On-premises, AWS, Azure, autre cloud        â”‚
â”‚    â€¢ Configuration CDC (Change Data Capture)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. Database Migration Service (DMS)              â”‚
â”‚    â€¢ Full dump initial                           â”‚
â”‚    â€¢ RÃ©plication continue                        â”‚
â”‚    â€¢ Monitoring du lag                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. Cible (Cloud SQL ou AlloyDB)                  â”‚
â”‚    â€¢ Synchronisation en continu                  â”‚
â”‚    â€¢ Validation des donnÃ©es                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. Cutover (Basculement)                         â”‚
â”‚    â€¢ ArrÃªt Ã©criture source                       â”‚
â”‚    â€¢ Sync finale                                 â”‚
â”‚    â€¢ Basculement application                     â”‚
â”‚    â€¢ Downtime : Minutes                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

##### Types de Migration SupportÃ©s
- **HomogÃ¨ne** : PostgreSQL â†’ Cloud SQL/AlloyDB
- **Sources supportÃ©es** :
  - PostgreSQL on-premises
  - AWS RDS PostgreSQL
  - Azure Database for PostgreSQL
  - Autres clouds

##### Modes de Migration
- **Continuous (CDC)** : RÃ©plication continue, downtime minimal
- **One-time** : Dump & restore classique

##### Avantages DMS
- Interface graphique simple
- Downtime minimal (quelques minutes)
- Validation automatique
- Monitoring intÃ©grÃ©
- Gratuit pour migrations vers GCP

#### 2. pg_dump / pg_restore

MÃ©thode traditionnelle pour petites bases :

```bash
# Export depuis source
pg_dump -h source-host -U username -d dbname \
  -Fc -f backup.dump

# Import vers Cloud SQL (via proxy)
./cloud_sql_proxy -instances=PROJECT:REGION:INSTANCE=tcp:5432 &

pg_restore -h 127.0.0.1 -p 5432 -U postgres \
  -d dbname backup.dump
```

**Cas d'usage :**
- Bases < 50 GB
- Migration simple
- Pas de contrainte de downtime strict

#### 3. RÃ©plication Logique Native

Pour contrÃ´le fin :

```sql
-- Sur source
CREATE PUBLICATION my_publication FOR ALL TABLES;

-- Sur Cloud SQL/AlloyDB (cible)
CREATE SUBSCRIPTION my_subscription
  CONNECTION 'host=source.com dbname=mydb user=repluser password=xxx'
  PUBLICATION my_publication;
```

### Migration vers AlloyDB SpÃ©cifique

#### ConsidÃ©rations AlloyDB
1. **VPC requis** : Configurer Private Services Access avant
2. **Extensions** : VÃ©rifier compatibilitÃ©
3. **Performance tuning** : Profiter du columnar engine automatiquement

#### Checklist de Migration

**Avant :**
1. âœ… Audit de compatibilitÃ© (extensions, paramÃ¨tres)
2. âœ… Dimensionnement cible (machine type)
3. âœ… Configuration VPC et networking
4. âœ… Tests sur environnement staging
5. âœ… Sauvegarde complÃ¨te source
6. âœ… Plan de rollback

**Pendant :**
1. âœ… Monitoring DMS (lag, errors)
2. âœ… Validation intÃ©gritÃ© (row counts, checksums)
3. âœ… Tests applicatifs

**AprÃ¨s :**
1. âœ… ANALYZE pour statistiques
2. âœ… Monitoring Cloud Monitoring
3. âœ… Validation des backups
4. âœ… Optimisation requÃªtes (profiter AlloyDB features)
5. âœ… Documentation architecture

---

## Tarification

### Cloud SQL for PostgreSQL

#### Composants de CoÃ»t

1. **Instance (Compute)** : FacturÃ© Ã  l'heure
2. **Stockage** : GB/mois
3. **Backup** : > 100% taille DB
4. **RÃ©seau** : Egress (sortie)
5. **HA** : 2Ã— compute si activÃ©

#### Exemples de Tarification (europe-west1)

**DÃ©veloppement (db-g1-small, 20 GB SSD, pas HA) :**
```
Compute :    ~25â‚¬/mois
Stockage :   ~4â‚¬/mois (20 GB Ã— 0,20â‚¬/GB)
Total :      ~29â‚¬/mois
```

**Production Petite (n1-standard-2, 100 GB SSD, HA) :**
```
Compute :    ~100â‚¬/mois Ã— 2 (HA)  = 200â‚¬
Stockage :   ~20â‚¬/mois (100 GB)   = 20â‚¬
Total :      ~220â‚¬/mois
```

**Production Moyenne (n1-highmem-4, 500 GB SSD, HA) :**
```
Compute :    ~350â‚¬/mois Ã— 2 (HA)  = 700â‚¬
Stockage :   ~100â‚¬/mois (500 GB)  = 100â‚¬
Total :      ~800â‚¬/mois
```

### AlloyDB for PostgreSQL

#### Composants de CoÃ»t

1. **Primary Instance** : FacturÃ© Ã  l'heure (HA incluse)
2. **Read Pool Instances** : Par instance
3. **Stockage** : GB/mois (auto-scaling)
4. **Backup** : GB/mois stockÃ©
5. **RÃ©seau** : Egress

#### Exemples de Tarification (europe-west1)

**Production Standard (2 vCPU, 16 GB, 100 GB stockage) :**
```
Primary Instance :    ~300â‚¬/mois (HA incluse)
Stockage :            ~15â‚¬/mois (100 GB Ã— 0,15â‚¬/GB)
Total :               ~315â‚¬/mois
```

**Production + Read Pool (Primary + 2 Read Instances) :**
```
Primary (2 vCPU) :    ~300â‚¬/mois
Read Instance 1 :     ~300â‚¬/mois
Read Instance 2 :     ~300â‚¬/mois
Stockage (partagÃ©) :  ~15â‚¬/mois
Total :               ~915â‚¬/mois
```

**Production Intensive (8 vCPU, 64 GB, 1 TB stockage) :**
```
Primary Instance :    ~1200â‚¬/mois
Stockage :            ~150â‚¬/mois (1 TB)
Total :               ~1350â‚¬/mois
```

### Optimisation des CoÃ»ts

#### Cloud SQL
1. **Committed Use Discounts (CUD)** : -20% Ã  -30% (1 an), -40% Ã  -60% (3 ans)
2. **ArrÃªt automatique** : Dev/test (Ã©conomise compute)
3. **HDD au lieu de SSD** : Pour donnÃ©es froides
4. **Sizing appropriÃ©** : Ã‰viter le sur-provisionnement

#### AlloyDB
1. **Committed Use Discounts** : Applicables
2. **Read Pool optimisÃ©** : Ajouter seulement si nÃ©cessaire
3. **Monitoring** : Identifier sous-utilisation

#### GÃ©nÃ©ral
1. **RÃ©gion** : Certaines rÃ©gions moins chÃ¨res
2. **Cleanup** : Supprimer instances inutilisÃ©es
3. **Reserved IPs** : LibÃ©rer IPs non utilisÃ©es (petits frais)

---

## Outils et IntÃ©gration GCP

### Google Cloud Console
- Interface web intuitive
- CrÃ©ation, modification, monitoring

### gcloud CLI
```bash
# CrÃ©er une instance Cloud SQL
gcloud sql instances create my-instance \
  --database-version=POSTGRES_16 \
  --tier=db-n1-standard-2 \
  --region=europe-west1 \
  --availability-type=REGIONAL

# CrÃ©er un cluster AlloyDB
gcloud alloydb clusters create my-cluster \
  --region=europe-west1 \
  --password=secure-password

gcloud alloydb instances create my-primary \
  --cluster=my-cluster \
  --region=europe-west1 \
  --instance-type=PRIMARY \
  --cpu-count=2
```

### Terraform (IaC)
```hcl
# Cloud SQL
resource "google_sql_database_instance" "main" {
  name             = "my-instance"
  database_version = "POSTGRES_16"
  region           = "europe-west1"

  settings {
    tier              = "db-n1-standard-2"
    availability_type = "REGIONAL"

    backup_configuration {
      enabled = true
      start_time = "03:00"
    }
  }
}

# AlloyDB
resource "google_alloydb_cluster" "main" {
  cluster_id = "my-cluster"
  location   = "europe-west1"
  network    = google_compute_network.default.id
}
```

### IntÃ©gration Services GCP

#### Google Kubernetes Engine (GKE)
- Connexion via Private IP
- Cloud SQL Proxy sidecar
- Workload Identity pour authentification

#### Cloud Functions / Cloud Run
- Serverless + Cloud SQL/AlloyDB
- Cloud SQL connections intÃ©grÃ©es
- Scaling automatique

#### BigQuery
- Export/import facilitÃ©
- Federated queries vers Cloud SQL
- ETL via Cloud Data Fusion

#### Dataflow / Dataproc
- Pipelines de donnÃ©es
- Connexion native
- Traitement distribuÃ©

---

## Bonnes Pratiques GCP

### SÃ©curitÃ©

1. âœ… **Private IP obligatoire** pour production
2. âœ… **IAM Database Authentication** (Ã©viter mots de passe)
3. âœ… **Cloud KMS** pour chiffrement CMEK
4. âœ… **VPC Service Controls** pour isolation pÃ©rimÃ¨tre
5. âœ… **Audit Logs activÃ©s** : Cloud Logging
6. âœ… **Least privilege** : IAM roles granulaires
7. âœ… **Secrets Manager** : Stocker credentials

### Performance

1. âœ… **pg_stat_statements** : Monitoring requÃªtes
2. âœ… **Query Insights** : Identifier lenteurs
3. âœ… **Indexes appropriÃ©s** : Analyser plans d'exÃ©cution
4. âœ… **Connection pooling** : PgBouncer ou proxy
5. âœ… **Read Replicas** : DÃ©charger lectures
6. âœ… **AlloyDB pour HTAP** : Si analytique + transactionnel
7. âœ… **Flags optimisÃ©s** : Adapter Ã  workload

### Haute DisponibilitÃ©

1. âœ… **HA activÃ©e** : Regional (Cloud SQL) ou default (AlloyDB)
2. âœ… **Cross-region replicas** : Pour DR
3. âœ… **Automated backups** : RÃ©tention 14-35 jours
4. âœ… **Tests de failover** : Valider rÃ©guliÃ¨rement
5. âœ… **Monitoring actif** : Alertes sur mÃ©triques
6. âœ… **Runbooks** : ProcÃ©dures d'urgence documentÃ©es

### CoÃ»ts

1. âœ… **Committed Use Discounts** : Production long terme
2. âœ… **Labels** : Tracking coÃ»ts par projet/env
3. âœ… **Budgets & Alertes** : DÃ©tection dÃ©passements
4. âœ… **ArrÃªt dev/test** : Hors horaires
5. âœ… **Rightsizing** : Recommandations GCP
6. âœ… **Storage cleanup** : Purger donnÃ©es obsolÃ¨tes

---

## Conclusion

Google Cloud propose deux excellentes options pour PostgreSQL, chacune avec ses forces :

### RÃ©sumÃ© Cloud SQL

- âœ… **Service mature et fiable** (2016)
- âœ… **100% compatible PostgreSQL**
- âœ… **CoÃ»t prÃ©visible** et raisonnable
- âœ… **SimplicitÃ© d'utilisation**
- âœ… **Public IP optionnel** (flexibilitÃ©)
- âœ… **Excellent pour 80% des applications**

### RÃ©sumÃ© AlloyDB

- âœ… **Performances exceptionnelles** (4Ã— OLTP, 100Ã— OLAP)
- âœ… **Columnar engine** unique pour analytique
- âœ… **ML Query Optimizer** intelligent
- âœ… **Scaling illimitÃ©** en lecture (Read Pool)
- âœ… **Clone instantanÃ©** pour dev/test
- âœ… **Failover ultra-rapide** (10-20s)
- âš ï¸ ~100% compatible PostgreSQL
- âš ï¸ CoÃ»t 2-3Ã— supÃ©rieur Ã  Cloud SQL
- âš ï¸ VPC obligatoire

### Recommandation GÃ©nÃ©rale

**Commencez avec Cloud SQL si :**
- Vous migrez depuis PostgreSQL
- Budget est une contrainte importante
- Performances Cloud SQL suffisent
- Besoin de Public IP

**Passez Ã  AlloyDB si :**
- Performances critiques (OLTP intensif)
- Mix OLTP + analytique (HTAP)
- Besoin de > 10 Read Replicas
- Budget permet investissement
- Failover < 20s requis

### Comparaison avec AWS et Azure

**Cloud SQL â‰ˆ RDS â‰ˆ Azure Flexible Server**
- Services trÃ¨s comparables
- Choix basÃ© sur Ã©cosystÃ¨me cloud existant

**AlloyDB vs Aurora vs Hyperscale**
- **AlloyDB** : Meilleur pour HTAP (columnar natif)
- **Aurora** : Excellent compromis gÃ©nÃ©ral
- **Hyperscale** : Meilleur pour scale-out horizontal

**Innovation Google :**
AlloyDB reprÃ©sente une approche unique avec son columnar engine natif, ce qui le diffÃ©rencie clairement d'Aurora. C'est un pari sur l'avenir du HTAP (Hybrid Transactional/Analytical Processing).

---

**Prochaine section du tutoriel :**
- 19.2.4. Managed vs Self-Hosted : Trade-offs

â­ï¸ [Managed vs Self-Hosted : Trade-offs](/19-postgresql-en-production/02.4-managed-vs-self-hosted.md)
