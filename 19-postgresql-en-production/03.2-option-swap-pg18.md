ğŸ” Retour au [Sommaire](/SOMMAIRE.md)

# 19.3.2. NouveautÃ© PG 18 : Option --swap pour upgrade rapide

## Introduction

PostgreSQL 18 introduit une nouvelle option rÃ©volutionnaire pour `pg_upgrade` : **l'option `--swap`**. Cette fonctionnalitÃ© permet d'effectuer des mises Ã  jour majeures encore plus rapidement en optimisant la maniÃ¨re dont les fichiers de donnÃ©es sont gÃ©rÃ©s pendant la migration.

## Rappel : Comment fonctionne pg_upgrade ?

Avant d'aborder l'option `--swap`, il est important de comprendre les modes de fonctionnement traditionnels de `pg_upgrade`.

### Les deux modes classiques

#### 1. Mode --copy (copie physique)

Le mode par dÃ©faut de `pg_upgrade` copie physiquement tous les fichiers de donnÃ©es de l'ancien cluster vers le nouveau.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Mode --copy (Copie physique)                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  Ancien Cluster (PG 17)          Nouveau Cluster (PG 18)    â”‚
â”‚  /var/lib/postgresql/17/         /var/lib/postgresql/18/    â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚ Table A  â”‚  â”€â”€â”€â”€â”€â”€ copie â”€â”€â”€â†’ â”‚ Table A  â”‚               â”‚
â”‚  â”‚ 10 GB    â”‚                    â”‚ 10 GB    â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚ Table B  â”‚  â”€â”€â”€â”€â”€â”€ copie â”€â”€â”€â†’ â”‚ Table B  â”‚               â”‚
â”‚  â”‚ 5 GB     â”‚                    â”‚ 5 GB     â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                                                             â”‚
â”‚  Total espace requis : Ancien (15 GB) + Nouveau (15 GB)     â”‚
â”‚                       = 30 GB                               â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**CaractÃ©ristiques** :
- âœ… **SÃ©curisÃ©** : L'ancien cluster reste intact
- âœ… **Rollback facile** : PossibilitÃ© de revenir en arriÃ¨re
- âŒ **Lent** : Copie physique = temps proportionnel Ã  la taille
- âŒ **Gourmand en espace** : NÃ©cessite 2Ã— la taille de la base

**Temps estimÃ©** :
- Base 100 GB : ~30-60 minutes
- Base 1 TB : ~5-10 heures
- Base 10 TB : ~50-100 heures

#### 2. Mode --link (liens physiques)

Le mode `--link` utilise des liens physiques (hardlinks) au lieu de copier les fichiers.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Mode --link (Liens physiques)                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  Ancien Cluster (PG 17)          Nouveau Cluster (PG 18)    â”‚
â”‚  /var/lib/postgresql/17/         /var/lib/postgresql/18/    â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚ Table A  â”‚  â”€â”€â”€â”€â”€â”€ link â”€â”€â”€â”€â†’ â”‚ Table A  â”‚ (mÃªme inode)  â”‚
â”‚  â”‚ 10 GB    â”‚         (ptr)      â”‚ 0 GB !   â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                                                             â”‚
â”‚  Les deux pointent vers les MÃŠMES donnÃ©es physiques         â”‚
â”‚                                                             â”‚
â”‚  Total espace requis : 15 GB (pas de duplication !)         â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**CaractÃ©ristiques** :
- âœ… **TrÃ¨s rapide** : Pas de copie physique
- âœ… **Ã‰conome en espace** : Pas de duplication des donnÃ©es
- âš ï¸ **Partage de donnÃ©es** : Les deux clusters partagent les mÃªmes fichiers
- âŒ **Pas de rollback** : Supprimer un cluster supprime les donnÃ©es des deux
- âŒ **MÃªme filesystem requis** : Les deux clusters doivent Ãªtre sur le mÃªme systÃ¨me de fichiers

**Temps estimÃ©** :
- Base 100 GB : ~5-10 minutes
- Base 1 TB : ~15-30 minutes
- Base 10 TB : ~30-60 minutes

### Qu'est-ce qu'un lien physique (hardlink) ?

Un lien physique est une fonctionnalitÃ© du systÃ¨me de fichiers Unix/Linux qui permet Ã  plusieurs noms de fichiers de pointer vers les mÃªmes donnÃ©es physiques sur le disque.

#### Analogie simple

Imaginez une bibliothÃ¨que :

**Sans hardlink (copie)** :
- Livre "PostgreSQL Guide" existe en section A
- Si vous voulez le mÃªme livre en section B, vous devez acheter un second exemplaire
- RÃ©sultat : 2 livres physiques, coÃ»t double, espace double

**Avec hardlink** :
- Livre "PostgreSQL Guide" existe physiquement une seule fois
- Vous crÃ©ez une fiche de rÃ©fÃ©rence en section A : "Le livre est sur l'Ã©tagÃ¨re #42"
- Vous crÃ©ez une autre fiche en section B : "Le livre est sur l'Ã©tagÃ¨re #42"
- RÃ©sultat : 1 seul livre physique, 2 rÃ©fÃ©rences, mÃªme livre partagÃ©

#### Exemple technique

```bash
# Fichier original
/var/lib/postgresql/17/base/16384/12345
Taille : 1 GB
Inode : 8762341

# Avec --link, pg_upgrade crÃ©e :
/var/lib/postgresql/18/base/16384/12345
Taille : 1 GB (apparente, mais...)
Inode : 8762341 (le mÃªme !)

# VÃ©rification
ls -li /var/lib/postgresql/17/base/16384/12345
# 8762341 -rw------- 2 postgres postgres 1073741824 Nov 23 10:00 12345
#         ^
#         Nombre de liens : 2 (deux noms pointent vers ces donnÃ©es)

du -sh /var/lib/postgresql/17/ /var/lib/postgresql/18/
# 100G    /var/lib/postgresql/17/
# 100G    /var/lib/postgresql/18/
# MAIS l'espace total utilisÃ© est seulement 100G, pas 200G !
```

### Le problÃ¨me avec --link

Bien que `--link` soit rapide et Ã©conome, il prÃ©sente un risque majeur :

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ScÃ©nario de risque avec --link                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  1. Migration avec --link rÃ©ussie                           â”‚
â”‚     PG 17 â”€â”€linkâ”€â”€â†’ PG 18 âœ…                                â”‚
â”‚                                                             â”‚
â”‚  2. DÃ©marrage de PG 18, tests, tout fonctionne              â”‚
â”‚     PG 18 en production âœ…                                  â”‚
â”‚                                                             â”‚
â”‚  3. MAIS : ProblÃ¨me dÃ©couvert 2 heures aprÃ¨s !              â”‚
â”‚     Bug applicatif, incompatibilitÃ©, erreur...              â”‚
â”‚                                                             â”‚
â”‚  4. Tentative de rollback vers PG 17                        â”‚
â”‚     âŒ IMPOSSIBLE !                                         â”‚
â”‚                                                             â”‚
â”‚  Pourquoi ? Les donnÃ©es ont Ã©tÃ© modifiÃ©es par PG 18         â”‚
â”‚  Les hardlinks pointent vers les donnÃ©es modifiÃ©es          â”‚
â”‚  PG 17 ne peut plus les lire (format incompatible)          â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**En rÃ©sumÃ©** :
- `--copy` : SÃ»r mais lent et gourmand
- `--link` : Rapide et Ã©conome mais sans filet de sÃ©curitÃ©

## La rÃ©volution --swap dans PostgreSQL 18

### Concept et motivation

L'option `--swap` combine le meilleur des deux mondes :
- âš¡ La **rapiditÃ©** de `--link`
- ğŸ”’ La **sÃ©curitÃ©** de `--copy`

### Comment Ã§a fonctionne ?

Le mode `--swap` utilise une technique ingÃ©nieuse appelÃ©e **Ã©change de rÃ©pertoires**.

#### Principe de base

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Mode --swap (Ã‰change de rÃ©pertoires)                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  AVANT migration :                                          â”‚
â”‚                                                             â”‚
â”‚  /var/lib/postgresql/17/main  â† Cluster actif (donnÃ©es)     â”‚
â”‚  /var/lib/postgresql/18/main  â† Nouveau cluster (vide)      â”‚
â”‚                                                             â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                             â”‚
â”‚  PENDANT migration avec --swap :                            â”‚
â”‚                                                             â”‚
â”‚  Ã‰tape 1 : CrÃ©ation liens dans rÃ©pertoire temporaire        â”‚
â”‚  /var/lib/postgresql/.pg_upgrade_tmp/                       â”‚
â”‚    â”œâ”€â”€ old_data/ (liens vers donnÃ©es PG 17)                 â”‚
â”‚    â””â”€â”€ new_structure/ (structure PG 18)                     â”‚
â”‚                                                             â”‚
â”‚  Ã‰tape 2 : Validation et prÃ©paration                        â”‚
â”‚                                                             â”‚
â”‚  Ã‰tape 3 : SWAP ATOMIQUE                                    â”‚
â”‚  /var/lib/postgresql/17/main  â†”  /var/lib/postgresql/.old   â”‚
â”‚  /var/lib/postgresql/18/main  â†  donnÃ©es PG 18              â”‚
â”‚                                                             â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                             â”‚
â”‚  APRÃˆS migration :                                          â”‚
â”‚                                                             â”‚
â”‚  /var/lib/postgresql/17/main  â† Ancien (sauvegardÃ©)         â”‚
â”‚  /var/lib/postgresql/18/main  â† Nouveau cluster actif       â”‚
â”‚  /var/lib/postgresql/.old     â† Backup automatique          â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Les Ã©tapes dÃ©taillÃ©es

**Phase 1 : PrÃ©paration (similaire Ã  --link)**

```bash
# pg_upgrade crÃ©e un environnement temporaire
mkdir /var/lib/postgresql/.pg_upgrade_tmp/

# CrÃ©e des liens vers les donnÃ©es existantes
# (comme --link, mais dans un espace isolÃ©)
```

**Phase 2 : Migration de la structure**

```bash
# Migre le schÃ©ma, les mÃ©tadonnÃ©es, les statistiques
# PrÃ©pare la nouvelle structure PG 18
# Mais les DONNÃ‰ES restent dans l'ancien cluster
```

**Phase 3 : L'Ã©change atomique (le "swap")**

```bash
# OpÃ©ration ATOMIQUE au niveau du systÃ¨me de fichiers
# Renommage ultra-rapide des rÃ©pertoires

mv /var/lib/postgresql/17/main /var/lib/postgresql/.old_backup
mv /var/lib/postgresql/.pg_upgrade_tmp/new /var/lib/postgresql/18/main

# DurÃ©e : quelques millisecondes, quelle que soit la taille !
```

### Pourquoi c'est rÃ©volutionnaire ?

#### 1. RapiditÃ©

Le swap est une opÃ©ration de **renommage de rÃ©pertoire**, qui est :
- âš¡ **Quasi-instantanÃ©e** : Ne dÃ©pend PAS de la taille des donnÃ©es
- ğŸ¯ **OpÃ©ration atomique** : Tout rÃ©ussit ou tout Ã©choue, pas d'Ã©tat intermÃ©diaire

```
Temps de swap :
- 1 GB    : ~10 millisecondes
- 100 GB  : ~10 millisecondes
- 10 TB   : ~10 millisecondes

Oui, vous avez bien lu : le temps est constant !
```

#### 2. SÃ©curitÃ©

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  StratÃ©gie de rollback avec --swap                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  Situation : Migration rÃ©ussie, mais problÃ¨me en prod       â”‚
â”‚                                                             â”‚
â”‚  /var/lib/postgresql/18/main  â† PG 18 actif (problÃ¨me)      â”‚
â”‚  /var/lib/postgresql/.old     â† PG 17 intact ! âœ…           â”‚
â”‚                                                             â”‚
â”‚  Rollback (en quelques secondes) :                          â”‚
â”‚                                                             â”‚
â”‚  1. ArrÃªter PG 18                                           â”‚
â”‚     pg_ctl stop -D /var/lib/postgresql/18/main              â”‚
â”‚                                                             â”‚
â”‚  2. Swap inverse                                            â”‚
â”‚     mv /var/lib/postgresql/18/main /var/lib/.failed_18      â”‚
â”‚     mv /var/lib/postgresql/.old /var/lib/postgresql/17/...  â”‚
â”‚                                                             â”‚
â”‚  3. RedÃ©marrer PG 17                                        â”‚
â”‚     pg_ctl start -D /var/lib/postgresql/17/main             â”‚
â”‚                                                             â”‚
â”‚  DurÃ©e totale : < 1 minute                                  â”‚
â”‚  Perte de donnÃ©es : AUCUNE                                  â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 3. EfficacitÃ© d'espace

Contrairement Ã  `--copy`, `--swap` n'a pas besoin de dupliquer toutes les donnÃ©es :

```
Espace disque requis :

--copy : Ancien (1 TB) + Nouveau (1 TB) = 2 TB
--swap : Ancien (1 TB) + Overhead (~10 GB) = 1.01 TB
```

## Comparaison des trois modes

### Tableau rÃ©capitulatif

| CritÃ¨re | --copy | --link | --swap (PG 18) |
|---------|--------|--------|----------------|
| **Vitesse migration** | ğŸŒ Lent | âš¡ TrÃ¨s rapide | âš¡âš¡ Ultra-rapide |
| **Espace disque** | âŒ 2Ã— taille | âœ… 1Ã— taille | âœ… ~1Ã— taille |
| **Rollback possible** | âœ… Oui | âŒ Non | âœ… Oui |
| **SÃ©curitÃ© donnÃ©es** | âœ… Excellente | âš ï¸ RisquÃ© | âœ… Excellente |
| **ComplexitÃ©** | ğŸŸ¢ Simple | ğŸŸ¡ Moyenne | ğŸŸ¡ Moyenne |
| **PrÃ©requis filesystem** | Aucun | MÃªme FS | MÃªme FS |
| **RecommandÃ© pour prod** | âœ… Oui | âš ï¸ Avec prÃ©caution | âœ…âœ… Fortement |

### Comparaison dÃ©taillÃ©e des temps

#### ScÃ©nario 1 : Base de 100 GB

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Base 100 GB - 500 tables                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  --copy :                                                   â”‚
â”‚  â”œâ”€ Copie des donnÃ©es : 25 min                              â”‚
â”‚  â”œâ”€ Migration schÃ©ma : 5 min                                â”‚
â”‚  â””â”€ Total : ~30 minutes                                     â”‚
â”‚                                                             â”‚
â”‚  --link :                                                   â”‚
â”‚  â”œâ”€ CrÃ©ation liens : 2 min                                  â”‚
â”‚  â”œâ”€ Migration schÃ©ma : 5 min                                â”‚
â”‚  â””â”€ Total : ~7 minutes                                      â”‚
â”‚                                                             â”‚
â”‚  --swap (PG 18) :                                           â”‚
â”‚  â”œâ”€ PrÃ©paration : 3 min                                     â”‚
â”‚  â”œâ”€ Migration schÃ©ma : 5 min                                â”‚
â”‚  â”œâ”€ Swap atomique : 0.01 sec âš¡                             â”‚
â”‚  â””â”€ Total : ~8 minutes                                      â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### ScÃ©nario 2 : Base de 2 TB

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Base 2 TB - 5000 tables                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  --copy :                                                   â”‚
â”‚  â”œâ”€ Copie des donnÃ©es : 8 heures                            â”‚
â”‚  â”œâ”€ Migration schÃ©ma : 30 min                               â”‚
â”‚  â””â”€ Total : ~8.5 heures                                     â”‚
â”‚                                                             â”‚
â”‚  --link :                                                   â”‚
â”‚  â”œâ”€ CrÃ©ation liens : 15 min                                 â”‚
â”‚  â”œâ”€ Migration schÃ©ma : 30 min                               â”‚
â”‚  â””â”€ Total : ~45 minutes                                     â”‚
â”‚                                                             â”‚
â”‚  --swap (PG 18) :                                           â”‚
â”‚  â”œâ”€ PrÃ©paration : 20 min                                    â”‚
â”‚  â”œâ”€ Migration schÃ©ma : 30 min                               â”‚
â”‚  â”œâ”€ Swap atomique : 0.01 sec âš¡                             â”‚
â”‚  â””â”€ Total : ~50 minutes                                     â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Graphique des temps de migration

```
Temps de migration (Ã©chelle logarithmique)

10h  â”¤
     â”‚  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ                           --copy
 5h  â”¤  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
     â”‚  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
 1h  â”¤  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  â–“â–“                       --link / --swap
     â”‚  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  â–“â–“
30m  â”¤  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  â–“â–“
     â”‚  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  â–“â–“
10m  â”¤  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  â–“â–“
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        100GB    2TB    Taille base
```

## Utilisation pratique de --swap

### Syntaxe de la commande

```bash
pg_upgrade \
  --old-datadir=/var/lib/postgresql/17/main \
  --new-datadir=/var/lib/postgresql/18/main \
  --old-bindir=/usr/lib/postgresql/17/bin \
  --new-bindir=/usr/lib/postgresql/18/bin \
  --swap  # â† La nouvelle option !
```

### PrÃ©requis et vÃ©rifications

#### 1. VÃ©rifier le systÃ¨me de fichiers

Le mode `--swap` nÃ©cessite que les deux clusters soient sur le **mÃªme systÃ¨me de fichiers** (comme `--link`).

```bash
# VÃ©rifier que les deux rÃ©pertoires sont sur le mÃªme filesystem
df /var/lib/postgresql/17/main /var/lib/postgresql/18/main

# Sortie attendue :
# Filesystem     1K-blocks      Used Available Use% Mounted on
# /dev/sda1      976762584 104857600 871904984  11% /var/lib/postgresql

# Si les deux lignes montrent le mÃªme "Filesystem" et "Mounted on" â†’ OK âœ…
```

#### 2. VÃ©rifier l'espace disque

```bash
# VÃ©rifier l'espace disponible
# Besoin d'environ 10-15% d'espace supplÃ©mentaire pour les mÃ©tadonnÃ©es

# Taille de l'ancien cluster
du -sh /var/lib/postgresql/17/main
# 1.2T

# Espace disponible
df -h /var/lib/postgresql/
# Available: 200G â†’ OK âœ… (> 15% de 1.2T)
```

#### 3. Mode vÃ©rification d'abord

**TOUJOURS** lancer avec `--check` avant la migration rÃ©elle :

```bash
pg_upgrade \
  --old-datadir=/var/lib/postgresql/17/main \
  --new-datadir=/var/lib/postgresql/18/main \
  --old-bindir=/usr/lib/postgresql/17/bin \
  --new-bindir=/usr/lib/postgresql/18/bin \
  --swap \
  --check  # â† Mode test, pas de modification

# Sortie attendue :
# Performing Consistency Checks
# -----------------------------
# Checking cluster versions                                  ok
# Checking database user is the install user                 ok
# Checking database connection settings                      ok
# Checking for prepared transactions                         ok
# Checking for system-defined composite types                ok
# Checking for reg* data types                               ok
# Checking for contrib/isn with bigint-passing mismatch      ok
# Checking for swap capability                               ok â† Nouveau !
#
# Swap mode is compatible with your filesystem setup
#
# *Clusters are compatible*
```

### ProcÃ©dure complÃ¨te de migration avec --swap

#### Ã‰tape 1 : PrÃ©paration (1 jour avant)

```bash
# 1. Sauvegarder l'ancien cluster (CRUCIAL !)
pg_basebackup -D /backup/pg17_before_upgrade -Fp -Xs -P

# 2. Mettre Ã  jour les statistiques
psql -d ma_base -c "ANALYZE VERBOSE;"

# 3. Installer PostgreSQL 18
apt-get install postgresql-18

# 4. Initialiser le nouveau cluster
initdb -D /var/lib/postgresql/18/main
```

#### Ã‰tape 2 : VÃ©rification (30 minutes avant)

```bash
# 1. ArrÃªter les applications
# (Plus de connexions Ã  la base)

# 2. ArrÃªter PostgreSQL 17
pg_ctl stop -D /var/lib/postgresql/17/main

# 3. Test Ã  blanc avec --check
pg_upgrade \
  --old-datadir=/var/lib/postgresql/17/main \
  --new-datadir=/var/lib/postgresql/18/main \
  --old-bindir=/usr/lib/postgresql/17/bin \
  --new-bindir=/usr/lib/postgresql/18/bin \
  --swap \
  --check

# 4. VÃ©rifier les logs
cat pg_upgrade_internal.log
```

#### Ã‰tape 3 : Migration (fenÃªtre de maintenance)

```bash
# 1. Lancer la migration rÃ©elle
pg_upgrade \
  --old-datadir=/var/lib/postgresql/17/main \
  --new-datadir=/var/lib/postgresql/18/main \
  --old-bindir=/usr/lib/postgresql/17/bin \
  --new-bindir=/usr/lib/postgresql/18/bin \
  --swap \
  --verbose  # Pour voir la progression

# Sortie :
# Performing Upgrade
# ------------------
# Analyzing all rows in the new cluster                      ok
# Freezing all rows in the new cluster                       ok
# Deleting files from new pg_xact                            ok
# Copying old pg_xact to new server                          ok
# Setting oldest XID for new cluster                         ok
# Setting next transaction ID and epoch for new cluster      ok
# Deleting files from new pg_multixact/offsets               ok
# Copying old pg_multixact/offsets to new server             ok
# ...
# Performing atomic swap of data directories                 ok â† Nouveau !
# Creating script to delete old cluster                      ok
#
# Upgrade Complete
# ----------------
# Optimizer statistics are preserved                          â† PG 18
# Old cluster data is preserved in .old directory             â† --swap
```

#### Ã‰tape 4 : Post-migration

```bash
# 1. DÃ©marrer PostgreSQL 18
pg_ctl start -D /var/lib/postgresql/18/main

# 2. VÃ©rifier que le cluster fonctionne
psql -d ma_base -c "SELECT version();"
# PostgreSQL 18.0 ... âœ…

# 3. Tests de validation
# - Connexions
# - Quelques requÃªtes critiques
# - VÃ©rifier les performances

# 4. Si tout est OK, nettoyer l'ancien cluster (plus tard)
# NE PAS supprimer immÃ©diatement ! Garder 1-2 semaines
# ./delete_old_cluster.sh  (script gÃ©nÃ©rÃ© par pg_upgrade)
```

### Script de rollback (si nÃ©cessaire)

En cas de problÃ¨me avec le nouveau cluster, le rollback avec `--swap` est simple :

```bash
#!/bin/bash
# rollback_pg18_to_pg17.sh

echo "ğŸ”„ Rollback de PostgreSQL 18 vers PostgreSQL 17"

# 1. ArrÃªter PG 18
echo "ArrÃªt de PostgreSQL 18..."
pg_ctl stop -D /var/lib/postgresql/18/main -m fast

# 2. Sauvegarder le cluster PG 18 (au cas oÃ¹)
echo "Sauvegarde du cluster PG 18 Ã©chouÃ©..."
mv /var/lib/postgresql/18/main /var/lib/postgresql/18/main.failed

# 3. Restaurer l'ancien cluster depuis .old
echo "Restauration de PostgreSQL 17..."
mv /var/lib/postgresql/.old /var/lib/postgresql/17/main

# 4. RedÃ©marrer PG 17
echo "RedÃ©marrage de PostgreSQL 17..."
pg_ctl start -D /var/lib/postgresql/17/main

# 5. VÃ©rification
echo "VÃ©rification..."
psql -d ma_base -c "SELECT version();"

echo "âœ… Rollback terminÃ©. PostgreSQL 17 est de retour en production."
```

**Temps de rollback** : < 2 minutes
**Perte de donnÃ©es** : Aucune (les modifications PG 18 sont isolÃ©es)

## Cas d'usage et recommandations

### Quand utiliser --swap ?

#### âœ… Cas idÃ©aux pour --swap

1. **Bases de production critiques**
   - Besoin d'un rollback rapide possible
   - Contraintes de downtime strictes
   - Taille importante (> 100 GB)

2. **Environnements avec haute disponibilitÃ©**
   - RÃ©plication en place
   - Besoin de minimiser le risque

3. **Migrations planifiÃ©es avec fenÃªtre de maintenance**
   - FenÃªtre de 2-4 heures
   - ProcÃ©dure de rollback documentÃ©e
   - Tests prÃ©alables effectuÃ©s

4. **PremiÃ¨res migrations PG 18**
   - Ã‰quipe dÃ©couvre PG 18
   - PrÃ©fÃ©rence pour la prudence
   - PossibilitÃ© de revenir en arriÃ¨re rassurante

#### âš ï¸ Cas oÃ¹ --copy peut Ãªtre prÃ©fÃ©rable

1. **DiffÃ©rents systÃ¨mes de fichiers**
   - Ancien cluster sur /mnt/old
   - Nouveau cluster sur /mnt/new (diffÃ©rent FS)
   - `--swap` n'est pas compatible

2. **RÃ©organisation des donnÃ©es souhaitÃ©e**
   - PrÃ©sence de bloat important
   - VolontÃ© de "nettoyer" la base
   - `--copy` permet une rÃ©organisation complÃ¨te

3. **Espace disque abondant**
   - Si espace non limitÃ©
   - PrÃ©fÃ©rence pour une copie totalement indÃ©pendante

### Recommandations par taille de base

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Recommandations selon la taille                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  < 10 GB (petite base)                                      â”‚
â”‚  â†’ --copy ou --swap (peu de diffÃ©rence)                     â”‚
â”‚  Downtime : 10-15 minutes dans les deux cas                 â”‚
â”‚                                                             â”‚
â”‚  10-100 GB (moyenne base)                                   â”‚
â”‚  â†’ --swap recommandÃ©                                        â”‚
â”‚  Gain : ~20 minutes vs --copy                               â”‚
â”‚  SÃ©curitÃ© : rollback possible                               â”‚
â”‚                                                             â”‚
â”‚  100 GB - 1 TB (grosse base)                                â”‚
â”‚  â†’ --swap fortement recommandÃ©                              â”‚
â”‚  Gain : 1-3 heures vs --copy                                â”‚
â”‚  Risque minimisÃ© pour production                            â”‚
â”‚                                                             â”‚
â”‚  > 1 TB (trÃ¨s grosse base)                                  â”‚
â”‚  â†’ --swap OBLIGATOIRE pour production                       â”‚
â”‚  --copy peut nÃ©cessiter 10+ heures                          â”‚
â”‚  --swap : ~1 heure maximum                                  â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Checklist de migration avec --swap

#### Avant migration (J-7 Ã  J-1)

- [ ] VÃ©rifier que les deux clusters sont sur le mÃªme filesystem
- [ ] Calculer l'espace disque nÃ©cessaire (ancien + 15%)
- [ ] Installer PostgreSQL 18
- [ ] Lire les release notes de PG 18
- [ ] Tester la migration sur environnement de DEV/STAGING
- [ ] Documenter la procÃ©dure de rollback
- [ ] PrÃ©parer les scripts de validation

#### Avant migration (J-Day, H-1)

- [ ] Informer les utilisateurs du downtime
- [ ] Sauvegarder l'ancien cluster (pg_basebackup)
- [ ] Lancer ANALYZE VERBOSE complet
- [ ] VÃ©rifier l'Ã©tat des rÃ©plicas (si existants)
- [ ] PrÃ©parer le monitoring

#### Pendant migration (FenÃªtre de maintenance)

- [ ] ArrÃªter les applications
- [ ] VÃ©rifier que plus aucune connexion active
- [ ] ArrÃªter PostgreSQL 17
- [ ] Lancer pg_upgrade --check avec --swap
- [ ] VÃ©rifier les logs du --check
- [ ] Si OK, lancer pg_upgrade rÃ©el avec --swap
- [ ] Surveiller les logs en temps rÃ©el

#### AprÃ¨s migration (H+1 Ã  H+4)

- [ ] DÃ©marrer PostgreSQL 18
- [ ] VÃ©rifier la version (SELECT version())
- [ ] Tests de connexion basiques
- [ ] ExÃ©cuter les requÃªtes de validation
- [ ] Comparer les plans d'exÃ©cution (EXPLAIN)
- [ ] Monitorer les performances
- [ ] VÃ©rifier les logs d'erreurs
- [ ] Informer les utilisateurs que le service est rÃ©tabli

#### AprÃ¨s migration (J+1 Ã  J+7)

- [ ] Surveiller les performances quotidiennement
- [ ] VÃ©rifier les logs quotidiennement
- [ ] Comparer les mÃ©triques avec PG 17
- [ ] Tester les fonctionnalitÃ©s critiques
- [ ] Valider le bon fonctionnement global

#### AprÃ¨s migration (J+7 Ã  J+30)

- [ ] Si tout est stable, archiver l'ancien cluster
- [ ] Documenter les diffÃ©rences observÃ©es PG17â†’PG18
- [ ] Nettoyer le rÃ©pertoire .old (aprÃ¨s validation finale)
- [ ] Mettre Ã  jour la documentation systÃ¨me

## Limitations et considÃ©rations

### Limitations techniques

#### 1. Contrainte du systÃ¨me de fichiers

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Configuration NON compatible avec --swap                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  /dev/sda1 â†’ /var/lib/postgresql/17/  (FS ext4)             â”‚
â”‚  /dev/sdb1 â†’ /var/lib/postgresql/18/  (FS xfs)              â”‚
â”‚                                                             â”‚
â”‚  âŒ DiffÃ©rents filesystems                                  â”‚
â”‚  â†’ Utiliser --copy Ã  la place                               â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Configuration compatible avec --swap                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  /dev/sda1 â†’ /var/lib/postgresql/                           â”‚
â”‚              â”œâ”€â”€ 17/main  âœ…                                â”‚
â”‚              â””â”€â”€ 18/main  âœ…                                â”‚
â”‚                                                             â”‚
â”‚  MÃªme filesystem                                            â”‚
â”‚  â†’ --swap fonctionne                                        â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 2. SystÃ¨mes de fichiers rÃ©seau

Les systÃ¨mes de fichiers rÃ©seau (NFS, CIFS) peuvent avoir des comportements spÃ©cifiques :

```bash
# VÃ©rifier le type de filesystem
df -T /var/lib/postgresql/

# Si NFS ou autre rÃ©seau :
# - Tester --swap en DEV d'abord
# - Attention aux latences rÃ©seau
# - PrÃ©fÃ©rer un stockage local si possible
```

#### 3. Droits et permissions

```bash
# Les permissions doivent Ãªtre correctes
ls -ld /var/lib/postgresql/17/main
# drwx------ 19 postgres postgres 4096 Nov 23 10:00 /var/lib/postgresql/17/main
#            ^^^ 700 requis pour PostgreSQL

# pg_upgrade vÃ©rifie cela automatiquement
```

### ConsidÃ©rations de performance

#### Impact I/O pendant la migration

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ActivitÃ© I/O pendant pg_upgrade --swap                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  Phase 1 : PrÃ©paration                                      â”‚
â”‚  I/O : ğŸ”µğŸ”µ Faible (lecture mÃ©tadonnÃ©es)                    â”‚
â”‚                                                             â”‚
â”‚  Phase 2 : Migration schÃ©ma et statistiques                 â”‚
â”‚  I/O : ğŸ”µğŸ”µğŸ”µ ModÃ©rÃ© (Ã©criture structure PG 18)             â”‚
â”‚                                                             â”‚
â”‚  Phase 3 : Swap atomique                                    â”‚
â”‚  I/O : ğŸ”µ TrÃ¨s faible (rename)                              â”‚
â”‚                                                             â”‚
â”‚  Impact global : Faible sur le sous-systÃ¨me disque          â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Utilisation mÃ©moire

```bash
# pg_upgrade consomme relativement peu de RAM
# Ordre de grandeur : 100-500 MB

# VÃ©rifier la mÃ©moire disponible avant migration
free -h
#               total        used        free
# Mem:           62Gi        15Gi        40Gi  â† OK âœ…

# Si < 1 GB de RAM libre, libÃ©rer de la mÃ©moire
```

### Gestion des erreurs

#### Erreurs possibles avec --swap

**Erreur 1 : Filesystems diffÃ©rents**

```bash
# Erreur :
# Swap mode requires both clusters on the same filesystem
# old cluster: /dev/sda1
# new cluster: /dev/sdb1

# Solution :
# - DÃ©placer un des clusters sur le mÃªme FS
# - OU utiliser --copy Ã  la place
```

**Erreur 2 : Espace disque insuffisant**

```bash
# Erreur :
# Not enough disk space for swap operation
# Required: 150 GB
# Available: 100 GB

# Solution :
# - LibÃ©rer de l'espace
# - Nettoyer les logs, WAL archives, etc.
# - Ou utiliser un disque plus grand
```

**Erreur 3 : Permissions incorrectes**

```bash
# Erreur :
# Permission denied for swap operation
# Cannot rename directories

# Solution :
chown -R postgres:postgres /var/lib/postgresql/17/
chown -R postgres:postgres /var/lib/postgresql/18/
chmod 700 /var/lib/postgresql/17/main
chmod 700 /var/lib/postgresql/18/main
```

## Comparaison avec --link : Quand choisir quoi ?

### Arbre de dÃ©cision

```
                    Besoin de migrer PG 17 â†’ PG 18
                                |
                                |
                     MÃªme systÃ¨me de fichiers ?
                        /              \
                      OUI              NON
                       |                |
                       |            --copy
                       |          (seule option)
                       |
            Rollback possible nÃ©cessaire ?
                  /              \
                OUI              NON
                 |                |
              --swap           --link
          (recommandÃ©)      (plus rapide)
```

### Tableau de comparaison --swap vs --link

| Aspect | --swap | --link |
|--------|--------|--------|
| **Vitesse** | âš¡âš¡ Ultra-rapide | âš¡âš¡ Ultra-rapide |
| **Rollback** | âœ… Possible facilement | âŒ Impossible |
| **SÃ©curitÃ©** | ğŸ”’ğŸ”’ TrÃ¨s Ã©levÃ©e | âš ï¸ RisquÃ© |
| **Espace disque** | ~1.1Ã— base | ~1Ã— base |
| **Production** | âœ…âœ… RecommandÃ© | âš ï¸ DÃ©conseillÃ© |
| **ComplexitÃ©** | ğŸŸ¡ Moyenne | ğŸŸ¡ Moyenne |
| **RÃ©cupÃ©ration erreur** | âœ… Excellente | âŒ Difficile |

### Cas pratiques

#### Cas 1 : Base critique e-commerce (500 GB)

```
Contexte :
- Site e-commerce 24/7
- FenÃªtre de maintenance : 3 heures max (3h-6h du matin)
- ZÃ©ro tolÃ©rance aux erreurs

Choix recommandÃ© : --swap

Raisons :
âœ… Rollback possible si problÃ¨me
âœ… Temps de migration < 1 heure
âœ… SÃ©curitÃ© maximale
âœ… Confiance de l'Ã©quipe

Alternative --link :
âŒ Trop risquÃ© sans filet de sÃ©curitÃ©
âŒ Si problÃ¨me Ã  6h30, impossible de revenir
```

#### Cas 2 : Base analytics (3 TB, lecture seule)

```
Contexte :
- Data warehouse / analytics
- Pas de transactions critiques
- FenÃªtre de maintenance : Tout le weekend
- DonnÃ©es majoritairement en lecture

Choix acceptable : --link ou --swap

Raisons --link :
âœ… LÃ©gÃ¨rement plus rapide
âœ… Risque acceptable (donnÃ©es non-critiques)
âœ… PossibilitÃ© de recrÃ©er depuis sources

Raisons --swap :
âœ… Plus sÃ»r malgrÃ© tout
âœ… ComplexitÃ© similaire
âœ… Bonne pratique
```

#### Cas 3 : Dev/Test (50 GB)

```
Contexte :
- Environnement de dÃ©veloppement
- Pas de contrainte de downtime
- Peut Ãªtre recrÃ©Ã© facilement

Choix : --link ou --copy

Raisons :
âœ… Rollback pas critique
âœ… --link pour la rapiditÃ©
âœ… --copy si apprentissage du process
```

## Questions frÃ©quentes (FAQ)

### Q1 : --swap est-il plus lent que --link ?

**RÃ©ponse** : Presque identique. `--swap` ajoute quelques opÃ©rations de gestion des rÃ©pertoires, mais la diffÃ©rence est nÃ©gligeable (ordre de la seconde ou deux).

```
--link : 45 minutes
--swap : 47 minutes
DiffÃ©rence : ~2 minutes sur une migration de 2 TB
```

### Q2 : Puis-je utiliser --swap ET --jobs en mÃªme temps ?

**RÃ©ponse** : **Oui** ! Les deux options sont compatibles :

```bash
pg_upgrade \
  --swap \
  --jobs=4 \  # ParallÃ©lisation
  [autres options]
```

### Q3 : Que se passe-t-il si la migration Ã©choue avec --swap ?

**RÃ©ponse** : `pg_upgrade` est conÃ§u pour Ãªtre **transactionnel** :

- âœ… Si erreur dÃ©tectÃ©e â†’ Annulation automatique
- âœ… Ancien cluster reste intact
- âœ… Logs dÃ©taillÃ©s pour diagnostiquer
- âœ… Aucune corruption de donnÃ©es

### Q4 : Combien de temps puis-je garder le rÃ©pertoire .old ?

**RÃ©ponse** : C'est Ã  vous de dÃ©cider, mais voici une recommandation :

```
J+0 Ã  J+7   : Garder absolument (pÃ©riode de validation)
J+7 Ã  J+30  : RecommandÃ© de garder (sÃ©curitÃ©)
J+30+       : Peut Ãªtre supprimÃ© si tout est stable
```

### Q5 : --swap fonctionne-t-il avec les tablespaces ?

**RÃ©ponse** : **Oui**, mais avec considÃ©rations :

- Les tablespaces doivent aussi Ãªtre sur le mÃªme filesystem
- Ou Ãªtre gÃ©rÃ©s indÃ©pendamment
- VÃ©rifier avec `--check` avant migration

```bash
# Lister les tablespaces
psql -c "\db+"

# VÃ©rifier leur localisation
SELECT spcname, pg_tablespace_location(oid)
FROM pg_tablespace;
```

### Q6 : Puis-je utiliser --swap pour migrer de PG 16 vers PG 18 ?

**RÃ©ponse** : **Oui**, `--swap` fonctionne pour toute migration majeure supportÃ©e par `pg_upgrade`. Pas uniquement PG 17 â†’ PG 18.

```bash
# Exemples valides :
PG 13 â†’ PG 18 avec --swap âœ…
PG 14 â†’ PG 18 avec --swap âœ…
PG 15 â†’ PG 18 avec --swap âœ…
PG 16 â†’ PG 18 avec --swap âœ…
PG 17 â†’ PG 18 avec --swap âœ…
```

### Q7 : --swap utilise-t-il des hardlinks comme --link ?

**RÃ©ponse** : Partiellement. Pendant la migration, `--swap` utilise des mÃ©canismes similaires aux hardlinks, mais la diffÃ©rence clÃ© est dans la **gestion finale** :

- `--link` : Hardlinks permanents, pas de sÃ©paration
- `--swap` : Utilisation temporaire, puis sÃ©paration complÃ¨te aprÃ¨s swap

### Q8 : Y a-t-il un risque de corruption avec --swap ?

**RÃ©ponse** : **Non**, le risque de corruption est identique Ã  `--copy` :

- Le swap est une opÃ©ration **atomique** du systÃ¨me de fichiers
- Soit il rÃ©ussit complÃ¨tement, soit il Ã©choue complÃ¨tement
- Pas d'Ã©tat intermÃ©diaire corrompu possible

## Bonnes pratiques avancÃ©es

### 1. Automatisation avec scripts

#### Script de migration complet

```bash
#!/bin/bash
# migrate_pg17_to_pg18_swap.sh

set -e  # ArrÃªt en cas d'erreur

LOG_FILE="/var/log/postgresql/migration_$(date +%Y%m%d_%H%M%S).log"
OLD_DIR="/var/lib/postgresql/17/main"
NEW_DIR="/var/lib/postgresql/18/main"

log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG_FILE"
}

log "ğŸš€ DÃ©but de la migration PostgreSQL 17 â†’ 18"

# 1. VÃ©rifications prÃ©alables
log "ğŸ“‹ VÃ©rifications prÃ©alables..."
df -h /var/lib/postgresql/ >> "$LOG_FILE"
pg_ctl status -D "$OLD_DIR" >> "$LOG_FILE"

# 2. Sauvegarde
log "ğŸ’¾ CrÃ©ation sauvegarde..."
pg_basebackup -D /backup/pg17_$(date +%Y%m%d) -Fp -Xs -P 2>&1 | tee -a "$LOG_FILE"

# 3. ANALYZE
log "ğŸ“Š Mise Ã  jour des statistiques..."
psql -d postgres -c "ANALYZE VERBOSE;" 2>&1 | tee -a "$LOG_FILE"

# 4. ArrÃªt PG 17
log "â¸ï¸  ArrÃªt PostgreSQL 17..."
pg_ctl stop -D "$OLD_DIR" -m fast 2>&1 | tee -a "$LOG_FILE"

# 5. Test --check
log "ğŸ” VÃ©rification (--check)..."
pg_upgrade \
  --old-datadir="$OLD_DIR" \
  --new-datadir="$NEW_DIR" \
  --old-bindir=/usr/lib/postgresql/17/bin \
  --new-bindir=/usr/lib/postgresql/18/bin \
  --swap \
  --check 2>&1 | tee -a "$LOG_FILE"

if [ $? -ne 0 ]; then
    log "âŒ VÃ©rification Ã©chouÃ©e. ArrÃªt."
    exit 1
fi

# 6. Migration rÃ©elle
log "ğŸ”„ Migration en cours avec --swap..."
pg_upgrade \
  --old-datadir="$OLD_DIR" \
  --new-datadir="$NEW_DIR" \
  --old-bindir=/usr/lib/postgresql/17/bin \
  --new-bindir=/usr/lib/postgresql/18/bin \
  --swap 2>&1 | tee -a "$LOG_FILE"

if [ $? -ne 0 ]; then
    log "âŒ Migration Ã©chouÃ©e. Consultez les logs."
    exit 1
fi

# 7. DÃ©marrage PG 18
log "â–¶ï¸  DÃ©marrage PostgreSQL 18..."
pg_ctl start -D "$NEW_DIR" 2>&1 | tee -a "$LOG_FILE"

# 8. Validation
log "âœ… Validation..."
psql -d postgres -c "SELECT version();" 2>&1 | tee -a "$LOG_FILE"
psql -d postgres -c "SELECT COUNT(*) FROM pg_stat_activity;" 2>&1 | tee -a "$LOG_FILE"

log "ğŸ‰ Migration terminÃ©e avec succÃ¨s !"
log "ğŸ“ Ancien cluster sauvegardÃ© dans .old"
log "ğŸ“„ Logs disponibles : $LOG_FILE"
```

### 2. Monitoring pendant la migration

```bash
# Dans un autre terminal, surveiller en temps rÃ©el

# 1. Progression des fichiers
watch -n 5 'ls -lh /var/lib/postgresql/.pg_upgrade_tmp/ 2>/dev/null || echo "En cours..."'

# 2. Utilisation disque
watch -n 5 'df -h /var/lib/postgresql/'

# 3. Logs
tail -f pg_upgrade_server.log

# 4. Processus actif
watch -n 2 'ps aux | grep pg_upgrade'
```

### 3. Tests post-migration

```sql
-- Script de validation post-migration
-- validation_pg18.sql

\echo '=== Test 1 : Version ==='
SELECT version();

\echo '\n=== Test 2 : Connexions ==='
SELECT COUNT(*) as nb_connexions FROM pg_stat_activity;

\echo '\n=== Test 3 : Tables principales ==='
SELECT
    schemaname,
    tablename,
    n_live_tup
FROM pg_stat_user_tables
ORDER BY n_live_tup DESC
LIMIT 10;

\echo '\n=== Test 4 : Statistiques prÃ©servÃ©es ==='
SELECT
    COUNT(*) as tables_with_stats
FROM pg_stats;

\echo '\n=== Test 5 : Index ==='
SELECT
    schemaname,
    tablename,
    indexname
FROM pg_indexes
WHERE schemaname NOT IN ('pg_catalog', 'information_schema')
LIMIT 10;

\echo '\n=== Test 6 : Extensions ==='
SELECT * FROM pg_extension;

\echo '\nâœ… Validation terminÃ©e'
```

## Conclusion

L'option `--swap` de PostgreSQL 18 reprÃ©sente une **avancÃ©e majeure** pour les migrations de bases de donnÃ©es en production.

### RÃ©capitulatif des avantages

- âœ… **RapiditÃ©** : Migration ultra-rapide grÃ¢ce au swap atomique
- âœ… **SÃ©curitÃ©** : Rollback possible et simple en cas de problÃ¨me
- âœ… **EfficacitÃ©** : Utilisation minimale d'espace disque supplÃ©mentaire
- âœ… **Confiance** : IdÃ©al pour les environnements critiques
- âœ… **SimplicitÃ©** : Activation par simple ajout d'un flag

### Cas d'usage recommandÃ©

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Utiliser --swap quand :                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  âœ… Base de production critique                             â”‚
â”‚  âœ… Besoin de rollback possible                             â”‚
â”‚  âœ… Contraintes de temps strictes                           â”‚
â”‚  âœ… Base > 100 GB                                           â”‚
â”‚  âœ… MÃªme filesystem pour ancien/nouveau cluster             â”‚
â”‚  âœ… PremiÃ¨re migration vers PG 18                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Comparaison finale

| | --copy | --link | --swap (PG 18) |
|---|--------|--------|----------------|
| **Pour DEV** | âœ… | âœ… | âœ… |
| **Pour PROD** | âš ï¸ Lent | âš ï¸ RisquÃ© | âœ…âœ… RecommandÃ© |
| **Bases < 10 GB** | âœ… | âœ… | âœ… |
| **Bases > 100 GB** | âŒ Trop lent | âš ï¸ Sans filet | âœ…âœ… IdÃ©al |
| **Migration critique** | âš ï¸ Downtime long | âŒ Trop risquÃ© | âœ…âœ… Parfait |

### Points clÃ©s Ã  retenir

1. **--swap = --link + sÃ©curitÃ©** : Vous obtenez la rapiditÃ© sans le risque
2. **Rollback simple** : En quelques minutes si nÃ©cessaire
3. **Production-ready** : ConÃ§u pour les environnements critiques
4. **Transparent** : MÃªme utilisation que pg_upgrade classique
5. **NouveautÃ© PG 18** : Profitez-en lors de votre migration

### Prochaines sections recommandÃ©es

Pour complÃ©ter votre comprÃ©hension des migrations PostgreSQL 18 :

- **Section 19.3.1** : PrÃ©servation des statistiques (complÃ©mentaire Ã  --swap)
- **Section 19.3.3** : VÃ©rifications parallÃ¨les avec --jobs
- **Section 19.3.4** : StratÃ©gies Blue/Green pour downtime minimal
- **Section 19.4** : Troubleshooting et gestion de crises post-migration

---

**Note** : Si vous retenez une seule chose de cette section, c'est celle-ci : **PostgreSQL 18 rend les migrations plus sÃ»res grÃ¢ce Ã  `--swap`**. Vous pouvez migrer rapidement tout en gardant la possibilitÃ© de revenir en arriÃ¨re facilement. C'est le meilleur des deux mondes !

â­ï¸ [NouveautÃ© PG 18 : VÃ©rifications parallÃ¨les (--jobs)](/19-postgresql-en-production/03.3-verifications-paralleles-pg18.md)
